[{"title":"LC-77-ç»„åˆ","url":"/posts/e3e1c4a3/","content":"\n## ç»„åˆ\n\nLeetCodeé¢˜ç›®é“¾æ¥ï¼š[77. ç»„åˆ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰](https://leetcode.cn/problems/combinations/description/)\n\néš¾åº¦ï¼š{% label ä¸­ç­‰ orange %}\n\n\n\n### åˆ†æ\n\næœ¬é¢˜å±äºå…¸å‹çš„é€’å½’å›æº¯çš„é¢˜å‹ï¼Œéå†ç»™å®šæ•°ç»„ï¼Œé€’å½’å›æº¯ç»„åˆå‡ºæ‰€æœ‰å¯èƒ½çš„ç»„åˆå³å¯\n\n>   æ³¨æ„ï¼šç»„åˆéœ€è¦è¿›è¡Œå»é‡ï¼ˆç»„æˆå…ƒç´ ç›¸åŒä½†æ˜¯é¡ºåºä¸åŒä»ç„¶å±äºåŒç§ç»„åˆï¼‰\n\n\n### æ€è·¯\n\n>   1.  éå†æ•°ç»„ï¼ŒåŠ å…¥ä¸´æ—¶ç»“æœé›†ï¼ˆæ³¨æ„å»é‡çš„åˆ¤æ–­é€»è¾‘ï¼‰\n>   2.  é€’å½’éå†æ•°ç»„\n>   3.  ä¸´æ—¶ç»“æœé›†å›æº¯åç»§ç»­éå†\n>\n>   é€’å½’ç»“æŸæ¡ä»¶ï¼šå½“ä¸´æ—¶ç»“æœé›†ä¸­çš„å…ƒç´ ä¸ªæ•°ç¬¦åˆæ¡ä»¶æ—¶å³éå†ç»“æŸï¼ŒåŠ å…¥æœ€ç»ˆç»“æœé›†å¹¶é€€å‡ºé€’å½’\n\n![LC-77-ç»„åˆ](LC-77-ç»„åˆ.assets/LC-77-ç»„åˆ.svg)\n\n{% hideToggle ç‚¹æˆ‘å±•å¼€,, %}\n\n{% tabs ä»£ç  %}\n\n<!-- tab Golang -->\n\n```go\n\nfunc recurve(idx int, n int, k int, cur *[]int, res *[][]int) {\n\tif len(*cur) == k {\n\t\ttmp := make([]int, len(*cur))\n\t\tcopy(tmp, *cur)\n\t\t*res = append(*res, tmp)\n\t\treturn\n\t}\n\tfor i := idx + 1; i <= n; i++ {\n\t\t*cur = append(*cur, i)\n\t\trecurve(i, n, k, cur, res)\n\t\t*cur = (*cur)[:len(*cur)-1]\n\t}\n}\n\nfunc Combine(n int, k int) [][]int {\n\tres := make([][]int, 0)\n\tcur := make([]int, 0, k)\n\trecurve(0, n, k, &cur, &res)\n\treturn res\n}\n\n```\n\n<!-- endtab -->\n\n<!-- tab Java -->\n\n```java\n\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n{% endhideToggle %}\n\n\n### æäº¤\n\n![1738571973971](LC-77-ç»„åˆ.assets/1738571973971.png)\n\n\n### å‚è€ƒèµ„æ–™\n\n>    [ä»£ç éšæƒ³å½•](https://programmercarl.com/0077.ç»„åˆ.html)\n\n","tags":["LeetCode","ç®—æ³•-å›æº¯"],"categories":["ç®—æ³•","å›æº¯"]},{"title":"è·³è¡¨-å®ç°ç¯‡ï¼ˆRedisï¼‰","url":"/posts/a381e6f7/","content":"\n## ç®€ä»‹\n\næœ¬æ–‡åŸºäº {% label Redis3.0 orange %} ç‰ˆæœ¬çš„æºç è§£è¯»è·³è¡¨çš„å®ç°\n\n{% label Redis3.0 orange %} æºç é“¾æ¥ï¼š[redis/redis at 3.0.0](https://github.com/redis/redis/tree/3.0.0)\n\nå»ºè®®é˜…è¯»ï¼š\n - [è·³è¡¨-åŸç†ç¯‡ | Crayonã®åšå®¢](/posts/2e152a56/)\n\næœ¬æ–‡æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š\n\n- [ç®€ä»‹](#ç®€ä»‹)\n- [èƒŒæ™¯çŸ¥è¯†](#èƒŒæ™¯çŸ¥è¯†)\n- [æºç è§£è¯»](#æºç è§£è¯»)\n\t- [ç»“æ„ä½“å®šä¹‰](#ç»“æ„ä½“å®šä¹‰)\n\t- [éšæœºå‡½æ•°](#éšæœºå‡½æ•°)\n\t- [æŸ¥æ‰¾](#æŸ¥æ‰¾)\n\t- [æ’å…¥](#æ’å…¥)\n\t- [åˆ é™¤](#åˆ é™¤)\n\n## èƒŒæ™¯çŸ¥è¯†\n\n{% label Redis orange %} å†…ç½®äº†å¤šç§æ•°æ®ç»“æ„ï¼Œå…¶ä¸­`zset`ï¼ˆæœ‰åºé›†åˆï¼Œè‹±æ–‡åï¼šsorted setï¼‰å…¼å…·é›†åˆçš„å…ƒç´ å”¯ä¸€æ€§ä»¥åŠæœ‰åºæ€§ï¼ˆå…ƒç´ æœ‰åºæ€§ï¼‰ä¸¤ä¸ªç‰¹æ€§ï¼Œè¢«å¹¿æ³›ç”¨åœ¨æ—¥å¸¸ä¸šåŠ¡éœ€æ±‚çš„å¼€å‘ä¸­\n\n`zset`ç”±å¤šä¸ªæ•°æ®ç»“æ„ç»„åˆå®ç°çš„ï¼Œè€Œè·³è¡¨ï¼ˆ`zskiplist`ï¼‰å°±æ˜¯å®ç°æœ‰åºæ€§çš„å…³é”®æ•°æ®ç»“æ„ï¼Œ{% label Redis orange %} å°±æ˜¯é€šè¿‡è·³è¡¨å®ç°äº†`zset`ç»“æ„çš„æ’åºã€æ ¹æ®æ’åçš„èŒƒå›´è·å–ç­‰æ“ä½œ\n\n{% label Redis orange %} è‡ªå·±å®ç°äº†è·³è¡¨ç»“æ„ï¼Œä¸ºç¬¦åˆè‡ªèº«ä¸šåŠ¡æ“ä½œçš„éœ€è¦å¢åŠ äº†ä¸€äº›é¢å¤–çš„å­—æ®µä»¥åŠæ“ä½œï¼Œè™½ç„¶å’ŒåŸå§‹è®ºæ–‡ä¸­çš„ç»“æ„ä¸å¤ªä¸€æ ·ï¼Œä½†åŸºæœ¬çš„æ“ä½œé€»è¾‘éƒ½æ˜¯ç›¸åŒçš„\n\n## æºç è§£è¯»\n\n### ç»“æ„ä½“å®šä¹‰\n\n#### zset\n\n```c\ntypedef struct zset {\n    dict *dict;\n    zskiplist *zsl;\n} zset;\n```\n\nå®ç°`zset`çš„ç»“æ„ä½“å®šä¹‰ï¼Œä»ç»“æ„ä½“ä¸­çš„æˆå‘˜\n\n-   `dict`ï¼ˆ`dict`ï¼‰ï¼šå®ç°é›†åˆçš„ç‰¹æ€§\n-   `zsl`ï¼ˆ`zskiplist`ï¼‰ï¼šå®ç°æœ‰åºï¼ˆæ’åºï¼‰çš„ç‰¹æ€§\n\nå°±å¯ä»¥çŸ¥é“`zset`å°±æ˜¯é€šè¿‡ç»„åˆ`dict`ï¼ˆ {% label Redis orange %} åº•å±‚æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œå³å“ˆå¸Œè¡¨ï¼‰ã€`zskiplist`ï¼ˆè·³è¡¨ï¼‰ä¸¤ç§æ•°æ®ç»“æ„å®ç°çš„\n\n\n\n#### zskiplist\n\n```c\ntypedef struct zskiplist {\n    struct zskiplistNode *header, *tail;\n    unsigned long length;\n    int level;\n} zskiplist;\n```\n\n-   `header`ã€`tail`ï¼šå¤´å°¾æŒ‡é’ˆ\n-   `length`ï¼šå…ƒç´ ä¸ªæ•°\n-   `level`ï¼šå½“å‰è·³è¡¨çš„æœ€é«˜å±‚çº§\n\n\n\n#### zskiplistNode\n\n```c\n/* ZSETs use a specialized version of Skiplists */\ntypedef struct zskiplistNode {\n    robj *obj;\n    double score;\n    struct zskiplistNode *backward;\n    struct zskiplistLevel {\n        struct zskiplistNode *forward;\n        unsigned int span;\n    } level[];\n} zskiplistNode;\n```\n\n-   `rojb`ï¼šå…ƒç´ å€¼\n-   `score`ï¼šåˆ†æ•°ï¼Œä¹Ÿå°±æ˜¯è·³è¡¨åŸå§‹è®ºæ–‡ä¸­çš„`key`\n-   <span style=\"font-weight: bold; color: red;\">`backward`ï¼šå›é€€æŒ‡é’ˆï¼Œä¸»è¦ç”¨äºåå‘éå†ä½¿ç”¨</span>\n-   **`level`**\n    -   `forward`ï¼šå‰è¿›æŒ‡é’ˆ\n    -   <span style=\"font-weight: bold; color: red;\">`span` ï¼šå‰è¿›æŒ‡é’ˆçš„è·¨åº¦ï¼ˆç”¨æ¥è®°å½•å¯¹åº”çš„å‰è¿›æŒ‡é’ˆå‘å‰æ—¶è·¨è¿‡çš„å…ƒç´ ä¸ªæ•°ï¼ŒåŸºäºè¿™ä¸ªå­—æ®µå¯ä»¥å¾ˆæ–¹ä¾¿çš„è®¡ç®—æ’ä½ï¼‰</span>\n\n\n\n![1738048075089](è·³è¡¨-å®ç°ç¯‡ï¼ˆRedisï¼‰.assets/1738048075089.png)\n\n\n\n### å¸¸é‡å®šä¹‰\n\n```c\n#define ZSKIPLIST_MAXLEVEL 32 /* Should be enough for 2^32 elements */\n#define ZSKIPLIST_P 0.25      /* Skiplist P = 1/4 */\n```\n\n{% label Redis orange %} è·³è·ƒè¡¨çš„æœ€é«˜å±‚çº§æ˜¯32å±‚ï¼Œå±‚æ™‹å‡æ¦‚ç‡ä¸º*0.25*\n\n\n\n### éšæœºå‡½æ•°\n\n\n\n```c\n/* Returns a random level for the new skiplist node we are going to create.\n * The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL\n * (both inclusive), with a powerlaw-alike distribution where higher\n * levels are less likely to be returned. */\nint zslRandomLevel(void) {\n    int level = 1;\n    while ((random()&0xFFFF) < (ZSKIPLIST_P * 0xFFFF))\n        level += 1;\n    return (level<ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;\n}\n```\n\n\n\n### åˆå§‹åŒ–\n\n```c\nzskiplist *zslCreate(void) {\n    int j;\n    zskiplist *zsl;\n\n    zsl = zmalloc(sizeof(*zsl));\n    zsl->level = 1;\n    zsl->length = 0;\n    zsl->header = zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL);\n    for (j = 0; j < ZSKIPLIST_MAXLEVEL; j++) {\n        zsl->header->level[j].forward = NULL;\n        zsl->header->level[j].span = 0;\n    }\n    zsl->header->backward = NULL;\n    zsl->tail = NULL;\n    return zsl;\n}\n```\n\né€šè¿‡`zslCreate`å¯ä»¥åˆ›å»ºä¸€ä¸ª`zskiplist`æŒ‡é’ˆ\n\n\n\n### æ’å…¥\n\n{% label Redis orange %} è·³è¡¨å¼•å…¥äº†ä¸€äº›é¢å¤–çš„å­—æ®µ/æœºåˆ¶ä»¥ç¬¦åˆå®é™…ä¸šåŠ¡æ“ä½œçš„éœ€è¦\n\nå‡½æ•°å£°æ˜\n\n```c\nzskiplistNode *zslInsert(zskiplist *zsl, double score, robj *obj);\n```\n\n\n\nç›¸æ¯”äºåŸå§‹è®ºæ–‡è·³è¡¨çš„å®ç°è€Œè¨€å¤šäº†ä»¥ä¸‹ä¸¤å—é€»è¾‘ï¼š\n\n1.  `span`ï¼ˆè·¨åº¦ï¼‰çš„ç»´æŠ¤\n2.  `backward`ï¼ˆå›é€€æŒ‡é’ˆï¼‰çš„ç»´æŠ¤\n\né™¤äº†ç»´æŠ¤ä¸Šè¿°çš„ä¸¤å—é€»è¾‘ï¼Œå¯ä»¥å‘ç°å®é™…ä¸Šä»£ç çš„å®ç°å’Œè®ºæ–‡ä¼ªä»£ç åŸºæœ¬ç›¸åŒ\n\nä¹Ÿæ˜¯åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤\n\n1.  éå†è·³è¡¨ï¼Œæ‰¾åˆ°ç¬¦åˆçš„èŠ‚ç‚¹ä½ç½®ï¼Œå¹¶è®°å½•æ¯ä¸€å±‚éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹ï¼ˆæ’å…¥çš„èŠ‚ç‚¹å¯¹åº”çš„å‰é©±èŠ‚ç‚¹ï¼‰ï¼ˆä¹Ÿå°±æ˜¯è®°å½•`update`æ•°ç»„ï¼‰\n\n    -   å¢åŠ `rank`æ•°ç»„è®°å½•æ¯å±‚çš„æ’ä½\n\n    ```c\n        x = zsl->header;\n        for (i = zsl->level-1; i >= 0; i--) {\n            /* store rank that is crossed to reach the insert position */\n            // åˆå§‹åŒ–æ’ä½ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æœ€é¡¶å±‚ï¼Œåˆ™åˆå§‹åŒ–ä¸º0ï¼Œå…¶ä»–æƒ…å†µå°±æ˜¯ä¸Šä¸€å±‚çš„rankçš„å€¼\n            // æ¯”å¦‚ä»4å±‚å¼€å§‹éå†ï¼Œrank[3]=0ï¼Œrank[2]=rank[3]\n            // å…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå½“å‰å±‚çš„æ’ä½åº”è¯¥åŸºäºä¸Šä¸€å±‚çš„æ’ä½æ¥ç€è®¡æ•°\n            rank[i] = i == (zsl->level-1) ? 0 : rank[i+1];\n            while (x->level[i].forward &&\n                (x->level[i].forward->score < score ||\n                    (x->level[i].forward->score == score &&\n                    compareStringObjects(x->level[i].forward->obj,obj) < 0))) {\n                // è¿™é‡Œçš„æ¯”è¾ƒé™¤äº†æ ¹æ®scoreæ¯”è¾ƒä¹‹å¤–ï¼Œè¿˜å¢åŠ äº†scoreç›¸åŒæƒ…å†µä¸‹æ ¹æ®objï¼ˆå€¼ï¼‰æ¯”è¾ƒçš„åœºæ™¯\n                // æ›´æ–°æ’ä½ï¼Œå¢åŠ è·¨åº¦å°±æ˜¯æ–°çš„æ’ä½\n                rank[i] += x->level[i].span;\n                x = x->level[i].forward;\n            }\n            // è®°å½•èŠ‚ç‚¹ï¼ˆè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯æ’å…¥æ–°èŠ‚ç‚¹çš„æ¯ä¸€å±‚å¯¹åº”çš„å‰é©±èŠ‚ç‚¹ï¼‰\n            // å¦‚æœè¯´æ–°èŠ‚ç‚¹çš„å±‚çº§è¶…è¿‡å½“å‰è·³è¡¨çš„æœ€é«˜å±‚çº§ï¼Œè¿™é‡Œæ˜¯ä¸€å®šè®°å½•ä¸åˆ°çš„ï¼Œæ‰€ä»¥æ‰æœ‰ä¸‹é¢å•ç‹¬åˆ¤æ–­å¹¶å¤„ç†çš„é€»è¾‘\n            // ä¿è¯ä»£ç é€»è¾‘ç»Ÿä¸€ä¹Ÿè®©ä»£ç æ›´å…·å¯è¯»æ€§\n            update[i] = x;\n        }\n    ```\n\n2.  è°ƒç”¨éšæœºå‡½æ•°ç”Ÿæˆæ–°èŠ‚ç‚¹å±‚çº§ï¼Œå¦‚æœæ–°èŠ‚ç‚¹å±‚çº§è¶…è¿‡å½“å‰è·³è¡¨æœ€é«˜å±‚ï¼Œåˆ™æ›´æ–°`update`æ•°ç»„ï¼ˆè¶…è¿‡æœ€é«˜å±‚çš„å‰é©±èŠ‚ç‚¹å°±æ˜¯å¤´èŠ‚ç‚¹ï¼Œä½†æ˜¯éå†è¿‡ç¨‹ä¸ä¼šè®°å½•ï¼Œä¸ºäº†è®©åç»­èƒ½å¤Ÿç”¨ç»Ÿä¸€ä»£ç é€»è¾‘å¤„ç†ï¼Œå•ç‹¬è¿›è¡Œåˆ¤æ–­å¹¶æ›´æ–°`update`æ•°ç»„ï¼Œè¿˜æœ‰åŒæ­¥æ›´æ–°è·³è¡¨`level`å­—æ®µ\n\n    -   å¢åŠ `span`å­—æ®µçš„åˆå§‹åŒ–é€»è¾‘\n\n    ```c\n        // è°ƒç”¨éšæœºå‡½æ•°ç”Ÿæˆlevel\n        level = zslRandomLevel();\n        // å¦‚æœæ–°èŠ‚ç‚¹levelè¶…è¿‡å½“å‰è·³è¡¨æœ€é«˜å±‚\n        if (level > zsl->level) {\n            // åªå¤„ç†è¶…å‡ºå½“å‰è·³è¡¨æœ€é«˜å±‚çš„éƒ¨åˆ†\n            // ï¼ˆå‰©ä¸‹çš„éƒ½ä¼šåœ¨éå†è¿‡ç¨‹ä¸­è¢«è®°å½•ï¼Œåªæœ‰è¶…è¿‡çš„éƒ¨åˆ†ä¸ä¼šè¢«è®°å½•ï¼Œæ‰€ä»¥å•ç‹¬åœ¨è¿™é‡Œå¤„ç†ï¼‰\n            for (i = zsl->level; i < level; i++) {\n                // æ’ä½åˆå§‹åŒ–ï¼Œå’Œä¸Šé¢éå†è¿‡ç¨‹çš„åˆå§‹åŒ–é€»è¾‘ç›¸åŒ\n                rank[i] = 0;\n                // æ–°èŠ‚ç‚¹å±‚çº§æ˜¯æœ€é«˜çš„ï¼Œæ‰€ä»¥åªä¼šæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå‰é©±èŠ‚ç‚¹åªèƒ½æ˜¯header\n                update[i] = zsl->header;\n                // åŒç†ï¼Œåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥è·¨åº¦å°±æ˜¯è·³è¡¨é•¿åº¦ï¼ˆæ²¡æ›´æ–°å‰ï¼Œè·³è¡¨é•¿åº¦åœ¨æœ€åæ‰æ›´æ–°ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ˜¯åŸé•¿åº¦ï¼‰\n                update[i]->level[i].span = zsl->length;\n            }\n            // æ›´æ–°è·³è¡¨çš„æœ€é«˜å±‚çº§\n            zsl->level = level;\n        }\n    ```\n\n3.  åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œæ›´æ–°è·³è¡¨\n\n    -   å¢åŠ `span`å­—æ®µçš„æ›´æ–°\n\n    ```c\n    x = zslCreateNode(level,score,obj);\n        for (i = 0; i < level; i++) {\n            // ä»ä¸‹å¾€ä¸Šæ›´æ–°\n            // ä»¥ä¸‹ä¸¤å¥å’Œé“¾è¡¨æ’å…¥çš„æ˜¯ç›¸åŒçš„ï¼Œå°±æ˜¯å°†æ–°èŠ‚ç‚¹æ’å…¥çš„é€»è¾‘\n            x->level[i].forward = update[i]->level[i].forward;\n            update[i]->level[i].forward = x;\n    \n            /* update span covered by update[i] as x is inserted here */\n            // æ ¹æ®æ¯å±‚èŠ‚ç‚¹çš„æ’ä½æ¨ç®—å‡ºè·¨åº¦\n            // æ›´æ–°æ–°èŠ‚ç‚¹çš„è·¨åº¦\n            x->level[i].span = update[i]->level[i].span - (rank[0] - rank[i]);\n            // æ›´æ–°æ¯å±‚å‰é©±èŠ‚ç‚¹çš„è·¨åº¦ï¼ˆè€ƒè™‘åˆ°å‰é©±èŠ‚ç‚¹å¯èƒ½æ˜¯é‚£ä¸€å±‚çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ç®€å•åœ°ç›´æ¥è‡ªå¢1ï¼‰\n            update[i]->level[i].span = (rank[0] - rank[i]) + 1;\n        }\n    ```\n\n4.  {% label Redis orange %} å¤šäº†æœ€åä¸€ä¸ªæ­¥éª¤ï¼ˆå…¶ä½™å­—æ®µçš„æ›´æ–°ï¼‰\n\n    1.  æ›´æ–°`span`è·¨åº¦\n    2.  æ›´æ–°`backward`\n    3.  æ›´æ–°`tail`\n    4.  æ›´æ–°`length`\n\n    ```c\n        /* increment span for untouched levels */\n        for (i = level; i < zsl->level; i++) {\n            // å¯¹äºæ–°èŠ‚ç‚¹æ²¡æœ‰æ¶‰åŠåˆ°çš„å±‚çº§ï¼Œè·¨åº¦ç›´æ¥è‡ªå¢1å³å¯\n            update[i]->level[i].span++;\n        }\n        // æ›´æ–°BWæŒ‡é’ˆï¼ŒBWæŒ‡é’ˆæ²¡æœ‰å¤šå±‚çš„æ¦‚å¿µ\n        x->backward = (update[0] == zsl->header) ? NULL : update[0];\n        if (x->level[0].forward)\n            // å¦‚æœæ–°èŠ‚ç‚¹ä¸æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£å°±è¦æ›´æ–°åç»§èŠ‚ç‚¹BWæŒ‡å‘æ–°èŠ‚ç‚¹\n            x->level[0].forward->backward = x;\n        else\n            // æ–°èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ›´æ–°tail\n            zsl->tail = x;\n    // è·³è¡¨é•¿åº¦è‡ªå¢1\n        zsl->length++;\n        return x;\n    ```\n    \n\n\n\n#### è·¨åº¦æ›´æ–°\n\nä»¥ä¸‹é¢çš„è·³è¡¨æ’å…¥**score=8çš„èŠ‚ç‚¹**ä¸ºä¾‹\n\n![insert.svg](è·³è¡¨-å®ç°ç¯‡ï¼ˆRedisï¼‰.assets/insert.svg)\n\n**rank**æ•°ç»„ï¼š`[4, 4, 2, 2]`\n\n**update**æ•°ç»„ï¼š`[B, B, A, A]`ï¼ˆ`A`ã€`B`ä¸ºèŠ‚ç‚¹ä»£å·ï¼‰\n\n**æ–°èŠ‚ç‚¹**\n\n```c\nx->level[i].span = update[i]->level[i].span - (rank[0] - rank[i]);\n```\n\né’ˆå¯¹æ–°èŠ‚ç‚¹ï¼Œéœ€è¦æ›´æ–°æ–°èŠ‚ç‚¹å¯¹åº”çš„æ¯ä¸€å±‚çš„å‰è¿›æŒ‡é’ˆçš„è·¨åº¦\n\n1.  $i=0$ï¼Œæ›´æ–°æ–°èŠ‚ç‚¹ç¬¬ä¸€å±‚çš„è·¨åº¦\n\n    $update[0] = B$\n\n    $update[0]->level[0].span = 1$\n\n    $rank[0] - rank[0] = 4 - 4 = 0$\n\n    $x->level[0].span =  1 - 0 = 1$\n\n2.  $i=1$ï¼Œæ›´æ–°æ–°èŠ‚ç‚¹ç¬¬äºŒå±‚çš„è·¨åº¦\n\n    $update[1] =  B$\n\n    $update[1]->level[1].span = 1$\n\n    $rank[0] - rank[1] = 0$\n\n    $x->level[1].span = 1 - 0 = 1$\n\n3.  $i=2$ï¼Œæ›´æ–°æ–°èŠ‚ç‚¹ç¬¬ä¸‰å±‚çš„è·¨åº¦\n\n    $update[2] = A$\n\n    $update[2]->level[2].span = 3$\n\n    $rank[0] -rank[2] = 4 - 2 = 2$\n\n    $x->level[2].span = 3 - 2 = 1$\n\n4.  $i=3$ï¼Œæ›´æ–°æ–°èŠ‚ç‚¹ç¬¬å››å±‚çš„è·¨åº¦\n\n    $update[3] = A$\n\n    $update[3]->level[3].span = 3$\n\n    $rank[0] - rank[3] = 4 - 2 = 2$\n\n    $x->level[3].span = 3 - 2 = 1$\n\n**å‰é©±èŠ‚ç‚¹**\n\n**æ–°èŠ‚ç‚¹å±‚çº§å†…çš„èŠ‚ç‚¹**\n\n```c\nupdate[i]->level[i].span = (rank[0] - rank[i]) + 1;\n```\n\n1.  $i=0$ï¼Œæ›´æ–°ç¬¬ä¸€å±‚èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹`A`ï¼‰\n\n    $update[0]->level[0].span = (rank[0] - rank[0]) + 1 = (4 - 4) + 1 = 1$\n\n2.  $i=1$ï¼Œæ›´æ–°ç¬¬äºŒå±‚èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹`A`ï¼‰\n\n    $update[1]->level[0].span = (rank[0] - rank[1]) + 1 = (4 - 4) + 1 = 1$\n\n3.  $i=2$ï¼Œæ›´æ–°ç¬¬ä¸‰å±‚èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹`B`ï¼‰\n\n    $update[2]->level[2].span = (rank[0] - rank[2]) + 1 = (4 - 2) + 1 = 3$\n\n4.  $i=3$ï¼Œæ›´æ–°ç¬¬ä¸‰å±‚èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹`B`ï¼‰\n\n    $update[3]->level[3].span = (rank[0] - rank[3]) + 1 = (4 - 2) + 1 = 3$\n\n**è¶…è¿‡æ–°èŠ‚ç‚¹å±‚çº§çš„èŠ‚ç‚¹**\n\n```c\n    for (i = level; i < zsl->level; i++) {\n        // å¯¹äºæ–°èŠ‚ç‚¹æ²¡æœ‰æ¶‰åŠåˆ°çš„å±‚çº§ï¼Œè·¨åº¦ç›´æ¥è‡ªå¢1å³å¯\n        update[i]->level[i].span++;\n    }\n```\n\nå¯¹äºè¿™äº›èŠ‚ç‚¹ï¼ˆè¶…è¿‡æ–°èŠ‚ç‚¹ï¼‰çš„å±‚çº§ç”±äºç›´æ¥è·³è¿‡æ–°èŠ‚ç‚¹ï¼Œä¸Šå±‚èƒ½æ„ŸçŸ¥åˆ°çš„å°±æ˜¯å¤šè·¨è¿‡äº†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥ç›´æ¥è¿›è¡Œéå†å¹¶è‡ªå¢*1*å³å¯\n\n\n\næœ€ç»ˆæ’å…¥ç»“æœå¦‚ä¸‹å›¾\n\n>   è“è‰²æ ‡æ³¨å³ä¸ºæ–°å¢çš„æŒ‡é’ˆ\n\n![insert-result.svg](è·³è¡¨-å®ç°ç¯‡ï¼ˆRedisï¼‰.assets/insert-result.svg)\n\n\n\n### æŸ¥æ‰¾\n\nå‡½æ•°å£°æ˜\n\n```c\n// zslGetRank æ ¹æ®ç»™å®šçš„åˆ†æ•°ä»¥åŠå€¼è¿”å›èŠ‚ç‚¹çš„æ’ä½\nunsigned long zslGetRank(zskiplist *zsl, double score, robj *o);\n```\n\nå‡½æ•°å®ç°\n\n```c\n/* Find the rank for an element by both score and key.\n * Returns 0 when the element cannot be found, rank otherwise.\n * Note that the rank is 1-based due to the span of zsl->header to the\n * first element. */\nunsigned long zslGetRank(zskiplist *zsl, double score, robj *o) {\n    zskiplistNode *x;\n    unsigned long rank = 0;\n    int i;\n\n    x = zsl->header;\n    for (i = zsl->level-1; i >= 0; i--) {\n        while (x->level[i].forward &&\n            (x->level[i].forward->score < score ||\n                (x->level[i].forward->score == score &&\n                compareStringObjects(x->level[i].forward->obj,o) <= 0))) {\n            rank += x->level[i].span;\n            x = x->level[i].forward;\n        }\n\n        /* x might be equal to zsl->header, so test if obj is non-NULL */\n        if (x->obj && equalStringObjects(x->obj,o)) {\n            return rank;\n        }\n    }\n    return 0;\n}\n```\n\n\n\n### åˆ é™¤\n\nåˆ é™¤æ“ä½œå’Œæ’å…¥æ“ä½œç±»ä¼¼ï¼Œåªæ˜¯åœ¨æ‰¾åˆ°åˆ é™¤èŠ‚ç‚¹åï¼Œéœ€è¦å°†å„å±‚èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ›´æ–°ï¼Œç„¶ååˆ é™¤èŠ‚ç‚¹\n\nå‡½æ•°å£°æ˜\n\n```c\nint zslDelete(zskiplist *zsl, double score, robj *obj);\n```\n\nå‡½æ•°å®ç°\n\n```c\n/* Delete an element with matching score/object from the skiplist. */\nint zslDelete(zskiplist *zsl, double score, robj *obj) {\n    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;\n    int i;\n\n    x = zsl->header;\n    for (i = zsl->level-1; i >= 0; i--) {\n        while (x->level[i].forward &&\n            (x->level[i].forward->score < score ||\n                (x->level[i].forward->score == score &&\n                compareStringObjects(x->level[i].forward->obj,obj) < 0)))\n            x = x->level[i].forward;\n        update[i] = x;\n    }\n    /* We may have multiple elements with the same score, what we need\n     * is to find the element with both the right score and object. */\n    x = x->level[0].forward;\n    if (x && score == x->score && equalStringObjects(x->obj,obj)) {\n        zslDeleteNode(zsl, x, update);\n        zslFreeNode(x);\n        return 1;\n    }\n    return 0; /* not found */\n}\n```\n\n\n\n\n\n## å‚è€ƒèµ„æ–™\n\n>-   ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹â€”â€” ç¬¬5ç« ï¼šè·³è·ƒè¡¨\n>-   [huangzworks/redis-3.0-annotated: å¸¦æœ‰è¯¦ç»†æ³¨é‡Šçš„ Redis 3.0 ä»£ç ï¼ˆannotated Redis 3.0 source codeï¼‰ã€‚ (github.com)](https://github.com/huangzworks/redis-3.0-annotated)\n\n","tags":["æ•°æ®ç»“æ„","è·³è¡¨","Redis"],"categories":["æ•°æ®ç»“æ„","è·³è¡¨"]},{"title":"è·³è¡¨-å®ç°ç¯‡ï¼ˆGolangï¼‰","url":"/posts/b1617a14/","content":"\n## ç®€ä»‹\n\næœ¬æ–‡å°†å‚ç…§è®ºæ–‡ä½¿ç”¨Golangè¯­è¨€å®ç°è·³è¡¨\n\nå»ºè®®é˜…è¯»ï¼š[è·³è¡¨-åŸç†ç¯‡ | Crayonã®åšå®¢](/posts/2e152a56/)\n\næœ¬æ–‡æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š\n\n- [ç®€ä»‹](#ç®€ä»‹)\n- [ç¼–ç å®ç°](#ç¼–ç å®ç°)\n\t- [ç»“æ„ä½“å®šä¹‰](#ç»“æ„ä½“å®šä¹‰)\n\t- [éšæœºå‡½æ•°](#éšæœºå‡½æ•°)\n\t- [æŸ¥æ‰¾](#æŸ¥æ‰¾)\n\t- [æ’å…¥](#æ’å…¥)\n\t- [åˆ é™¤](#åˆ é™¤)\n- [ä»£ç æµ‹è¯•](#ä»£ç æµ‹è¯•)\n\t- [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)\n\t\t- [æ•°æ®é‡1k](#æ•°æ®é‡1k)\n\t\t- [æ•°æ®é‡1w](#æ•°æ®é‡1w)\n\t\t- [æ•°æ®é‡10w](#æ•°æ®é‡10w)\n- [Leetcode](#leetcode)\n\n## ç¼–ç å®ç°\n\næœ¬æ¬¡å®ç°å’Œè®ºæ–‡ä¸€æ ·ï¼ŒèŠ‚ç‚¹é¡ºåºä»¥å‡åºæ’åº\n\n### ç»“æ„ä½“å®šä¹‰\n\n```go\ntype (\n\tNode struct {\n\t\tKey      float64\n\t\tValue    interface{}\n\t\tForwards []*Node\n\t}\n\n\tSkipList struct {\n\t\tHead     *Node\n\t\tLevel    int\n\t\t// MaxLevel è·³è¡¨çš„æœ€å¤§å±‚çº§ï¼Œè¿™æ ·å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°ä¸åŒæœ€é«˜å±‚çº§çš„è·³è¡¨\n\t\tMaxLevel int\n\t\t// P å±‚çº§ä¸Šå‡çš„æ¦‚ç‡\n\t\tP        float64\n\t}\n)\n```\n\n### éšæœºå‡½æ•°\n\nå’Œè®ºæ–‡å¦‚å‡ºä¸€è¾™ï¼Œè¿™é‡Œä½¿ç”¨äº†golangçš„randåŒ…æ¥ç”Ÿæˆéšæœºæ•°\n\n```go\nfunc (s *SkipList) randomLevel() int {\n\tlevel := 1\n\tfor level < s.MaxLevel && rand.Float64() < s.P {\n\t\tlevel += 1\n\t}\n\treturn level\n}\n```\n\n### æŸ¥æ‰¾\n\n```go\nfunc (s *SkipList) Search(key float64) (interface{}, bool) {\n    // ä»å¤´èŠ‚ç‚¹å‡ºå‘\n\tx := s.Head\n    // å¤–å±‚å¾ªç¯ï¼Œæ§åˆ¶ä»ä¸Šåˆ°ä¸‹çš„å±‚çº§æœç´¢\n\tfor i := s.Level - 1; i >= 0; i-- {\n        // å†…å±‚å¾ªç¯ï¼Œæ§åˆ¶ä»å·¦åˆ°å³çš„å‰è¿›æœç´¢\n\t\tfor x.Forwards[i] != nil && x.Forwards[i].Key < key {\n\t\t\tx = x.Forwards[i]\n\t\t}\n\t}\n    // ä¸€ç›´æœç´¢åˆ°æœ€åä¸€å±‚ï¼Œä¸å°äºç›®æ ‡keyçš„å‰ä¸€ä¸ªèŠ‚ç‚¹\n    // è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå› ä¸ºé‡åˆ°NILä¼šæå‰è¿”å›ï¼Œä¸ä¼šè¿”å›NILï¼Œæ‰€ä»¥å¯ä»¥ä¸ç”¨åˆ¤ç©ºï¼‰\n\tx = x.Forwards[0]\n\tif x == nil || x.Key != key {\n\t\treturn nil, false\n\t}\n\treturn x.Value, true\n}\n```\n\n### æ’å…¥\n\næ’å…¥æ“ä½œå’Œsearchæ“ä½œç±»ä¼¼ï¼Œåªæ˜¯åœ¨æ‰¾åˆ°æ’å…¥ä½ç½®åï¼Œéœ€è¦å°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°å„å±‚çš„å‰é¢\n\nè€Œè®ºæ–‡ä¸­çš„ä¼ªä»£ç å¯ä»¥å‘ç°ï¼Œå…¶å®éå†èŠ‚ç‚¹çš„é€»è¾‘æ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯å¤šäº†ä¸€æ­¥è®°å½•å„å±‚èŠ‚ç‚¹çš„æ“ä½œï¼ˆéœ€è¦è®°å½•ä¸‹å½“å‰èŠ‚ç‚¹åœ¨å„å±‚çš„å‰é©±èŠ‚ç‚¹ï¼Œåç»­æ’å…¥æ—¶æ‰èƒ½åŒæ­¥æ›´æ–°ï¼‰\n\nå¹¶ä¸”åœ¨åˆ é™¤æ“ä½œæˆ‘ä»¬ä¹Ÿéœ€è¦è¿›è¡Œéå†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠéå†çš„ä»£ç å°è£…èµ·æ¥\n\n```go\nfunc (s *SkipList) findPrev(key float64) (x *Node, update []*Node) {\n\tupdate = make([]*Node, s.MaxLevel)\n\tx = s.Head\n\tfor i := s.Level - 1; i >= 0; i-- {\n\t\tfor x.Forwards[i] != nil && x.Forwards[i].Key < key {\n\t\t\tx = x.Forwards[i]\n\t\t}\n\t\tupdate[i] = x\n\t}\n\treturn\n}\n```\n\n**æ’å…¥å‡½æ•°**\n\n```go\nfunc (s *SkipList) Insert(key float64, value interface{}) {\n\tx, update := s.findPrev(key)\n\tx = x.Forwards[0]\n\tif x != nil && x.Key == key {\n\t\tx.Value = value\n\t\treturn\n\t}\n\n\tlevel := s.randomLevel()\n\tif level > s.Level {\n\t\tfor i := s.Level; i < level; i++ {\n\t\t\tupdate[i] = s.Head\n\t\t}\n\t\ts.Level = level\n\t}\n\n\tx = makeNode(key, value, level)\n\tfor i := 0; i < level; i++ {\n\t\tx.Forwards[i] = update[i].Forwards[i]\n\t\tupdate[i].Forwards[i] = x\n\t}\n}\n```\n\n**æŸ¥æ‰¾å‡½æ•°**\n\nä¸è¦å¿˜è®°æ›´æ–°ä¸‹æŸ¥æ‰¾å‡½æ•°çš„ä»£ç \n\n```go\nfunc (s *SkipList) Search(key float64) (interface{}, bool) {\n\tx, _ := s.findPrev(key)\n\tx = x.Forwards[0]\n\tif x == nil || x.Key != key {\n\t\treturn nil, false\n\t}\n\treturn x.Value, true\n}\n```\n\n### åˆ é™¤\n\nåˆ é™¤æ“ä½œå’Œæ’å…¥æ“ä½œç±»ä¼¼ï¼Œåªæ˜¯åœ¨æ‰¾åˆ°åˆ é™¤èŠ‚ç‚¹åï¼Œéœ€è¦å°†å„å±‚èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ›´æ–°ï¼Œç„¶ååˆ é™¤èŠ‚ç‚¹\n\n```go\nfunc (s *SkipList) Delete(key float64) bool {\n\tx, update := s.findPrev(key)\n\tx = x.Forwards[0]\n\tif x == nil || x.Key != key {\n\t\treturn false\n\t}\n\n\tfor i := 0; i < s.Level; i++ {\n\t\tif update[i].Forwards[i] != x {\n\t\t\tbreak\n\t\t}\n\t\tupdate[i].Forwards[i] = x.Forwards[i]\n\t}\n\n\tfor i := s.Level - 1; i >= 0; i-- {\n\t\tif s.Head.Forwards[i] != nil {\n\t\t\tbreak\n\t\t}\n\t\ts.Level--\n\t}\n\n\treturn true\n}\n```\n\n## ä»£ç æµ‹è¯•\n\nç”±äºè·³è¡¨å­˜åœ¨éšæœºçš„å› ç´ ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡å¤šæ¬¡çš„è¿è¡Œæ¥æµ‹è¯•è·³è¡¨çš„æ­£ç¡®æ€§\n\n![1737798614731](è·³è¡¨-å®ç°ç¯‡ï¼ˆGolangï¼‰.assets/1737798614731.png)\n\né€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šæ‰§è¡Œçš„æ“ä½œ\n\né…ç½®æ–‡ä»¶æ ·ä¾‹\n\n```yaml\n# æ‰¹é‡æ’å…¥0-9999çš„kv\n# otï¼ˆoperation typeï¼‰ï¼šæ“ä½œç±»å‹\n- ot: insert_range\n  # inputï¼šè¾“å…¥å‚æ•°\n  input:\n    # æœ€ç»ˆæ’å…¥çš„æ•°æ®èŒƒå›´ï¼š0-9999\n    # range_startï¼šèŒƒå›´èµ·ç‚¹\n    range_start: 0\n\t# range_endï¼šèŒƒå›´ç»ˆç‚¹\n    range_end: 10000\n# k=-1ï¼Œä¸å­˜åœ¨\n- ot: search\n  input:\n    key: -1\n  output:\n    ok: false\n# k=3377ï¼Œå­˜åœ¨ä¸”v=3377\n- ot: search\n  input:\n    key: 3377\n  output:\n    ok: true\n    value: 3377\n```\n\nå…·ä½“çš„æµ‹è¯•ä»£ç å¯ä»¥æŸ¥çœ‹\n[demo-bucket/algorithm/algorithm-golang/skiplist/skiplist_test.go at master Â· SuCrayon/demo-bucket](https://github.com/SuCrayon/demo-bucket/blob/master/algorithm/algorithm-golang/skiplist/skiplist_test.go)\n\n### æ€§èƒ½å¯¹æ¯”\n\né€šè¿‡è®¾ç½®å±‚çº§ä¸º1æˆ‘ä»¬å¯ä»¥ç”¨åŒæ ·çš„ä»£ç æ¨¡æ‹Ÿæœ‰åºå•é“¾è¡¨ï¼ˆä¹Ÿå°±æ˜¯BSTé€€åŒ–æˆé“¾è¡¨çš„é‚£ç§æƒ…å†µï¼‰çš„æŸ¥æ‰¾æ€§èƒ½\n\n\n\n{% note info %}\n\nä»¥ä¸‹æµ‹è¯•ä½¿ç”¨çš„benchmarkå‚æ•°\n\n```bash\n-test.benchmem -test.benchtime=5s\n```\n\n{% endnote %}\n\n\n\n#### æ•°æ®é‡1k\n\n**è·³è¡¨ï¼ˆMaxLevel=16ï¼ŒP=0.5ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n34254062,179.8,384,3\n```\n\n\n\n**è·³è¡¨ï¼ˆMaxLevel=32ï¼ŒP=0.25ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n29570007,215.7,768,3\n```\n\n\n\n**è·³è¡¨ï¼ˆMaxLevel=32ï¼ŒP=0.5ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n24861520,237.4,768,3\n```\n\n\n\n**å•é“¾è¡¨ï¼ˆMaxLevel=1ï¼ŒP=0ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n786034,7536,24,3\n```\n\n\n\n#### æ•°æ®é‡1w\n\n**è·³è¡¨ï¼ˆMaxLevel=16ï¼ŒP=0.5ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n25082064,292.0,384,3\n21268509,252.2,384,3\n19541179,270.8,384,3\n24443103,234.1,384,3\n23645776,236.2,384,3\n```\n\n**è·³è¡¨ï¼ˆMaxLevel=32ï¼ŒP=0.25ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n15089992,403.9,768,3\n18066450,392.1,768,3\n16331352,439.7,768,3\n```\n\n**è·³è¡¨ï¼ˆMaxLevel=32ï¼ŒP=0.5ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n15095322,430.9,768,3\n```\n\n**å•é“¾è¡¨ï¼ˆMaxLevel=1ï¼ŒP=0ï¼‰**\n\n```csv\nopCount,nsPerOp,bytePerOp,allocPerOp\n36655,166034,24,3\n```\n\n\n\n\n\n#### æ•°æ®é‡10w\n\n**å•é“¾è¡¨ï¼ˆMaxLevel=1ï¼ŒP=0ï¼‰**\n\n![1737800600781](è·³è¡¨-å®ç°ç¯‡ï¼ˆGolangï¼‰.assets/1737800600781.png)\n\nå¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªæ•°æ®é‡ä¸‹çš„æ“ä½œéå¸¸åœ°æ…¢\n\n\n\n**è·³è¡¨ï¼ˆMaxLevel=32ï¼ŒP=0.5ï¼‰**\n\n![1737800664852](è·³è¡¨-å®ç°ç¯‡ï¼ˆGolangï¼‰.assets/1737800664852.png)\n\nè€Œè·³è¡¨åˆ™å’Œ**1w**æ•°æ®é‡æ—¶ä¸€æ ·ï¼Œæ²¡æœ‰æ˜æ˜¾åœ°æ€§èƒ½ä¸‹é™\n\n\n\nå…·ä½“çš„æµ‹è¯•ä»£ç å¯ä»¥æŸ¥çœ‹\n[demo-bucket/algorithm/algorithm-golang/skiplist/benchmark_test.go at master Â· SuCrayon/demo-bucket](https://github.com/SuCrayon/demo-bucket/blob/master/algorithm/algorithm-golang/skiplist/benchmark_test.go)\n\n\n\n## Leetcode\n\næ­£å¥½`Leetcode`ä¸Šå°±æœ‰ä¸€é“æ‰‹å†™è·³è¡¨çš„é¢˜ç›®\n\nç¨å¾®æ”¹é€ ä¸‹ä»£ç å®ç°å³å¯æäº¤æµ‹è¯•äº†\n\né¢˜ç›®é“¾æ¥ï¼š[1206. è®¾è®¡è·³è¡¨ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰](https://leetcode.cn/problems/design-skiplist/description/)\n\n![1737801773560](è·³è¡¨-å®ç°ç¯‡ï¼ˆGolangï¼‰.assets/1737801773560.png)\n\n\n\n\n\n","tags":["æ•°æ®ç»“æ„","è·³è¡¨","Golang"],"categories":["æ•°æ®ç»“æ„","è·³è¡¨"]},{"title":"è·³è¡¨-åŸç†ç¯‡","url":"/posts/2e152a56/","content":"\n\n## ä»€ä¹ˆæ˜¯è·³è¡¨\n\nè·³è¡¨ï¼ˆä¹Ÿå¯ä»¥å«è·³è·ƒè¡¨ï¼Œè‹±æ–‡åï¼š*Skip List*ï¼‰æ˜¯ç”±*William Pugh*å‘æ˜çš„ä¸€ç§æŸ¥æ‰¾æ•°æ®ç»“æ„ï¼Œæ”¯æŒå¯¹æ•°æ®çš„å¿«é€ŸæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤\n\nOI Wikiï¼š[è·³è¡¨ - OI Wiki](https://oi-wiki.org/ds/skiplist/)\n\nè®ºæ–‡åœ°å€ï¼š[skiplists](https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990.pdf)\n\nè®ºæ–‡å¼€ç¯‡å°±è¯´æ˜äº†è¿™æ˜¯ä¸€ç§å¯ä»¥ç”¨æ¥ä»£æ›¿å¹³è¡¡æ ‘çš„æ•°æ®ç»“æ„ï¼ˆå¹³è¡¡æ ‘çš„å®ç°å®åœ¨æ˜¯å¤ªå¤æ‚äº†ğŸ˜©ï¼‰\n\nä¸å¹³è¡¡æ ‘ç›¸æ¯”ï¼Œè·³è¡¨çš„æ’å…¥å’Œåˆ é™¤ç®—æ³•è¦ç®€å•å¾—å¤š\n\n\n\n### BSTå­˜åœ¨çš„é—®é¢˜\n\n>   Binary trees can be used for representing abstract data types such as dictionaries and ordered lists. They work well when the elements are inserted in a random order. Some sequences of operations, such as inserting the elements in order, produce degenerate data structures that give very poor performance. If it were possible to randomly permute the list of items to be in serted, trees would work well with high probability for any in put sequence. In most cases queries must be answered on-line, so randomly permuting the input is impractical. Balanced tree algorithms re-arrange the tree as operations are performed to maintain certain balance conditions and assure good perfor mance.\n\nè®ºæ–‡ä¸­æåˆ°ï¼Œå¯¹äºäºŒå‰æœç´¢æ ‘è€Œè¨€ï¼Œå½“æ’å…¥çš„æ•°æ®æ˜¯é¡ºåºçš„æ—¶å€™ï¼Œä¼šäº§ç”Ÿé€€åŒ–\n\näºŒå‰æœç´¢æ ‘ï¼ˆ`BST`ï¼Œ*Binary Search Tree*ï¼‰ï¼Œæ˜¯ä¸€ç§å…·æœ‰ç‰¹æ®Šæ’åºæ€§è´¨çš„äºŒå‰æ ‘ï¼Œé€šè¿‡åœ¨æ’å…¥æ•°æ®æ—¶ä¿è¯é¡ºåºä»¥ä¾¿åç»­èƒ½å¿«é€Ÿæ£€ç´¢\n\nç†æƒ³æƒ…å†µä¸‹`BST`å‘ˆç°ç±»ä¼¼ä»¥ä¸‹çš„ç»“æ„ï¼Œèƒ½å¤Ÿè¾¾åˆ°ç±»ä¼¼äºŒåˆ†æŸ¥æ‰¾çš„æ•ˆæœ\n\n\n```mermaid\ngraph TD;\n    A[7] --> B[3];\n    A --> C[9];\n    B --> D[1];\n    B --> E[5];\n    E --> F[4];\n    E --> G[6];\n    C --> H[8];\n    C --> I[10];\n```\n\nä½†æ˜¯å½“æ’å…¥çš„æ•°æ®åºåˆ—å°±æ˜¯æœ‰åºçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°é€€åŒ–æˆé“¾è¡¨çš„æƒ…å†µ\n\n\n```mermaid\ngraph TD;\n    A[2] --> B[1];\n    A --> C[3];\n    C --> D[4];\n    D --> E[5];\n    E --> F[6];\n```\n\n[äºŒå‰æœç´¢æ ‘å¯è§†åŒ–](https://gallery.selfboot.cn/zh/algorithms/binarysearchtree)\n\n\n\nå…³äºé€€åŒ–çš„é—®é¢˜ä¹Ÿå¯ä»¥çœ‹çœ‹å°ç°çš„æ¼«ç”»è®²è§£\n\n[æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯è·³è·ƒè¡¨ï¼Ÿ](https://mp.weixin.qq.com/s?__biz=MzIxMjE5MTE1Nw==&mid=2653190879&idx=1&sn=1916d0f6e72f34408261d70d13eecf5b&chksm=8c990805bbee81137dd6cadbe7b69cf84020233385cc5d7cee778d10977b6f9b28ea235b93e0&scene=21#wechat_redirect)\n\n\n\n## è·³è¡¨çš„ç»“æ„\n\né’ˆå¯¹`BST`ä¼šé€€åŒ–æˆé“¾è¡¨çš„é—®é¢˜ï¼Œæˆ–è€…è¯´é’ˆå¯¹é“¾è¡¨æˆ‘ä»¬æƒ³è¦æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾çš„æ€æƒ³æˆ‘ä»¬å¯ä»¥å»ºç«‹å¤šçº§ç´¢å¼•çš„æ¦‚å¿µ\n\n![1737649458888](è·³è¡¨-åŸç†ç¯‡.assets/1737649458888.png)\n\nåŸè®ºæ–‡ä¸­å°±æœ‰æåˆ°åƒ`AVL`ç­‰å¼ºåˆ¶å¹³è¡¡ï¼ˆç»“æ„å®šä¹‰æ¯”è¾ƒå¤æ‚ï¼Œæ¯æ¬¡æ“ä½œéƒ½è¦ä¿è¯ç»“æ„çš„æ­£ç¡®æ€§ï¼‰ï¼Œå¯¼è‡´å¯èƒ½æœ€ç»ˆçš„æ€§èƒ½å¾ˆå¥½ï¼Œä½†æ˜¯ä»£ç çš„å®ç°éš¾åº¦å¯èƒ½ç›´æ¥å¯¼è‡´å…¶ä»–äººæ— æ³•ç»´æŠ¤å’Œæ‰©å±•\n\nè®ºæ–‡åŸæ–‡æ˜¯è¿™ä¹ˆæè¿°çš„ï¼š\n\n> Second, if the algorithm is complex, programmers are de terred from implementing optimizations. For example, bal anced tree algorithms are normally described using recursive insert and delete procedures, since that is the most simple and intuitive method of describing the algorithms. A recursive in sert or delete procedure incurs a procedure call overhead. By using non-recursive insert and delete procedures, some of this overhead can be eliminated. However, the complexity of non recursive algorithms for insertion and deletion in a balanced tree is intimidating and this complexity deters most program mers from eliminating recursion in these routines.\n>\n>   ...\n>\n> From a theoretical point of view, there is no need for skip lists. Balanced trees can do everything that can be done with skip lists and have good worst-case time bounds (unlike skip lists). However, implementing balanced trees is an exacting task and as a result balanced tree algorithms are rarely imple mented except as part of a programming assignment in a data structures class. Skip lists are a simple data structure that can be used in place of balanced trees for most applications. Skip lists algo rithms are very easy to implement, extend and modify. Skip lists are about as fast as highly optimized balanced tree algo rithms and are substantially faster than casually implemented balanced tree algorithms.\n\n\n\nè·³è¡¨è®¾è®¡ä¸Šçš„ä¸€ä¸ªå·§å¦™çš„ç‚¹å°±åœ¨äºä¸å¼ºåˆ¶ç»´æŠ¤ç´¢å¼•å±‚çº§ï¼ˆå°±æ˜¯è¿™ä¸ªè®¾è®¡æ—¢å…¼é¡¾äº†æ€§èƒ½ä¹Ÿç®€åŒ–äº†ä»£ç å®ç°ï¼‰\n\næ’å…¥èŠ‚ç‚¹çš„æ—¶å€™éšæœºç”Ÿæˆç´¢å¼•å±‚çº§æ•°\n\n### Initializationï¼ˆåˆå§‹åŒ–ï¼‰\n\n>   An element NIL is allocated and given a key greater than any legal key. All levels of all skip lists are terminated with NIL. A new list is initialized so that the the level of the list is equal to 1 and all forward pointers of the listâ€™s header point to NIL.\n\n![1737706482282](è·³è¡¨-åŸç†ç¯‡.assets/1737706482282.png)\n\nåˆ†é…ä¸€ä¸ª`NIL`èŠ‚ç‚¹ï¼ˆè¿™ä¸ªèŠ‚ç‚¹çš„é”®å¤§äºä»»ä½•å…ƒç´ ï¼‰ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹çš„æ‰€æœ‰çº§åˆ«çš„æŒ‡é’ˆæœ€ç»ˆéƒ½ä»¥`NIL`ä¸ºç»ˆç‚¹\n\n### Searchï¼ˆæŸ¥æ‰¾ï¼‰\n\né€šè¿‡éå†å‰è¿›æŒ‡é’ˆæ¥æœç´¢å…ƒç´ \n\n{% note warning %}\n\næ³¨æ„ï¼šéå†æ—¶ä¸ä¼šè¶Šè¿‡æ­£åœ¨æœç´¢çš„å…ƒç´ çš„èŠ‚ç‚¹ï¼Œå½“å½“å‰å±‚çº§æ— æ³•æ‰¾åˆ°æŒ‡å®šå…ƒç´ æ—¶ï¼Œéœ€è¦å‘ä¸‹ä¸€å±‚çº§æœç´¢\n\n{% endnote %}\n\n#### ç®—æ³•ä¼ªä»£ç \n\n![1737706994096](è·³è¡¨-åŸç†ç¯‡.assets/1737706994096.png)\n\n```plaintext\nfor i := list->level downto 1 do\n\t// ç¬¬ä¸€å±‚å¾ªç¯ï¼Œä»ä¸Šåˆ°ä¸‹çš„å±‚çº§éå†\n\twhile x->forward[i]->key < searchKey do\n\t\t// ç¬¬äºŒå±‚å¾ªç¯ï¼Œä»å·¦åˆ°å³éå†ï¼Œåªæœ‰èŠ‚ç‚¹å°äºsearchKeyæ‰èƒ½å‰è¿›ï¼ˆå› ä¸ºæ˜¯ä»ä¸Šåˆ°ä¸‹éå†ï¼ŒèŠ‚ç‚¹å°äºè¯´æ˜searchKeyå¯¹åº”çš„èŠ‚ç‚¹ä¸€å®šåœ¨è¯¥èŠ‚ç‚¹ ä¹‹åï¼Œæ‰€ä»¥å¯ä»¥å‰è¿›ï¼‰\n\t\tx := x->forward[i]\n\n```\n\n#### é€æ­¥è§£æ\n\nä»¥æœç´¢12èŠ‚ç‚¹ä¸ºä¾‹å­\n\n![1737708513748](è·³è¡¨-åŸç†ç¯‡.assets/1737708513748.png)\n\n{% note info %}\n**ç¬¦å·è¯´æ˜**\n`NIL`ï¼šç»ˆç‚¹ï¼ˆè¡¨ç¤ºæ— ç©·å¤§ï¼Œæœç´¢åˆ°è¿™ä¸ªèŠ‚ç‚¹è¡¨ç¤ºå¿…é¡»å‘ä¸‹æœç´¢ï¼Œå³æœ¬å±‚éå†ç»“æŸï¼‰\n`HEAD`ï¼šå¤´èŠ‚ç‚¹\n`x`ï¼šå½“å‰èŠ‚ç‚¹\n`x.forward[i]`ï¼šè¡¨ç¤ºxçš„ç¬¬i+1å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆi+1å±‚çš„å‰è¿›æŒ‡é’ˆï¼‰\n`x.forward[i].key`ï¼šè¡¨ç¤ºxçš„ç¬¬i+1å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„key\n{% endnote %}\n\n0.  åˆå§‹åŒ–`x=HEAD`\n\n1.  `x.forward[3].key`ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ã€6ã€‘ï¼‰ï¼Œ6å°äº12ï¼Œ`x = x.forward[3]`ï¼ˆå‰è¿›ï¼‰\n2.  `x.forward[3].key`ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ã€`NIL`ã€‘ï¼‰ï¼Œ`NIL`è¡¨ç¤ºç»ˆç‚¹ï¼ˆæ— ç©·å¤§ï¼‰ï¼Œ`i--`ï¼ˆå‘ä¸‹æœç´¢ï¼‰\n3.  `x.forward[2].key`ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ã€25ã€‘ï¼‰ï¼Œ25å¤§äº12ï¼Œ`i--`ï¼ˆå‘ä¸‹æœç´¢ï¼‰\n4.  `x.forward[1].key`ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ã€9ã€‘ï¼‰ï¼Œ9å°äº12ï¼Œ`x = x.forward[1]`ï¼ˆå‰è¿›ï¼‰\n5.  `x.forward[1].key`ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ã€25ã€‘ï¼‰ï¼Œ25å¤§äº12ï¼Œ`i--`ï¼ˆå‘ä¸‹æœç´¢ï¼‰\n6.  `x.forward[0].key`ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ã€12ã€‘ï¼‰ï¼Œ12ç­‰äº12ï¼Œ`i--`ï¼ˆå‘ä¸‹æœç´¢ï¼‰\n7.  `i<0`è¡¨ç¤ºæ²¡æœ‰åœ¨ä¸‹ä¸€å±‚äº†ï¼Œéå†ï¼ˆå¾ªç¯ï¼‰ç»“æŸï¼Œ`x`åœç•™åœ¨èŠ‚ç‚¹ã€12ã€‘çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆä¹Ÿå°±æ˜¯èŠ‚ç‚¹ã€9ã€‘ï¼‰\n8.  `x.forward[0].key`æ˜¯å¦ç­‰äº12ï¼Œå¦‚æœæ˜¯åˆ™è¯´æ˜æ‰¾åˆ°ç›®æ ‡ï¼Œä¸æ˜¯åˆ™è¡¨ç¤ºç›®æ ‡ä¸åœ¨è·³è¡¨å†…\n\n\n\nå¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªéå†çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªæ‰¾å‰é©±èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œæ‰¾åˆ°ç­‰äºç›®æ ‡å€¼çš„èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹\n\n### éšæœºå‡½æ•°ï¼ˆRandom Levelï¼‰\n\nè·³è¡¨ä½¿ç”¨éšæœºçš„æ–¹å¼æ¥ç”Ÿæˆæ–°èŠ‚ç‚¹çš„å±‚é«˜\n\n![1737712483120](è·³è¡¨-åŸç†ç¯‡.assets/1737712483120.png)\n\n### Insertionï¼ˆæ’å…¥ï¼‰\n\nç†è§£äº†æœç´¢çš„è¿‡ç¨‹ï¼Œæ’å…¥æ“ä½œä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæœ¬è´¨å°±æ˜¯æ‰¾åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹å¹¶å°†å€¼æ’å…¥çš„è¿‡ç¨‹ï¼ˆä¸ç†Ÿæ‚‰çš„å»ºè®®å¤ä¹ ä¸‹é“¾è¡¨çš„æ’å…¥æ“ä½œğŸ˜ï¼‰\n\n#### ç®—æ³•ä¼ªä»£ç \n\nå…ˆä¸Šè®ºæ–‡çš„ä¼ªä»£ç \n\n![1737709368360](è·³è¡¨-åŸç†ç¯‡.assets/1737709368360.png)\n\n```plaintext\nInsert(list, searchKey, newValue)\n\tlocal update[1...MaxLevel]\n\tx := list->header\n\t// è¿™ä¸€æ­¥å’Œæœç´¢çš„ä»£ç ä¸€æ ·ï¼Œæ‰¾åˆ°å‰é©±èŠ‚ç‚¹\n\tfor i := list->level downto 1 do\n\t\twhile x->forward[i].key < searchKey do\n\t\t\tx := x->forward[i]\n\t\t-- x->key < searchKey <= x->forward[i]->key\n\t\t// è®°å½•äº†éå†è·¯å¾„ä¸­æ¯å±‚çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹\n\t\tupdate[i] := x\n\tx := x->forward[i]\n\t// å¦‚æœç›¸åŒåˆ™ç›´æ¥æ›´æ–°å€¼\n\tif x->key = searchKey then x->value := newValue\n\telse\n\t\t// éšæœºç”Ÿæˆæ–°èŠ‚ç‚¹çš„å±‚çº§\n\t\t|v| := randomLevel()\n\t\t// å¦‚æœæ–°èŠ‚ç‚¹çš„å±‚çº§å¤§äºå½“å‰è·³è¡¨çš„æœ€é«˜å±‚çº§\n\t\t// è®°å½•ç›¸åº”çš„ä¿¡æ¯æ–¹ä¾¿åé¢ç»Ÿä¸€æ›´æ–°èŠ‚ç‚¹\n\t\t// è¿˜è¦æ›´æ–°å½“å‰è·³è¡¨çš„æœ€é«˜å±‚çº§\n\t\tif |v| > list->level then\n\t\t\tfor i := list->level+1 to |v| do\n\t\t\t\tupdate[i] := list->header\n\t\t\tlist->level := |v|\n\t\tx := makeNode(|v|, searchKey, value)\n\t\t// å’Œå¸¸è§„çš„é“¾è¡¨æ’å…¥æ“ä½œç±»ä¼¼\n\t\t// 1. æ–°èŠ‚ç‚¹è¿æ¥å‰é©±èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹\n\t\t// 2. å‰é©±èŠ‚ç‚¹åœ¨è¿æ¥æ–°èŠ‚ç‚¹\n\t\tfor i := 1 to level do\n\t\t\tx->forward[i] := update[i]->forward[i]\n\t\t\tupdate[i]->forward[i] := x\n```\n\n#### é€æ­¥è§£æ\n\nä»¥ä¸‹æ˜¯è®ºæ–‡ä¸­å…³äºæ’å…¥èŠ‚ç‚¹ã€17ã€‘çš„ç¤ºæ„å›¾\n\n![1737706980365](è·³è¡¨-åŸç†ç¯‡.assets/1737706980365.png)\n\nå¯¹ç€è®ºæ–‡çš„ç¤ºæ„å›¾æˆ‘ä»¬é€æ­¥åˆ†æä»£ç çš„æ‰§è¡Œè¿‡ç¨‹\n\n{% note info %}\n**ç¬¦å·è¯´æ˜**\n`NIL`ï¼šç»ˆç‚¹ï¼ˆè¡¨ç¤ºæ— ç©·å¤§ï¼Œæœç´¢åˆ°è¿™ä¸ªèŠ‚ç‚¹è¡¨ç¤ºå¿…é¡»å‘ä¸‹æœç´¢ï¼Œå³æœ¬å±‚éå†ç»“æŸï¼‰\n`HEAD`ï¼šå¤´èŠ‚ç‚¹\n`x`ï¼šå½“å‰èŠ‚ç‚¹\n`x.forward[i]`ï¼šè¡¨ç¤ºxçš„ç¬¬i+1å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆi+1å±‚çš„å‰è¿›æŒ‡é’ˆï¼‰\n`x.forward[i].key`ï¼šè¡¨ç¤ºxçš„ç¬¬i+1å±‚çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„key\n`update`ï¼šupdateæ•°ç»„ï¼Œè®°å½•äº†éå†è¿‡ç¨‹ä¸­æ¯ä¸€å±‚çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆä»å“ªä¸ªèŠ‚ç‚¹å¾€ä¸‹éå†çš„ï¼Œè¿™äº›èŠ‚ç‚¹æ˜¯éœ€è¦åŒæ­¥æ›´æ–°çš„ï¼‰\n{% endnote %}\n\n\n\n0.  åˆå§‹åŒ–`x=HEAD`ï¼Œåˆå§‹åŒ–`updateæ•°ç»„`ï¼ˆç›´æ¥åˆå§‹åŒ–æœ€å¤§çš„å±‚çº§æ•°çš„å¤§å°ï¼Œåç»­ä¸ç”¨åŠ¨æ€æ‰©ç¼©ï¼‰\n\néå†è¿‡ç¨‹ä¸­ä¸æœç´¢çš„ä¸€æ ·ï¼Œåªæ˜¯åœ¨å‘ä¸‹æœç´¢ä¹‹å‰å°†èŠ‚ç‚¹è®°å½•åˆ°`update`\n\n##### |V| \\<= list->level\n\n**æ–°èŠ‚ç‚¹å±‚çº§ä¸è¶…è¿‡å½“å‰è·³è¡¨çš„æœ€é«˜å±‚çº§**\n\nè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦æ›´æ–°æ–°èŠ‚ç‚¹å¯¹åº”çš„å±‚çº§ä¸Šçš„å‰é©±èŠ‚ç‚¹å³å¯\n\n![insert-case1](è·³è¡¨-åŸç†ç¯‡.assets/insert-case1.svg)\n\n\n\n##### |V| \\> list->level\n\n**æ–°èŠ‚ç‚¹å±‚çº§è¶…è¿‡å½“å‰è·³è¡¨çš„æœ€é«˜å±‚çº§**\n\néå†è¿‡ç¨‹ä¸­ç”±äºå¹¶ä¸ç»è¿‡`HEAD`æ‰€ä»¥`update`ä¸­ä¸ä¼šæœ‰è®°å½•ï¼Œè€Œå½“æ–°èŠ‚ç‚¹çš„å±‚çº§è¶…è¿‡å½“å‰è·³è¡¨æœ€é«˜å±‚çº§çš„æ—¶å€™åˆéœ€è¦æ›´æ–°`HEAD`çš„å‰è¿›æŒ‡é’ˆï¼Œä¸ºäº†åç»­æ“ä½œé€»è¾‘ç»Ÿä¸€ï¼Œå•ç‹¬æ‰§è¡Œä¸€éå¾ªç¯èµ‹å€¼ï¼Œè¿™å°±æ˜¯ä»¥ä¸‹ä»£ç çš„å«ä¹‰\n\n![1737712286704](è·³è¡¨-åŸç†ç¯‡.assets/1737712286704.png)\n\n\n\n![insert-case2](è·³è¡¨-åŸç†ç¯‡.assets/insert-case2.svg)\n\n\n\n### Deletionï¼ˆåˆ é™¤ï¼‰\n\n#### ç®—æ³•ä¼ªä»£ç \n\n![1737712378629](è·³è¡¨-åŸç†ç¯‡.assets/1737712378629.png)\n\n\n\n#### é€æ­¥è§£æ\n\nè·³è¡¨èŠ‚ç‚¹çš„åˆ é™¤ä¹Ÿéå¸¸çš„ç®€å•ï¼Œå’Œé“¾è¡¨çš„åˆ é™¤æ“ä½œç›¸åŒï¼Œåªæ˜¯å¤šäº†å¤šå±‚çº§èŠ‚ç‚¹çš„æ›´æ–°çš„æ“ä½œ\n\n1.  æœç´¢å‰é©±èŠ‚ç‚¹\n\n2.  æ›´æ–°æ‰€æœ‰ç›¸å…³å±‚çº§ï¼ˆ`update`ï¼‰çš„æŒ‡é’ˆï¼ˆæ–­å¼€ä¸è¢«åˆ é™¤èŠ‚ç‚¹çš„è¿æ¥ï¼‰\n\n    ```plaintext\n    ...\n    for i := 1 to list->level do\n    \t// åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹è¿æ¥çš„ä¸æ˜¯è¢«åˆ é™¤èŠ‚ç‚¹ï¼Œé‚£å°±ä¸éœ€è¦æ›´æ–°ï¼Œå¯ä»¥æå‰ä¸­æ­¢å¾ªç¯\n    \tif update[i]->forward[i] != x then break\n    \tupdate[i]->forward[i] := x->forward[i]\n    // æ˜¾å¼é‡Šæ”¾\n    free(x)\n    ...\n    ```\n\n3.  ä»ä¸Šåˆ°ä¸‹æ›´æ–°`HEAD`æŒ‡é’ˆï¼Œè·³è¡¨å±‚çº§æ›´æ–°\n\n    ```plaintext\n    ...\n    // é€šè¿‡å¦ä¸€ä¸ªå¾ªç¯æ¥æ›´æ–°å½“å‰è·³è¡¨çš„æœ€é«˜å±‚çº§\n    // èŒè´£å•ä¸€ï¼ˆä¸€ä¸ªå¾ªç¯æ›´æ–°èŠ‚ç‚¹æŒ‡é’ˆï¼Œä¸€ä¸ªå¾ªç¯æ›´æ–°å±‚çº§æ•°ï¼‰ï¼Œä»£ç å¯è¯»æ€§æ›´å¥½\n    while list->level > 1 and\n    \tlist->header->forward[list->level] = NIL do\n    \tlist->level := list->level-1\n    ```\n\n\n\n## å‚è€ƒèµ„æ–™\n\n>   [è·³è¡¨å¯è§†åŒ–ï¼šhttps://gallery.selfboot.cn/zh/algorithms/skiplist](https://gallery.selfboot.cn/zh/algorithms/skiplist)\n>\n>   [è·³è¡¨è®ºæ–‡ï¼šhttps://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990.pdf](https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990.pdf)\n>\n>   [è·³è¡¨ - OI Wiki](https://oi-wiki.org/ds/skiplist/)\n>\n>   [æ¼«ç”»ï¼šä»€ä¹ˆæ˜¯è·³è·ƒè¡¨ï¼Ÿ](https://mp.weixin.qq.com/s?__biz=MzIxMjE5MTE1Nw==&mid=2653190879&idx=1&sn=1916d0f6e72f34408261d70d13eecf5b&chksm=8c990805bbee81137dd6cadbe7b69cf84020233385cc5d7cee778d10977b6f9b28ea235b93e0&scene=21#wechat_redirect)","tags":["æ•°æ®ç»“æ„","è·³è¡¨"],"categories":["æ•°æ®ç»“æ„","è·³è¡¨"]},{"title":"Redis-å­—å…¸","url":"/posts/eca128ac/","content":"\n\n## æ¦‚è¿°\n\n**å­—å…¸**ï¼Œåˆç§°ä¸ºç¬¦å·è¡¨ï¼ˆ*symbol table*ï¼‰ã€å…³è”æ•°ç»„ï¼ˆ*associative array*ï¼‰æˆ–æ˜ å°„ï¼ˆ*map*ï¼‰ï¼Œæ˜¯ä¸€ç§ç”¨äºä¿å­˜é”®å€¼å¯¹ï¼ˆ*key-value pair*ï¼‰çš„æŠ½è±¡æ•°æ®ç»“æ„\n\n\n\n> å’Œ{% label Java purple %} çš„`HashMap`ï¼Œ {% label Python green %} çš„`dict`ä»¥åŠ {% label Golang blue %} çš„`map`ç±»ä¼¼\n\n\n\n**å­—å…¸**åœ¨{% label Redis green %} ä¸­çš„åº”ç”¨ç›¸å½“å¹¿æ³›ï¼Œæ¯”å¦‚{% label Redis green %} çš„æ•°æ®åº“å°±æ˜¯ä½¿ç”¨**å­—å…¸**æ¥ä½œä¸ºåº•å±‚å®ç°çš„ï¼Œå¯¹æ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ“ä½œä¹Ÿæ˜¯æ„å»ºåœ¨å¯¹**å­—å…¸**çš„æ“ä½œä¹‹ä¸Šçš„\n\né™¤äº†ç”¨æ¥è¡¨ç¤ºæ•°æ®åº“ä¹‹å¤–ï¼Œ**å­—å…¸**è¿˜æ˜¯å“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå½“ä¸€ä¸ªå“ˆå¸Œé”®åŒ…å«çš„é”®å€¼å¯¹æ¯”è¾ƒå¤šï¼Œåˆæˆ–è€…é”®å€¼å¯¹ä¸­çš„å…ƒç´ éƒ½æ˜¯æ¯”è¾ƒé•¿çš„å­—ç¬¦ä¸²æ—¶ï¼Œ {% label Redis green %} å°±ä¼šä½¿ç”¨**å­—å…¸**ä½œä¸ºå“ˆå¸Œé”®çš„åº•å±‚å®ç°\n\n\n## å­—å…¸çš„å®ç°\n\n`Redis`çš„**å­—å…¸**ä½¿ç”¨*å“ˆå¸Œè¡¨*ä½œä¸ºåº•å±‚å®ç°ï¼Œä¸€ä¸ª*å“ˆå¸Œè¡¨*é‡Œé¢å¯ä»¥æœ‰å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œè€Œæ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å°±ä¿å­˜äº†**å­—å…¸**ä¸­çš„ä¸€ä¸ªé”®å€¼å¯¹\n\n### å“ˆå¸Œè¡¨\n\n`Redis`çš„**å­—å…¸**æ‰€ä½¿ç”¨çš„å“ˆå¸Œè¡¨ç”±`dict.h/dictht`ç»“æ„å®šä¹‰ï¼š\n\n```c\n\n/* This is our hash table structure. Every dictionary has two of this as we\n * implement incremental rehashing, for the old to the new table. */\n/*\n * å“ˆå¸Œè¡¨\n *\n * æ¯ä¸ªå­—å…¸éƒ½ä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œä»è€Œå®ç°æ¸è¿›å¼ rehash ã€‚\n */\ntypedef struct dictht {\n    \n    // å“ˆå¸Œè¡¨æ•°ç»„\n    dictEntry **table;\n\n    // å“ˆå¸Œè¡¨å¤§å°\n    unsigned long size;\n    \n    // å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼\n    // æ€»æ˜¯ç­‰äº size - 1\n    unsigned long sizemask;\n\n    // è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡\n    unsigned long used;\n\n} dictht;\n\n```\n\n\n{% note info %}\n\n- `table`å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘`dict.h/dictEntry`ç»“æ„çš„æŒ‡é’ˆï¼Œæ¯ä¸ª`dictEntry`ç»“æ„ä¿å­˜ç€ä¸€ä¸ªé”®å€¼å¯¹\n- `size`å±æ€§è®°å½•äº†å“ˆå¸Œè¡¨çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯`table`æ•°ç»„çš„å¤§å°\n- `used`å±æ€§è®°å½•äº†å“ˆå¸Œè¡¨ç›®å‰å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡\n- `sizemask`å±æ€§çš„å€¼æ€»æ˜¯ç­‰äº`size-1`ï¼Œè¿™ä¸ªå±æ€§å’Œå“ˆå¸Œå€¼ä¸€èµ·å†³å®šäº†ä¸€ä¸ªé”®åº”è¯¥è¢«æ”¾åˆ°`table`æ•°ç»„çš„å“ªä¸ªç´¢å¼•ä¸Šé¢\n\n{% endnote %}\n\n![1720094241571](å­—å…¸.assets/1720094241571.png)  \n\n### å“ˆå¸Œè¡¨èŠ‚ç‚¹\n\nå“ˆå¸Œè¡¨èŠ‚ç‚¹ä½¿ç”¨`dictEntry`ç»“æ„è¡¨ç¤ºï¼Œæ¯ä¸ª`dictEntry`ç»“æ„éƒ½ä¿å­˜ç€ä¸€ä¸ªé”®å€¼å¯¹\n\n```c\n\n/*\n * å“ˆå¸Œè¡¨èŠ‚ç‚¹\n */\ntypedef struct dictEntry {\n    \n    // é”®\n    void *key;\n\n    // å€¼\n    union {\n        void *val;\n        uint64_t u64;\n        int64_t s64;\n    } v;\n\n    // æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨\n    struct dictEntry *next;\n\n} dictEntry;\n\n```\n\n{% note info %}\n\n- `key`å±æ€§ä¿å­˜ç€é”®å€¼å¯¹ä¸­çš„é”®\n- `v`å±æ€§åˆ™ä¿å­˜ç€é”®å€¼å¯¹ä¸­çš„å€¼ï¼Œå…¶ä¸­é”®å€¼å¯¹çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª`uint64_t`æ•´æ•°åˆæˆ–è€…æ˜¯ä¸€ä¸ª`int64_t`æ•´æ•°\n- `next`å±æ€§æŒ‡å‘å¦ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå¯ä»¥å°†å¤šä¸ªå“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥æ­¤æ¥è§£å†³é”®å†²çªï¼ˆ*collision*ï¼‰çš„é—®é¢˜\n\n> ä»`next`æŒ‡é’ˆå¯ä»¥çŸ¥é“{% label Redis green %}ä½¿ç”¨çš„å°±æ˜¯æ‹‰é“¾æ³•è§£å†³å“ˆå¸Œå†²çªçš„\n\n{% endnote %}\n\n\n![1720094523892](å­—å…¸.assets/1720094523892.png)  \n\n### å­—å…¸\n\n`Redis`ä¸­çš„**å­—å…¸**ç”±`dict.h/dict`ç»“æ„è¡¨ç¤º\n\n```c\n\n/*\n * å­—å…¸\n */\ntypedef struct dict {\n\n    // ç±»å‹ç‰¹å®šå‡½æ•°\n    dictType *type;\n\n    // ç§æœ‰æ•°æ®\n    void *privdata;\n\n    // å“ˆå¸Œè¡¨\n    dictht ht[2];\n\n    // rehash ç´¢å¼•\n    // å½“ rehash ä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º -1\n    int rehashidx; /* rehashing not in progress if rehashidx == -1 */\n\n} dict;\n\n```\n\n{% note info %}\n\n- `type`å±æ€§å’Œ`privdata`å±æ€§æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œä¸ºåˆ›å»ºå¤šæ€å­—å…¸è€Œè®¾ç½®çš„\n  - `type`å±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘`dictType`ç»“æ„çš„æŒ‡é’ˆï¼Œæ¯ä¸ª`dictType`ç»“æ„ä¿å­˜äº†ä¸€ç»„ç”¨äºæ“ä½œç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼Œ`Redis`ä¼šä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•°\n  - `privdata`å±æ€§åˆ™ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•°\n\n`dict.h/dictType`\n\n{% hideBlock dictTypeå®šä¹‰,, %}\n\n```c\n\n/*\n * å­—å…¸ç±»å‹ç‰¹å®šå‡½æ•°\n */\ntypedef struct dictType {\n\n    // è®¡ç®—å“ˆå¸Œå€¼çš„å‡½æ•°\n    unsigned int (*hashFunction)(const void *key);\n\n    // å¤åˆ¶é”®çš„å‡½æ•°\n    void *(*keyDup)(void *privdata, const void *key);\n\n    // å¤åˆ¶å€¼çš„å‡½æ•°\n    void *(*valDup)(void *privdata, const void *obj);\n\n    // å¯¹æ¯”é”®çš„å‡½æ•°\n    int (*keyCompare)(void *privdata, const void *key1, const void *key2);\n\n    // é”€æ¯é”®çš„å‡½æ•°\n    void (*keyDestructor)(void *privdata, void *key);\n    \n    // é”€æ¯å€¼çš„å‡½æ•°\n    void (*valDestructor)(void *privdata, void *obj);\n\n} dictType;\n\n```\n\n{% endhideBlock %}\n\n- `ht`å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé¡¹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª`dictht`å“ˆå¸Œè¡¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå­—å…¸åªæ˜¯ç”¨`ht[0]`çš„å“ˆå¸Œè¡¨ï¼Œ`ht[1]`å“ˆå¸Œè¡¨åªä¼šåœ¨å¯¹`ht[0]`å“ˆå¸Œè¡¨è¿›è¡Œ*rehash*æ—¶ä½¿ç”¨\n\n- `rehashidx`ä¹Ÿå’Œ*rehash*æœ‰å…³ï¼Œå®ƒè®°å½•äº†*rehash*çš„è¿›åº¦ï¼Œå¦‚æœç›®å‰æ²¡æœ‰åœ¨è¿›è¡Œ*rehash*ï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¸º-1\n\n{% endnote %}\n\næ™®é€šçŠ¶æ€ä¸‹ï¼ˆæ²¡æœ‰è¿›è¡Œ*rehash*ï¼‰çš„å­—å…¸ï¼š\n\n![1720096568065](å­—å…¸.assets/1720096568065.png)  \n\n## å“ˆå¸Œç®—æ³•\n\nå½“è¦å°†ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸é‡Œé¢çš„æ—¶å€™ï¼Œç¨‹åºéœ€è¦å…ˆæ ¹æ®é”®å€¼å¯¹çš„é”®è®¡ç®—å‡ºå“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œç„¶åå†æ ¹æ®ç´¢å¼•å€¼ï¼Œå°†åŒ…å«æ–°é”®å€¼å¯¹çš„å“ˆå¸Œè¡¨èŠ‚ç‚¹æ”¾åˆ°å“ˆå¸Œè¡¨æ•°ç»„çš„æŒ‡å®šç´¢å¼•ä½ç½®ä¸Šé¢\n\n\n\n`Redis`è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼çš„æ–¹æ³•å¦‚ä¸‹ï¼š\n\n>   1.  ä½¿ç”¨å­—å…¸è®¾ç½®çš„å“ˆå¸Œå‡½æ•°ï¼Œè®¡ç®—é”®çš„å“ˆå¸Œå€¼\n>\n>       `hash = dict -> type -> hashFunction(key);`\n>\n>   2.  ä½¿ç”¨å“ˆå¸Œè¡¨çš„`sizemask`å±æ€§å’Œå“ˆå¸Œå€¼è®¡ç®—å‡ºç´¢å¼•å€¼\n>\n>       æ ¹æ®æƒ…å†µä¸åŒï¼Œ`ht[x]`å¯ä»¥æ˜¯`ht[0]`æˆ–è€…æ˜¯`ht[1]`\n>\n>       `index = hash & dict -> ht[x].sizemask;`\n\n\n\nå½“å­—å…¸è¢«ç”¨ä½œæ•°æ®åº“çš„åº•å±‚å®ç°ï¼Œæˆ–è€…å“ˆå¸Œé”®çš„åº•å±‚å®ç°æ—¶ï¼Œ`Redis`ä½¿ç”¨`MurmurHash2`ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼\n\n>   èµ„æ–™ï¼šhttp://code.google.com/p/smhasher/\n\n## è§£å†³é”®å†²çª\n\nå½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«åˆ†é…åˆ°äº†å“ˆå¸Œè¡¨æ•°ç»„çš„åŒä¸€ä¸ªç´¢å¼•ä¸Šé¢ æ—¶ï¼Œæˆ‘ä»¬ç§°è¿™äº›é”®å‘ç”Ÿäº†å†²çªï¼ˆ*collision*ï¼‰\n\n\n\n`Redis`çš„å“ˆå¸Œè¡¨ä½¿ç”¨æ‹‰é“¾æ³•ï¼ˆé“¾åœ°å€æ³•/*separate chaining*ï¼‰æ¥è§£å†³é”®å†²çª\n\n\n\næ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª`next`æŒ‡é’ˆï¼Œå¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹å¯ä»¥ç”¨`next`æŒ‡é’ˆæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œè¢«åˆ†é…åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸Šçš„å¤šä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨è¿™ä¸ªå•å‘é“¾è¡¨è¿æ¥èµ·æ¥ï¼Œè¿™å°±è§£å†³äº†é”®å†²çªé—®é¢˜\n\n\n\n![1720283556269](å­—å…¸.assets/1720283556269.png)\n\n\n{% hideToggle æºç åˆ†æ,, %}\n\n```c\n\ndictEntry *dictAddRaw(dict *d, void *key)\n{\n    // ...\n    // å‰ç½®ä»£ç ï¼Œæš‚æ—¶ä¸éœ€è¦å…³æ³¨ï¼Œåªéœ€è¦çœ‹ä»¥ä¸‹çš„å…³é”®ä»£ç å³å¯\n    // ...\n\n    // T = O(1)\n    /* Allocate the memory and store the new entry */\n    // å¦‚æœå­—å…¸æ­£åœ¨ rehash ï¼Œé‚£ä¹ˆå°†æ–°é”®æ·»åŠ åˆ° 1 å·å“ˆå¸Œè¡¨\n    // å¦åˆ™ï¼Œå°†æ–°é”®æ·»åŠ åˆ° 0 å·å“ˆå¸Œè¡¨\n    ht = dictIsRehashing(d) ? &d->ht[1] : &d->ht[0];\n    // ä¸ºæ–°èŠ‚ç‚¹åˆ†é…ç©ºé—´\n    entry = zmalloc(sizeof(*entry));\n    // å°†æ–°èŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨è¡¨å¤´\n    entry->next = ht->table[index];\n    ht->table[index] = entry;\n    // æ›´æ–°å“ˆå¸Œè¡¨å·²ä½¿ç”¨èŠ‚ç‚¹æ•°é‡\n    ht->used++;\n\n    /* Set the hash entry fields. */\n    // è®¾ç½®æ–°èŠ‚ç‚¹çš„é”®\n    // T = O(1)\n    dictSetKey(d, entry, key);\n\n    return entry;\n}\n\n```\n\næ–°èŠ‚ç‚¹åŠ å…¥çš„é€»è¾‘ä¸­ï¼Œæ˜¯ç›´æ¥å°†æ–°èŠ‚ç‚¹çš„`next`æŒ‡å‘å½“å‰ç´¢å¼•ä½ç½®çš„èŠ‚ç‚¹ï¼Œç„¶åæ›´æ–°ç´¢å¼•ä½ç½®çš„æŒ‡é’ˆä¸ºå½“å‰æ–°åŠ å…¥çš„èŠ‚ç‚¹\n\nè¿™ä¸ªè¿‡ç¨‹å³ä¸ºå¤´æ’æ³•çš„å®ç°ï¼Œå³æ¯æ¬¡æ–°èŠ‚ç‚¹éƒ½ä¼šæ”¾åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼Œè¿™ç§æ–¹å¼å°†æ’å…¥çš„å¤æ‚åº¦å›ºå®šåœ¨`O(1)`\n\n\n\n![1720284337818](å­—å…¸.assets/1720284337818.png)\n\n{% endhideToggle %}\n\n## rehash\n\néšç€æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œå“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹ä¼šé€æ¸åœ°å¢å¤šæˆ–è€…å‡å°‘ï¼Œä¸ºäº†è®©å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼ˆ*load factor*ï¼‰ç»´æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œå½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ï¼Œç¨‹åºéœ€è¦å¯¹å“ˆå¸Œè¡¨çš„å¤§å°è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©\n\n\n\næ‰©å±•å’Œæ”¶ç¼©å“ˆå¸Œè¡¨çš„å·¥ä½œå¯ä»¥é€šè¿‡æ‰§è¡Œ`rehash`ï¼ˆé‡æ–°æ•£åˆ—ï¼‰æ“ä½œæ¥å®Œæˆï¼Œ`Redis`å¯¹å­—å…¸çš„å“ˆå¸Œè¡¨æ‰§è¡Œ`rehash`çš„æ­¥éª¤å¦‚ä¸‹ï¼š\n\n1.  ä¸ºå­—å…¸çš„`ht[1]`å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œè¿™ä¸ªå“ˆå¸Œè¡¨çš„ç©ºé—´å¤§å°å–å†³äºè¦æ‰§è¡Œçš„æ“ä½œå’Œ`ht[0]`å½“å‰åŒ…å«çš„é”®å€¼å¯¹æ•°é‡ï¼ˆä¹Ÿå°±æ˜¯`ht[0].used`å±æ€§çš„å€¼ï¼‰\n\n    -   å¦‚æœæ‰§è¡Œçš„æ˜¯æ‰©å±•æ“ä½œï¼Œé‚£ä¹ˆ`ht[1]`çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº$ht[0].used * 2$çš„$2^n$\n\n    -   å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œé‚£ä¹ˆ`ht[1]`çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº$ht[0].used$çš„$2^n$\n\n        \n\n2.  å°†ä¿å­˜åœ¨`ht[0]`ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹`rehash`åˆ°`ht[1]`ä¸Šé¢\n\n    >   `rehash`æŒ‡çš„æ˜¯é‡æ–°è®¡ç®—é”®çš„å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œç„¶åå°†é”®å€¼å¯¹æ”¾ç½®åˆ°`ht[1]`å“ˆå¸Œè¡¨çš„æŒ‡å®šä½ç½®ä¸Š\n\n3.  å½“`ht[0]`åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿ç§»åˆ°äº†`ht[1]`ä¹‹åï¼ˆ`ht[0]`å˜ä¸ºç©ºè¡¨ï¼‰ï¼Œé‡Šæ”¾`ht[0]`ï¼Œå°†`ht[1]`è®¾ç½®ä¸º`ht[0]`ï¼ˆäº¤æ¢æŒ‡é’ˆï¼‰ï¼Œå¹¶åœ¨`ht[1]`æ–°åˆ›å»ºä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨ï¼Œä¸ºä¸‹ä¸€æ¬¡`rehash`åšå‡†å¤‡\n\n**ä¸¾ä¸ªæ —å­ğŸŒ°**\n\nå‡è®¾ç¨‹åºè¦å¯¹ä¸‹å›¾æ‰€ç¤ºçš„å­—å…¸çš„`ht[0]`è¿›è¡Œæ‰©å±•æ“ä½œ\n\n![1720334001176](å­—å…¸.assets/1720334001176.png)\n\n1.  `ht[0].used`å½“å‰çš„å€¼ä¸º$4$ï¼Œ$4*2=8$ï¼Œè€Œ$8$ï¼ˆ$2^3$ï¼‰æ°å¥½æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äº$4$çš„$2$çš„$n$æ¬¡æ–¹ï¼Œæ‰€ä»¥ç¨‹åºä¼šå°†`ht[1]`å“ˆå¸Œè¡¨çš„å¤§å°è®¾ç½®ä¸º$8$\n\n    ![1720334215791](å­—å…¸.assets/1720334215791.png)\n\n2.  å°†`ht[0]`åŒ…å«çš„å››ä¸ªé”®å€¼å¯¹éƒ½`rehash`åˆ°`ht[1]`\n\n    ![1720334249824](å­—å…¸.assets/1720334249824.png)\n\n3.  é‡Šæ”¾`ht[0]`ï¼Œå¹¶å°†`ht[1]`è®¾ç½®ä¸º`ht[0]`ï¼Œç„¶åä¸º`ht[1]`åˆ†é…ä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨\n\n    è‡³æ­¤ï¼Œå¯¹å“ˆå¸Œè¡¨çš„æ‰©å±•æ“ä½œæ‰§è¡Œå®Œæ¯•ï¼Œç¨‹åºæˆåŠŸå°†å“ˆå¸Œè¡¨çš„å¤§å°ä»åŸæ¥çš„$4$æ‰©å¤§åˆ°äº†ç°åœ¨çš„$8$\n\n    ![1720334335665](å­—å…¸.assets/1720334335665.png)\n\n\n\n### å“ˆå¸Œè¡¨çš„æ‰©å±•ä¸æ”¶ç¼©\n\n#### æ‰©å±•\n\nå½“ä»¥ä¸‹æ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªè¢«æ»¡è¶³æ—¶ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å±•æ“ä½œ\n\n-   æœåŠ¡å™¨ç›®å‰æ²¡æœ‰åœ¨æ‰§è¡Œ`BGSAVE`å‘½ä»¤æˆ–è€…`BGREWRITEAOF`å‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº$1$\n-   æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡Œ`BGSAVE`å‘½ä»¤æˆ–è€…`BGREWRITEAOF`å‘½ä»¤ï¼Œå¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äº$5$\n\nå…¶ä¸­ï¼Œå“ˆå¸Œè¡¨è´Ÿè½½å› å­çš„è®¡ç®—å…¬å¼ä¸ºï¼š\n$$\nLoadFactor = ht[0].used / ht[0].size\n$$\n\n\n>   æ ¹æ®`BGSAVE`æˆ–è€…`BGREWRITEAOF`å‘½ä»¤æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼ŒæœåŠ¡å™¨æ‰§è¡Œæ‰©å±•æ“ä½œæ‰€éœ€çš„è´Ÿè½½å› å­å¹¶ä¸ç›¸åŒï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ‰§è¡Œ`BGSAVE`æˆ–è€…`BGREWRITEAOF`å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼Œ`Redis`éœ€è¦åˆ›å»ºå½“å‰æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹ï¼Œè€Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆ*copy-on-write*ï¼‰æŠ€æœ¯æ¥ä¼˜åŒ–å­è¿›ç¨‹çš„ä½¿ç”¨æ•ˆç‡ï¼Œæ‰€ä»¥åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´ï¼ŒæœåŠ¡å™¨ä¼šæé«˜æ‰§è¡Œæ‰©å±•æ“ä½œæ‰€éœ€çš„è´Ÿè½½å› å­ï¼Œä»è€Œå°½å¯èƒ½åœ°é¿å…åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´è¿›è¡Œå“ˆå¸Œè¡¨æ‰©å±•æ“ä½œï¼Œè¿™å¯ä»¥ é¿å…ä¸å¿…è¦çš„å†…å­˜å†™å…¥æ“ä½œï¼Œæœ€å¤§é™åº¦åœ°èŠ‚çº¦å†…å­˜\n\n{% hideToggle æºç åˆ†æ,, %}\n\n`dict.c/_dictExpandIfNeeded`\n\n```c\n\nstatic int _dictExpandIfNeeded(dict *d)\n{\n    // ...\n\n    /* If we reached the 1:1 ratio, and we are allowed to resize the hash\n     * table (global setting) or we should avoid it but the ratio between\n     * elements/buckets is over the \"safe\" threshold, we resize doubling\n     * the number of buckets. */\n    // ä¸€ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ä¸ºçœŸæ—¶ï¼Œå¯¹å­—å…¸è¿›è¡Œæ‰©å±•\n    // 1ï¼‰å­—å…¸å·²ä½¿ç”¨èŠ‚ç‚¹æ•°å’Œå­—å…¸å¤§å°ä¹‹é—´çš„æ¯”ç‡æ¥è¿‘ 1ï¼š1\n    //    å¹¶ä¸” dict_can_resize ä¸ºçœŸ\n    // 2ï¼‰å·²ä½¿ç”¨èŠ‚ç‚¹æ•°å’Œå­—å…¸å¤§å°ä¹‹é—´çš„æ¯”ç‡è¶…è¿‡ dict_force_resize_ratio\n    if (d->ht[0].used >= d->ht[0].size &&\n        (dict_can_resize ||\n         d->ht[0].used/d->ht[0].size > dict_force_resize_ratio))\n    {\n        // æ–°å“ˆå¸Œè¡¨çš„å¤§å°è‡³å°‘æ˜¯ç›®å‰å·²ä½¿ç”¨èŠ‚ç‚¹æ•°çš„ä¸¤å€\n        // T = O(N)\n        return dictExpand(d, d->ht[0].used*2);\n    }\n\n    return DICT_OK;\n}\n\n```\n\n- å½“`dict_can_resize`å¼€å…³å¤„äºå¯ç”¨çŠ¶æ€ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº1æ—¶ï¼Œä¼šè¿›è¡Œæ‰©å®¹\n- å½“è´Ÿè½½å› å­å¤§äº`dict_force_resize_ratio`æ—¶ï¼Œä¼šå¼ºåˆ¶è¿›è¡Œæ‰©å®¹\n\nå½“`Redis`æ‰§è¡Œ`BGSAVE`æˆ–è€…`BGREWRITEAOF`å‘½ä»¤æ—¶ï¼Œä¼šä½¿ç”¨`dictDisableResize`å‡½æ•°å…³é—­`dict_can_resize`å¼€å…³ï¼Œå°½å¯èƒ½ä¸è¿›è¡Œæ‰©å®¹ï¼›è€Œå½“å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­è¶…è¿‡äº†å¼ºåˆ¶æ‰©å®¹çš„ä¸Šé™ï¼ˆç›®å‰è¿™ä¸ªå€¼è®¾ç½®çš„æ˜¯$5$ï¼‰æ—¶ï¼Œä¹Ÿä¼šå¼ºåˆ¶è¿›è¡Œæ‰©å®¹ä»¥ä¿è¯å“ˆå¸Œè¡¨çš„æ€§èƒ½\n\n```c\n\n/*\n * å¼€å¯è‡ªåŠ¨ rehash\n *\n * T = O(1)\n */\nvoid dictEnableResize(void) {\n    dict_can_resize = 1;\n}\n\n/*\n * å…³é—­è‡ªåŠ¨ rehash\n *\n * T = O(1)\n */\nvoid dictDisableResize(void) {\n    dict_can_resize = 0;\n}\n\n```\n\n{% endhideToggle %}\n\n#### æ”¶ç¼©\n\nå½“å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å°äº$0.1$æ—¶ï¼Œç¨‹åºè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©æ“ä½œ\n\n\n\n\n\n### æ¸è¿›å¼rehash\n\næ‰©å±•æˆ–æ”¶ç¼©å“ˆå¸Œè¡¨éœ€è¦å°†`ht[0]`é‡Œé¢çš„æ‰€æœ‰é”®å€¼å¯¹`rehash`åˆ°`ht[1]`é‡Œé¢ï¼Œä½†æ˜¯ï¼Œè¿™ä¸ª`rehash`åŠ¨ä½œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼å®Œæˆçš„\n\n\n{% note info %}\n\nåŸå› åœ¨äºï¼Œå¦‚æœ`ht[0]`é‡Œé¢åªä¿å­˜ç€å››ä¸ªé”®å€¼å¯¹ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¯ä»¥åœ¨ç¬é—´å°±å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨`rehash`åˆ°`ht[1]`ï¼›ä½†æ˜¯ï¼Œå¦‚æœå“ˆå¸Œè¡¨é‡Œé¢ä¿å­˜ç€ä¸Šä¸‡ä¸Šåƒä¸‡ç”šè‡³ä¸Šäº¿ä¸ªé”®å€¼å¯¹çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¸€æ¬¡æ€§å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨`rehash`åˆ°`ht[1]`çš„è¯ï¼Œåºå¤§çš„è®¡ç®—é‡å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢æœåŠ¡\n\n{% endnote %}\n\nå› æ­¤ï¼Œä¸ºäº†é¿å…`rehash`å¯¹æœåŠ¡å™¨æ€§èƒ½é€ æˆå½±å“ï¼ŒæœåŠ¡å™¨ä¸æ˜¯ä¸€æ¬¡æ€§å°†`ht[0]`é‡Œé¢çš„é”®å€¼å¯¹å…¨éƒ¨`rehash`åˆ°`ht[1]`ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼åœ°å°†`ht[0]`é‡Œé¢çš„é”®å€¼å¯¹æ…¢æ…¢åœ°`rehash`åˆ°`ht[1]`ä¸Š\n\n\n\nä»¥ä¸‹æ˜¯å“ˆå¸Œè¡¨æ¸è¿›å¼`rehash`çš„è¯¦ç»†æ­¥éª¤ï¼š\n\n1.  ä¸º`ht[1]`åˆ†é…ç©ºé—´ï¼Œè®©å­—å…¸åŒæ—¶æŒæœ‰`ht[0]`å’Œ`ht[1]`ä¸¤ä¸ªå“ˆå¸Œè¡¨\n2.  åœ¨å­—å…¸ä¸­ç»´æŒä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡`rehashidx`ï¼Œå¹¶å°†å®ƒçš„å€¼è®¾ç½®ä¸º$0$ï¼Œè¡¨ç¤º`rehash`å·¥ä½œæ­£å¼å¼€å§‹\n3.  åœ¨`rehash`è¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾æˆ–è€…æ›´æ–°æ“ä½œæ—¶ï¼Œç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œä»¥å¤–ï¼Œè¿˜ä¼šé¡ºå¸¦å°†`ht[0]`å“ˆå¸Œè¡¨åœ¨`rehashidx`ç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹`rehash`åˆ°`ht[1]`ä¸Šï¼Œå½“`rehash`å·¥ä½œå®Œæˆä¹‹åï¼Œç¨‹åºå°†rehashidx`å±æ€§çš„å€¼å¢ä¸€\n4.  éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œæœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œ`ht[0]`çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½ä¼šè¢«`rehash`åˆ°`ht[1]`ï¼Œè¿™æ—¶ç¨‹åºå°†`rehashidx`å±æ€§çš„å€¼è®¾ä¸º$-1$ï¼Œè¡¨ç¤º`rehash`æ“ä½œå·²å®Œæˆ\n\n\n\n>   æ¸è¿›å¼`rehash`çš„å¥½å¤„åœ¨äºå®ƒé‡‡å–äº†åˆ†è€Œæ²»ä¹‹çš„æ–¹å¼ï¼Œå°†`rehash`é”®å€¼å¯¹æ‰€éœ€çš„è®¡ç®—å·¥ä½œå‡æ‘Šåˆ°å¯¹å­—å…¸çš„æ¯ä¸ªæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾å’Œæ›´æ–°æ“ä½œä¸Šï¼Œä»è€Œé¿å…äº†é›†ä¸­å¼`rehash`å¸¦æ¥çš„åºå¤§è®¡ç®—é‡\n\n\n\n#### æ¸è¿›å¼rehashæ‰§è¡ŒæœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œ\n\nå› ä¸ºåœ¨è¿›è¡Œæ¸è¿›å¼`rehash`çš„è¿‡ç¨‹ä¸­ï¼Œå­—å…¸ä¼šåŒæ—¶ä½¿ç”¨`ht[0]`å’Œ`ht[1]`ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œæ‰€ä»¥åœ¨æ¸è¿›å¼`rehash`è¿›è¡ŒæœŸé—´ï¼Œå­—å…¸çš„åˆ é™¤ã€æŸ¥æ‰¾ã€æ›´æ–°ç­‰æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œ\n\n-   è¦åœ¨å­—å…¸é‡Œé¢æŸ¥æ‰¾ä¸€ä¸ªé”®çš„è¯ï¼Œç¨‹åºä¼šç°åœ¨`ht[0]`é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°çš„è¯ ï¼Œå°±ä¼šç»§ç»­åˆ°`ht[1]`é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾\n-   æ–°æ·»åŠ åˆ°å­—å…¸çš„é”®å€¼å¯¹ä¸€å¾‹ä¼šè¢«ä¿å­˜åˆ°`ht[1]`é‡Œé¢ï¼Œè€Œ`ht[0]`åˆ™ä¸ä¼šå†è¿›è¡Œä»»ä½•æ·»åŠ æ“ä½œï¼Œè¿™ä¸€æªæ–½ä¿è¯äº†`ht[0]`åŒ…å«çš„é”®å€¼å¯¹æ•°é‡åªå‡ä¸å¢ï¼Œå¹¶éšç€`rehash`æ“ä½œçš„æ‰§è¡Œè€Œæœ€ç»ˆå˜æˆç©ºè¡¨\n\n{% hideToggle æºç åˆ†æ,, %}\n\n`dict.c/dictGenericDelete`\n\n```c\n\nstatic int dictGenericDelete(dict *d, const void *key, int nofree)\n{\n    // ...\n\n    // éå†å“ˆå¸Œè¡¨\n    // T = O(1)\n    for (table = 0; table <= 1; table++) {\n\n        // è®¡ç®—ç´¢å¼•å€¼ \n        idx = h & d->ht[table].sizemask;\n        // æŒ‡å‘è¯¥ç´¢å¼•ä¸Šçš„é“¾è¡¨\n        he = d->ht[table].table[idx];\n        prevHe = NULL;\n        // éå†é“¾è¡¨ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹\n        // T = O(1)\n        while(he) {\n        \n            if (dictCompareKeys(d, key, he->key)) {\n\n                // ...\n\n                // æ›´æ–°å·²ä½¿ç”¨èŠ‚ç‚¹æ•°é‡\n                d->ht[table].used--;\n\n                // è¿”å›å·²æ‰¾åˆ°ä¿¡å·\n                return DICT_OK;\n            }\n\n            prevHe = he;\n            he = he->next;\n        }\n\n        // å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜åœ¨ 0 å·å“ˆå¸Œè¡¨ä¸­æ‰¾ä¸åˆ°ç»™å®šé”®\n        // é‚£ä¹ˆæ ¹æ®å­—å…¸æ˜¯å¦æ­£åœ¨è¿›è¡Œ rehash ï¼Œå†³å®šè¦ä¸è¦æŸ¥æ‰¾ 1 å·å“ˆå¸Œè¡¨\n        if (!dictIsRehashing(d)) break;\n    }\n\n    // æ²¡æ‰¾åˆ°\n    return DICT_ERR; /* not found */\n}\n\n```\n\n{% endhideToggle %}\n\n## æ€»ç»“\n\n-   å­—å…¸è¢«å¹¿æ³›ç”¨äºå®ç°`Redis`çš„å„ç§åŠŸèƒ½ï¼Œå…¶ä¸­åŒ…æ‹¬æ•°æ®åº“å’Œå“ˆå¸Œé”®\n-   `Redis`ä¸­çš„å­—å…¸ä½¿ç”¨å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°ï¼Œæ¯ä¸ªå­—å…¸å¸¦æœ‰ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œä¸€ä¸ªå¹³æ—¶ä½¿ç”¨ï¼Œå¦ä¸€ä¸ªä»…åœ¨è¿›è¡Œ`rehash`æ—¶ä½¿ç”¨\n-   å½“å­—å…¸è¢«ç”¨ä½œæ•°æ®åº“çš„åº•å±‚å®ç°ï¼Œæˆ–è€…å“ˆå¸Œé”®çš„åº•å±‚å®ç°æ—¶ï¼Œ`Redis`ä½¿ç”¨`MurmurHash2`ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼\n-   å“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•è§£å†³å“ˆå¸Œå†²çªï¼Œè¢«åˆ†é…åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸Šçš„å¤šä¸ªé”®å€¼å¯¹ä¼šè¿æ¥æˆä¸€ä¸ªå•å‘é“¾è¡¨\n-   åœ¨å¯¹å“ˆå¸Œè¡¨è¿›è¡Œæ‰©å±•æˆ–è€…æ”¶ç¼©æ“ä½œæ—¶ï¼Œç¨‹åºéœ€è¦å°†ç°æœ‰å“ˆå¸Œè¡¨åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹`rehash`åˆ°æ–°å“ˆå¸Œè¡¨é‡Œé¢ï¼Œå¹¶ä¸”è¿™ä¸ª`rehash`è¿‡ç¨‹å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆï¼Œè€Œæ˜¯æ¸è¿›å¼å®Œæˆåœ°\n\n\n\n## å‚è€ƒèµ„æ–™\n\n>   ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹â€”â€” ç¬¬å››ç« ï¼šå­—å…¸\n>\n>    [huangzworks/redis-3.0-annotated: å¸¦æœ‰è¯¦ç»†æ³¨é‡Šçš„ Redis 3.0 ä»£ç ï¼ˆannotated Redis 3.0 source codeï¼‰ã€‚ (github.com)](https://github.com/huangzworks/redis-3.0-annotated) \n>\n\n\n\n\n\n\n\n\n\n","tags":["Redis","æ•°æ®åº“","NoSQL"],"categories":["Redis"]},{"title":"Redis-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰","url":"/posts/79e7fc4f/","content":"\n\n\n\n## æ¦‚è¿°\n\n{% label Redis purple %}æ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€çš„ä¼ ç»Ÿå­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§åä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSimple dynamic stringï¼ŒSDSï¼‰çš„æŠ½è±¡ç±»å‹ï¼Œå¹¶å°†{% label SDS green %}ç”¨ä½œ{% label Redis purple %}é»˜è®¤çš„å­—ç¬¦ä¸²è¡¨ç¤º\n\n> Cè¯­è¨€ä¼ ç»Ÿå­—ç¬¦ä¸²é€šå¸¸ç”¨ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦æ•°ç»„è¡¨ç¤º\n\n\nåœ¨{% label Redis purple %}ä¸­ï¼ŒCå­—ç¬¦ä¸²åªä¼šä½œä¸ºå­—ç¬¦ä¸²å­—é¢é‡ç”¨åœ¨ä¸€äº›æ— é¡»å¯¹å­—ç¬¦ä¸²å€¼è¿›è¡Œä¿®æ”¹çš„åœ°æ–¹ï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—\n\nå½“{% label Redis purple %}éœ€è¦çš„æ˜¯ä¸€ä¸ªå¯ä»¥è¢«ä¿®æ”¹çš„å­—ç¬¦ä¸²å€¼çš„æ—¶å€™ï¼Œ{% label Redis purple %}å°±ä¼šä½¿ç”¨{% label SDS green %}æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å€¼\n\n{% note %}\n\næ¯”å¦‚åœ¨{% label Redis purple %}çš„æ•°æ®åº“é‡Œé¢ï¼ŒåŒ…å«å­—ç¬¦ä¸²å€¼çš„é”®å€¼å¯¹åœ¨åº•å±‚éƒ½æ˜¯æœ‰{% label SDS green %}å®ç°çš„\n\n{% endnote %}\n\n\né™¤äº†ç”¨æ¥ä¿å­˜æ•°æ®åº“ä¸­çš„å­—ç¬¦ä¸²å€¼ä¹‹å¤–ï¼Œ{% label SDS green %}è¿˜è¢«ç”¨ä½œç¼“å†²åŒº\n\n{% note %}\n\n- `AOF`æ¨¡å—ä¸­çš„`AOF`ç¼“å†²åŒº\n- å®¢æˆ·ç«¯çŠ¶æ€ä¸­çš„è¾“å…¥ç¼“å†²åŒº\n\n{% endnote %}\n\n\n\n## SDSçš„å®šä¹‰\n\næ¯ä¸ª`sds.h/sdshdr`ç»“æ„è¡¨ç¤ºä¸€ä¸ª{% label SDS green %}å€¼\n\n```c\n\n/*\n * ä¿å­˜å­—ç¬¦ä¸²å¯¹è±¡çš„ç»“æ„\n */\nstruct sdshdr {\n    \n    // buf ä¸­å·²å ç”¨ç©ºé—´çš„é•¿åº¦\n    int len;\n\n    // buf ä¸­å‰©ä½™å¯ç”¨ç©ºé—´çš„é•¿åº¦\n    int free;\n\n    // æ•°æ®ç©ºé—´\n    char buf[];\n};\n\n```\n\n\n![1719648860531](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719648860531.png)  \n\n\n{% note info %}\n\n`free`å±æ€§çš„å€¼ä¸º0ï¼Œè¡¨ç¤ºè¿™ä¸ª{% label SDS green %}æ²¡æœ‰å‰©ä½™å¯ç”¨ç©ºé—´äº†\n\n`len`å±æ€§çš„å€¼ä¸º5ï¼Œè¡¨ç¤ºè¿™ä¸ª{% label SDS green %}ä¿å­˜äº†ä¸€ä¸ªäº”å­—èŠ‚é•¿çš„å­—ç¬¦ä¸²\n\n`buf`å±æ€§æ˜¯ä¸€ä¸ª`char`ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„çš„å‰äº”ä¸ªå­—èŠ‚åˆ†åˆ«ä¿å­˜`R`ã€`e`ã€`d`ã€`i`ã€`s`äº”ä¸ªå­—ç¬¦ï¼Œè€Œæœ€åä¸€ä¸ªå­—èŠ‚åˆ™ä¿å­˜äº†ç©ºå­—ç¬¦`'\\0'`\n\n{% endnote %}\n\n\n{% note info %}\n\n{% label SDS green %}éµå¾ªäº†Cå­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„æƒ¯ä¾‹ï¼Œ**ä¿å­˜ç©ºå­—ç¬¦çš„1å­—èŠ‚ç©ºé—´ä¸è®¡ç®—åœ¨{% label SDS green %}çš„`len`å±æ€§é‡Œé¢**\n\nä¸ºç©ºå­—ç¬¦åˆ†é…é¢å¤–çš„1å­—èŠ‚ç©ºé—´ï¼Œä»¥åŠæ·»åŠ ç©ºå­—ç¬¦åˆ°å­—ç¬¦ä¸²æœ«å°¾ç­‰æ“ä½œï¼Œéƒ½æ˜¯æœ‰{% label SDS green %}å‡½æ•°è‡ªåŠ¨å®Œæˆçš„ï¼Œæ‰€ä»¥è¿™ä¸ªç©ºå­—ç¬¦å¯¹äº{% label SDS green %}çš„ä½¿ç”¨è€…ï¼ˆä¸Šå±‚è°ƒç”¨æ–¹ï¼‰æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„\n\n{% hideToggle éƒ¨åˆ†å‡½æ•°è§£æ,, %}\n\n![1719674373325](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719674373325.png)  \n\nå¦‚ä¸‹å›¾ï¼Œ`sdscatlen`å‡½æ•°æ˜¯ç”¨äºæ‹¼æ¥ï¼ˆè¿½åŠ ï¼‰å­—ç¬¦ä¸²åˆ°å·²æœ‰{% label SDS green %}çš„å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°è¿”å›å‰çš„æœ€åä¸€æ­¥ï¼Œä¼šåœ¨ç»“å°¾è‡ªåŠ¨å¡«å……`'\\0'`\n\nåŒ…æ‹¬åœ¨{% label SDS green %}æ‰©å®¹çš„æ—¶å€™ï¼Œä¹Ÿä¼šè‡ªåŠ¨å¤šåˆ†é…1å­—èŠ‚çš„ç©ºé—´ç•™ç»™æœ€åçš„`'\\0'`ä½¿ç”¨\n\nå¦‚ä¸‹å›¾ï¼Œ`sdsMakeRoomFor`å‡½æ•°æ˜¯ç”¨äº{% label SDS green %}æ‰©å®¹çš„å‡½æ•°\n\n![1719674571768](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719674571768.png)  \n\n{% endhideToggle %}\n\néµå¾ªç©ºå­—ç¬¦ç»“å°¾è¿™ä¸€æƒ¯ä¾‹çš„å¥½å¤„æ˜¯ï¼Œ{% label SDS green %}å¯ä»¥ç›´æ¥å¤ç”¨ä¸€éƒ¨åˆ†Cå­—ç¬¦ä¸²å‡½æ•°åº“é‡Œé¢çš„å‡½æ•°\n\n{% hideToggle å‡½æ•°å¤ç”¨ä¾‹å­,, %}\n\nå¯ä»¥ç›´æ¥ä½¿ç”¨`<stdio.h>/printf`å‡½æ•°æ‰“å°{% label SDS green %}ä¿å­˜çš„å­—ç¬¦ä¸²çš„å€¼\n\n```c\n\nprintf(\"%s\", s->buf);\n\n```\n\n{% endhideToggle %}\n\n{% endnote %}\n\n\n## SDSä¸Cå­—ç¬¦ä¸²çš„åŒºåˆ«\n\n### å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦\n\n`C`å­—ç¬¦ä¸²ä¸ä¼šè®°å½•é•¿åº¦ä¿¡æ¯ï¼Œæ¯æ¬¡è·å–ä¸€ä¸ª`C`å­—ç¬¦ä¸²çš„é•¿åº¦éƒ½å¿…é¡»éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œå¯¹é‡åˆ°çš„æ¯ä¸ªå­—ç¬¦ä¸²è¿›è¡Œè®¡æ•°ï¼Œç›´åˆ°é‡åˆ°ä»£è¡¨å­—ç¬¦ä¸²ç»“å°¾çš„ç©ºå­—ç¬¦ä¸ºæ­¢ï¼Œè¿™ä¸ªæ“ä½œçš„å¤æ‚åº¦ä¸º*O(N)*\n\n\n\nè€Œ{% label SDS green %}åªéœ€è¦è®¿é—®`len`å±æ€§å³å¯\n\n![1719733950042](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719733950042.png)\n\n{% note info %}\n\n{% label SDS green %}`len`å’Œ`free`å±æ€§çš„è®¾ç½®å’Œæ›´æ–°å·¥ä½œéƒ½æ˜¯ç”±{% label SDS green %}çš„**API**åœ¨æ‰§è¡Œæ—¶è‡ªåŠ¨å®Œæˆçš„ï¼ˆé€šè¿‡åœ¨å†™æ“ä½œå†—ä½™å­˜å‚¨é•¿åº¦çš„ä¿¡æ¯æ¥å®ç°å¿«é€Ÿè¯»å–ï¼‰\n\n{% endnote %}\n\n\n\n### æœç»ç¼“å†²åŒºæº¢å‡º\n\n`C`å­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«é•¿åº¦å¸¦æ¥çš„å¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯å®¹æ˜“é€ æˆç¼“å†²åŒºæº¢å‡ºï¼ˆbuffer overflowï¼‰\n\nå¦‚`<string.h>/strcat`å‡½æ•°å¯ä»¥å°†`src`å­—ç¬¦ä¸²ä¸­çš„å†…å®¹æ‹¼æ¥åˆ°`dest`å­—ç¬¦ä¸²çš„æœ«å°¾ï¼ˆä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥å‡½æ•°ï¼‰\n\n```c\nchar *strcat(char *dest, const char *src);\n```\n\n\n\nå› ä¸º`C`å­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«çš„é•¿åº¦ï¼Œæ‰€ä»¥`strcat`å‡å®šç”¨æˆ·åœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œå·²ç»ä¸º`dest`åˆ†é…äº†è¶³å¤Ÿçš„å†…å­˜äº†ï¼Œå¯ä»¥å®¹çº³`src`å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œè€Œä¸€æ—¦`src`æ²¡æœ‰é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´ï¼Œå°±ä¼šäº§ç”Ÿç¼“å†²åŒºæº¢å‡º\n\n\n\næ¯”å¦‚ä¸‹å›¾ä¸­çš„ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå‡è®¾è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²åœ¨å†…å­˜ä¸­æ˜¯ç´§é‚»çš„\n\n![1719734881193](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719734881193.png)\n\næ­¤æ—¶æ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥çš„æ“ä½œ\n\n```c\nstrcat(s1, \" Cluster\");\n```\n\nç”±äº`s1`æ²¡æœ‰é¢„ç•™è¶³å¤Ÿçš„ç©ºé—´ä»¥å®¹çº³æ‹¼æ¥çš„`Cluster`å­—ç¬¦ä¸²ï¼ˆç©ºé—´ä¸è¶³ä¹Ÿæ²¡æœ‰æå‰è¿›è¡Œæ‰©å®¹ï¼‰ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œå®Œ`strcat`å‡½æ•°ä¹‹åï¼Œ`s2`çš„å†…å®¹ä¼šè¢«æ„å¤–ä¿®æ”¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\n\n![1719735008040](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719735008040.png)\n\n\n\nè€Œ{% label SDS green %}åˆ™åœ¨**API**å±‚é¢å°±ä¼šè¿›è¡Œç©ºé—´æ£€æŸ¥ï¼Œå‘ç°ç©ºé—´ä¸è¶³æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œæ‰©å®¹ï¼Œæ‰€ä»¥ä¸å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºé—®é¢˜\n\nä»¥ä¸‹æ˜¯{% label SDS green %}å­—ç¬¦ä¸²æ‹¼æ¥çš„**API**â€”â€”`sdscatlen`å‡½æ•°æºç \n\n![1719735247877](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719735247877.png)\n\n\n\n### å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å¸¦æ¥çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°\n\nå¯¹äºä¸€ä¸ªåŒ…å«**N**ä¸ªå­—ç¬¦çš„`C`å­—ç¬¦ä¸²æ¥è¯´ï¼Œåº•å±‚å®ç°æ€»æ˜¯ä¸€ä¸ª**N+1**ä¸ªå­—ç¬¦é•¿çš„æ•°ç»„ï¼ˆé¢å¤–çš„ä¸€ä¸ªå­—ç¬¦ç©ºé—´ç”¨äºä¿å­˜ç©ºå­—ç¬¦ï¼‰\n\nè¿™å¯¼è‡´æ¯æ¬¡å¢é•¿æˆ–ç¼©çŸ­ä¸€ä¸ª`C`å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºæ€»æ˜¯è¦å¯¹ä¿å­˜è¿™ä¸ª`C`å­—ç¬¦ä¸²çš„æ•°ç»„è¿›è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…æ“ä½œ\n\n-   å¯¹äºå¢é•¿å­—ç¬¦ä¸²çš„æ“ä½œï¼ˆæ¯”å¦‚æ‹¼æ¥æ“ä½œï¼‰â€”â€”æ‰§è¡Œè¿™ä¸ªæ“ä½œä¹‹å‰ï¼Œç¨‹åºéœ€è¦é€šè¿‡å†…å­˜é‡åˆ†é…æ¥æ‰©å±•åº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å°ï¼ˆå¦‚æœå¿˜äº†è¿™ä¸€æ­¥å°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºï¼‰\n-   å¯¹äºç¼©çŸ­å­—ç¬¦ä¸²çš„æ“ä½œï¼ˆæ¯”å¦‚æˆªæ–­æ“ä½œï¼‰â€”â€”æ‰§è¡Œè¿™ä¸ªæ“ä½œä¹‹åï¼Œç¨‹åºéœ€è¦é€šè¿‡å†…å­˜é‡åˆ†é…æ¥é‡Šæ”¾å­—ç¬¦ä¸²ä¸åœ¨ä½¿ç”¨çš„é‚£éƒ¨åˆ†ç©ºé—´ï¼ˆå¦‚æœå¿˜äº†è¿™ä¸€æ­¥å°±ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼‰\n\n\n\n`SDS`é€šè¿‡`len`å’Œ`free`å±æ€§è§£é™¤äº†å­—ç¬¦ä¸²é•¿åº¦å’Œåº•å±‚æ•°ç»„é•¿åº¦ä¹‹é—´çš„å…³è”ï¼š`buf`æ•°ç»„çš„é•¿åº¦ä¸ä¸€å®šå°±æ˜¯å­—ç¬¦æ•°é‡+1ï¼Œæ•°ç»„é‡Œé¢å¯ä»¥åŒ…å«æœªä½¿ç”¨çš„å­—èŠ‚ï¼Œè€Œè¿™äº›å­—èŠ‚çš„æ•°é‡å°±ç”±`SDS`çš„`free`å±æ€§è®°å½•\n\n\n\né€šè¿‡æœªä½¿ç”¨ç©ºé—´ï¼Œ{% label SDS green %} å®ç°äº†**ç©ºé—´é¢„åˆ†é…**å’Œ**æƒ°æ€§ç©ºé—´é‡Šæ”¾**ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ï¼Œå‡å°‘äº†ä¿®æ”¹å­—ç¬¦ä¸²æ—¶å†…å­˜é‡åˆ†é…çš„æ¬¡æ•°\n\nè¿›è¡Œ**N**æ¬¡å­—ç¬¦ä¸²æ“ä½œï¼š\n\n-   `C`å­—ç¬¦ä¸²å¿…é¡»è¿›è¡Œ**N**æ¬¡å†…å­˜é‡åˆ†é…\n-   `SDS`åˆ™é™ä½åˆ°æœ€å¤šéœ€è¦è¿›è¡Œ**N**æ¬¡å†…å­˜é‡åˆ†é…ï¼ˆç©ºé—´é¢„ç•™ï¼‰\n\n\n\n#### ç©ºé—´é¢„åˆ†é…\n\nå½“éœ€è¦å¯¹{% label SDS green %} è¿›è¡Œæ‰©å®¹çš„æ—¶å€™ï¼Œä¼šé¢å¤–åˆ†é…æœªä½¿ç”¨çš„ç©ºé—´\n\næ‰©å®¹è§„åˆ™\n\n{% note info %}\n\næ³¨ï¼šRedis3.0æºç çš„æ‰©å®¹è§„åˆ™ï¼Œå¯èƒ½ä¸é€‚ç”¨äºå…¶ä»–ç‰ˆæœ¬\n\n{% endnote %}\n\n\n\n-   å¦‚æœä¿®æ”¹ä¹‹åçš„é•¿åº¦å°äº1MBï¼Œé‚£ä¹ˆä¼šåˆ†é…å’Œ`len`å±æ€§åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´ï¼ˆå³`free`å±æ€§å’Œ`len`å±æ€§ç›¸åŒï¼‰\n\n    æ¯”å¦‚ï¼Œä¿®æ”¹åçš„`len`ä¸º13ï¼Œé‚£ä¹ˆç¨‹åºä¹Ÿä¼šåˆ†é…13å­—èŠ‚çš„æœªä½¿ç”¨ç©ºé—´ï¼Œ{% label SDS green %} çš„`buf`æ•°ç»„çš„å®é™…é•¿åº¦å°†å˜æˆ13+13+1=27å­—èŠ‚ï¼ˆé¢å¤–1å­—èŠ‚ç”¨äºä¿å­˜ç©ºå­—ç¬¦ï¼Œè¿™1å­—èŠ‚æ˜¯ç”³è¯·å†…å­˜æ—¶è‡ªåŠ¨æ·»åŠ çš„ï¼‰\n\n-   å¦‚æœä¿®æ”¹ä¹‹åçš„é•¿åº¦å¤§äºç­‰äº1MBï¼Œé‚£ä¹ˆä¼šåˆ†é…1MBçš„æœªä½¿ç”¨ç©ºé—´\n\n{% hideToggle æ‰©å®¹æºç ,, %}\n\n![1719742759110](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719742759110.png)  \n\n{% endhideToggle %}\n\n\n\n#### æƒ°æ€§ç©ºé—´é‡Šæ”¾\n\nè¿™ä¸ªç­–ç•¥ç”¨äºä¼˜åŒ–{% label SDS green %}çš„å­—ç¬¦ä¸²ç¼©çŸ­çš„æ“ä½œ\n\nå½“{% label SDS green %} çš„**API**éœ€è¦ç¼©çŸ­{% label SDS green %}ä¿å­˜çš„å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºä¸ä¼šç«‹å³ä½¿ç”¨å†…å­˜é‡åˆ†é…æ¥å›æ”¶ç¼©çŸ­åçš„å¤šå‡ºæ¥çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨`free`å±æ€§å°†è¿™äº›å­—èŠ‚æ•°é‡è®°å½•èµ·æ¥ï¼Œå¹¶ç­‰å¾…å°†æ¥ä½¿ç”¨\n\n\n\n`sdstrim`å‡½æ•°æ¥å—ä¸€ä¸ª{% label SDS green %} å’Œä¸€ä¸ª`C`å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ï¼Œç§»é™¤{% label SDS green %}å‰åå‰ç¼€ä¸­æ‰€æœ‰åœ¨`C`å­—ç¬¦ä¸²ä¸­å‡ºç°è¿‡çš„å­—ç¬¦\n\n![1719744670422](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719744670422.png)  \n\n```c\nsdstrim(s, \"XY\"); // ç§»é™¤SDSå­—ç¬¦ä¸²ä¸­çš„å‰åå‰ç¼€ä¸­æ‰€æœ‰'X'å’Œ'Y'\n```\n\n![1719744758517](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719744758517.png)  \n\n{% hideToggle ä»£ç éªŒè¯,, %}\n\n```c\n\nint main(int argc, char const *argv[])\n{\n    sds s = sdsnew(\"XYXabcXYYX\");\n    printf(\"s: %s, s->len: %ld, s->free: %ld\\n\", s, sdslen(s), sdsavail(s));\n\n    s = sdstrim(s, \"XY\");\n    printf(\"s: %s, s->len: %ld, s->free: %ld\\n\", s, sdslen(s), sdsavail(s));\n\n    return 0;\n}\n\n```\n\næ‰§è¡Œç»“æœï¼š\n\n![1719744803261](ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰.assets/1719744803261.png)  \n\n{% endhideToggle %}\n\n\n\n### äºŒè¿›åˆ¶å®‰å…¨\n\n`C`å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼ˆæ¯”å¦‚**ASCII**ï¼‰ï¼Œå¹¶ä¸”é™¤äº†å­—ç¬¦ä¸²çš„æœ«å°¾ä¹‹å¤–ï¼Œå­—ç¬¦ä¸²é‡Œé¢ä¸èƒ½åŒ…å«ç©ºå­—ç¬¦ï¼Œå¦åˆ™æœ€å…ˆè¢«ç¨‹åºè¯»å…¥çš„ç©ºå­—ç¬¦å°†è¢«è¯¯è®¤ä¸ºå­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œè¿™äº›é™åˆ¶ä½¿å¾—`C`å­—ç¬¦ä¸²åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè€Œä¸èƒ½ä¿å­˜åƒå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘è¿™æ ·çš„äºŒè¿›åˆ¶æ•°æ®\n\nå¦‚æœæœ‰ä¸€ç§ä½¿ç”¨ç©ºå­—ç¬¦æ¥åˆ†å‰²å¤šä¸ªå•è¯çš„ç‰¹æ®Šæ•°æ®æ ¼å¼ï¼Œé‚£ä¹ˆè¿™ç§æ ¼å¼å°±ä¸èƒ½ä½¿ç”¨`C`å­—ç¬¦ä¸²æ¥ä¿å­˜\n\nè€Œ`SDS`ä½¿ç”¨`len`å±æ€§æ¥åˆ¤æ–­å­—ç¬¦ä¸²é•¿åº¦çš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ­¤é—®é¢˜\n\n\n\n### å…¼å®¹éƒ¨åˆ†Cå­—ç¬¦ä¸²å‡½æ•°\n\n`SDS`åº•å±‚çš„æ•°æ®ç»“æ„ä¸­ä½¿ç”¨`buf`å±æ€§å­˜å‚¨å®é™…çš„å­—ç¬¦ä¸²æ•°æ®ï¼Œæœ¬èº«çš„å­˜å‚¨è¿˜æ˜¯éµå¾ª`C`å­—ç¬¦ä¸²çš„æƒ¯ä¾‹ï¼Œè¿™ä½¿å¾—`SDS`å¯ä»¥å¤ç”¨éƒ¨åˆ†`C`å­—ç¬¦ä¸²çš„åº“å‡½æ•°\n\n\n\n\n### æ€»ç»“\n\n| åœºæ™¯           | C å­—ç¬¦ä¸²                                                     | SDS                                                          |\n| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |\n| å­—ç¬¦ä¸²é•¿åº¦è·å– | æ…¢ï¼ˆå¤æ‚åº¦ä¸º`O(N)`ï¼‰                                         | å¿«ï¼ˆå¤æ‚åº¦ä¸º`O(1)`ï¼‰                                         |\n| **API**å®‰å…¨æ€§  | ä½ï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œéœ€è¦ä½¿ç”¨è€…è‡ªè¡Œè€ƒè™‘å­—ç¬¦ä¸²æ‰©å®¹ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°ç¼“å†²åŒºæº¢å‡ºï¼‰ | é«˜ï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œé¢„å…ˆæ£€æŸ¥å®¹é‡ï¼Œä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºï¼‰         |\n| å­—ç¬¦ä¸²ä¿®æ”¹æ•ˆç‡ | è¾ƒä½ï¼ˆä¿®æ”¹å­—ç¬¦ä¸²**N**æ¬¡å¿…ç„¶éœ€è¦æ‰§è¡Œ**N**æ¬¡å†…å­˜é‡åˆ†é…ï¼‰       | é«˜ï¼ˆä¿®æ”¹å­—ç¬¦ä¸²**N**æ¬¡æœ€å¤šéœ€è¦æ‰§è¡Œ**N**æ¬¡å†…å­˜é‡åˆ†é…ï¼‰         |\n| æ•°æ®å†…å®¹       | åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®                                             | äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œä¹Ÿé€‚ç”¨äºäºŒè¿›åˆ¶æ•°æ®çš„ä¿å­˜                       |\n| åº“å‡½æ•°å…¼å®¹æ€§   | ä¸å­˜åœ¨å…¼å®¹é—®é¢˜                                               | å¯ä»¥ä½¿ç”¨éƒ¨åˆ†åº“å‡½æ•°ï¼ˆåº•å±‚å­—ç¬¦ä¸²å­˜å‚¨ä»ç„¶ä¿æŒ`C`å­—ç¬¦ä¸²çš„æƒ¯ä¾‹æ˜¯å¾—ä»¥å¤ç”¨éƒ¨åˆ†åº“å‡½æ•°çš„å…³é”®ï¼‰ |\n\n\n\n\n\n## å‚è€ƒèµ„æ–™\n\n>   -   ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹â€”â€” ç¬¬2ç« ï¼šç®€å•åŠ¨æ€å­—ç¬¦ä¸²\n>   -   [huangzworks/redis-3.0-annotated: å¸¦æœ‰è¯¦ç»†æ³¨é‡Šçš„ Redis 3.0 ä»£ç ï¼ˆannotated Redis 3.0 source codeï¼‰ã€‚ (github.com)](https://github.com/huangzworks/redis-3.0-annotated) ","tags":["Redis","æ•°æ®åº“","NoSQL"],"categories":["Redis"]},{"title":"Golang-é€ƒé€¸åˆ†æ","url":"/posts/cb05bf87/","content":"\n\n\n## é€ƒé€¸åˆ†æ\n\n\n\n### ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æ\n\n\n\nåœ¨`C`ã€`C++`è¿™ç±»éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå¯¹è±¡æˆ–ç»“æ„ä½“å…·ä½“åˆ†é…åˆ°å †è¿˜æ˜¯æ ˆä¸Šæ˜¯ç”±å·¥ç¨‹å¸ˆè‡ªä¸»å†³å®šçš„ï¼Œå¦‚æœèƒ½å¤Ÿç²¾å‡†åœ°ä¸ºæ¯ä¸€ä¸ªå˜é‡åˆ†é…åˆç†çš„ç©ºé—´ï¼Œé‚£ä¹ˆç¨‹åºçš„è¿è¡Œæ•ˆç‡å’Œå†…å­˜ä½¿ç”¨æ•ˆç‡ä¸€å®šæ˜¯æœ€é«˜çš„ï¼Œä½†æ˜¯æ‰‹åŠ¨åˆ†é…ä¼šå¯¼è‡´ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š\n\n-   ä¸éœ€è¦åˆ†é…åˆ°å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°å †ä¸Š â€”â€” æµªè´¹å†…å­˜ç©ºé—´ã€ä¸”å¯èƒ½å¿˜è®°é‡Šæ”¾å¯¼è‡´å†…å­˜æ³„æ¼\n-   éœ€è¦åˆ†é…åˆ°å †ä¸Šçš„å¯¹è±¡åˆ†é…åˆ°æ ˆä¸Š â€”â€” æ‚¬æŒ‚æŒ‡é’ˆã€å½±å“å†…å­˜å®‰å…¨\n\n\n\n#### æ‚¬æŒ‚æŒ‡é’ˆ\n\nåœ¨`C`è¯­è¨€ä¸­ï¼Œæ ˆä¸Šçš„å˜é‡è¢«å‡½æ•°ä½œä¸ºè¿”å›å€¼è¿”å›ç»™è°ƒç”¨æ–¹æ˜¯ä¸€ä¸ªå¸¸è§çš„é”™è¯¯\n\nå¦‚ä»¥ä¸‹ä»£ç \n\n```c\nint *foo ( void )   \n{   \n    int t = 3;\n    return &t;\n}\n```\n\nå½“ `foo`å‡½æ•°è¿”å›åï¼Œå®ƒçš„æœ¬åœ°å˜é‡ä¼šè¢«ç¼–è¯‘å™¨å›æ”¶ï¼Œè°ƒç”¨æ–¹è·å–çš„æ˜¯ä¸€ä¸ªæ‚¬æŒ‚æŒ‡é’ˆï¼Œä¸ç¡®å®šå½“å‰æŒ‡é’ˆæŒ‡å‘çš„å€¼æ˜¯å¦è¿˜èƒ½æ­£å¸¸ä½¿ç”¨ï¼ˆå¯èƒ½éƒ½å·²ç»è¢«å›æ”¶äº†ï¼‰\n\n\n\n>   ä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æï¼Ÿ\n>\n>   åœ¨ç¼–è¯‘å™¨ä¼˜åŒ–ä¸­ï¼Œ*é€ƒé€¸åˆ†æ*æ˜¯ç”¨æ¥å†³å®šæŒ‡é’ˆåŠ¨æ€ä½œç”¨åŸŸçš„æ–¹æ³•ï¼Œæ˜¯ä¸€ç§é™æ€åˆ†æä¸‹æ–¹æ³•\n>\n>   `Go`è¯­è¨€çš„ç¼–è¯‘å™¨ä½¿ç”¨é€ƒé€¸åˆ†æå†³å®šå˜é‡åº”è¯¥åœ¨æ ˆä¸Šåˆ†é…è¿˜æ˜¯åœ¨å †ä¸Šåˆ†é…\n\n\n\n`Go`è¯­è¨€ä¸­çš„é€ƒé€¸åˆ†ææ˜¯ç¼–è¯‘å™¨æ‰§è¡Œé™æ€ä»£ç åˆ†æåï¼Œå¯¹å†…å­˜ç®¡ç†è¿›è¡Œçš„ä¼˜åŒ–å’Œç®€åŒ–ï¼Œå®ƒå¯ä»¥å†³å®šä¸€ä¸ªå˜é‡æ˜¯åˆ†é…åˆ°æ ˆä¸Šè¿˜æ˜¯å †ä¸Š\n\n\n\n### é€ƒé€¸ç­–ç•¥\n\nå¦‚æœä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªå˜é‡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‘ç”Ÿé€ƒé€¸\n\nç¼–è¯‘å™¨æ ¹æ®å˜é‡æ˜¯å¦è¢«å¤–éƒ¨å¼•ç”¨æ¥å†³å®šæ˜¯å¦é€ƒé€¸\n\n>   -   å¦‚æœå‡½æ•°å¤–éƒ¨æ²¡æœ‰å¼•ç”¨ï¼Œåˆ™ä¼˜å…ˆæ”¾åˆ°æ ˆä¸­ï¼ˆä¸æ˜¯ä¸€å®šæ”¾åœ¨æ ˆä¸­ï¼‰\n>   -   å¦‚æœå‡½æ•°å¤–éƒ¨å­˜åœ¨å¼•ç”¨ï¼Œåˆ™å¿…å®šæ”¾åœ¨å †ä¸­\n\n\n\n#### è§£è¯»\n\n-   å‡½æ•°å¤–éƒ¨æ²¡æœ‰å¼•ç”¨ï¼Œåˆ™ä¼˜å…ˆæ”¾åœ¨æ ˆä¸­\n\n    >   æ ˆç©ºé—´\n    >\n    >   ä¼˜ç‚¹ï¼šæ ˆå†…å­˜çš„åˆ†é…éå¸¸çš„å¿«ï¼Œåªéœ€è¦ä¸¤ä¸ª`CPU`æŒ‡ä»¤â€”â€”`PUSH`å’Œ`RELEASE`ï¼Œå¯¹åº”åˆ†é…å’Œé‡Šæ”¾ï¼Œæ ˆä¼šåœ¨å‡½æ•°è°ƒç”¨ç»“æŸåè‡ªåŠ¨å›æ”¶\n    >\n    >   ç¼ºç‚¹ï¼šæ ˆç©ºé—´æœ‰é™ï¼Œä¸åƒå †ä¸€æ ·ç©ºé—´å……è¶³ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸å­˜åœ¨å¤–éƒ¨å¼•ç”¨çš„æƒ…å†µä¸‹ä¹Ÿåªæ˜¯ä¼˜å…ˆæ ˆï¼Œè€Œä¸æ˜¯ç»å¯¹åˆ†é…åœ¨æ ˆä¸Šï¼Œå¯¹äºé‚£äº›ä¸å¯é¢„çŸ¥å¤§å°çš„å˜é‡ï¼Œä¾ç„¶è¦åˆ†é…åœ¨å †ä¸Š\n    >\n    >   \n    >\n    >   å †ç©ºé—´\n    >\n    >   ä¼˜ç‚¹ï¼šå †ç©ºé—´å……è¶³ï¼ˆç›¸è¾ƒäºæ ˆç©ºé—´è€Œè¨€ï¼‰\n    >\n    >   ç¼ºç‚¹ï¼šå †ä¸åƒæ ˆé‚£æ ·å¯ä»¥è‡ªåŠ¨æ¸…ç†ï¼Œåœ¨`C`ã€`C++`è¿™ç±»æ²¡æœ‰`GC`æœºåˆ¶çš„è¯­è¨€ä¸­å°±å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾å†…å­˜ï¼Œå¦åˆ™å®¹æ˜“å‘ç”Ÿå†…å­˜æ³„æ¼\n\n-   å¦‚æœå‡½æ•°å¤–éƒ¨å­˜åœ¨å¼•ç”¨ï¼Œåˆ™å¿…å®šæ”¾åœ¨å †ä¸­\n\n    å½“å¤–éƒ¨å­˜åœ¨å¼•ç”¨æ—¶ï¼Œå°†å˜é‡åˆ†é…åˆ°æ ˆä¸ŠåŠ¿å¿…ä¼šå‡ºç°æ‚¬æŒ‚æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ç±»å˜é‡å¿…é¡»åˆ†é…åˆ°å †ä¸­\n\n\n\né€šè¿‡é€ƒé€¸åˆ†æï¼Œä»ä»£ç å±‚é¢åˆ†æåå°½é‡å°†é‚£äº›ä¸éœ€è¦åˆ†é…åˆ°å †ä¸Šçš„å˜é‡ç›´æ¥åˆ†é…åˆ°æ ˆä¸Šï¼Œå †ä¸Šçš„å˜é‡å°‘äº†ï¼Œä¼šå‡è½»åˆ†é…å †å†…å­˜çš„å¼€é”€ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘`GC`çš„å‹åŠ›ï¼Œæé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦\n\n\n\n### å¦‚ä½•æŸ¥çœ‹é€ƒé€¸åˆ†æç»“æœ\n\næ¯”å¦‚ä»¥ä¸‹ä»£ç æ —å­ğŸŒ°\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc foo() *int {\n\tt := 3\n\treturn &t;\n}\n\nfunc main() {\n\tx := foo()\n\tfmt.Println(*x)\n}\n```\n\n\n\n#### æŸ¥çœ‹ç¼–è¯‘æ—¶çš„è¾“å‡ºç»“æœ\n\nä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘å¯ä»¥çŸ¥é“é€ƒé€¸åˆ†æçš„ç»“æœ\n\n```go\ngo build -gcflags '-m -l' main.go\n```\n\n>   `-gcflags`ï¼šæ˜¯`Go`ç¼–è¯‘å™¨é€‰é¡¹ï¼Œå…·ä½“æœ‰å“ªäº›é€‰é¡¹åŠå«ä¹‰å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹\n>\n>   ```go\n>   go tool compile -h\n>   ```\n>\n>   å‘½ä»¤è¾“å‡º\n>\n>   ```bash\n>   usage: compile [options] file.go...\n>   ...\n>    -l    disable inlining\n>    -m    print optimization decisions\n>   ...\n>   ```\n>\n>   `-l`ï¼šå…³é—­å†…è”ä¼˜åŒ–\n>\n>   `-m`ï¼šæ‰“å°ä¼˜åŒ–å†³ç­–ç»“æœ\n\n\n\n![1711871015189](é€ƒé€¸åˆ†æ.assets/1711871015189.png)\n\n\n\n#### æŸ¥çœ‹æ±‡ç¼–ä»£ç \n\nä¹Ÿå¯ä»¥é€šè¿‡æ±‡ç¼–ä»£ç çŸ¥é“é€ƒé€¸åˆ†æçš„ç»“æœ\n\n```go\ngo tool compile -S escape_analysis.go\n```\n\n\n\n![1711871320525](é€ƒé€¸åˆ†æ.assets/1711871320525.png)\n\nè¿™é‡Œè¯´æ˜`t`æ˜¯é€šè¿‡`runtime.newobject()`åœ¨å †ä¸Šåˆ†é…çš„å¯¹è±¡\n\n\n\n\n\n### å¸¸è§çš„é€ƒé€¸åœºæ™¯\n\n#### æŒ‡é’ˆé€ƒé€¸\n\næœ€å…¸å‹çš„ä¸€ç§åœºæ™¯ï¼Œå½“å‡½æ•°å¤–éƒ¨å­˜åœ¨å¯¹å‡½æ•°å†…å˜é‡çš„å¼•ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œå°†å˜é‡åˆ†é…åˆ°å †ä¸Šï¼ˆä¸ç„¶ä¸å°±å‡ºç°æ‚¬æŒ‚æŒ‡é’ˆäº†å˜›ï¼‰\n\nçœ‹ä¸€æ®µå¹³æ—¶æœ€å¸¸è§çš„æŒ‡é’ˆé€ƒé€¸ä»£ç \n\n```go\npackage main\n\ntype Student struct {\n    Name string\n    Age  int\n}\n\nfunc NewStudent(name string, age int) *Student {\n    return &Student{\n        Name: name,\n        Age:  age,\n    }\n}\n\nfunc main() {\n    NewStudent(\"Crayon\", 24)\n}\n```\n\nè¿™æ®µä»£ç çš„æ„ä¹‰å¾ˆç®€å•ï¼Œå°±æ˜¯æä¾›äº†ä¸€ä¸ª`NewStudent`çš„åˆ›å»ºè€…å‡½æ•°ï¼Œæœ‰æ—¶å€™ä¸ºäº†é¿å…å¤§ç»“æ„ä½“ä½œä¸ºå‡½æ•°å‡ºå…¥å‚æ—¶çš„å€¼æ‹·è´çš„æ€§èƒ½å¼€é”€ï¼Œä¼šä½¿ç”¨æŒ‡é’ˆç±»å‹çš„ç»“æ„ä½“\n\n`NewStudent`å‡½æ•°å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ª`Student`ç»“æ„ä½“ï¼Œå¹¶å°†è¯¥ç»“æ„ä½“æŒ‡é’ˆè¿”å›ç»™å¤–éƒ¨ï¼Œ`Go`ç¼–è¯‘å™¨è®¤ä¸ºè¿™æ˜¯ä¸€ç§æŒ‡é’ˆé€ƒé€¸è¡Œä¸ºï¼Œéœ€è¦å°†å˜é‡åˆ†é…åˆ°å †ä¸Šä»¥é¿å…æ‚¬æŒ‚æŒ‡é’ˆçš„é—®é¢˜çš„äº§ç”Ÿï¼Œå°½ç®¡å‡½æ•°å¤–éƒ¨ï¼ˆ`main`å‡½æ•°ï¼‰ä¸­ç›®å‰è¿˜æ²¡æœ‰ä½¿ç”¨åˆ°`NewStudent`å‡½æ•°è¿”å›çš„ç»“æ„ä½“æŒ‡é’ˆ\n\n\n\n#### æ ˆç©ºé—´ä¸è¶³é€ƒé€¸\n\næ ˆçš„ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥å½“å˜é‡æ‰€éœ€è¦çš„å†…å­˜å¤§å°è¶…è¿‡æ ˆæ‰€èƒ½åˆ†é…çš„ç©ºé—´çš„æ—¶å€™ï¼Œå°±ä¼šå°†å˜é‡åˆ†é…åˆ°å †ä¸Š\n\n```go\npackage main\n\nfunc Slice() {\n    s := make([]int, 0, 1000)\n\n    for i, _ := range s {\n        s[i] = i\n    }\n}\n\nfunc main() {\n    Slice()\n}\n```\n\næŸ¥çœ‹ç¼–è¯‘çš„ç»“æœï¼Œæ­¤æ—¶å¹¶ä¸ä¼šå‘ç”Ÿé€ƒé€¸\n\n![1711876383880](é€ƒé€¸åˆ†æ.assets/1711876383880.png)\n\n\n\nä½†æ˜¯æˆ‘ä»¬åŠ å¤§åˆ‡ç‰‡çš„å®¹é‡å¤§å°ï¼Œå°±ä¼šå‘ç”Ÿé€ƒé€¸\n\n```go\npackage main\n\nfunc Slice() {\n    s := make([]int, 0, 10000)\n\n    for i, _ := range s {\n        s[i] = i\n    }\n}\n\nfunc main() {\n    Slice()\n}\n```\n\nå°†åˆ‡ç‰‡å®¹é‡æ‰©å¤§åˆ°10000ï¼Œæ­¤æ—¶å†æ‰§è¡Œç¼–è¯‘ï¼Œå¯ä»¥çœ‹åˆ°å‘ç”Ÿäº†é€ƒé€¸\n\n![1711876465962](é€ƒé€¸åˆ†æ.assets/1711876465962.png)\n\n\n\n##### å®¹é‡æœªçŸ¥ä¹Ÿä¼šå¯¼è‡´å¯¼è‡´\n\nå½“åˆ‡ç‰‡çš„å®¹é‡ä¸ºå˜é‡ï¼ˆå³ç¼–è¯‘æœŸè¿˜æ˜¯æœªçŸ¥çš„ï¼‰çš„æ—¶å€™ï¼Œä¹Ÿä¼šå‘ç”Ÿé€ƒé€¸\n\n```go\npackage main\n\nimport \"math/rand\"\n\nfunc Slice() {\n    n := rand.Intn(10)\n    _ = make([]int, n)\n}\n\nfunc main() {\n    Slice()\n}\n```\n\n\n\n![1712202550858](é€ƒé€¸åˆ†æ.assets/1712202550858.png)\n\n\n\n#### é—­åŒ…å¼•ç”¨å¯¹è±¡é€ƒé€¸\n\n```go\npackage main\n\nfunc Fibonacci() func() int {\n    a, b := 0, 1\n    return func() int {\n        a, b = b, a+b\n        return a\n    }\n}\n\nfunc main() {\n    f := Fibonacci()\n    for i := 0; i < 10;i++ {\n        f()\n    }\n}\n```\n\n\n\n![1711877883619](é€ƒé€¸åˆ†æ.assets/1711877883619.png)\n\nå¯è§å‡½æ•°å†…éƒ¨`a`ã€`b`éƒ½å‘ç”Ÿäº†é€ƒé€¸\n\n\n\n#### åŠ¨æ€ç±»å‹é€ƒé€¸ï¼Ÿ\n\nè¿™å—åº”è¯¥æ˜¯æœ‰ä¸€å®šçš„è¯¯åŒºï¼Œè‡³å°‘æˆ‘åœ¨`1.17`ç‰ˆæœ¬æµ‹è¯•æ—¶ï¼Œç©ºæ¥å£ç±»å‹çš„å‚æ•°ä¸ä¼šå‘ç”Ÿé€ƒé€¸\n\n```go\npackage main\n\nfunc test(v interface{}) interface{} {\n    return v\n}\n\nfunc main() {\n    s := \"Crayon\"\n    test(s)\n}\n```\n\nè¿™é‡Œ`test`å‡½æ•°çš„å…¥å‚æ˜¯ç©ºæ¥å£ï¼ˆåŠ¨æ€ç±»å‹ï¼‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å‘ç”Ÿé€ƒé€¸\n\n\n\nä½†æ˜¯ä½¿ç”¨`fmt.Println`å‡½æ•°æ—¶å°±ä¼šå‘ç”Ÿé€ƒé€¸\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc test(v interface{}) interface{} {\n    return v\n}\n\nfunc main() {\n    s := \"Crayon\"\n    // test(s)\n    fmt.Println(s)\n}\n```\n\n\n\nä½¿ç”¨`fmt.Println`æ‰“å°å˜é‡å°±å‘ç”Ÿäº†é€ƒé€¸\n\n![1711879475952](é€ƒé€¸åˆ†æ.assets/1711879475952.png)\n\n\n\nåˆ†æ`fmt.Println`çš„æºç ï¼Œå‚è€ƒå…¶ä»–æ–‡ç« å‘ç°ä¸€ä¸ªæœ‰æ„æ€çš„ç‚¹\n\né‚£å°±æ˜¯`reflect`ç³»åˆ—çš„æ–¹æ³•ï¼Œå¦‚`reflect.ValueOf`ï¼Œè°ƒç”¨è¯¥ç±»æ–¹æ³•ä¼šè§¦å‘é€ƒé€¸\n\n\n\n```go\npackage main\n\nimport \"reflect\"\n\nfunc main() {\n    s := \"Crayon\"\n    reflect.TypeOf(s)\n    reflect.TypeOf(s).Kind()\n    reflect.ValueOf(s)\n    reflect.ValueOf(s).Kind()\n}\n```\n\n\n\n![1712207034963](é€ƒé€¸åˆ†æ.assets/1712207034963.png)\n\n\n\n##### `reflect.ValueOf`å¯¼è‡´é€ƒé€¸ï¼Ÿ\n\nè¿™é‡Œå…ˆçœ‹ä¸‹`reflect.ValueOf`å‡½æ•°ï¼Œç‚¹è¿›æºç å°±èƒ½ç›´æ¥çœ‹åˆ°ä¸ºä»€ä¹ˆé€ƒé€¸äº†\n\n![1712207129918](é€ƒé€¸åˆ†æ.assets/1712207129918.png)\n\næ˜¾ç¤ºçš„è°ƒç”¨`escapes`å‡½æ•°è®©å˜é‡é€ƒé€¸ï¼Œè¿™é‡Œæ˜¯æœ‰æ„ä¸ºä¹‹ï¼Œå…·ä½“ä¸ºä»€ä¹ˆæœ‰å¾…æ·±å…¥ç ”ç©¶ä¸‹ï¼Œè¿™é‡Œå°±ä¸å¾€ä¸‹å±•å¼€äº†\n\n\n\n##### `reflect.TypeOf`å¯¼è‡´é€ƒé€¸ï¼Ÿ\n\nä»å®éªŒçš„ç»“æœæ¥çœ‹ï¼Œåªæ˜¯è°ƒç”¨`reflect.TypeOf`å‡½æ•°å¹¶ä¸ä¼šè§¦å‘é€ƒé€¸ï¼Œè€Œæ˜¯åœ¨æ¥ç€è°ƒç”¨`Type`æ¥å£ï¼ˆ`reflect.TypeOf`å‡½æ•°çš„è¿”å›å€¼ï¼‰çš„æ–¹æ³•çš„æ—¶å€™æ‰ä¼šå‘ç”Ÿé€ƒé€¸\n\n![1712207287284](é€ƒé€¸åˆ†æ.assets/1712207287284.png)\n\næŸ¥çœ‹`TypeOf`çš„æºç ï¼Œç®€å•ç”»äº†ä¸€ä¸‹æ¶‰åŠçš„å‡ ä¸ªç»“æ„ä½“/æ¥å£çš„ç±»å›¾\n\n![1712208272189](é€ƒé€¸åˆ†æ.assets/1712208272189.svg)\n\n`Type`æ˜¯ä¸€ä¸ªé¡¶å±‚çš„æ¥å£ï¼Œ`rtype`æ˜¯`Type`æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œ`emptyInterface`å’Œ`rtype`åˆ™æ˜¯ç»„åˆçš„å…³ç³»ï¼Œå­˜åœ¨ä¸€ä¸ª`typ`çš„æˆå‘˜å˜é‡å¼•ç”¨`rtype`\n\n![1712208451934](é€ƒé€¸åˆ†æ.assets/1712208451934.png)\n\n`toType`çš„å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯å°†å…·ä½“å®ç°è½¬åŒ–æˆæ›´æŠ½è±¡çš„æ¥å£ç±»å‹\n\n\n\n###### åœºæ™¯å¤ç°\n\nåˆ†åˆ«æ¨¡æ‹Ÿäº†`reflect.TypeOf`å‡½æ•°çš„æºç è¡Œä¸ºä»¥åŠç»“æ„ä½“æŠ½è±¡æˆæ¥å£çš„æ–¹æ³•è°ƒç”¨çš„åœºæ™¯\n\n```go\npackage main\n\nimport \"unsafe\"\n\ntype MyInterface interface {\n    Do()\n}\n\ntype Pointer struct {\n}\n\nfunc (s *Pointer) Do() {\n\n}\n\nfunc Pointer2MyInterface(s *Pointer) MyInterface {\n    return s\n}\n\ntype emptyInterface struct {\n    typ  *Pointer\n    word unsafe.Pointer\n}\n\nfunc TypeOf(i interface{}) MyInterface {\n    eface := (*emptyInterface)(unsafe.Pointer(&i))\n    return Pointer2MyInterface(eface.typ)\n}\n\nfunc TypeOf0(i interface{}) *Pointer {\n    eface := (*emptyInterface)(unsafe.Pointer(&i))\n    return eface.typ\n}\n\nfunc TypeOf1(i interface{}) Pointer {\n    eface := (*emptyInterface)(unsafe.Pointer(&i))\n    return *eface.typ\n}\n\nfunc main() {\n    p1 := Pointer{}\n    TypeOf(p1)\n    TypeOf(p1).(*Pointer).Do()\n    TypeOf(p1).Do()\n\n    TypeOf0(p1)\n    TypeOf0(p1).Do()\n\n    TypeOf1(p1)\n    pp1 := TypeOf1(p1)\n    pp1.Do()\n\n    p2 := &Pointer{}\n    Pointer2MyInterface(p2)\n\n    p3 := &Pointer{}\n    Pointer2MyInterface(p3).Do()\n\n    p4 := &Pointer{}\n    Pointer2MyInterface(p4).(*Pointer).Do()\n}\n```\n\né€ƒé€¸åˆ†æç»“æœ\n\n```bash\n$ go tool compile -m -l escape_analysis.go\nescape_analysis.go:12:7: s does not escape\nescape_analysis.go:16:26: leaking param: s to result ~r1 level=0\nescape_analysis.go:25:13: leaking param: i to result ~r1 level=0\nescape_analysis.go:30:14: leaking param: i to result ~r1 level=0\nescape_analysis.go:35:14: i does not escape\nescape_analysis.go:42:11: p1 does not escape\nescape_analysis.go:43:11: p1 does not escape\nescape_analysis.go:44:11: p1 escapes to heap\nescape_analysis.go:46:12: p1 does not escape\nescape_analysis.go:47:12: p1 does not escape\nescape_analysis.go:49:12: p1 does not escape\nescape_analysis.go:50:19: p1 does not escape\nescape_analysis.go:53:11: &Pointer{} does not escape\nescape_analysis.go:56:11: &Pointer{} escapes to heap\nescape_analysis.go:59:11: &Pointer{} does not escape\n<autogenerated>:1: leaking param: .this\n```\n\n\n\n###### ç»“è®º\n\nä»é€ƒé€¸åˆ†æçš„ç»“æœå¯ä»¥è¯´æ˜ï¼Œæ¥å£æ–¹æ³•çš„è°ƒç”¨ä¼šå¯¼è‡´é€ƒé€¸\n\nå¤§æ¦‚çš„åŸå› å¯èƒ½æ˜¯æ¥å£å±äºåŠ¨æ€çš„ç±»å‹ï¼Œåªè¦å®ç°äº†æ¥å£çš„ç»“æ„ä½“éƒ½å¯èƒ½æ˜¯ç»“æ„ä½“çš„å®ç°ï¼Œè€Œç¼–è¯‘æœŸé—´æˆ‘ä»¬å¹¶ä¸èƒ½çŸ¥é“è°ƒç”¨æ–¹æ³•çš„å˜é‡å±äºå“ªç±»å®ç°ï¼Œä¸ºé¿å…æŒ‡é’ˆå¼•ç”¨ä»¥åŠæ ˆç©ºé—´å¤§å°å¯èƒ½ä¸è¶³çš„é—®é¢˜ï¼Œå°±ç›´æ¥å°†å˜é‡é€ƒé€¸åˆ†é…åˆ°å †ä¸Šäº†\n\n\n\n\n\n#### sliceã€mapã€chanå…ƒç´ ä¸ºæŒ‡é’ˆç±»å‹ï¼Œå…ƒç´ é€ƒé€¸\n\n```go\npackage main\n\nfunc main() {\n    s1 := make([]*string, 0, 10)\n    str1 := \"str1\"\n    s1 = append(s1, &str1)\n\n    s2 := make([]string, 0, 10)\n    str2 := \"str2\"\n    s2 = append(s2, str2)\n\n    m1 := make(map[*string]string, 8)\n    mkey1 := \"mkey1\"\n    mvalue1 := \"mvalue1\"\n    m1[&mkey1] = mvalue1\n\n    m2 := make(map[string]*string, 8)\n    mkey2 := \"mkey2\"\n    mvalue2 := \"mvalue2\"\n    m2[mkey2] = &mvalue2\n\n    m3 := make(map[*string]*string, 8)\n    mkey3 := \"mkey3\"\n    mvalue3 := \"mvalue3\"\n    m3[&mkey3] = &mvalue3\n\n    m4 := make(map[string]string, 8)\n    mkey4 := \"mkey4\"\n    mvalue4 := \"mvalue4\"\n    m4[mkey4] = mvalue4\n\n    ch1 := make(chan *string, 10)\n    chStr1 := \"chStr1\"\n    ch1 <- &chStr1\n\n    ch2 := make(chan string, 10)\n    chStr2 := \"chStr2\"\n    ch2 <- chStr2\n}\n```\n\né€ƒé€¸åˆ†æç»“æœ\n\n```bash\n$ go tool compile -m -l escape_analysis.go\nescape_analysis.go:5:5: moved to heap: str1\nescape_analysis.go:13:5: moved to heap: mkey1\nescape_analysis.go:19:5: moved to heap: mvalue2\nescape_analysis.go:23:5: moved to heap: mkey3\nescape_analysis.go:24:5: moved to heap: mvalue3\nescape_analysis.go:33:5: moved to heap: chStr1\nescape_analysis.go:4:15: make([]*string, 0, 10) does not escape\nescape_analysis.go:8:15: make([]string, 0, 10) does not escape\nescape_analysis.go:12:15: make(map[*string]string, 8) does not escape\nescape_analysis.go:17:15: make(map[string]*string, 8) does not escape\nescape_analysis.go:22:15: make(map[*string]*string, 8) does not escape\nescape_analysis.go:27:15: make(map[string]string, 8) does not escape\n```\n\n\n\nç»“è®ºï¼šæŒ‡é’ˆç±»å‹å…ƒç´ ä¼šå‘ç”Ÿé€ƒé€¸\n\n\n\n### æ¡ˆä¾‹åˆ†æ\n\n#### æ¡ˆä¾‹ä¸€\n\n```go\npackage main\ntype S struct {}\n\nfunc main() {\n  var x S\n  _ = identity(x)\n}\n\nfunc identity(x S) S {\n  return x\n}\n```\n\n\n\n{% hideBlock æŸ¥çœ‹åˆ†æ %}\n\n{% label æ²¡æœ‰å‘ç”Ÿé€ƒé€¸ green %}\n\nç”±äº`Go`è¯­è¨€ä¸­å‚æ•°æ˜¯å€¼ä¼ é€’ï¼Œè¾“å…¥è¾“å‡ºéƒ½æ˜¯å€¼æ‹·è´ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ä¼šå‘ç”Ÿé€ƒé€¸ï¼Œå˜é‡`x`è¿˜æ˜¯åˆ†é…åœ¨æ ˆä¸Š\n\n{% endhideBlock %}\n\n\n\n#### æ¡ˆä¾‹äºŒ\n\n```go\npackage main\n\ntype S struct {}\n\nfunc main() {\n  var x S\n  y := &x\n  _ = identity(y)\n}\n\nfunc identity(z *S) *S {\n  return z\n}\n```\n\n\n\n{% hideBlock æŸ¥çœ‹åˆ†æ %}\n\n{% label æ²¡æœ‰å‘ç”Ÿé€ƒé€¸ green %}\n\nå˜é‡`x`è¢«å˜é‡`y`å¼•ç”¨ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰è¶…å‡º`main`å‡½æ•°çš„ä½œç”¨åŸŸï¼Œæ‰€ä»¥æ²¡æœ‰å‘ç”Ÿé€ƒé€¸\n\nè€Œ`identity`å‡½æ•°è¾“å…¥ç›´æ¥ä½œä¸ºè¿”å›å€¼è¿”å›ï¼Œæ²¡æœ‰å°†å˜é‡`z`çš„å¼•ç”¨è¿”å›åˆ°å‡½æ•°å¤–éƒ¨ï¼Œæ‰€ä»¥å˜é‡`z`æ²¡æœ‰å‘ç”Ÿé€ƒé€¸\n\n{% endhideBlock %}\n\n\n\n#### æ¡ˆä¾‹ä¸‰\n\n```go\npackage main\n\ntype S struct {\n  M *int\n}\n\nfunc main() {\n  var i int\n  refStruct(i)\n}\n\nfunc refStruct(y int) (z S) {\n  z.M = &y\n  return z\n}\n```\n\n\n\n{% hideBlock æŸ¥çœ‹åˆ†æ %}\n\n{% label å‘ç”Ÿé€ƒé€¸ orange %}\n\nå˜é‡`y`å±äº`refStruct`å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼ˆå½¢å‚ï¼‰ï¼Œå°†`y`çš„å¼•ç”¨èµ‹ç»™`z.M`è¿™ä¸ªç»“æ„ä½“å†…çš„å˜é‡å†è¿”å›ç»™å‡½æ•°å¤–éƒ¨ï¼Œå‡½æ•°å¤–éƒ¨æƒ³è¦è®¿é—®`M`ï¼ˆè·å–`M`å¼•ç”¨åœ°å€å¯¹åº”çš„å€¼ï¼‰ï¼Œ`y`å°±ä¸èƒ½åˆ†é…åœ¨æ ˆä¸Šï¼Œå¿…é¡»é€ƒé€¸åˆ†é…åˆ°å †ä¸Š\n\n{% endhideBlock %}\n\n\n\n### æ€»ç»“\n\n-   æ ˆä¸Šåˆ†é…å†…å­˜æ¯”åœ¨å †ä¸­åˆ†é…å†…å­˜æœ‰æ›´é«˜çš„æ•ˆç‡\n-   æ ˆä¸Šåˆ†é…çš„å†…å­˜ä¸éœ€è¦`GC`å¤„ç†ï¼Œå›æ”¶çš„æ•ˆç‡é«˜ï¼ˆç”¨å®Œå³å›æ”¶ï¼‰\n-   å †ä¸Šåˆ†é…çš„å†…å­˜ä½¿ç”¨å®Œæ¯•ä¼šäº¤ç»™`GC`å¤„ç†\n-   é€ƒé€¸åˆ†æçš„ç›®çš„æ˜¯å†³å®šå†…å­˜åˆ†é…åœ¨æ ˆè¿˜æ˜¯å †ä¸Šï¼Œæ­£ç¡®çš„å†…å­˜æ–¹å¼èƒ½å¤Ÿæé«˜åˆ†é…æ•ˆç‡å’Œå›æ”¶æ•ˆç‡ï¼Œæå‡ç¨‹åºæ€§èƒ½\n-   `Go`è¯­è¨€é€ƒé€¸åˆ†æåœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆ\n\n\n\n### å‚è€ƒèµ„æ–™\n\n>   [Go è¯­è¨€çš„æ ˆå†…å­˜å’Œé€ƒé€¸åˆ†æ | Go è¯­è¨€è®¾è®¡ä¸å®ç° (draveness.me)](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-stack-management/)\n>\n>   [é€ƒé€¸åˆ†ææ˜¯æ€ä¹ˆè¿›è¡Œçš„ | Go ç¨‹åºå‘˜é¢è¯•ç¬”è¯•å®å…¸ (golang.design)](https://golang.design/go-questions/compile/escape/)\n>\n>   [golangçš„fmtåŒ…å¼•å‘çš„å˜é‡é€ƒé€¸åˆ°å †çš„é—®é¢˜_golang fmt.sprintf out of memory-CSDNåšå®¢](https://blog.csdn.net/weixin_44531174/article/details/116173347)\n>\n>   [golangå˜é‡é€ƒé€¸åˆ†æå°æ¢ - å£°zzz (reusee.github.io)](https://reusee.github.io/post/escape_analysis/)\n>\n>   [é€šè¿‡å®ä¾‹ç†è§£Goé€ƒé€¸åˆ†æ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/374991282)\n>\n>   [é€šè¿‡å®ä¾‹ç†è§£Goé€ƒé€¸åˆ†æ | Tony Bai](https://tonybai.com/2021/05/24/understand-go-escape-analysis-by-example/)","tags":["Golang","ç¼–ç¨‹è¯­è¨€"],"categories":["ç¼–ç¨‹è¯­è¨€","Golang"]},{"title":"Golang-æ•°ç»„ä¸åˆ‡ç‰‡","url":"/posts/a8e92d53/","content":"\n\n\n## æ•°ç»„ä¸åˆ‡ç‰‡\n\n### æ•°ç»„ä¸åˆ‡ç‰‡æœ‰ä»€ä¹ˆå¼‚åŒ\n\nåˆ‡ç‰‡çš„åº•å±‚æ•°æ®å°±æ˜¯æ•°ç»„ï¼Œæ˜¯å¯¹æ•°ç»„çš„å°è£…ï¼Œæè¿°ä¸€ä¸ªæ•°ç»„çš„ç‰‡æ®µ\n\nç›¸åŒç‚¹åœ¨äºä¸¤è€…éƒ½æ˜¯å¯¹é¡ºåºæ•°æ®ç»“æ„çš„ä¸€ç§è¡¨è¾¾ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡æ¥è®¿é—®å…ƒç´ \n\n\n\n**æ•°ç»„**\n\næ•°ç»„æ˜¯å®šé•¿çš„ï¼Œåœ¨åˆå§‹åŒ–ä¹‹åå°±æ— æ³•æ”¹å˜\n\n`Go`è¯­è¨€ä¸­åªæœ‰**å­˜å‚¨å…ƒç´ ç±»å‹**å’Œ**æ•°ç»„å¤§å°**éƒ½ç›¸åŒæ‰è®¤ä¸ºæ˜¯åŒä¸€ç±»å‹\n\n\n\n**åˆ‡ç‰‡**\n\nåˆ‡ç‰‡å¯ä»¥ç†è§£ä¸ºæ˜¯åŠ¨æ€æ•°ç»„ï¼Œåˆ‡ç‰‡çš„ç±»å‹ä¸é•¿åº¦æ— å…³\n\n\n\næ•°ç»„å°±æ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ï¼Œåˆ‡ç‰‡å®é™…ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«ä¸‰ä¸ªå­—æ®µï¼šé•¿åº¦ã€å®¹é‡ã€åº•å±‚æ•°ç»„æŒ‡é’ˆ\n\n\n\n```go\n// runtime/slice.go\ntype slice struct {\n    // åº•å±‚æ•°ç»„çš„æŒ‡é’ˆ\n\tarray unsafe.Pointer\n    // é•¿åº¦\n\tlen   int\n    // å®¹é‡\n\tcap   int\n}\n```\n\n\n\n`slice`ç»“æ„ç¤ºæ„å›¾\n\n![1711180039754](æ•°ç»„ä¸åˆ‡ç‰‡/1711180039754.png)\n\n\n\n{% note warning %}\n\nåº•å±‚æ•°ç»„æ˜¯å¯ä»¥è¢«å¤šä¸ª`slice`åŒæ—¶å¼•ç”¨çš„ï¼Œå› æ­¤ï¼Œå¯¹ä¸€ä¸ª`slice`çš„å…ƒç´ è¿›è¡Œæ“ä½œå¯èƒ½å½±å“å…¶ä»–`slice`\n\n{% endnote %}\n\n\n\n#### ä»£ç åˆ†æ\n\n\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n\tslice := []int{0, 1, 2, 3, 4, 5, 6, 7, 8, 9}\n\ts1 := slice[2:5]\n\ts2 := s1[2:6:7]\n\n\ts2 = append(s2, 100)\n\ts2 = append(s2, 200)\n\n\ts1[2] = 20\n\n\tfmt.Println(s1)\n\tfmt.Println(s2)\n\tfmt.Println(slice)\n}\n```\n\nä»¥ä¸Šä»£ç çš„è¾“å‡ºç»“æœ\n\n{% hideBlock æŸ¥çœ‹ç­”æ¡ˆ %}\n\n```\n[2 3 20]\n[4 5 6 7 100 200]\n[0 1 2 3 20 5 6 7 100 9]\n```\n\n{% endhideBlock %}\n\n\n\n### ç‰¹æ®Šåˆ‡ç‰‡\n\næ ¹æ®æ•°ç»„æˆ–åˆ‡ç‰‡ç”Ÿæˆæ–°çš„åˆ‡ç‰‡ä¸€èˆ¬ä½¿ç”¨ä»¥ä¸‹æ–¹å¼\n\n```go\nslice := array[start:end]\n```\n\nè¿™ç§ç”Ÿæˆæ–¹å¼æ²¡æœ‰æŒ‡å®šåˆ‡ç‰‡çš„å®¹é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ‡ç‰‡å®¹é‡å°±æ˜¯ä»`start`å¼€å§‹ä¸€ç›´åˆ°`array`ç»“æŸ\n\nä»£ç ç¤ºä¾‹\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n    arr := [5]int{0, 1, 2, 3, 4}\n    s1 := arr[2:4]\n    fmt.Printf(\"s1: %v, len(s1): %d, cap(s1): %d\\n\", s1, len(s1), cap(s1))\n}\n```\n\nä»¥ä¸Šä»£ç è¿è¡Œç»“æœ\n\n{% hideToggle è¿è¡Œç»“æœ %}\n\n```\ns1: [2 3], len(s1): 2, cap(s1): 3\n```\n\n{% endhideToggle %}\n\n\n\næ ¹æ®æ•°ç»„æˆ–åˆ‡ç‰‡ç”Ÿæˆåˆ‡ç‰‡è¿˜æœ‰å¦ä¸€ç§å†™æ³•ï¼Œå³åˆ‡ç‰‡çš„åŒæ—¶ä¹ŸæŒ‡å®šå®¹é‡\n\n```go\nslice := array[start:end:max]\n```\n\nåˆ‡ç‰‡é•¿åº¦å’Œå®¹é‡çš„è®¡ç®—å…¬å¼å¦‚ä¸‹\n\n`len(slice)==end-start`\n\n`cap(slice)==max-start`\n\nä¸‰ä¸ªå‚æ•°ä¹‹é—´æ»¡è¶³ä»¥ä¸‹å…³ç³»\n\n`start<=end<=max<=len(arr)-1`\n\n`max`çš„å€¼å¿…é¡»å¤§äºç­‰äº`end`ä¸”ä¸èƒ½å¤§äºåº•å±‚æ•°ç»„çš„ç´¢å¼•æœ€å¤§å€¼\n\nä»£ç ç¤ºä¾‹\n\n```go\npackage main\n\nimport \"fmt\"\n\nfunc main() {\n    arr := [5]int{0, 1, 2, 3, 4}\n    s1 := arr[2:4:5]\n    // 6å¤§äºæ•°ç»„çš„ç´¢å¼•æœ€å¤§å€¼ï¼Œè¿™é‡Œç¼–è¯‘æœŸå°±ä¼šæŠ¥é”™\n    // s2 := arr[2:4:6]\n    fmt.Printf(\"s1: %v, len(s1): %d, cap(s1): %d\\n\", s1, len(s1), cap(s1))\n\n    s1 = make([]int, 0, 10)\n    s1 = append(s1, 0, 1, 2, 3, 4)\n    // s1åº•å±‚æ•°ç»„é•¿åº¦ï¼Œå³capä¸º10ï¼Œæ‰€ä»¥8æ²¡æœ‰é—®é¢˜\n    s2 := s1[2:4:8]\n    fmt.Printf(\"s2: %v, len(s2): %d, cap(s2): %d\\n\", s2, len(s2), cap(s2))\n}\n\n```\n\n\n\n{% hideToggle è¿è¡Œç»“æœ %}\n\n```\ns1: [2 3], len(s1): 2, cap(s1): 3\ns2: [2 3], len(s2): 2, cap(s2): 6\n```\n\n{% endhideToggle %}\n\n\n\n### åˆ‡ç‰‡æ‰©å®¹\n\n\n\n#### 1.17åŠä¹‹å‰çš„ç‰ˆæœ¬\n\n```go\n// runtime/slice.go\n// growslice handles slice growth during append.\n// It is passed the slice element type, the old slice, and the desired new minimum capacity,\n// and it returns a new slice with at least that capacity, with the old data\n// copied into it.\n// ...\nfunc growslice(et *_type, old slice, cap int) slice {\n    // ...\n    newcap := old.cap\n\tdoublecap := newcap + newcap\n\tif cap > doublecap {\n\t\tnewcap = cap\n\t} else {\n\t\tif old.cap < 1024 {\n\t\t\tnewcap = doublecap\n\t\t} else {\n\t\t\t// Check 0 < newcap to detect overflow\n\t\t\t// and prevent an infinite loop.\n\t\t\tfor 0 < newcap && newcap < cap {\n\t\t\t\tnewcap += newcap / 4\n\t\t\t}\n\t\t\t// Set newcap to the requested cap when\n\t\t\t// the newcap calculation overflowed.\n\t\t\tif newcap <= 0 {\n\t\t\t\tnewcap = cap\n\t\t\t}\n\t\t}\n\t}\n    \n    // ...\n}\n```\n\n##### å‡½æ•°å‚æ•°è§£æ\n\n`cap`ï¼šæœŸæœ›æ‰©å®¹åˆ°çš„æœ€å°å®¹é‡\n\n```go\ns1 := []int{1}\ns1 = s1.append(s1, 2, 3, 4)\n```\n\næ¯”å¦‚è¿™é‡Œ`s1`éœ€è¦è¿½åŠ 3ä¸ªå…ƒç´ ï¼Œå®¹é‡ä¸è¶³éœ€è¦è§¦å‘æ‰©å®¹ï¼Œæ–°åˆ‡ç‰‡çš„æœ€å°å®¹é‡å°±æ˜¯`1+3=4`ï¼Œæ•…å¯¹åº”`cap`å‚æ•°ä¸º4\n\n\n\n\n\n##### é¢„ä¼°å®¹é‡\n\n-   å¦‚æœæœŸæœ›å®¹é‡ï¼ˆ`cap`ï¼‰å¤§äºå½“å‰å®¹é‡çš„ä¸¤å€ï¼ˆ`doublecap`ï¼‰å°±ä¼šä½¿ç”¨æœŸæœ›å®¹é‡\n-   å¦‚æœå½“å‰åˆ‡ç‰‡çš„å®¹é‡ï¼ˆ`old.cap`ï¼‰å°äº1024å°±ä¼šå°†å®¹é‡ç¿»å€\n-   å¦‚æœå½“å‰åˆ‡ç‰‡çš„å®¹é‡ï¼ˆ`old.cap`ï¼‰å¤§äº1024å°±ä¼šæ¯æ¬¡å¢åŠ 25%çš„å®¹é‡ï¼Œç›´åˆ°æ–°å®¹é‡å¤§äºæœŸæœ›å®¹é‡ï¼ˆ{% label å¹¶ä¸æ˜¯æ‰©å®¹1/4å“¦ red %}ï¼‰\n\n\n\n{% note warning %}\n\nä¸Šè¿°æ‰©å®¹é€»è¾‘åªæ˜¯ç¡®å®šäº†åˆ‡ç‰‡çš„å¤§è‡´å®¹é‡ï¼ˆä»…ä»…æ˜¯æ‰©å®¹é€»è¾‘çš„ä¸ŠåŠéƒ¨åˆ†ï¼‰ï¼Œæ¥ä¸‹æ¥è¿˜éœ€è¦æ ¹æ®åˆ‡ç‰‡ä¸­çš„å…ƒç´ å¤§å°å¯¹é½å†…å­˜ï¼Œæ ¹æ®åˆ‡ç‰‡ä¸­å…ƒç´ æ‰€å å­—èŠ‚å¤§å°èµ°ä¸åŒçš„åˆ†æ”¯é€»è¾‘è¿›è¡Œå†…å­˜å¯¹é½\n\n{% endnote %}\n\n\n\n##### å†…å­˜å¯¹é½\n\nä¸ŠåŠéƒ¨åˆ†ç¡®å®šäº†ä¸€ä¸ªåŸºå‡†çš„æ‰©å®¹å®¹é‡ï¼Œæ¥ä¸‹æ¥ä¸‹åŠéƒ¨åˆ†éœ€è¦è®¡ç®—å†…å­˜å¤§å°å¹¶ä¸”åˆ¤æ–­æ˜¯å¦éœ€è¦å†…å­˜å¯¹é½æ¥ç¡®å®šæœ€ç»ˆæ‰©å®¹åçš„å®¹é‡å¤§å°\n\n```go\nfunc growslice(et *_type, old slice, cap int) slice {\n    // ...\n    // åˆ°è¿™å·²ç»å¾—åˆ°newcapï¼ˆå¤§è‡´å®¹é‡ï¼‰å¤§å°ï¼Œæ¥ä¸‹æ¥çš„ä»£ç éœ€è¦æ ¹æ®å†…å­˜å¯¹é½çš„æƒ…å†µæ¥ç¡®å®šæœ€ç»ˆçš„capå¤§å°æ¥åˆ›å»ºæ–°çš„åº•å±‚æ•°ç»„\n    var overflow bool\n\tvar lenmem, newlenmem, capmem uintptr\n\t// Specialize for common values of et.size.\n\t// For 1 we don't need any division/multiplication.\n\t// For sys.PtrSize, compiler will optimize division/multiplication into a shift by a constant.\n\t// For powers of 2, use a variable shift.\n\tswitch {\n\tcase et.size == 1:\n\t\tlenmem = uintptr(old.len)\n\t\tnewlenmem = uintptr(cap)\n\t\tcapmem = roundupsize(uintptr(newcap))\n\t\toverflow = uintptr(newcap) > maxAlloc\n\t\tnewcap = int(capmem)\n\tcase et.size == sys.PtrSize:\n\t\tlenmem = uintptr(old.len) * sys.PtrSize\n\t\tnewlenmem = uintptr(cap) * sys.PtrSize\n\t\tcapmem = roundupsize(uintptr(newcap) * sys.PtrSize)\n\t\toverflow = uintptr(newcap) > maxAlloc/sys.PtrSize\n\t\tnewcap = int(capmem / sys.PtrSize)\n\tcase isPowerOfTwo(et.size):\n\t\tvar shift uintptr\n\t\tif sys.PtrSize == 8 {\n\t\t\t// Mask shift for better code generation.\n\t\t\tshift = uintptr(sys.Ctz64(uint64(et.size))) & 63\n\t\t} else {\n\t\t\tshift = uintptr(sys.Ctz32(uint32(et.size))) & 31\n\t\t}\n\t\tlenmem = uintptr(old.len) << shift\n\t\tnewlenmem = uintptr(cap) << shift\n\t\tcapmem = roundupsize(uintptr(newcap) << shift)\n\t\toverflow = uintptr(newcap) > (maxAlloc >> shift)\n\t\tnewcap = int(capmem >> shift)\n\tdefault:\n\t\tlenmem = uintptr(old.len) * et.size\n\t\tnewlenmem = uintptr(cap) * et.size\n\t\tcapmem, overflow = math.MulUintptr(et.size, uintptr(newcap))\n\t\tcapmem = roundupsize(capmem)\n\t\tnewcap = int(capmem / et.size)\n\t}\n\n\tif overflow || capmem > maxAlloc {\n\t\tpanic(errorString(\"growslice: cap out of range\"))\n\t}\n\n\tvar p unsafe.Pointer\n\tif et.ptrdata == 0 {\n\t\tp = mallocgc(capmem, nil, false)\n\t\t\n\t\tmemclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)\n\t} else {\n\t\tp = mallocgc(capmem, et, true)\n\t\tif lenmem > 0 && writeBarrier.enabled {\n\t\t\tbulkBarrierPreWriteSrcOnly(uintptr(p), uintptr(old.array), lenmem-et.size+et.ptrdata)\n\t\t}\n\t}\n\tmemmove(p, old.array, lenmem)\n\n\treturn slice{p, old.len, newcap}\n}\n```\n\n\n\n\n\n#### ä»£ç åˆ†æ\n\n\n\n```go\npackage main\n\nimport \"fmt\"\n\n/*\nåˆ‡ç‰‡æ‰©å®¹\n*/\n\nfunc main() {\n    s1 := []int{1, 2}\n    fmt.Printf(\"[before] s1: %v, len(s1): %d, cap(s1): %d\\n\", s1, len(s1), cap(s1))\n    s1 = append(s1, 3, 4, 5)\n    fmt.Printf(\"[after] s1: %v, len(s1): %d, cap(s1): %d\\n\", s1, len(s1), cap(s1))\n}\n\n```\n\n\n\næ ¹æ®ä¸Šé¢è§„åˆ™åˆ†æï¼Œå…ˆå¯¹å®¹é‡è¿›è¡Œé¢„ä¼°\n\n-   `append`ä¹‹å‰ï¼š`len(s1)==2`ï¼Œ`cap(s1)==2`\n-   `append`ä¹‹åï¼šç”±äºåˆ‡ç‰‡å®¹é‡å·²ç»ç”¨å®Œï¼Œä¼šè§¦å‘æ‰©å®¹ï¼Œæ‰©å®¹å`len(s1)==5`ï¼Œ`cap(s1)==5`\n\n\n\nç¡®å®šäº†é¢„ä¼°å®¹é‡ä¸º5ï¼Œå³`newcap=5`\n\n\n\n<!-- TODO: æ¶‰åŠåˆ°å†…å­˜å¯¹é½ -->\n\n\n\n{% hideToggle è¿è¡Œç»“æœ %}\n\n```\n[before] s1: [1 2], len(s1): 2, cap(s1): 2\n[after] s1: [1 2 3 4 5], len(s1): 5, cap(s1): 6\n```\n\n{% endhideToggle %}\n\n\n\n### åˆ‡ç‰‡ä½œä¸ºå‡½æ•°å‚æ•°\n\n`slice`æœ¬è´¨æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«ä¸‰ä¸ªæˆå‘˜å±æ€§ï¼š`len`ï¼Œ`cap`ï¼Œ`array`\n\nå½“`slice`ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ç»“æ„ä½“ï¼Œç›´æ¥ä¼ é€’`slice`ï¼Œå®å‚æ˜¯ä¸ä¼šè¢«å‡½æ•°ä¸­çš„æ“ä½œæ”¹å˜çš„ï¼Œä½†æ˜¯å¦‚æœä¼ çš„æ˜¯`slice`æŒ‡é’ˆï¼Œå°½ç®¡`Go`å¹¶æ²¡æœ‰å¼•ç”¨ä¼ é€’ï¼ˆéƒ½æ˜¯å€¼ä¼ é€’ï¼‰ï¼Œä½†æ˜¯å› ä¸ºæŒ‡é’ˆå®é™…æŒ‡å‘çš„æ•°æ®ç›¸åŒï¼Œæ‰€ä»¥å‡½æ•°å†…éƒ¨çš„æ“ä½œä¼šå½±å“å®å‚\n\n\n\n>   ä»€ä¹ˆæ˜¯å€¼ä¼ é€’ï¼Œä»€ä¹ˆæ˜¯å¼•ç”¨ä¼ é€’\n>\n>   å…ˆè¯´ç»“è®ºï¼Œ`Go`è¯­è¨€ä¸­åªæœ‰å€¼ä¼ é€’ï¼Œæ²¡æœ‰å¼•ç”¨ä¼ é€’\n>\n>   å€¼ä¼ é€’ï¼šå½¢å‚éƒ½æ˜¯å®å‚çš„æ‹·è´ï¼Œå‡½æ•°å†…å¤–å‚æ•°çš„åœ°å€å€¼æ˜¯ä¸åŒçš„\n>\n>   å¼•ç”¨ä¼ é€’ï¼šé‚£è‡ªç„¶å’Œå€¼ä¼ é€’ç›¸åäº†ï¼Œå½¢å‚å®å‚å®Œå…¨ç›¸åŒï¼Œå°±æ˜¯ä¸€ä»½æ•°æ®\n\n\n\næ˜ç¡®äº†å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’åï¼Œå†æ¥çœ‹ä»¥ä¸‹ä»£ç çš„æ‰§è¡Œç»“æœ\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n)\n\n/*\nsliceä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’\n*/\n\nfunc main() {\n    s := []int{1, 1, 1}\n    // &s: åˆ‡ç‰‡æœ¬èº«åœ°å€ï¼ˆæŒ‡å‘åˆ‡ç‰‡è¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆï¼‰\n    // s: åˆ‡ç‰‡æŒ‡å‘çš„åº•å±‚æ•°ç»„åœ°å€\n    // &s[0]: åˆ‡ç‰‡æŒ‡å‘çš„åº•å±‚æ•°ç»„åœ°å€ï¼ˆæ•°ç»„æ˜¯ä¸€ç‰‡è¿ç»­çš„åœ°å€ç©ºé—´ï¼Œæ•°ç»„åœ°å€å³ä¸ºèµ·å§‹å…ƒç´ çš„åœ°å€ï¼‰\n    fmt.Printf(\"[function main] &s: %p, s: %p, &s[0]: %p\\n\", &s, s, &s[0])\n    f(s)\n    fmt.Println(s)\n}\n\nfunc f(s []int) {\n    fmt.Printf(\"[function f] &s: %p, s: %p, &s[0]: %p\\n\", &s, s, &s[0])\n    for i := range s {\n        s[i] += 1\n    }\n}\n```\n\n\n\n{% hideToggle è¿è¡Œç»“æœ %}\n\n```\n[function main] &s: 0xc000096060, s: 0xc0000ae078, &s[0]: 0xc0000ae078\n[function f] &s: 0xc000096090, s: 0xc0000ae078, &s[0]: 0xc0000ae078\n[2 2 2]\n```\n\n{% endhideToggle %}\n\n\n\n#### ä¸ºä»€ä¹ˆå‡½æ•°å†…éƒ¨çš„ä¿®æ”¹ç”Ÿæ•ˆäº†\n\nä»å‡½æ•°å†…å¤–å¯¹åˆ‡ç‰‡åœ°å€çš„æ‰“å°ç»“æœæ¥çœ‹ï¼Œ`Go`å‚æ•°ä¼ é€’å°±æ˜¯å€¼ä¼ é€’\n\né‚£ä¹ˆä¸ºä»€ä¹ˆèƒ½å¯¹å‡½æ•°å¤–éƒ¨çš„åˆ‡ç‰‡äº§ç”Ÿå½±å“ï¼Ÿ\n\nåŸå› åœ¨äºåˆ‡ç‰‡æœ¬èº«ä¹Ÿæ˜¯ä¿å­˜äº†åº•å±‚æ•°ç»„çš„æŒ‡é’ˆï¼Œå€¼ä¼ é€’çš„è¿‡ç¨‹æœ¬è´¨å°±æ˜¯ä¸€ä¸ªæ‹·è´ï¼ˆæµ…æ‹·è´ï¼‰ï¼Œå¯¹äºå¼•ç”¨ç±»å‹çš„ï¼ˆä¿å­˜æŒ‡é’ˆï¼‰çš„å‚æ•°æ¥è¯´å®ƒçš„å€¼å°±æ˜¯åœ°å€ï¼ˆåªä¸è¿‡è¿™ä¸ªåœ°å€åˆæ˜¯æŒ‡å‘çš„å¦ä¸€ä¸ªç©ºé—´/å˜é‡ï¼‰\n\næ‰€ä»¥è¿™é‡Œçš„ä¿®æ”¹å¯¹å‡½æ•°å¤–éƒ¨ç”Ÿæ•ˆ\n\n\n\nåŒ…æ‹¬å…¶ä»–ç±»å‹ï¼Œå¦‚`map`ã€`channel`ç­‰éƒ½æ˜¯åŒä¸€ä¸ªåŸç†\n\n\n\n#### é™·é˜±\n\næ—¢ç„¶æ˜¯å› ä¸ºåº•å±‚æ•°ç»„çš„åŸå› å¯¼è‡´çš„ä¿®æ”¹ç”Ÿæ•ˆï¼Œé‚£ä¹ˆæ˜¯å¦åœ¨å‡½æ•°å†…éƒ¨è§¦å‘äº†æ‰©å®¹ï¼ˆåº•å±‚æ•°ç»„åœ°å€å˜æ›´ï¼‰ï¼Œä¿®æ”¹å¯¹äºå¤–éƒ¨çš„åˆ‡ç‰‡æ˜¯å¦å¯è§ï¼Ÿ\n\n```go\npackage main\n\nimport (\n\t\"fmt\"\n)\n\n/*\nsliceä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’\n*/\n\nfunc main() {\n\ts := []int{1}\n\t// &s: åˆ‡ç‰‡æœ¬èº«åœ°å€ï¼ˆæŒ‡å‘åˆ‡ç‰‡è¿™ä¸ªç»“æ„ä½“çš„æŒ‡é’ˆï¼‰\n\t// s: åˆ‡ç‰‡æŒ‡å‘çš„åº•å±‚æ•°ç»„åœ°å€\n\t// &s[0]: åˆ‡ç‰‡æŒ‡å‘çš„åº•å±‚æ•°ç»„åœ°å€ï¼ˆæ•°ç»„æ˜¯ä¸€ç‰‡è¿ç»­çš„åœ°å€ç©ºé—´ï¼Œæ•°ç»„åœ°å€å³ä¸ºèµ·å§‹å…ƒç´ çš„åœ°å€ï¼‰\n\tfmt.Printf(\"[function main] s: %v, &s: %p, &(s->arr): %p, &s[0]: %p\\n\", s[0:cap(s)], &s, s, &s[0])\n\tf(s)\n\tfmt.Printf(\"[function main] s: %v, &s: %p, &(s->arr): %p, &s[0]: %p\\n\", s[0:cap(s)], &s, s, &s[0])\n\n\tfmt.Println()\n\n\t// æœ‰å¤šä½™ç©ºé—´çš„åˆ‡ç‰‡ï¼ŒéªŒè¯ä¸æ‰©å®¹æƒ…å†µä¸‹æ˜¯å¦ä¿®æ”¹ç”Ÿæ•ˆ\n\ts = make([]int, 1, 4)\n\ts[0] = 1\n\tfmt.Printf(\"[function main] s: %v, &s: %p, &(s->arr): %p, &s[0]: %p\\n\", s[0:cap(s)], &s, s, &s[0])\n\t// å®é™…ä¸Šæ²¡æœ‰æ‰©å®¹å‘ç”Ÿï¼Œæ‰€ä»¥å‡½æ•°å†…éƒ¨æ‰“å°åœ°å€çš„æ—¶å€™æ˜¯ä¸å˜çš„\n\tf(s)\n\t// å‡½æ•°å†…éƒ¨å¯¹äºappendæ“ä½œæˆåŠŸä¿®æ”¹åº•å±‚çš„æ•°ç»„ï¼Œå¤–éƒ¨æ˜¯å¯ä»¥æ­£å¸¸æ„ŸçŸ¥åˆ°çš„ï¼Œä¿®æ”¹ç”Ÿæ•ˆ\n\tfmt.Printf(\"[function main] s: %v, &s: %p, &(s->arr): %p, &s[0]: %p\\n\", s[0:cap(s)], &s, s, &s[0])\n}\n\nfunc f(s []int) {\n\t// å¯ä»¥å‘ç°sçš„æŒ‡é’ˆï¼ˆåœ°å€ï¼‰å˜åŒ–äº†ï¼Œå®é™…ä¼ é€’è¿›æ¥çš„æ˜¯æ‹·è´çš„æ–°å€¼ï¼ˆå½¢å‚ä¸å®å‚çš„åŒºåˆ«ï¼‰\n\tfmt.Printf(\"[function f, before growing] s: %v, &s: %p, &(s->arr): %p, &s[0]: %p\\n\", s[0:cap(s)], &s, s, &s[0])\n\ts = append(s, 2, 3, 4)\n\tfmt.Printf(\"[function f, after growing] s: %v, &s: %p, &(s->arr): %p, &s[0]: %p\\n\", s[0:cap(s)], &s, s, &s[0])\n}\n\n```\n\n\n\n{% hideToggle è¿è¡Œç»“æœ %}\n\n```\n[function main] s: [1], &s: 0xc000004078, &(s->arr): 0xc00000a0a8, &s[0]: 0xc00000a0a8\n[function f, before growing] s: [1], &s: 0xc0000040c0, &(s->arr): 0xc00000a0a8, &s[0]: 0xc00000a0a8\n[function f, after growing] s: [1 2 3 4], &s: 0xc0000040c0, &(s->arr): 0xc000010200, &s[0]: 0xc000010200\n[function main] s: [1], &s: 0xc000004078, &(s->arr): 0xc00000a0a8, &s[0]: 0xc00000a0a8\n\n[function main] s: [1 0 0 0], &s: 0xc000004078, &(s->arr): 0xc000010220, &s[0]: 0xc000010220\n[function f, before growing] s: [1 0 0 0], &s: 0xc000004198, &(s->arr): 0xc000010220, &s[0]: 0xc000010220\n[function f, after growing] s: [1 2 3 4], &s: 0xc000004198, &(s->arr): 0xc000010220, &s[0]: 0xc000010220\n[function main] s: [1 2 3 4], &s: 0xc000004078, &(s->arr): 0xc000010220, &s[0]: 0xc000010220\n```\n\n{% endhideToggle %}\n\n\n\n<!-- TODOï¼šå’Œmapåˆæœ‰ä¸åŒï¼Ÿ -->\n\n\n\n### å¹¶å‘æ”¯æŒ\n\n`slice`æ²¡æœ‰åšå¹¶å‘æ§åˆ¶ï¼Œå¹¶å‘ç¯å¢ƒä¸‹æ˜¯ä¸å®‰å…¨çš„ï¼Œä½†æ˜¯å¤šä¸ª`goroutine`æ“ä½œå¯èƒ½å¹¶ä¸ä¼šå‡ºç°é—®é¢˜\n\nè€Œ`map`åˆ™ä¸åŒï¼Œè¿è¡Œæ—¶è‹¥æ£€æµ‹åˆ°åŒä¸€ä¸ª`map`**åŒæ—¶**è¢«å¤šä¸ª`goroutine`å¼•ç”¨å¹¶æ“ä½œï¼Œç¨‹åºä¼šç›´æ¥å´©æºƒï¼ˆå¦‚æœåˆšå¥½é”™å¼€ï¼Œåˆ™ä¸ä¼šå‡ºç°é—®é¢˜ï¼‰\n\n\n\n## å‚è€ƒèµ„æ–™\n\n>   [Go è¯­è¨€æ•°ç»„çš„å®ç°åŸç† | Go è¯­è¨€è®¾è®¡ä¸å®ç° (draveness.me)](https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-array/)\n>\n>   [Go è¯­è¨€åˆ‡ç‰‡çš„å®ç°åŸç† | Go è¯­è¨€è®¾è®¡ä¸å®ç° (draveness.me)](https://draveness.me/golang/docs/part2-foundation/ch03-datastructure/golang-array-and-slice/)\n>\n>   [åˆ‡ç‰‡çš„å®¹é‡æ˜¯æ€æ ·å¢é•¿çš„ | Go ç¨‹åºå‘˜é¢è¯•ç¬”è¯•å®å…¸ (golang.design)](https://golang.design/go-questions/slice/grow/)\n>\n>   [slice_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1hv411x7we?p=2)\n\n\n\n","tags":["Golang","ç¼–ç¨‹è¯­è¨€"],"categories":["ç¼–ç¨‹è¯­è¨€","Golang"]},{"title":"Linux-pså‘½ä»¤çš„ä½¿ç”¨","url":"/posts/6f16d83b/","content":"\n## ps\n\n*report a snapshot of the current processes.*\n\nç»Ÿè®¡å½“å‰è¿›ç¨‹è¿è¡Œæƒ…å†µ\n\n\n\n### æ¦‚è¿°\n\n`ps`å‘½ä»¤çš„é€‰é¡¹æœ‰ä¸‰ç§é£æ ¼\n\n>   This version of ps accepts several kinds of options:\n>\n>   â€‹\t\t1   UNIX options, which may be grouped and must be preceded by a dash.\n>\n>   â€‹\t\t2   BSD options, which may be grouped and must not be used with a dash.\n>\n>   â€‹\t\t3   GNU long options, which are preceded by two dashes.\n\n\n\n-   UNIXï¼šå¯ä»¥åˆ†ç»„ï¼Œä½¿ç”¨ä¸€ä¸ªç ´æŠ˜å·ï¼ˆdashï¼‰å¼€å¤´\n\n    ```bash\n    $ ps -ef\n    ```\n\n-   BSDï¼šå¯ä»¥åˆ†ç»„ï¼Œä¸ä½¿ç”¨ç ´æŠ˜å·ï¼ˆdashï¼‰\n\n    ```bash\n    $ ps aux\n    ```\n\n-   GNUï¼šä¸å¯ä»¥åˆ†ç»„ï¼Œä½¿ç”¨ä¸¤ä¸ªç ´æŠ˜å·ï¼ˆdashï¼‰å¼€å¤´\n\n    ```bash\n    $ ps --user\n    ```\n\n\n\n#### `ps -aux`å’Œ`ps aux`æ˜¯ä¸ä¸€æ ·çš„\n\n\n\n>   Note that \"ps -aux\" is distinct from \"ps aux\".  The POSIX and UNIX standards require that \"ps -aux\" print all processes owned by a\n>         user named \"x\", as well as printing all processes that would be selected by the -a option.  If the user named \"x\" does not exist, this\n>         ps may interpret the command as \"ps aux\" instead and print a warning.  This behavior is intended to aid in transitioning old scripts\n>         and habits.  It is fragile, subject to change, and thus should not be relied upon.\n\n\n\n`man`æ‰‹å†Œä¸­æ˜ç¡®æåˆ°`ps -aux`å’Œ`ps aux`æ˜¯å®Œå…¨ä¸åŒçš„\n\nåœ¨`POSIX`å’Œ`UNIX`æ ‡å‡†ä¸­`ps -aux`ä¼šå±•ç¤ºå½’å±äºç”¨æˆ·`x`çš„æ‰€æœ‰çš„è¿›ç¨‹ï¼Œåªæœ‰åœ¨æ²¡æœ‰ç”¨æˆ·åä¸º`x`çš„ç”¨æˆ·æ—¶ï¼Œ`ps -aux`è¢«è§£é‡Šä¸º`ps aux`ï¼Œæ­¤æ—¶è¿™ä¸¤ä¸ªå‘½ä»¤æ‰æ˜¯ç­‰æ•ˆçš„\n\n\n\n### å¸¸ç”¨é€‰é¡¹\n\n\n\n#### `-a`\n\n>   Select all processes except both session leaders (see getsid(2)) and processes not associated with a terminal.\n\nä¸æ˜¯å…¨éƒ¨è¿›ç¨‹ï¼Œæ’é™¤äº†`session leaders`å’Œé‚£äº›æ²¡æœ‰å…³è”åˆ°ç»ˆç«¯çš„è¿›ç¨‹\n\n\n\n>   æ²¡æœ‰å…³è”åˆ°ç»ˆç«¯çš„è¿›ç¨‹å¯ä»¥ç®€å•ç†è§£ï¼ˆä¸å®Œå…¨æ­£ç¡®ï¼‰ä¸ºåå°è¿›ç¨‹ï¼Œä¸ç”±å…·ä½“çš„æŸä¸ªç»ˆç«¯å‰å°è¿è¡Œ\n\n\n\n```bash\n[root@crayon tmp]# ps -a\n  PID TTY          TIME CMD\n 2199 pts/0    00:00:00 tail\n 2416 pts/2    00:00:00 man\n 2425 pts/2    00:00:00 less\n 2906 pts/1    00:00:00 ps\n```\n\n\n\n`TTY`è¿™è¡Œéƒ½æœ‰å€¼ï¼Œä»£è¡¨è¿™äº›éƒ½æ˜¯ç”±å…·ä½“æŸä¸ªç»ˆç«¯\n\n\n\n>   å…³äº**Linuxä¼šè¯ã€ç»ˆç«¯ä¸è¿›ç¨‹ç»„**å¯ä»¥å‚è€ƒ\n>\n>   [Linuxä¼šè¯ã€ç»ˆç«¯ä¸è¿›ç¨‹ç»„ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/563471531)\n>\n>   [Linux TTY/PTSæ¦‚è¿° - Linuxç¨‹åºå‘˜ - SegmentFault æ€å¦](https://segmentfault.com/a/1190000009082089)\n>\n>   [Linux sessionå’Œè¿›ç¨‹ç»„æ¦‚è¿° - Linuxç¨‹åºå‘˜ - SegmentFault æ€å¦](https://segmentfault.com/a/1190000009152815)\n\n\n\n#### `-u`/`U`/`--user`\n\n>   -u userlist\n>                 Select by effective user ID (EUID) or name.  This selects the processes whose effective user name or ID is in userlist.\n>\n>   â€‹              The effective user ID describes the user whose file access permissions are used by the process (see geteuid(2)).  Identical to\n>   â€‹              U and --user.\n\né€‰æ‹©å½’å±äºæŒ‡å®šç”¨æˆ·idæˆ–ç”¨æˆ·åçš„è¿›ç¨‹\n\n\n\n#### `a`\n\n>   a      Lift the BSD-style \"only yourself\" restriction, which is imposed upon the set of all processes when some BSD-style (without\n>                 \"-\") options are used or when the ps personality setting is BSD-like.  The set of processes selected in this manner is in\n>                 addition to the set of processes selected by other means.  An alternate description is that this option causes ps to list all\n>                 **processes with a terminal (tty), or to list all processes when used together with the x option.**\n\nå¯ä»¥åˆ—å‡ºä¸å±äºå½“å‰ç”¨æˆ·çš„è¿›ç¨‹ä¿¡æ¯ï¼ˆè§£é™¤**åªåˆ—å‡ºå½’å±äºå½“å‰ç”¨æˆ·çš„è¿›ç¨‹**çš„é™åˆ¶ï¼‰\n\nä½†æ˜¯åªèƒ½åˆ—å‡ºä¸ç»ˆç«¯å…³è”çš„è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯åå°è¿›ç¨‹ä¸ä¼šæ˜¾ç¤ºï¼ˆéœ€è¦ä½¿ç”¨`x`/`-x`é€‰é¡¹ï¼‰\n\n\n\næ³¨æ„`man`æ‰‹å†Œä¸­çš„æœ€åä¸€å¥\n\n>   `a`å’Œ`x`/`-x`é€‰é¡¹ç»„åˆä½¿ç”¨å³å¯æ‰“å°æ‰€æœ‰è¿›ç¨‹çš„ä¿¡æ¯ï¼Œå’Œ`-e`é€‰é¡¹æ•ˆæœä¸€æ ·\n\n#### `x`/`-x`\n\n>x      Lift the BSD-style \"must have a tty\" restriction, which is imposed upon the set of all processes when some BSD-style (without\n>              \"-\") options are used or when the ps personality setting is BSD-like.  The set of processes selected in this manner is in\n>              addition to the set of processes selected by other means.  An alternate description is that this option causes ps to list all\n>              processes owned by you (same EUID as ps), or to list all processes when used together with the a option.\n\nå¯ä»¥åˆ—å‡ºéç»ˆç«¯å…³è”çš„è¿›ç¨‹ä¿¡æ¯ï¼ˆè§£é™¤**åªåˆ—å‡ºä¸ç»ˆç«¯å…³è”çš„è¿›ç¨‹**çš„é™åˆ¶ï¼‰\n\nä½†æ˜¯åªèƒ½åˆ—å‡ºå½’å±äºå½“å‰ç”¨æˆ·çš„è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯å…¶ä»–ç”¨æˆ·çš„è¿›ç¨‹ä¸ä¼šæ˜¾ç¤ºï¼ˆéœ€è¦ä½¿ç”¨`a`é€‰é¡¹ï¼‰\n\n\n\n#### `-e`/`-A`\n\n>   -e     Select all processes.  Identical to -A.\n>\n>   -A     Select all processes.  Identical to -e.\n\nåˆ—å‡ºæ‰€æœ‰è¿›ç¨‹ä¿¡æ¯\n\n\n\n#### `u`\n\n>   u      Display user-oriented format.\n\n`man`æ‰‹å†Œçš„åŸæ–‡è§£é‡Šæ˜¯é¢å‘ç”¨æˆ·çš„æ ¼å¼åŒ–è¾“å‡º\n\n```bash\n[root@crayon tmp]# ps u\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot       681  0.0  0.0 110204   856 tty1     Ss+  14:03   \n...\nroot      3381  0.0  0.0 155448  1868 pts/1    R+   20:40   0:00 ps u\n```\n\né™¤äº†`USER`ã€`PID`å¤–è¿˜åŒ…å«äº†è¿›ç¨‹èµ„æºå ç”¨çš„ä¿¡æ¯\n\n\n\n#### `-f`/`-F`\n\n>   -f     Do full-format listing. This option can be combined with many other UNIX-style options to add additional columns.  It also\n>                 causes the command arguments to be printed.  When used with -L, the NLWP (number of threads) and LWP (thread ID) columns will\n>                 be added.  See the c option, the format keyword args, and the format keyword comm.\n>\n>   \n>\n>   -F     Extra full format.  See the -f option, which -F implies.\n\n`man`æ‰‹å†Œçš„åŸæ–‡è§£é‡Šæ˜¯å®Œæ•´æ ¼å¼è¾“å‡º\n\næ­é…`-L`é€‰é¡¹è¿˜å¯ä»¥è¾“å‡ºçº¿ç¨‹ä¿¡æ¯ï¼š`NLWP`çº¿ç¨‹æ•°å’Œ`LWP`çº¿ç¨‹ID\n\n\n\n#### `-L`\n\n>   -L     Show threads, possibly with LWP and NLWP columns.\n\næ˜¾ç¤ºçº¿ç¨‹ä¿¡æ¯\n\n`NLWP`ï¼šçº¿ç¨‹æ•°\n\n`LWP`ï¼šçº¿ç¨‹ID\n\n\n\n#### `f`/`--forest`\n\n>   f      ASCII art process hierarchy (forest).\n>\n>   --forest\n>                 ASCII art process tree.\n\næ ‘å½¢ç»“æ„è¾“å‡ºï¼Œè¿™ä¸ªå¯ä»¥å¾ˆæ–¹ä¾¿çš„æŸ¥çœ‹è¿›ç¨‹å±‚çº§ï¼ˆçˆ¶å­å…³ç³»ï¼‰\n\nå’Œ`-H`çš„åŒºåˆ«å°±æ˜¯`-H`åªæ˜¯æŒ‰ç…§ç©ºè¡Œç¼©è¿›\n\nè€Œ`f`/`--forest`ä¼šå¡«å……ä¸€äº›å­—ç¬¦è®©ç»“æœæ›´å¥½çœ‹ä¸€ç‚¹\n\n```bash\n[root@crayon tmp]# ps -ef --forest | head -n 5\nUID        PID  PPID  C STIME TTY          TIME CMD\nroot         2     0  0 14:02 ?        00:00:00 [kthreadd]\nroot         4     2  0 14:02 ?        00:00:00  \\_ [kworker/0:0H]\nroot         5     2  0 14:02 ?        00:00:00  \\_ [kworker/u2:0]\nroot         6     2  0 14:02 ?        00:00:03  \\_ [ksoftirqd/0]\n```\n\n\n\n#### `-H`\n\n>   -H     Show process hierarchy (forest).\n\n```bash\n[root@crayon tmp]# ps -efH\nroot      1088     1  0 14:03 ?        00:00:00   /usr/sbin/sshd -D\nroot      1787  1088  0 14:59 ?        00:00:02     sshd: root@pts/0\nroot      1791  1787  0 14:59 pts/0    00:00:00       -bash\nroot      2199  1791  0 15:11 pts/0    00:00:00         tail -f -n 100 /dev/null\nroot      2172  1088  0 15:11 ?        00:00:07     sshd: root@pts/1\nroot      2176  2172  0 15:11 pts/1    00:00:00       -bash\nroot      3413  2176  0 20:59 pts/1    00:00:00         ps -efH\nroot      3414  2176  0 20:59 pts/1    00:00:00         grep --color=auto -C 5 1088\nroot      2295  1088  0 15:30 ?        00:00:06     sshd: root@pts/2\nroot      2299  2295  0 15:30 pts/2    00:00:00       -bash\nroot      3097  2299  0 16:52 pts/2    00:00:00         man ps\nroot      3106  3097  0 16:52 pts/2    00:00:00           less -s\nroot      2371  1088  0 15:39 ?        00:00:01     sshd: root@pts/3\nroot      2375  2371  0 15:39 pts/3    00:00:00       -bash\nroot      1092     1  0 14:03 ?        00:00:07   /usr/sbin/rsyslogd -n\n```\n\n\n\n### å¸¸ç”¨ç»„åˆ\n\n#### `ps -ef f`\n\n```bash\n[root@crayon tmp]# ps -ef f\nUID        PID  PPID  C STIME TTY      STAT   TIME CMD\nroot         2     0  0 14:02 ?        S      0:00 [kthreadd]\nroot         4     2  0 14:02 ?        S<     0:00  \\_ [kworker/0:0H]\nroot         5     2  0 14:02 ?        S      0:00  \\_ [kworker/u2:0]\nroot         6     2  0 14:02 ?        S      0:03  \\_ [ksoftirqd/0]\n...\n```\n\næŒ‰ç…§è¿›ç¨‹å±‚çº§ä»¥æ ‘å½¢æ‰“å°å‡ºæ‰€æœ‰è¿›ç¨‹ä¿¡æ¯\n\n\n\n#### `ps axuf`\n\n```bash\n[root@crayon tmp]# ps axu\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot         1  0.0  0.3 128056  6728 ?        Ss   14:02   0:05 /usr/lib/systemd/systemd --switched-root --system --deserialize 22\nroot         2  0.0  0.0      0     0 ?        S    14:02   0:00 [kthreadd]\nroot         4  0.0  0.0      0     0 ?        S<   14:02   0:00 [kworker/0:0H]\nroot         5  0.0  0.0      0     0 ?        S    14:02   0:00 [kworker/u2:0]\n```\n\næŒ‰ç…§è¿›ç¨‹å±‚çº§ä»¥æ ‘å½¢æ‰“å°å‡ºæ‰€æœ‰è¿›ç¨‹çš„ä¿¡æ¯\n\n`ax`é€‰é¡¹å’Œ`-e`/`-A`ç­‰æ•ˆï¼Œéƒ½æ˜¯åˆ—å‡ºæ‰€æœ‰çš„è¿›ç¨‹\n\n`u`é€‰é¡¹é¢å‘ç”¨æˆ·æ‰“å°å‡ºå…³é”®ä¿¡æ¯\n\n`u`å’Œ`-f`é€‰é¡¹éƒ½æ˜¯æ§åˆ¶è¾“å‡ºä¿¡æ¯ï¼Œä¼šæœ‰å†²çªï¼ŒæŒ‰éœ€é€‰æ‹©äº’æ–¥ä½¿ç”¨å³å¯\n\n```bash\n[root@crayon tmp]# ps u -f\nerror: conflicting format options\n```\n\n\n\n`u`é€‰é¡¹ä¼šè¾“å‡ºè¿›ç¨‹èµ„æºçš„ä½¿ç”¨æƒ…å†µ\n\n\n\n\n\n### å‚è€ƒèµ„æ–™\n\nè¿˜æœ‰æ›´å¤šçš„ä½¿ç”¨ç»†èŠ‚å¯ä»¥å‚é˜…ä»¥ä¸‹æ–‡ç« \n\n>    [è¾ƒä¸ºå¹³æ»‘çš„ Linux ps å‘½ä»¤å…¥é—¨ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/674077333) \n\n","tags":["Linux"],"categories":["Linux"]},{"title":"Pythonæ€§èƒ½åˆ†æå®æˆ˜1","url":"/posts/bf927dad/","content":"\n\n## å‰ç½®çŸ¥è¯†\n\n1. {% label Python green %}åŸºç¡€è¯­æ³•\n2. {% label cProfile purple %}åŸºæœ¬ä½¿ç”¨\n\n\n## é—®é¢˜\nç¯å¢ƒä¸Šå‘ç°æœ‰æ¥å£è¯·æ±‚çš„å“åº”æ—¶é—´é«˜è¾¾10sä»¥ä¸Šï¼Œä¸¥é‡å½±å“åŠŸèƒ½çš„ä½¿ç”¨\n\néœ€è¦åˆ†æå…·ä½“çš„ä»£ç æ‰§è¡Œè€—æ—¶ï¼Œé’ˆå¯¹é—®é¢˜ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä¼˜åŒ–æ¥å£æ€§èƒ½\n\n\n### è§£å†³æ€è·¯\n\n#### åˆ†æä»£ç æ‰§è¡Œæƒ…å†µ\n\nä½¿ç”¨ {% label cProfile purple %} å·¥å…·ï¼Œå°†ç›®æ ‡æ¥å£çš„ä»£ç æ‰§è¡Œæƒ…å†µ`dump`åˆ°æ–‡ä»¶ä¸­\n\n```python\n\nwith cProfile.Profile() as pf:\n  # api business code\n  # ...\n  pf.dump_stats('api.prof')\n\n```\n\n\nè·å¾—`dump`æ–‡ä»¶åï¼Œä½¿ç”¨ {% label snakeviz green %} æ¸²æŸ“æ–¹ä¾¿æŸ¥çœ‹\n\n```bash\n\nsnakeviz api.prof\n\n```\næ‰§è¡Œå‘½ä»¤åï¼Œ{% label snakeviz green %} ä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨æ˜¾ç¤ºæ¸²æŸ“åçš„ç»“æœ\n\n![1705725581868](Pythonæ€§èƒ½åˆ†æå®æˆ˜1.assets/1705725581866.png)\n\n\nå¯ä»¥çœ‹åˆ°æ¥å£ä¸­è°ƒç”¨çš„`service`æ–¹æ³•è€—æ—¶é•¿è¾¾10så·¦å³ï¼Œæ ¹æ®å›¾ç¤ºçš„è°ƒç”¨æ ˆå¯ä»¥çœ‹åˆ°è€—æ—¶ä¹…ä¸»è¦æ˜¯è·Ÿä¸€ä¸ª`decrypt`æ–¹æ³•æœ‰å…³\n\n\næ¥ä¸‹æ¥åˆ°åº•ä¸‹çš„æœç´¢æ¡†è¿‡æ»¤å‡ºå…³äº`decrypt`ç›¸å…³çš„æ‰§è¡Œæƒ…å†µ\n\n![1705682582062](Pythonæ€§èƒ½åˆ†æå®æˆ˜1.assets/1705682582062.png)\n\nå¯ä»¥çœ‹åˆ°ï¼Œ`decrypt`ç›¸å…³çš„æ–¹æ³•è¢«è°ƒç”¨37æ¬¡ï¼Œæ¯æ¬¡è€—æ—¶`0.2s`å·¦å³\n\n`0.2s`ç®—æ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œäº†ï¼Œè¿™æ ·è€—æ—¶çš„ä»£ç é€»è¾‘å±…ç„¶è¿˜æ‰§è¡Œäº†37æ¬¡ï¼Œæœ€ç»ˆå¯¼è‡´æ€»è€—æ—¶æœ‰`7s`ä¹‹å¤š\n\n\n#### åˆ†æé—®é¢˜ä»£ç \n\næ‰¾åˆ°äº†å¯èƒ½æœ‰é—®é¢˜çš„ä»£ç ä½ç½®ï¼Œæ¥ä¸‹æ¥å°±è¦çœ‹çœ‹å¯¹åº”çš„ä»£ç é€»è¾‘äº†\n\n{% note warning %}\n\næœ¬æ–‡ä¸­ä»£ç æ¶‰åŠç§å¯†ä¿¡æ¯ï¼Œä»…ä»¥ä¼ªä»£ç çš„æ–¹å¼è¿›è¡Œè®²è§£\n\n{% endnote %}\n\n`decrypt`å®é™…ä¸Šæ˜¯ä¸€ä¸ªè§£å¯†çš„æ–¹æ³•ï¼Œè§£å¯†ç®—æ³•éœ€è¦è¿›è¡Œå¤§é‡çš„è¿ç®—ï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆè¿™ä¸ªæ“ä½œå•æ¬¡å°±éœ€è¦è€—è´¹`0.2s`äº†\n\n\n**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªè§£å¯†æ“ä½œ**\n\nè¿™é‡Œå®é™…ä¸Šæ˜¯å¯¹éœ€è¦è¿æ¥çš„ä¸­é—´ä»¶å¯†ç è¿›è¡Œè§£å¯†\n\nä¼ªä»£ç å¦‚ä¸‹ï¼š\n\n```python\n\nclass MongoConfig:\n    @property\n    def mongo_password(self):\n        return decrypt(BaseConfig.cipher)\n\n```\n\nç”Ÿäº§ç¯å¢ƒä¸­çš„å¯†ç éƒ½æ˜¯ç»è¿‡åŠ å¯†å¤„ç†çš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è§£å¯†çš„æ“ä½œ\n\né‚£ä¹ˆå°±æ˜¯è¯´è¿™ä¸ªæ“ä½œä¸å¯é¿å…ï¼Œä¹Ÿæ²¡æœ‰å¾ˆå¤§ä¼˜åŒ–ç©ºé—´äº†\n\n\nè¿™é‡Œå°±æœ‰ä¸ªç–‘é—®äº†ï¼Œæ—¢ç„¶åªæ˜¯ä¸€ä¸ªå¯†ç è§£å¯†çš„æ“ä½œï¼Œä¸”åªæ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œä¸ºä»€ä¹ˆéœ€è¦è°ƒç”¨é‚£ä¹ˆå¤šæ¬¡ï¼Œåªéœ€è¦åœ¨æœåŠ¡å¯åŠ¨ä¹‹æ—¶è¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–çš„æ“ä½œå°±å¯ä»¥äº†\n\n#### å°è¯•ä¿®å¤\n\næ ¹æ®æŸ¥çœ‹ä»£ç é€»è¾‘ååˆ†æçš„åŸå› ï¼Œå°è¯•å°†è§£å¯†çš„æ“ä½œæ”¾åˆ°åˆå§‹åŒ–çš„æµç¨‹ä¸­ï¼Œå¹¶ä½¿ç”¨`functools.cached_property`ç¼“å­˜è®¡ç®—ç»“æœï¼ˆè¿™æ ·å°±å¯ä»¥ä¿è¯åªè¿›è¡Œä¸€æ¬¡è®¡ç®—ï¼Œåç»­ç›´æ¥ä»ç¼“å­˜è·å–ç»“æœï¼‰\n\nä¼ªä»£ç å¦‚ä¸‹ï¼š\n```python\n\n    @functools.cached_property\n    def mongo_password(self):\n      return decrypt(BaseConfig.cipher)\n\n```\n\n#### è¿˜æ²¡ç»“æŸï¼Ÿ\n\nä»£ç ä¿®æ”¹åå†æ¬¡`dump`æŸ¥çœ‹ä¼˜åŒ–ç»“æœ\n\n![1705728492283](Pythonæ€§èƒ½åˆ†æå®æˆ˜1.assets/1705728492282.png)\n\nçœ‹èµ·æ¥ä¼˜åŒ–çš„æ•ˆæœè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œä½†æ˜¯æ¥å£ä»ç„¶æœ‰`2s`çš„è€—æ—¶ï¼Œæ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„æ•ˆæœ\n\nåˆ†æè€—æ—¶ä¸»è¦æ˜¯åœ¨`service`ä¸­ä¸€ä¸ªæŸ¥è¯¢`instance`çš„æ–¹æ³•ï¼Œé€šè¿‡`id`æŸ¥è¯¢ {% label Mongo green %}\n\nè¿™é‡ŒæŸ¥è¯¢æ•°æ®çš„æ“ä½œå°±è€—è´¹äº†`2s`\n\n{% note info %}\n\nè¿™é‡ŒæŒ‰é“ç†å¦‚æœè¿™æ˜¯ä¸ªå•ç‹¬çš„ä¸€æ¬¡æŸ¥è¯¢ï¼Œ`2s`å·²ç»å±äºæ…¢æŸ¥è¯¢äº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ¥åˆ°æ…¢æŸ¥è¯¢çš„å‘Šè­¦æ¶ˆæ¯\n\nå¯ä»¥å…ˆçŒœæµ‹ä¸‹åŸå› \n\n{% endnote %}\n\n{% hideBlock å®é™…ç»“æœ,, %}\n\nå¥½å§ï¼Œè¿™é‡Œåº”è¯¥å·²ç»çŒœåˆ°äº†å¤§æ¦‚çš„åŸå› äº†\n\nè¿‡æ»¤ä¸‹`mongo`å’Œ`cursor`å…³é”®å­—\n\n![1705729070489](Pythonæ€§èƒ½åˆ†æå®æˆ˜1.assets/1705729070487.png)\n\n\nä»è¡¨æ ¼çš„æ•°æ®å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å•æ¬¡çš„è€—æ—¶éƒ½å±äºæ­£å¸¸èŒƒå›´ï¼Œé—®é¢˜å‡ºåœ¨è°ƒç”¨æ¬¡æ•°ä¸Š\n\nè°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œå¯¼è‡´æœ€ç»ˆç´¯è®¡è€—æ—¶è¿‡é•¿\n\nä»`cursor.py`ä¸­`_refresh`å’Œ`__send_message`æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ä¹Ÿèƒ½çœ‹å‡ºæœ‰çŒ«è…»ï¼Œå•æ¬¡æ¥å£ï¼ˆæœ¬èº«è¯¥æ¥å£å¹¶ä¸è¿”å›å¤§é‡æ•°æ®ï¼‰è®¿é—®éœ€è¦å‘`Mongo`è¯·æ±‚è¿‘100æ¬¡çš„æ•°æ®ï¼Œè¿™æ˜¾ç„¶ä¸å¤ªåˆç†\n\n#### è¿½æ ¹é—®åº•\n\nå®šä½åˆ°é—®é¢˜ä»£ç \n\nä»¥ä¸‹å±•ç¤ºä¼ªä»£ç ï¼š\n\n> å…¶å®è¯¥æ¥å£è·å–`instance`è¿™ä¸€æ­¥çš„æ“ä½œéå¸¸ç®€å•ï¼Œåªéœ€è¦æ ¹æ®`id`è·å–æ•°æ®ï¼Œå¹¶åšä¸€å®šçš„æ•°æ®å¯ŒåŒ–å’Œè½¬æ¢å³å¯\n\n```python\n\nfor id in ids:\n    instance =  InstanceColl().find_instance_by_id(id)\n    # æ¥ä¸‹æ¥æ˜¯æ•°æ®å¯ŒåŒ–å’Œè½¬æ¢çš„é€»è¾‘\n    # ...\n\n\n```\n\nè¿™é‡Œå¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°é—®é¢˜äº†ï¼Œä¸ºäº†æ–¹ä¾¿æ¥ä¸‹æ¥çš„æ•°æ®è½¬æ¢ï¼Œç›´æ¥å¯¹`ids`è¿›è¡Œéå†å¹¶åœ¨å¾ªç¯å†…åˆå§‹åŒ–`InstanceColl`å»æŸ¥è¯¢å•ä¸ª`id`çš„`instance`æ•°æ®\n\nè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦å»ºç«‹å¤§é‡`Mongo`è¿æ¥ï¼Œå¤šæ¬¡è¯·æ±‚`Mongo`è·å–æ•°æ®\n\n\n#### å®Œæˆä¿®å¤\n\næœ€ç»ˆå°†å¾ªç¯å•ä¸ªæŸ¥è¯¢`instance`çš„ä»£ç é‡å†™ï¼Œç›´æ¥ä½¿ç”¨`in`æŸ¥è¯¢ä¸€æ¬¡æŸ¥è¯¢æ‰€æœ‰`instance`å†è¿›è¡Œæ•°æ®å°è£…åï¼Œæ¥å£å“åº”æ—¶é—´ä¼˜åŒ–åˆ°`200ms`\n\n\n\n{% endhideBlock %}","tags":["Python"],"categories":["ç¼–ç¨‹è¯­è¨€","Python"]},{"title":"MongoDBå‰¯æœ¬é›†æ­å»º","url":"/posts/fd4a1d37/","content":"\n\n## MongoDBå‰¯æœ¬é›†æ­å»º\n\n\n### æ¦‚è¿°\n> æœ¬æ–‡å‚ç…§ {% label MongoDB green %}å®˜æ–¹æ–‡æ¡£ï¼ˆ[https://www.mongodb.com/docs/manual/tutorial/deploy-replica-set/#std-label-server-replica-set-deploy](https://www.mongodb.com/docs/manual/tutorial/deploy-replica-set/#std-label-server-replica-set-deploy)ï¼‰è¿›è¡Œå®è·µ\n> åŸºäºå•æœºç¯å¢ƒï¼Œå¯åŠ¨3ä¸ª`mongod`è¿›ç¨‹æ¨¡æ‹Ÿæ­å»ºmongoå‰¯æœ¬é›†ï¼ˆreplica setï¼‰\n\n#### å®è·µç¯å¢ƒ\n\n> ä½¿ç”¨å•å°æœºå™¨å¯åŠ¨å¤šä¸ª`mongod`è¿›ç¨‹æ¨¡æ‹Ÿé›†ç¾¤\n\næ“ä½œç³»ç»Ÿï¼ˆOSï¼‰ï¼š\n```bash\n$ cat /etc/redhat-release \nCentOS Linux release 7.9.2009 (Core)\n```\n\nä½¿ç”¨Dockeræ„å»ºMongoç¯å¢ƒ\n\nDockerç‰ˆæœ¬ï¼š\n\n```bash\n$ docker --version\nDocker version 1.13.1, build 7d71120/1.13.1\n```\n\nMongoé•œåƒç‰ˆæœ¬ï¼š\n```bash\n$ docker images | grep mongo\ndocker.io/mongo     4.2-bionic          e301407a044e        6 months ago        388 MB\n```\n\n{% note info %}\nCentOS7å®‰è£…Dockeræ•™ç¨‹ï¼š[https://cloud.tencent.com/developer/article/1701451](https://cloud.tencent.com/developer/article/1701451)\n{% endnote %}\n\n\n### ä¸€äº›å»ºè®®\n\n#### Hostnames\n\n{% note warning %}\nå®˜æ–¹å»ºè®®ä½¿ç”¨ {% label DNS purple %}ä»£æ›¿ç›´æ¥ä½¿ç”¨ {% label IP purple %}åœ°å€æ¥é…ç½®èŠ‚ç‚¹ä¿¡æ¯\n\nåœ¨ {% label MongoDB green %} 5.0å¼€å§‹ï¼Œå¦‚æœèŠ‚ç‚¹åªé…ç½®ä¸€ä¸ª {% label IP purple %}åœ°å€åˆ™å¯åŠ¨æ—¶å°±ä¼šæ ¡éªŒå¹¶ä¸”æ— æ³•å¯åŠ¨\n\n{% hideBlock å®˜æ–¹åŸæ–‡,, %}\n> Use hostnames instead of IP addresses to configure clusters across a split network horizon. Starting in MongoDB 5.0, nodes that are only configured with an IP address will fail startup validation and will not start.\n\n{% endhideBlock %}\n{% endnote %}\n\n\n\n### å‰ç½®é…ç½®\n\n#### é…ç½®åŸŸåæ˜ å°„\nåˆ†åˆ«ä¸º3ä¸ª`mongod`è¿›ç¨‹çš„hostnameé…ç½®åŸŸåæ˜ å°„\n\n```bash\n$ vim /etc/hosts\n```\n\nè¿½åŠ ä»¥ä¸‹åŸŸåé…ç½®\n\n```\n127.0.0.1 mongodb0.example.net\n127.0.0.1 mongodb1.example.net\n127.0.0.1 mongodb2.example.net\n```\n\n\n\n#### åˆ›å»ºç›®å½•ä¸æ–‡ä»¶\n\n##### åˆ›å»ºæ•°æ®ç›®å½•\n\n```bash\n$ mkdir /data/mongod0 /data/mongod1 /data/mongod2\n```\n\n##### åˆ›å»ºé…ç½®æ–‡ä»¶\n\n{% hideToggle æ ·ä¾‹é…ç½®æ–‡ä»¶,, %}\nå–è‡ªé•œåƒä¸­çš„é…ç½®æ¨¡æ¿æ–‡ä»¶`/etc/mongod.conf.orig`\n\n```yaml\n# mongod.conf\n\n# for documentation of all options, see:\n#   http://docs.mongodb.org/manual/reference/configuration-options/\n\n# Where and how to store data.\nstorage:\n  # æ•°æ®ç›®å½•\n  dbPath: /data/mongod0\n#  engine:\n#  mmapv1:\n#  wiredTiger:\n\n# where to write logging data.\nsystemLog:\n  # æ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶\n  destination: file\n  # å¦‚æœæ—¥å¿—æ–‡ä»¶å­˜åœ¨åˆ™è¿›è¡Œæ—¥å¿—è¿½åŠ \n  logAppend: true\n  # æ—¥å¿—æ–‡ä»¶è·¯å¾„\n  path: /var/log/mongodb/mongod0.log\n\n# network interfaces\nnet:\n  port: 17000\n  bindIp: 0.0.0.0\n  # å’ŒbindIp: ::,0.0.0.0æ•ˆæœç›¸åŒ\n  # bindIpAll: true\n\n# how the process runs\nprocessManagement:\n  # forkå­è¿›ç¨‹çš„å½¢å¼å¯åŠ¨ï¼Œæ­¤å‚æ•°ç”¨äºåå°å¯åŠ¨æœåŠ¡\n  fork: true\n\nreplication:\n   # å‰¯æœ¬é›†åç§°ï¼Œå‰¯æœ¬é›†éƒ¨ç½²å¿…é¡»å¡«å†™ï¼Œç”¨äºåŒºåˆ†æ‰€å±çš„å‰¯æœ¬é›†\n   replSetName: \"rs-example-0\"\n```\n\n{% endhideToggle %}\n\n\n\næ ¹æ®æ¨¡æ¿é…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹`storage.dbpath`ã€`systemLog.path`ã€`net.port`ï¼Œåˆ†åˆ«ç»™ä¸‰ä¸ªä¸åŒçš„`mongod`å®ä¾‹ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š\n\n```bash\n$ ls -lh /etc/mongod\ntotal 12K\n-rw-r--r--. 1 root root 707 Sep 17 07:47 mongod0.conf\n-rw-r--r--. 1 root root 707 Sep 17 07:47 mongod1.conf\n-rw-r--r--. 1 root root 707 Sep 17 07:47 mongod2.conf\n```\n\n\n\n\n\n### æ­¥éª¤\n\n#### ä¾æ¬¡å¯åŠ¨mongodè¿›ç¨‹\n\n\n\n```bash\n# ä½¿ç”¨--configæˆ–-få‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶\n$ mongod -f /etc/mongod/mongod0.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 643\nchild process started successfully, parent exiting\n\n$ mongod -f /etc/mongod/mongod1.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 692\nchild process started successfully, parent exiting\n\n$ mongod -f /etc/mongod/mongod2.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 730\nchild process started successfully, parent exiting\n```\n\n\n\n```bash\n$ ps -ef | grep mongod\nroot       643     0  2 07:42 ?        00:00:12 mongod -f mongod0.conf\nroot       692     0  2 07:49 ?        00:00:00 mongod -f mongod1.conf\nroot       730     0  8 07:49 ?        00:00:01 mongod -f mongod2.conf\nroot       769     6  0 07:50 ?        00:00:00 grep mongod\n```\n\næˆåŠŸå¯åŠ¨ä¸‰ä¸ª`mongod`è¿›ç¨‹\n\n\n\n#### è¿æ¥å…¶ä¸­ä¸€ä¸ªmongodå®ä¾‹\n\n**Connect mongosh to one of the mongod instances.**\n\n{% note info %}\n\nå®˜ç½‘ä½¿ç”¨`mongosh`çš„å‘½ä»¤è¡Œå·¥å…·è¿›è¡Œè¿æ¥ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨`mongo`çš„äºŒè¿›åˆ¶å·¥å…·ï¼Œæ³¨æ„æŒ‡å®šè¿æ¥ä¸»æœºå’Œç«¯å£ï¼Œé»˜è®¤ä½¿ç”¨27017\n\n{% endnote %}\n\nå°è¯•ä½¿ç”¨`mongo`å‘½ä»¤è¿æ¥`mongod0`å®ä¾‹\n\n```bash\n$ mongo --host mongodb0.example.net --port 17000\nMongoDB shell version v4.2.24\nconnecting to: mongodb://127.0.0.1:17000/?compressors=disabled&gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"f81fbaff-63d9-45fa-8043-8c5c6cf97105\") }\nMongoDB server version: 4.2.24\n...\n```\n\nè¿æ¥æˆåŠŸ\n\n\n\n#### åˆå§‹åŒ–å‰¯æœ¬é›†\n\n**Initiate the replica set.**\n\n{% note warning %}\n\nåªéœ€è¦åœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œ`rs.initiate()`\n\n{% endnote %}\n\n```bash\n> rs.initiate({\"_id\": \"rs-example-0\", \"members\": [{\"_id\": 0, \"host\": \"mongodb0.example.net:17000\"}]})\n{ \"ok\" : 1 }\nrs-example-0:OTHER> \n\nrs-example-0:PRIMARY> \n```\n\nä»¥ä¸Šæ­¥éª¤ä¸­ï¼Œå°†`mongod0`å®ä¾‹åŠ å…¥åˆ°åä¸º`rs-example-0`çš„å‰¯æœ¬é›†ä¸­ï¼ŒæˆåŠŸåè§‚å¯Ÿåˆ°å‘½ä»¤è¡Œæç¤ºç¬¦æ˜¾ç¤ºè§’è‰²ä¸º {% label OTHER purple %}ï¼Œå†æ¬¡å›è½¦ååˆ™å˜ä¸º {% label PRIMARY purple %}\n\n\n\nå†ä½¿ç”¨`rs.add()`å‘½ä»¤ä¾æ¬¡æ·»åŠ å·²æœ‰èŠ‚ç‚¹åŠ å…¥å‰¯æœ¬é›†\n\n```bash\nrs-example-0:PRIMARY> rs.add({\"_id\": 1, \"host\": \"mongodb1.example.net:17001\"})\n{\n        \"ok\" : 1,\n        \"$clusterTime\" : {\n                \"clusterTime\" : Timestamp(1694939436, 1),\n                \"signature\" : {\n                        \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"),\n                        \"keyId\" : NumberLong(0)\n                }\n        },\n        \"operationTime\" : Timestamp(1694939436, 1)\n}\n\nrs-example-0:PRIMARY> rs.add({\"_id\": 2, \"host\": \"mongodb2.example.net:17002\"})\n{\n        \"ok\" : 1,\n        \"$clusterTime\" : {\n                \"clusterTime\" : Timestamp(1694939337, 1),\n                \"signature\" : {\n                        \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"),\n                        \"keyId\" : NumberLong(0)\n                }\n        },\n        \"operationTime\" : Timestamp(1694939337, 1)\n}\n```\n\n\n\n{% note info %}\n\nä¹Ÿå¯ä»¥ç”¨`rs.initiate()`ä¼ å…¥æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ç›´æ¥å®Œæˆåˆå§‹åŒ–\n\n{% endnote %}\n\n\n\n##### å¸¸è§é—®é¢˜\n\n###### ç©ºå‚è°ƒç”¨`rs.initiate()`æŠ¥é”™ï¼Œ`hostname`é…ç½®é”™è¯¯\n\n```bash\n> rs.initiate()\n{\n        \"ok\" : 0,\n        \"errmsg\" : \"No host described in new configuration 1 for replica set rs-example-0 maps to this node\",\n        \"code\" : 93,\n        \"codeName\" : \"InvalidReplicaSetConfig\"\n}\n```\n\n\n\nè§£æï¼šå½“ç©ºå‚è°ƒç”¨æ—¶ï¼Œmongodbä½¿ç”¨æœ¬æœºçš„`hostname`ä½œä¸ºé»˜è®¤çš„é…ç½®ï¼Œå¦‚æœ`hostname`æ— æ³•ä½œä¸ºDNSè§£æçš„è¯ï¼Œé‚£ä¹ˆå°±ä¼šæŠ¥æ‰¾ä¸åˆ°å¯¹åº”çš„ä¸»æœº\n\n\n\næŸ¥è¯¢æœ¬æœº`hostname`é…ç½®\n\n```bash\n# å½“å‰é…ç½®\n$ hostname\nCrayon\n\n# ä¿®æ”¹\n$ hostname mongodb0.example.net\n\n# æŸ¥çœ‹æ˜¯å¦ä¿®æ”¹æˆåŠŸ\n$ hostname\nmongodb0.example.net\n```\n\n\n\nå†æ¬¡æ‰§è¡Œ`rs.initiate()`\n\n```bash\n> rs.initiate()\n{\n        \"info2\" : \"no configuration specified. Using a default configuration for the set\",\n        \"me\" : \"mongodb0.example.net:17000\",\n        \"ok\" : 1\n}\n```\n\n\n\n\n\n###### ç¼ºå°‘`members`å‚æ•°\n\n```bash\n> rs.initiate({_id: \"rs\"})\n{\n        \"ok\" : 0,\n        \"errmsg\" : \"Missing expected field \\\"members\\\"\",\n        \"code\" : 93,\n        \"codeName\" : \"InvalidReplicaSetConfig\"\n}\n```\n\næ·»åŠ `members`å‚æ•°å³å¯\n\n\n\n###### `_id`ä¸é…ç½®æ–‡ä»¶ä¸­çš„å‰¯æœ¬é›†åç§°ä¸ä¸€è‡´\n\n```bash\n> rs.initiate({_id: \"rs\", \"members\": []})\n{\n        \"ok\" : 0,\n        \"errmsg\" : \"Attempting to initiate a replica set with name rs, but command line reports rs-example-0; rejecting\",\n        \"code\" : 93,\n        \"codeName\" : \"InvalidReplicaSetConfig\"\n}\n```\n\n\n\n###### å‰¯æœ¬é›†èŠ‚ç‚¹æ•°ä¸è¶³\n\n```bash\n> rs.initiate({\"_id\": \"rs-example-0\", \"members\": []})\n{\n        \"ok\" : 0,\n        \"errmsg\" : \"Replica set configuration contains 0 members, but must have at least 1 and no more than  50\",\n        \"code\" : 93,\n        \"codeName\" : \"InvalidReplicaSetConfig\"\n}\n```\n\nå‰¯æœ¬é›†è¦æ±‚è‡³å°‘1ä¸ªèŠ‚ç‚¹ï¼Œè‡³å¤š50ä¸ªèŠ‚ç‚¹\n\n\n\n##### æŸ¥çœ‹å‰¯æœ¬é›†é…ç½®\n\n**View the replica set configuration.**\n\nä½¿ç”¨`rs.conf()`å¯ä»¥æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ‰€åœ¨å‰¯æœ¬é›†çš„é…ç½®ä¿¡æ¯\n\n{% hideToggle ç‚¹æˆ‘å±•å¼€,, %}\n\n```bash\nrs-example-0:PRIMARY> rs.conf()\n{\n        \"_id\" : \"rs-example-0\",\n        \"version\" : 5,\n        \"protocolVersion\" : NumberLong(1),\n        \"writeConcernMajorityJournalDefault\" : true,\n        \"members\" : [\n                {\n                        \"_id\" : 0,\n                        \"host\" : \"mongodb0.example.net:17000\",\n                        \"arbiterOnly\" : false,\n                        \"buildIndexes\" : true,\n                        \"hidden\" : false,\n                        \"priority\" : 1,\n                        \"tags\" : {\n\n                        },\n                        \"slaveDelay\" : NumberLong(0),\n                        \"votes\" : 1\n                },\n                {\n                        \"_id\" : 2,\n                        \"host\" : \"mongodb2.example.net:17002\",\n                        \"arbiterOnly\" : false,\n                        \"buildIndexes\" : true,\n                        \"hidden\" : false,\n                        \"priority\" : 1,\n                        \"tags\" : {\n\n                        },\n                        \"slaveDelay\" : NumberLong(0),\n                        \"votes\" : 1\n                },\n                {\n                        \"_id\" : 1,\n                        \"host\" : \"mongodb1.example.net:17001\",\n                        \"arbiterOnly\" : false,\n                        \"buildIndexes\" : true,\n                        \"hidden\" : false,\n                        \"priority\" : 1,\n                        \"tags\" : {\n\n                        },\n                        \"slaveDelay\" : NumberLong(0),\n                        \"votes\" : 1\n                }\n        ],\n        \"settings\" : {\n                \"chainingAllowed\" : true,\n                \"heartbeatIntervalMillis\" : 2000,\n                \"heartbeatTimeoutSecs\" : 10,\n                \"electionTimeoutMillis\" : 10000,\n                \"catchUpTimeoutMillis\" : -1,\n                \"catchUpTakeoverDelayMillis\" : 30000,\n                \"getLastErrorModes\" : {\n\n                },\n                \"getLastErrorDefaults\" : {\n                        \"w\" : 1,\n                        \"wtimeout\" : 0\n                },\n                \"replicaSetId\" : ObjectId(\"6506b39ed951f6176dfb632d\")\n        }\n}\n```\n\n{% endhideToggle %}\n\n\n##### æŸ¥çœ‹å‰¯æœ¬é›†çŠ¶æ€\n\nä½¿ç”¨`rs.status()`å¯ä»¥æŸ¥çœ‹å½“å‰å‰¯æœ¬é›†çŠ¶æ€\n\n{% hideToggle ç‚¹æˆ‘å±•å¼€,, %}\n\n```bash\nrs-example-0:SECONDARY> rs.status()\n{\n        \"set\" : \"rs-example-0\",\n        \"date\" : ISODate(\"2023-09-17T08:49:41.493Z\"),\n        \"myState\" : 2,\n        \"term\" : NumberLong(1),\n        \"syncingTo\" : \"mongodb0.example.net:17000\",\n        \"syncSourceHost\" : \"mongodb0.example.net:17000\",\n        \"syncSourceId\" : 0,\n        \"heartbeatIntervalMillis\" : NumberLong(2000),\n        \"majorityVoteCount\" : 2,\n        \"writeMajorityCount\" : 2,\n        \"optimes\" : {\n                \"lastCommittedOpTime\" : {\n                        \"ts\" : Timestamp(1694940575, 1),\n                        \"t\" : NumberLong(1)\n                },\n                \"lastCommittedWallTime\" : ISODate(\"2023-09-17T08:49:35.387Z\"),\n                \"readConcernMajorityOpTime\" : {\n                        \"ts\" : Timestamp(1694940575, 1),\n                        \"t\" : NumberLong(1)\n                },\n                \"readConcernMajorityWallTime\" : ISODate(\"2023-09-17T08:49:35.387Z\"),\n                \"appliedOpTime\" : {\n                        \"ts\" : Timestamp(1694940575, 1),\n                        \"t\" : NumberLong(1)\n                },\n                \"durableOpTime\" : {\n                        \"ts\" : Timestamp(1694940575, 1),\n                        \"t\" : NumberLong(1)\n                },\n                \"lastAppliedWallTime\" : ISODate(\"2023-09-17T08:49:35.387Z\"),\n                \"lastDurableWallTime\" : ISODate(\"2023-09-17T08:49:35.387Z\")\n        },\n        \"lastStableRecoveryTimestamp\" : Timestamp(1694940515, 1),\n        \"lastStableCheckpointTimestamp\" : Timestamp(1694940515, 1),\n        \"members\" : [\n                {\n                        \"_id\" : 0,\n                        \"name\" : \"mongodb0.example.net:17000\",\n                        \"health\" : 1,\n                        \"state\" : 1,\n                        \"stateStr\" : \"PRIMARY\",\n                        \"uptime\" : 1144,\n                        \"optime\" : {\n                                \"ts\" : Timestamp(1694940575, 1),\n                                \"t\" : NumberLong(1)\n                        },\n                        \"optimeDurable\" : {\n                                \"ts\" : Timestamp(1694940575, 1),\n                                \"t\" : NumberLong(1)\n                        },\n                        \"optimeDate\" : ISODate(\"2023-09-17T08:49:35Z\"),\n                        \"optimeDurableDate\" : ISODate(\"2023-09-17T08:49:35Z\"),\n                        \"lastHeartbeat\" : ISODate(\"2023-09-17T08:49:41.167Z\"),\n                        \"lastHeartbeatRecv\" : ISODate(\"2023-09-17T08:49:40.819Z\"),\n                        \"pingMs\" : NumberLong(0),\n                        \"lastHeartbeatMessage\" : \"\",\n                        \"syncingTo\" : \"\",\n                        \"syncSourceHost\" : \"\",\n                        \"syncSourceId\" : -1,\n                        \"infoMessage\" : \"\",\n                        \"electionTime\" : Timestamp(1694938014, 2),\n                        \"electionDate\" : ISODate(\"2023-09-17T08:06:54Z\"),\n                        \"configVersion\" : 5\n                },\n                {\n                        \"_id\" : 1,\n                        \"name\" : \"mongodb1.example.net:17001\",\n                        \"health\" : 1,\n                        \"state\" : 2,\n                        \"stateStr\" : \"SECONDARY\",\n                        \"uptime\" : 1178,\n                        \"optime\" : {\n                                \"ts\" : Timestamp(1694940575, 1),\n                                \"t\" : NumberLong(1)\n                        },\n                        \"optimeDate\" : ISODate(\"2023-09-17T08:49:35Z\"),\n                        \"syncingTo\" : \"mongodb0.example.net:17000\",\n                        \"syncSourceHost\" : \"mongodb0.example.net:17000\",\n                        \"syncSourceId\" : 0,\n                        \"infoMessage\" : \"\",\n                        \"configVersion\" : 5,\n                        \"self\" : true,\n                        \"lastHeartbeatMessage\" : \"\"\n                },\n                {\n                        \"_id\" : 2,\n                        \"name\" : \"mongodb2.example.net:17002\",\n                        \"health\" : 1,\n                        \"state\" : 2,\n                        \"stateStr\" : \"SECONDARY\",\n                        \"uptime\" : 1144,\n                        \"optime\" : {\n                                \"ts\" : Timestamp(1694940575, 1),\n                                \"t\" : NumberLong(1)\n                        },\n                        \"optimeDurable\" : {\n                                \"ts\" : Timestamp(1694940575, 1),\n                                \"t\" : NumberLong(1)\n                        },\n                        \"optimeDate\" : ISODate(\"2023-09-17T08:49:35Z\"),\n                        \"optimeDurableDate\" : ISODate(\"2023-09-17T08:49:35Z\"),\n                        \"lastHeartbeat\" : ISODate(\"2023-09-17T08:49:41.167Z\"),\n                        \"lastHeartbeatRecv\" : ISODate(\"2023-09-17T08:49:41.170Z\"),\n                        \"pingMs\" : NumberLong(0),\n                        \"lastHeartbeatMessage\" : \"\",\n                        \"syncingTo\" : \"mongodb0.example.net:17000\",\n                        \"syncSourceHost\" : \"mongodb0.example.net:17000\",\n                        \"syncSourceId\" : 0,\n                        \"infoMessage\" : \"\",\n                        \"configVersion\" : 5\n                }\n        ],\n        \"ok\" : 1,\n        \"$clusterTime\" : {\n                \"clusterTime\" : Timestamp(1694940575, 1),\n                \"signature\" : {\n                        \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"),\n                        \"keyId\" : NumberLong(0)\n                }\n        },\n        \"operationTime\" : Timestamp(1694940575, 1)\n}\n```\n\n{% endhideToggle %}\n\n\n\n#### å…³é—­mongodè¿›ç¨‹\n\n##### mongoå‘½ä»¤\n\nä½¿ç”¨`mongo`å‘½ä»¤è¿æ¥åˆ°`mongod`åï¼Œä½¿ç”¨\n\n```bash\n# åˆ‡æ¢åˆ°adminåº“\nrs-example-0:SECONDARY> use admin\nrs-example-0:SECONDARY> db.shutdownServer()\n\n```\n\n{% note info %}\n\néœ€è¦å…ˆåˆ‡æ¢åˆ°`admin`åº“\n\n{% endnote %}\n\n\n\næ‰§è¡Œå®Œæ¯•å`mongo`å‘½ä»¤ä¼šè‡ªåŠ¨æ–­å¼€ä¸`mongod`çš„è¿æ¥\n\nä¼šæœ‰ä»¥ä¸‹æ—¥å¿—æŠ¥é”™\n\n{% hideToggle ç‚¹å‡»å±•å¼€,, %}\n\n\n\n```bash\n2023-12-23T14:53:57.358+0000 I  NETWORK  [js] DBClientConnection failed to receive message from mongodb2.example.net:17002 - HostUnreachable: Connection closed by peer\nserver should be down...\n2023-12-23T14:53:57.360+0000 I  NETWORK  [js] trying reconnect to mongodb2.example.net:17002 failed\n2023-12-23T14:53:57.360+0000 I  NETWORK  [js] reconnect mongodb2.example.net:17002 failed failed \n> exit\nbye\n2023-12-23T14:53:58.363+0000 I  NETWORK  [js] trying reconnect to mongodb2.example.net:17002 failed\n2023-12-23T14:53:58.363+0000 I  NETWORK  [js] reconnect mongodb2.example.net:17002 failed failed \n2023-12-23T14:53:58.363+0000 I  QUERY    [js] Failed to end session { id: UUID(\"2135374c-738d-4033-be37-87d9292704b4\") } due to SocketException: socket exception [CONNECT_ERROR] server [couldn't connect to server mongodb2.example.net:17002, connection attempt failed: SocketException: Error connecting to mongodb2.example.net:17002 (127.0.0.1:17002) :: caused by :: Connection refused]\n```\n\n\n\n{% endhideToggle %}\n\n\n\n##### mongodå‘½ä»¤\n\nç›´æ¥ä½¿ç”¨`mongod`å‘½ä»¤\n\n```bash\n$ mongod -f [config] --shutdown\n```\n\n{% note info %}\n\n éœ€è¦æŒ‡å®š`-f`æˆ–`--config`å‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶ï¼ˆ`-f`å’Œ`--config`ç­‰æ•ˆï¼‰\n\næˆ–è€…`--dbpath` æŒ‡å®šæ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼ˆå…¶å®`-f`/`--config`ä¹Ÿæ˜¯é€šè¿‡è¯»å–`dbpath`çš„å‚æ•°è·å–äº†æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼‰\n\næœ¬è´¨ä¸ŠåŸç†æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯é€šè¿‡`dbpath`ä¸‹é¢çš„`mongod.lock`æ–‡ä»¶è·å–å®ä¾‹è¿›ç¨‹å‘é€ä¿¡å·é€€å‡ºè¿›ç¨‹\n\n```bash\n$ cat /data/mongod0/mongod.lock\n276\n```\n\n\n\n\n\n{% endnote %}","tags":["æ•°æ®åº“","NoSQL","MongoDB"],"categories":["MongoDB"]},{"title":"LC-17-ç”µè¯å·ç çš„å­—æ¯ç»„åˆ","url":"/posts/6fe015cf/","content":"\n## ç”µè¯å·ç çš„å­—æ¯ç»„åˆ\n\nLeetCodeé¢˜ç›®é“¾æ¥ï¼š[17. ç”µè¯å·ç çš„å­—æ¯ç»„åˆ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰](https://leetcode.cn/problems/letter-combinations-of-a-phone-number/description/)\n\néš¾åº¦ï¼š{% label ä¸­ç­‰ orange %}\n\n\n\n### åˆ†æ\n\næœ¬é¢˜å±äºå…¸å‹çš„é€’å½’å›æº¯çš„é¢˜å‹ï¼Œæ ¹æ®æ•°å­—æŸ¥æ‰¾å¯ä½¿ç”¨çš„å­—æ¯ï¼Œåœ¨è¿›è¡Œéå†é€’å½’å›æº¯ç»„åˆå‡ºæ‰€æœ‰å¯èƒ½çš„ç»„åˆå³å¯\n\n![1688805900848](LC-17-ç”µè¯å·ç çš„å­—æ¯ç»„åˆ.assets/1688805900848.png)  \n\n\n### æ€è·¯\n\n>   1.  é€’å½’çºµå‘éå†æ•°å­—ä¸²ï¼ˆé€’å½’è¿‡ç¨‹ä¸­å½“å‰éå†çš„ç´¢å¼•å³å¯å®ç°é€’å½’çºµå‘éå†ï¼‰\n>   2.  æ ¹æ®æ•°å­—å–å‡ºå¯¹åº”çš„å­—æ¯é›†åˆ\n>   3.  éå†è¯¥é›†åˆç»„åˆç»“æœ\n>\n>   é€’å½’ç»“æŸæ¡ä»¶ï¼šå½“ç»“æœé›†ä¸­çš„å­—æ¯å’Œæ‰€ç»™æ•°å­—ä¸€æ ·å¤šæ—¶ï¼Œå³éå†ç»“æŸ\n\n\n\n{% hideToggle ç‚¹æˆ‘å±•å¼€,, %}\n\n{% tabs ä»£ç  %}\n\n<!-- tab Golang -->\n\n```go\nconst (\n    CHAR_ONE   = '1'\n    CHAR_TWO   = '2'\n    CHAR_THREE = '3'\n    CHAR_FOUR  = '4'\n    CHAR_FIVE  = '5'\n    CHAR_SIX   = '6'\n    CHAR_SEVEN = '7'\n    CHAR_EIGHT = '8'\n    CHAR_NINE  = '9'\n)\n\nvar (\n    ONE_LETTERS   = []uint8{}\n    TWO_LETTERS   = []uint8{'a', 'b', 'c'}\n    THREE_LETTERS = []uint8{'d', 'e', 'f'}\n    FOUR_LETTERS  = []uint8{'g', 'h', 'i'}\n    FIVE_LETTERS  = []uint8{'j', 'k', 'l'}\n    SIX_LETTERS   = []uint8{'m', 'n', 'o'}\n    SEVEN_LETTERS = []uint8{'p', 'q', 'r', 's'}\n    EIGHT_LETTERS = []uint8{'t', 'u', 'v'}\n    NINE_LETTERS  = []uint8{'w', 'x', 'y', 'z'}\n)\n\nvar NUM_LETTERS_COR_MAP = map[uint8][]uint8{\n    CHAR_ONE:   ONE_LETTERS,\n    CHAR_TWO:   TWO_LETTERS,\n    CHAR_THREE: THREE_LETTERS,\n    CHAR_FOUR:  FOUR_LETTERS,\n    CHAR_FIVE:  FIVE_LETTERS,\n    CHAR_SIX:   SIX_LETTERS,\n    CHAR_SEVEN: SEVEN_LETTERS,\n    CHAR_EIGHT: EIGHT_LETTERS,\n    CHAR_NINE:  NINE_LETTERS,\n}\n\nfunc recurve(digits string, ret *[]string, index int, cur []uint8) {\n    if index == len(digits){\n        // é€’å½’ç»“æŸï¼ŒåŠ å…¥ç»“æœé›†\n        if len(cur) > 0 {\n            *ret = append(*ret, string(cur))\n        }\n        return\n    }\n\n    digit := digits[index]\n    letters := NUM_LETTERS_COR_MAP[digit]\n    for _, letter := range letters {\n        recurve(digits, ret, index+1, append(cur, letter))\n    }\n}\n\nfunc letterCombinations(digits string) []string {\n    var ret []string\n    recurve(digits, &ret, 0, []uint8{})\n    return ret\n}\n```\n\n<!-- endtab -->\n\n<!-- tab Java -->\n\n```java\n\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n{% endhideToggle %}\n\n","tags":["LeetCode","ç®—æ³•-å›æº¯"],"categories":["ç®—æ³•","å›æº¯"]},{"title":"1.1-å®¹å™¨çš„åŸºæœ¬æ“ä½œå’Œå®ç°åŸç†","url":"/posts/dee5f7cb/","content":"\n## å®¹å™¨çš„åŸºæœ¬æ“ä½œå’Œå®ç°åŸç†\n\n### å®¹å™¨æ˜¯ä»€ä¹ˆ\né•œåƒå°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„**æ–‡ä»¶ç³»ç»Ÿ**\nå®ƒæä¾›äº†å®¹å™¨ä¸­ç¨‹åºæ‰§è¡Œéœ€è¦çš„æ‰€æœ‰æ–‡ä»¶ã€‚å…·ä½“æ¥è¯´å°±æ˜¯åº”ç”¨ç¨‹åºæƒ³è¦å¯åŠ¨ï¼Œéœ€è¦ä¸‰ç±»æ–‡ä»¶ï¼š\n- ç›¸å…³çš„ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶ã€åº“æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶\n\nè¿™ä¸‰ç±»æ–‡ä»¶éƒ½è¢«å®¹å™¨æ‰“åŒ…å¥½äº†\nè¿™æ ·ï¼Œåœ¨å®¹å™¨è¿è¡Œçš„æ—¶å€™å°±ä¸å†ä¾èµ–å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æ“ä½œç³»ç»Ÿç±»å‹å’Œé…ç½®äº†\n\nä»ç”¨æˆ·ä½¿ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œå®¹å™¨å’Œä¸€å°ç‹¬ç«‹çš„æœºå™¨æˆ–è€…è™šæ‹Ÿæœºæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„åŒºåˆ«\nä½†æ˜¯å®ƒå’Œè™šæ‹Ÿæœºç›¸æ¯”ï¼Œå´æ²¡æœ‰å„ç§å¤æ‚çš„**ç¡¬ä»¶è™šæ‹Ÿå±‚**ï¼Œæ²¡æœ‰ç‹¬ç«‹çš„Linuxå†…æ ¸\n\nå®¹å™¨çš„æ‰€æœ‰è¿›ç¨‹è°ƒåº¦ã€å†…å­˜è®¿é—®ã€æ–‡ä»¶è¯»å†™éƒ½æ˜¯ç›´æ¥è·‘åœ¨å®¿ä¸»æœºçš„å†…æ ¸ä¹‹ä¸Šçš„ã€‚\n\n### å¦‚ä½•å®ç°çš„\nä¸¤ä¸ªæœ¯è¯­\n1. Namespace\n2. Cgroups\n\nè¿™ä¸¤é¡¹æŠ€æœ¯å¯ä»¥è®©ç¨‹åºåœ¨ä¸€ä¸ªèµ„æºå¯æ§çš„ç‹¬ç«‹ï¼ˆéš”ç¦»ï¼‰ç¯å¢ƒä¸­è¿è¡Œï¼Œè¿™ä¸ªå°±æ˜¯å®¹å™¨äº†ã€‚\n\n#### Namespace\næŸ¥çœ‹dockerå®¹å™¨ä¸­çš„è¿›ç¨‹æƒ…å†µ\n```bash\n$ docker exec <containerID> ps -ef\nPID   USER     TIME  COMMAND\n    1 root      0:00 nginx: master process nginx -g daemon off;\n   24 nginx     0:01 nginx: worker process\n   25 root      0:00 ps -ef\n```\nç›´æ¥åœ¨å®¿ä¸»æœºæ‰§è¡Œ`ps -ef | grep nginx`ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™å‡ ä¸ªè¿›ç¨‹\n```bash\n$ ps -ef | grep nginx\nroot       818   760  0 Jan18 ?        00:00:00 nginx: master process nginx -g daemon off;\nsystemd+   921   818  0 Jan18 ?        00:00:01 nginx: worker process\nroot      1305  1276  0 Jan18 ?        00:00:00 nginx: master process nginx -g daemon off;\nroot      1367  1305  0 Jan18 ?        00:00:00 nginx: worker process\n```\n\n![1674991583875](å®¹å™¨å®æˆ˜.assets/1674991583875.png)\n\nLinuxåœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª`PID Namespace`ï¼Œä¼šå•ç‹¬å¯¹è¿›ç¨‹è¿›è¡ŒPIDçš„ç¼–å·ï¼ˆæ¯ä¸ªNamespaceçš„PIDç¼–å·éƒ½æ˜¯ä»1å¼€å§‹çš„ï¼‰ã€‚\nåœ¨è¿™ä¸ª`PID Namespace`ä¸­æ˜¯çœ‹ä¸åˆ°å…¶ä»–Namespaceé‡Œçš„è¿›ç¨‹çš„ã€‚\n\nè€Œåœ¨å®¿ä¸»æœºä¸Šçš„`Host PID Namespace`ï¼Œå®ƒæ˜¯å…¶ä»–Namespaceçš„çˆ¶Namespaceï¼Œå¯ä»¥çœ‹åˆ°è¿™å°æœºå™¨ä¸Šçš„æ‰€æœ‰è¿›ç¨‹ï¼Œä¸è¿‡è¿›ç¨‹ç¼–å·ä¸æ˜¯`Container PID Namespace`é‡Œçš„ç¼–å·äº†ã€‚\n\nNamespaceå…¶å®å°±æ˜¯ä¸€ç§éš”ç¦»æœºåˆ¶ï¼Œä¸»è¦ç›®çš„æ˜¯éš”ç¦»è¿è¡Œåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„å®¹å™¨ï¼Œè®©è¿™äº›å®¹å™¨ä¹‹é—´ä¸èƒ½è®¿é—®å½¼æ­¤çš„èµ„æºã€‚\n\nä½œç”¨ï¼š\n1. å¯ä»¥å……åˆ†åˆ©ç”¨ç³»ç»Ÿçš„èµ„æºï¼ŒåŒä¸€å°å®¿ä¸»æœºä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªç”¨æˆ·çš„å®¹å™¨\n2. ä¿è¯å®‰å…¨æ€§ï¼Œå› ä¸ºä¸åŒç”¨æˆ·ä¹‹é—´ä¸èƒ½è®¿é—®å¯¹æ–¹çš„èµ„æº\n\nNamespaceç±»å‹ï¼š\n- Cgroup\n- IPC\n- Network\n- Mount\n- PID\n- Time\n- User\n- UTS\n\n![1674992082859](å®¹å™¨å®æˆ˜.assets/1674992082859.png)\n\n\n#### Cgroups\n\nCgroupsï¼ˆControl Groupsï¼‰\nå¯ä»¥å¯¹æŒ‡å®šçš„è¿›ç¨‹åšå„ç§è®¡ç®—æœºèµ„æºçš„é™åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶CPUçš„ä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€IOè®¾å¤‡çš„æµé‡ç­‰ç­‰ã€‚\n\n> Cgroupså®šä¹‰ï¼š\n>\n\nå‡ ç§å¸¸ç”¨çš„Cgroupså­ç³»ç»Ÿï¼š\n- cpuå­ç³»ç»Ÿï¼Œç”¨æ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„ï¼ˆä¸€ç»„è¿›ç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå®¹å™¨é‡Œé¢çš„æ‰€æœ‰è¿›ç¨‹ï¼‰å¯ä½¿ç”¨çš„æœ€å¤§CPU\n- memoryå­ç³»ç»Ÿï¼Œç”¨æ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„æœ€å¤§çš„å†…å­˜ä½¿ç”¨é‡\n- pidså­ç³»ç»Ÿï¼Œç”¨æ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„é‡Œæœ€å¤šå¯ä»¥è¿è¡Œå¤šå°‘ä¸ªè¿›ç¨‹\n- cpusetå­ç³»ç»Ÿï¼Œç”¨æ¥é™åˆ¶ä¸€ä¸ªæ§åˆ¶ç»„é‡Œçš„è¿›ç¨‹å¯ä»¥åœ¨å“ªå‡ ä¸ªç‰©ç†CPUä¸Šè¿è¡Œ\n\n> Cgroupsæœ‰v1å’Œv2ä¸¤ä¸ªç‰ˆæœ¬ï¼š\n> v1åœ¨Linuxä¸­å¾ˆæ—©å°±å®ç°äº†ï¼Œå„ç§å­ç³»ç»Ÿæ¯”è¾ƒç‹¬ç«‹ï¼Œæ¯ä¸ªè¿›ç¨‹åœ¨å„ä¸ªCgroupså­ç³»ç»Ÿä¸­ç‹¬ç«‹é…ç½®ï¼Œ**å¯ä»¥å±äºä¸åŒçš„group**ã€‚\n> \n> è™½ç„¶è¿™æ ·æ¯”è¾ƒçµæ´»ï¼Œä½†æ˜¯ä¼šå¯¼è‡´**å¯¹åŒä¸€è¿›ç¨‹çš„èµ„æºåè°ƒæ¯”è¾ƒå›°éš¾**ã€‚è™½ç„¶v1æœ‰ç¼ºé™·ï¼Œä½†æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­å¤§éƒ¨åˆ†è¿˜æ˜¯ä½¿ç”¨çš„v1ã€‚\n\n#### æ€»ç»“\nNamespaceå¸®åŠ©å®¹å™¨æ¥å®ç°å„ç§è®¡ç®—èµ„æºçš„éš”ç¦»\n\nCgroupsä¸»è¦é™åˆ¶å®¹å™¨èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºé‡","tags":["Docker","Linux","Namespace","Cgroups"],"categories":["å®¹å™¨å®æˆ˜"]},{"title":"Windowsæ¿€æ´»","url":"/posts/22b15887/","content":"\n\n## Windowsæ¿€æ´»\n\n### Windows7\n\n#### ä¸“ä¸šç‰ˆ\n1. ç®¡ç†å‘˜èº«ä»½å¯åŠ¨`cmd`\n2. è¾“å…¥`slmgr /skms kms.xspace.in`\n3. è¾“å…¥`slmgr /ipkvk 7jg-NPHTm-C97Jm-9mPgT-3V66T`\n4. è¾“å…¥`slmgr /ato`\n\næ¿€æ´»æˆåŠŸ\n\n#### ä¼ä¸šç‰ˆ\n1. ç®¡ç†å‘˜èº«ä»½å¯åŠ¨`cmd`\n2. è¾“å…¥`slmgr /skms kms.03k.org`\n3. è¾“å…¥`slmgr /ipk 33PXH-7Y6KF-2VJC9-XBBR8-HVTHH`\n4. è¾“å…¥`slmgr /ato`\n\næ¿€æ´»æˆåŠŸ","tags":["Windows"],"categories":["å¾…å½’æ¡£"]},{"title":"LC-165-æ¯”è¾ƒç‰ˆæœ¬å·","url":"/posts/c4d24896/","content":"\n\n\n## æ¯”è¾ƒç‰ˆæœ¬å·\n\nLeetCodeé¢˜ç›®é“¾æ¥ï¼š[165. æ¯”è¾ƒç‰ˆæœ¬å· - åŠ›æ‰£ï¼ˆLeetCodeï¼‰](https://leetcode.cn/problems/compare-version-numbers/description/)\n\néš¾åº¦ï¼š{% label ä¸­ç­‰ orange %}\n\n\n\n### åˆ†æ\n\n\n\n### æ€è·¯\n\n>   ç›´æ¥é€šè¿‡`.`åˆ‡åˆ†å­—ç¬¦ä¸²ï¼Œéå†æ•°ç»„ï¼Œç›´æ¥ä½¿ç”¨å†…ç½®å‡½æ•°å°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰å°±ç»§ç»­æ¯”è¾ƒï¼Œå¦‚æœä¸ç­‰å°±ç›´æ¥è¿”å›ç»“æœ\n>\n>   å¯¹äºç‰ˆæœ¬å·é•¿åº¦ä¸ç­‰çš„æƒ…å†µï¼Œåªéœ€å°†ç¼ºå°‘çš„é¡¹è§†ä¸º0ç„¶åæ­£å¸¸è¿›è¡Œæ¯”è¾ƒå°±è¡Œ\n\n{% hideToggle ç‚¹æˆ‘å±•å¼€,, %}\n\n{% tabs ä»£ç ä¸€, 1 %}\n\n<!-- tab Java -->\n\n```java\nclass Solution {\n    public int compareVersion(String version1, String version2) {\n        String[] arr1 = version1.split(\"\\\\.\");\n        String[] arr2 = version2.split(\"\\\\.\");\n        int ret = 0;\n        for (int i = 0;i < Math.max(arr1.length, arr2.length);i++) {\n            // é»˜è®¤ä¸º0\n            int x = 0;\n            int y = 0;\n            // æ²¡æœ‰æŒ‡å®šç‰ˆæœ¬å·çš„è¯å°±ä¸ä¼šèµ°è¿™æ®µé€»è¾‘ï¼Œæ‰€ä»¥å°±ä¼šç”¨0åšé»˜è®¤å€¼å‚ä¸æ¯”è¾ƒ\n            if (i < arr1.length) {\n                x = Integer.parseInt(arr1[i]);\n            }\n            if (i < arr2.length) {\n                y = Integer.parseInt(arr2[i]);\n            }\n            if (x != y) {\n                ret = x > y ? 1 : -1;\n                break;\n            }\n        }\n\n        return ret;\n    }\n}\n```\n\n<!-- endtab -->\n\n<!-- tab Golang -->\n\n```go\nfunc compareVersion(version1 string, version2 string) int {\n    var (\n        slice1 = strings.Split(version1, \".\")\n        slice2 = strings.Split(version2, \".\")\n    )\n    \n    for i := 0;i < len(slice1) || i < len(slice2);i++ {\n        x := 0\n        y := 0\n\n        if i < len(slice1) {\n            // è¿™é‡Œçš„erréœ€è¦æ ¹æ®å®é™…æƒ…å†µåšå¼‚å¸¸å¤„ç†\n            x, _ = strconv.Atoi(slice1[i])\n        }\n\n        if i < len(slice2) {\n            // è¿™é‡Œçš„erréœ€è¦æ ¹æ®å®é™…æƒ…å†µåšå¼‚å¸¸å¤„ç†\n            y, _ = strconv.Atoi(slice2[i])\n        }\n\n        if x > y {\n            return 1\n        }\n        if x < y {\n            return -1\n        }\n    }\n\n    return 0\n}\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n{% endhideToggle %}\n\n#### ä¼˜åŒ–\n\né‡‡ç”¨`.`åˆ‡åˆ†å­—ç¬¦ä¸²éœ€è¦ä½¿ç”¨æ•°ç»„æ¥ä¿å­˜åˆ‡åˆ†çš„ç»“æœæ¥éå†\n\nå¯ä»¥ä½¿ç”¨{% label åŒæŒ‡é’ˆ %}ç›´æ¥éå†å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ\n\n{% hideToggle ç‚¹æˆ‘å±•å¼€,, %}\n\n{% tabs ä»£ç äºŒ, 1 %}\n\n<!-- tab Java -->\n\n```java\nclass Solution {\n    public int compareVersion(String version1, String version2) {\n        int i = 0;\n        int j = 0;\n        while (i < version1.length() || j < version2.length()) {\n            int x = 0;\n            int y = 0;\n\n            while(i < version1.length()) {\n                if (version1.charAt(i) == '.') {\n                    i++;\n                    break;\n                }\n                // å…¶å®ä¹Ÿæ˜¯è½¬æˆæ•°å­—è¿›è¡Œæ¯”è¾ƒ\n                x = 10 * x + version1.charAt(i) - '0';\n                i++;\n            }\n\n            while(j < version2.length()) {\n                if (version2.charAt(j) == '.') {\n                    j++;\n                    break;\n                }\n                y = 10 * y + version2.charAt(j) - '0';\n                j++;\n            }\n\n            if (x > y) {\n                return 1;\n            }\n            if (x < y) {\n                return -1;\n            }\n        }\n\n        return 0;\n    }\n}\n```\n\n<!-- endtab -->\n\n<!-- tab Golang -->\n\n```go\nfunc compareVersion(version1 string, version2 string) int {\n    var (\n        i = 0\n        j = 0\n    )\n\n    for ;i < len(version1) || j < len(version2); {\n        var (\n            x = 0\n            y = 0\n        )\n        for ;i < len(version1) && version1[i] != '.';i++ {\n            x = 10 * x + int(version1[i] - '0')\n        }\n        i++;\n        for ;j < len(version2) && version2[j] != '.';j++ {\n            y = 10 * y + int(version2[j] - '0')\n        }\n        j++;\n\n        if x > y {\n            return 1\n        }\n        if x < y {\n            return -1\n        }\n    }\n    return 0\n}\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n{% endhideToggle %}\n\n### æ‹“å±•\n\n>   æ ¹æ®å›½é™…ä¸»æµçš„æƒ¯ä¾‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ã€Œè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆSemantic Versioningï¼‰ã€çš„å‘½åæ–¹å¼ï¼Œæœ‰æ—¶ç®€ç§° SemVerã€‚è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼ˆä»¥ä¸‹ç®€ç§°ã€Œç‰ˆæœ¬å·ã€ï¼‰çš„æ ¼å¼æ˜¯ï¼š`<major>.<minor>.<patch>`ã€‚å³ä½¿ç”¨ä¸‰ä½éè´Ÿæ•´æ•°ï¼Œä»¥ç‚¹å·`.`è¿æ¥ã€‚\n>\n>   -   `<major>`å³ä¸»ç‰ˆæœ¬å·ï¼Œä¿—ç§°å¤§ç‰ˆæœ¬å‡çº§ã€‚æ”¹åŠ¨åˆ°ä¸»ç‰ˆæœ¬å·æ—¶ï¼Œæ ‡å¿—ç€ API å‘ç”Ÿäº†å·¨å¤§å˜åŒ–ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºæ–°å¢ç‰¹æ€§ã€ä¿®æ”¹æœºåˆ¶ã€åˆ é™¤åŠŸèƒ½ï¼Œ ä¸€èˆ¬ä¸å…¼å®¹ä¸Šä¸€ä¸ªä¸»ç‰ˆæœ¬å·ã€‚\n>   -   `<minor>`å³æ¬¡ç‰ˆæœ¬å·ï¼Œä¿—ç§°å°ç‰ˆæœ¬å‡çº§ã€‚å½“æˆ‘ä»¬è¿›è¡Œå¸¸è§„çš„æ–°å¢æˆ–ä¿®æ”¹åŠŸèƒ½æ—¶ï¼Œæ”¹åŠ¨æ¬¡ç‰ˆæœ¬å·ï¼Œä½†æ˜¯å¿…é¡»æ˜¯å‘å‰å…¼å®¹çš„ã€‚è¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ç›´æ¥åˆ é™¤æŸä¸ªåŠŸèƒ½ã€‚å¦‚è‹¥å¿…è¦ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¿®æ”¹æ—¥å¿—ä¸­æ ‡è®°æŸé¡¹åŠŸèƒ½ä¸ºã€Œå³å°†åˆ é™¤ï¼ˆDeprecatedï¼‰ã€ï¼Œç„¶ååœ¨ä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬ä¸­å°†å…¶å½»åº•åˆ é™¤ã€‚\n>   -   `<patch>`å³ä¿®è®¢å·ï¼Œä¿—ç§° bug ä¿®å¤ã€‚é¡¾åæ€ä¹‰ï¼Œå¦‚æœä»…ä»…ä¸ºäº†ä¿®å¤æˆ–è°ƒæ•´ä¸€äº›å°é—®é¢˜ï¼Œæˆ‘ä»¬å°±åªæ”¹åŠ¨ä¿®è®¢å·ã€‚\n\nå‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/qq_35246620/article/details/78443169\n\n\n\nå®é™…å¼€å‘ä¸­ï¼Œæœ‰æ—¶ä¹Ÿä¼šç»™ç‰ˆæœ¬å·åæ·»åŠ `-<6ä½commitID>`å”¯ä¸€æ ‡è¯†æŸä¸ªç‰ˆæœ¬çš„æäº¤\n","tags":["LeetCode","ç®—æ³•-å­—ç¬¦ä¸²","ç®—æ³•-åŒæŒ‡é’ˆ"],"categories":["ç®—æ³•","å­—ç¬¦ä¸²"]},{"title":"Hexo-Butterflyæ‰‹å†Œ","url":"/posts/1f69cb6c/","content":"\n\n\n\n\n## å›¾æ ‡\nButterflyæ”¯æŒ[font-awesome v6](https://fontawesome.com/icons?from=io)å›¾æ ‡\n\n![20220831165924991](images/posts-assets/Hexo-Butterflyæ‰‹å†Œ.assets/20220831165924991.jpg)\n\n\n\n![20220831165948029](images/posts-assets/Hexo-Butterflyæ‰‹å†Œ.assets/20220831165948029.jpg)\n\n## æ ‡ç­¾å¤–æŒ‚\n\n### Noteï¼ˆBootstrap Calloutï¼‰\n\n{% note primary no-icon %}\nNoteï¼ˆBootstrap Calloutï¼‰\n{% endnote %}\n\n#### é…ç½®å‚æ•°\n\n| åç§°    | ç”¨æ³•                                                         |\n| ------- | ------------------------------------------------------------ |\n| class   | ã€å¯é€‰ã€‘æ ‡è¯†/é¢œè‰²ï¼Œå¯é€‰å€¼ï¼ˆ `default` / `primary` / `success` / `info` / `warning` / `danger` ï¼‰ |\n| no-icon | ã€å¯é€‰ã€‘å¡«å†™è¯¥é¡¹åˆ™ä¸æ˜¾ç¤ºicon                                 |\n| style   | ã€å¯é€‰ã€‘è¦†ç›–é…ç½®ä¸­çš„styleï¼Œå¯é€‰å€¼ï¼ˆ `simple` / `modern` / `flat` / `disabled` ï¼‰ |\n| color   | ã€å¯é€‰ã€‘é¢œè‰²ï¼Œå¯é€‰å€¼ï¼ˆ `default` / `blue` / `pink` / `red` / `purple` / `orange` / `green` ï¼‰ |\n| icon    | ã€å¯é€‰ã€‘å¯é…ç½®è‡ªå®šä¹‰ icon (åªæ”¯æŒ fontawesome å›¾æ ‡, ä¹Ÿå¯ä»¥é…ç½® no-icon ) |\n\n#### ç”¨æ³•\n\n{% tabs note-grammar %}\n\n<!-- tab ç”¨æ³•1 -->\n\n```bash\n{% note [class] [no-icon] [style] %}\nAny content (support inline tags too.io).\n{% endnote %}\n```\n\næ•ˆæœï¼š\n\n{% note primary %}\nAny content (support inline tags too.io).\n{% endnote %}\n\n<!-- endtab -->\n\n<!-- tab ç”¨æ³•2 -->\n\n```bash\n{% note [color] [icon] [style] %}\nAny content (support inline tags too.io).\n{% endnote %}\n```\n\næ•ˆæœï¼š\n\n{% note purple no-icon %}\n\nAny content (support inline tags too.io).\n\n{% endnote %}\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n### æ—§Galleryï¼ˆç›¸å†Œå›¾åº“ï¼‰\n\n#### é…ç½®å‚æ•°\n\n| åç§°        | è¯´æ˜             |\n| ----------- | ---------------- |\n| name        | åç§°             |\n| description | æè¿°             |\n| link        | é“¾æ¥åˆ°çš„ç›¸å†Œåœ°å€ |\n| img-url     | å°é¢åœ°å€         |\n\n#### ç”¨æ³•\n\n```html\n<div class=\"gallery-group-main\">\n    {% galleryGroup 'å£çº¸' 'æ”¶è—çš„ä¸€äº›å£çº¸' '/gallery/wallpaper' 'https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png' %}\n    {% galleryGroup 'æ¼«å¨' 'å…³äºæ¼«å¨çš„å›¾ç‰‡' '/gallery/marvel' 'https://i.loli.net/2019/12/25/8t97aVlp4hgyBGu.jpg' %}\n</div>\n```\n\næ•ˆæœï¼š\n\n<div class=\"gallery-group-main\">\n    {% galleryGroup 'å£çº¸' 'æ”¶è—çš„ä¸€äº›å£çº¸' '/gallery/wallpaper' 'https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png' %}\n    {% galleryGroup 'æ¼«å¨' 'å…³äºæ¼«å¨çš„å›¾ç‰‡' '/gallery/marvel' 'https://i.loli.net/2019/12/25/8t97aVlp4hgyBGu.jpg' %}\n</div>\n\n\n\n### æ–°Galleryç›¸å†Œ\n\nåŒºåˆ«äºæ—§Galleryç›¸å†Œï¼Œæ–°Galleryä¼šæ ¹æ®å›¾ç‰‡çš„é•¿åº¦è¿›è¡Œè‡ªåŠ¨æ’ç‰ˆ\n\n#### ç”¨æ³•\n\n```bash\n{% gallery %}\nmarkdownå›¾ç‰‡æ ¼å¼\n{% endgallery %}\n```\n\næ•ˆæœï¼š\n\n{% gallery %}\n\n![](https://i.loli.net/2019/11/10/T7Mu8Aod3egmC4Q.png)\n\n![](https://i.loli.net/2019/12/25/8t97aVlp4hgyBGu.jpg)\n\n{% endgallery %}\n\n\n\n### Tag-Hideï¼ˆéšè—ã€æ”¶ç¼©ï¼‰\n\n{% hideToggle ç”¨æ³• %}\n\n{% note warning %}\n\næ³¨æ„ï¼šdisplayä¸­ä¸èƒ½åŒ…å«è‹±æ–‡é€—å·ï¼Œéœ€è¦ç”¨`&sbquo;`ä»£æ›¿\n\n{% endnote %}\n\n{% tabs tag-hide-grammar %}\n\n<!-- tab Inlineï¼ˆéšè—å•è¡Œæ–‡æœ¬ï¼‰ -->\n\nåªé™éšè—æ–‡å­—\n\nç”¨æ³•ï¼š\n\n```bash\n{% hideInline content, display, bg, color %}\n```\n\n-   contentï¼šæ–‡æœ¬å†…å®¹\n-   displayï¼šã€å¯é€‰ã€‘æŒ‰é’®æ˜¾ç¤ºæ–‡å­—\n-   bgï¼šã€å¯é€‰ã€‘æŒ‰é’®èƒŒæ™¯é¢œè‰²\n-   colorï¼šã€å¯é€‰ã€‘æŒ‰é’®æ–‡å­—é¢œè‰²\n\næ•ˆæœï¼š\n\n{% hideInline ç‚¹æˆ‘, éšè—å†…å®¹, blue, #fff %}\n\n<!-- endtab -->\n\n<!-- tab Blockï¼ˆéšè—å¤šè¡Œå†…å®¹ï¼‰ -->\n\nå¯ä»¥éšè—å¾ˆå¤šå†…å®¹ï¼ŒåŒ…æ‹¬å›¾ç‰‡ï¼Œä»£ç å—ç­‰ç­‰\n\nç”¨æ³•ï¼š\n\n```bash\n{% hideBlock display, bg, color %}\ncontent\n{% endhideBlock %}\n```\n\næ•ˆæœï¼š\n\n{% hideBlock ç‚¹æˆ‘ %}\n\n{% hideInline ç‚¹æˆ‘, éšè—å†…å®¹, blue, #fff %}\n\n{% endhideBlock %}\n\n<!-- endtab -->\n\n<!-- tab Toggleï¼ˆæ”¶ç¼©å†…å®¹ï¼‰ -->\n\næ”¶ç¼©æ¡†\n\nç”¨æ³•ï¼š\n\n```bash\n{% hideToggle display, bg, color %}\ncontent\n{% endhideToggle %}\n```\n\næ•ˆæœï¼š\n\n{% hideToggle ç‚¹æˆ‘å±•å¼€ %}\næ”¶ç¼©é»˜è®¤ä¸å±•ç¤ºçš„å†…å®¹\n{% endhideToggle %}\n\n<!-- endtab -->\n\n{% endtabs %}\n\n{% endhideToggle %}\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["Hexo","Butterfly"],"categories":["å¾…å½’æ¡£"]},{"title":"minikubeå®‰è£…","url":"/posts/f7b5b7db/","content":"\n\n\n## minikubeå®‰è£…\n\nminikubeå®˜ç½‘åœ°å€ï¼š[https://minikube.sigs.k8s.io/docs/start/](https://minikube.sigs.k8s.io/docs/start/)\n\n### å¡«å‘æŒ‡å¼•\n\n1. [å¯åŠ¨æŠ¥é”™ï¼šDRV_AS_ROOT](#DRV_AS_ROOT)\n2. [å¯åŠ¨æŠ¥é”™ï¼šHOST_HOME_PERMISSION](#HOST_HOME_PERMISSION)\n3. [å¯åŠ¨æ‹‰å–é•œåƒæ…¢](#image_pull_slow)\n\n### å®‰è£…è¿‡ç¨‹\n\n1. ç¡®è®¤ç³»ç»Ÿä»¥åŠå¯¹åº”æ¶æ„\n\n    ```bash\n    $ uname -a # æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯\n    Linux crayon 5.4.0-65-generic #73~18.04.1-Ubuntu SMP Tue Jan 19 09:02:24 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\n    \n    $ arch # æŸ¥çœ‹æ¶æ„\n    x86_64\n    ```\n\n    é€‰æ‹©å¯¹åº”çš„é…ç½®å¤åˆ¶ä¸‹è½½å‘½ä»¤ä¸‹è½½`minikube`å®‰è£…åŒ…å¹¶å®‰è£…\n\n    ![1660403658866](images/posts-assets/minikubeå®‰è£….assets/1660403658866.jpg)\n\n    ```bash\n    curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb\n    sudo dpkg -i minikube_latest_amd64.deb\n    ```\n\n2. <span id=\"DRV_AS_ROOT\">å¯åŠ¨minikube</span>\n\n    å®˜æ–¹æ³¨æ˜äº†ä¸è¦ä½¿ç”¨`root`æƒé™å¯åŠ¨ï¼Œä½¿ç”¨`sudo`æˆ–ä»¥`root`ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ä¼šæŠ¥é”™\n\n    ```bash\n    $ sudo minikube start\n    ğŸ˜„  Ubuntu 18.04 (vbox/amd64) ä¸Šçš„ minikube v1.26.0\n    âœ¨  è‡ªåŠ¨é€‰æ‹© docker é©±åŠ¨ã€‚å…¶ä»–é€‰é¡¹ï¼šnone, ssh\n    ğŸ›‘  The \"docker\" driver should not be used with root privileges. If you wish to continue as root, use --force.\n    ğŸ’¡  If you are running minikube within a VM, consider using --driver=none:\n    ğŸ“˜    https://minikube.sigs.k8s.io/docs/reference/drivers/none/\n    \n    âŒ  Exiting due to DRV_AS_ROOT: The \"docker\" driver should not be used with root privileges.\n    ```\n\n    \n\n    <span id=\"HOST_HOME_PERMISSION\"></span>æ­¤æ—¶ç›´æ¥ä½¿ç”¨`minikube start`å‘½ä»¤ï¼Œä½†æ˜¯å¯èƒ½å‡ºç°ä»¥ä¸‹é—®é¢˜\n\n    ```bash\n    $ minikube start\n    E0731 22:35:25.835507    4817 root.go:88] failed to log command start to audit: failed to open the audit log: open /home/crayon/.minikube/logs/audit.json: permission denied\n    E0731 22:35:25.835958    4817 cloud_events.go:60] unable to write to /home/crayon/.minikube/profiles/minikube/events.json: open /home/crayon/.minikube/profiles/minikube/events.json: permission denied\n    ğŸ˜„  Ubuntu 18.04 (vbox/amd64) ä¸Šçš„ minikube v1.26.0\n    âœ¨  è‡ªåŠ¨é€‰æ‹© docker é©±åŠ¨ã€‚å…¶ä»–é€‰é¡¹ï¼šnone, ssh\n    \n    ğŸ§¯  The requested memory allocation of 1987MiB does not leave room for system overhead (total system memory: 1987MiB). You may face stability issues.\n    ğŸ’¡  å»ºè®®ï¼šStart minikube with less memory allocated: 'minikube start --memory=1987mb'\n    \n    ğŸ“Œ  Using Docker driver with root privileges\n    ğŸ‘  Starting control plane node minikube in cluster minikube\n    ğŸšœ  Pulling base image ...\n    ğŸ’¾  Downloading Kubernetes v1.24.1 preload ...\n    \n    âŒ  Exiting due to HOST_HOME_PERMISSION: Failed to save config: open /home/crayon/.minikube/profiles/minikube/config.json: permission denied\n    ğŸ’¡  å»ºè®®ï¼šYour user lacks permissions to the minikube profile directory. Run: 'sudo chown -R $USER $HOME/.minikube; chmod -R u+wrx $HOME/.minikube' to fix\n    ğŸ¿  Related issue: https://github.com/kubernetes/minikube/issues/9165\n    ```\n\n    \n\n    é—®é¢˜åœ¨äºå½“å‰ç”¨æˆ·çš„æƒé™ä¸è¶³å¯¼è‡´çš„ï¼ŒåŸå› å¯èƒ½æ˜¯å› ä¸ºä¸€å¼€å§‹ä½¿ç”¨äº†`root`ç”¨æˆ·æ‰§è¡Œäº†å‘½ä»¤è€Œä»¥`root`ç”¨æˆ·åˆ›å»ºäº†ç›¸å…³é…ç½®æ–‡ä»¶å¯¼è‡´çš„ï¼ŒæŒ‰ç…§å‘½ä»¤çš„æç¤ºä¿¡æ¯ä¿®æ”¹æ–‡ä»¶çš„æƒé™å³å¯è§£å†³\n\n    ```bash\n    # è¿™é‡Œçš„æ–‡ä»¶è·¯å¾„é»˜è®¤æ˜¯åœ¨å½“å‰ç”¨æˆ·çš„homeç›®å½•ä¸‹ï¼Œéœ€è¦å°†homeç›®å½•è·¯å¾„æ”¹ä¸ºä½ è‡ªå·±çš„homeç›®å½•è·¯å¾„\n    $ sudo chown -R crayon /home/crayon/.minikube; chmod -R u+wrx /home/crayon/.minikube\n    ```\n\n    æ”¹å®Œæƒé™å†æ¬¡æ‰§è¡Œå¯åŠ¨å‘½ä»¤\n\n    ```bash\n    $ minikube start\n    ğŸ˜„  Ubuntu 18.04 (vbox/amd64) ä¸Šçš„ minikube v1.26.0\n    âœ¨  æ ¹æ®ç°æœ‰çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ docker é©±åŠ¨ç¨‹åº\n    \n    ğŸ§¯  The requested memory allocation of 1987MiB does not leave room for system overhead (total system memory: 1987MiB). You may face stability issues.\n    ğŸ’¡  å»ºè®®ï¼šStart minikube with less memory allocated: 'minikube start --memory=1987mb'\n    \n    ğŸ‘  Starting control plane node minikube in cluster minikube\n    ```\n\n    <span id=\"image_pull_slow\"></span>å¯åŠ¨ä¹‹åä¼šå»æ‹‰å»é•œåƒï¼Œè¿™ä¸ªæ—¶å€™ä¼šå‘ç°é•œåƒæ‹‰å–çš„é€Ÿåº¦ææ…¢\n\n    å»ºè®®ä½¿ç”¨ä¸­å›½åŒºé•œåƒæ‹‰å–åœ°å€\n\n    ```bash\n    # å…ˆæ‰§è¡Œåˆ é™¤\n    $ minikube delete\n    ğŸ”¥  æ­£åœ¨åˆ é™¤ docker ä¸­çš„â€œminikubeâ€â€¦\n    ğŸ”¥  æ­£åœ¨åˆ é™¤å®¹å™¨ \"minikube\" ...\n    ğŸ”¥  æ­£åœ¨ç§»é™¤ /home/crayon/.minikube/machines/minikubeâ€¦\n    ğŸ’€  Removed all traces of the \"minikube\" cluster.\n    # å†æ‰§è¡Œstartå‘½ä»¤\n    $ minikube start --image-mirror-country='cn' # å®˜æ–¹ä¸“é—¨ä¸ºä¸­å›½ç”¨æˆ·å‡†å¤‡çš„\n    \n    ```\n\n    \n\n3. minikube start --image-mirror-country='cn' --extra-config=kubelet.cgroup-driver=systemd --driver='docker'\n\n","tags":["Kubernetes","minikube","Ubuntu"],"categories":["å¾…å½’æ¡£"]},{"title":"Hexo-Butterflyæ·»åŠ å‹é“¾","url":"/posts/5b29ce89/","content":"\n## Hexo-Butterflyæ·»åŠ å‹é“¾\n\n### æ€è·¯\n\n- å‹é“¾é€šè¿‡Githubä»“åº“çš„æ–¹å¼å¯¹å¤–å¼€æ”¾ï¼Œå…¶ä»–äººå¯é€šè¿‡`Fork`ä»“åº“æäº¤`PR`çš„æ–¹å¼æ·»åŠ å‹é“¾ä¿¡æ¯\n- å‹é“¾ä¿¡æ¯ä»“åº“é›†æˆæµæ°´çº¿ï¼Œå®ç°è‡ªåŠ¨æ¨åŒ…åˆ°`NPM`ä»“åº“\n- åšå®¢ç«™ç‚¹é€šè¿‡`CDN`æ–¹å¼å¼•ç”¨`script`ï¼Œè§£æåæ¸²æŸ“è‡³é¡µé¢ä¸Š\n\n\n\n### å®ç°\n\n#### 1. æ³¨å†ŒNPMè´¦å·ï¼Œåˆå§‹åŒ–é¡¹ç›®\n\n [npm (npmjs.com)](https://www.npmjs.com/) \n\nåˆ°NPMç½‘ç«™ä¸Šæ³¨å†Œè´¦å·\n\nä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆå§‹åŒ–npmé¡¹ç›®\n\n```bash\n$ npm init\n# æŒ‰ç…§æç¤ºå¡«å†™ä¿¡æ¯å³å¯ï¼Œåé¢å¯ä»¥é€šè¿‡package.jsonä¿®æ”¹\n\n# è®¾ç½®ä¸‹é•œåƒæº\n$ npm config set registry http://registry.npmjs.org\n\n# ç™»å½•è´¦æˆ·\n$ npm adduser\nUsername: your name\nPassword: your password\nEmail: your email\n\n# æ£€æŸ¥æ˜¯å¦ç™»å½•æˆåŠŸ\n$ npm whoami\n# ä¸æˆåŠŸåˆ™é‡æ–°ç™»é™†ä¸‹\n$ npm login\n```\n\n\n\n`.gitignore`å’Œ`.npmignore`æ–‡ä»¶\n\n`.gitignore`æ–‡ä»¶ç”¨æ¥å¿½ç•¥æ–‡ä»¶ï¼Œä¸ä¸Šä¼ åˆ°Gitä»“åº“\n\n`.npmignore`æ–‡ä»¶ç”¨æ¥å¿½ç•¥æ–‡ä»¶ï¼Œä¸éšåŒ…å‘å¸ƒ\n\né€šè¿‡`package.json`é‡Œçš„`files`å±æ€§è®¾ç½®å‘å¸ƒæ–‡ä»¶çš„ç™½åå•\n\nä¼˜å…ˆçº§ï¼š`files` > `.npmignore` > `.gitignore`\n\n```bash\n# å®Œæˆå†…å®¹ç¼–å†™åå‘å¸ƒåŒ…\n$ npm publish\n# å¦‚æœæç¤ºåŒ…ä¸èƒ½ä¸ºprivateï¼Œéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤\n$ npm publish --access public\n```\n\n\n\n#### 2. é€šè¿‡CDNè®¿é—®\n\nè¿™é‡Œä½¿ç”¨`jsdelivr`\n\nåœ°å€æ ¼å¼ï¼š`https://cdn.jsdelivr.net/npm/(your packagename)@(version)/(file)`\n\nä¸å†™ç‰ˆæœ¬å·çš„è¯é»˜è®¤ä½¿ç”¨`latest`ï¼Œå³æœ€æ–°ç‰ˆæœ¬\n\n\n\n#### 3. é›†æˆGithub workflow\n\næ–‡æ¡£åœ°å€ï¼š[å…³äºå·¥ä½œæµç¨‹ - GitHub Docs](https://docs.github.com/cn/actions/using-workflows/about-workflows) \n\nä»“åº“æ ¹ç›®å½•çš„`.github/workflows/`ç›®å½•åˆ›å»º`yaml`æ–‡ä»¶æ¥å®šä¹‰å·¥ä½œæµ\n\nç°åœ¨åˆ›å»ºä¸€ä¸ªåä¸º`blog-friend-link.yaml`çš„æ–‡ä»¶å®šä¹‰å·¥ä½œæµï¼Œè¯¥å·¥ä½œæµç”¨æ¥è‡ªåŠ¨è§£æä»“åº“ä¸­çš„å‹é“¾æ–‡ä»¶å¹¶è¿›è¡Œè‡ªåŠ¨å‘åŒ…ï¼Œè¿™æ ·æ¯æ¬¡æœ‰ä»£ç æ›´æ–°å³å¯è‡ªåŠ¨å‘å¸ƒæœ€æ–°çš„`NPM`åŒ…ï¼Œåšå®¢é€šè¿‡é“¾æ¥å³å¯è·å–åˆ°æœ€æ–°çš„å‹é“¾ä¿¡æ¯äº†ã€‚\n\næ ·ä¾‹æ–‡ä»¶ï¼š\n\nè¯¥æ–‡ä»¶å®šä¹‰äº†è¿™æ ·ä¸€ä¸ªå·¥ä½œæµï¼šåœ¨æŒ‡å®šbranchã€tagæœ‰pull_requestæ—¶ä¼šè§¦å‘ï¼Œä¹Ÿå¯æ‰‹åŠ¨è§¦å‘ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªåä¸ºpublishçš„jobï¼Œè¯¥jobè¿è¡Œåœ¨ubuntu-latestç³»ç»Ÿä¸Šï¼Œä¸”é»˜è®¤æ‰€æœ‰çš„stepéƒ½åœ¨`blog/friend-link`ç›®å½•ä¸‹æ‰§è¡Œï¼Œè¯¥jobåŒ…å«5ä¸ªstep\n\n1. ä½¿ç”¨`actions/checkout@v3`çš„actionæ£€å‡ºä»“åº“ï¼Œè¿™æ ·æˆ‘ä»¬çš„jobæ‰å¯ä»¥è®¿é—®åˆ°\n2. ä½¿ç”¨`actions/setup-node@v3`çš„actionåˆå§‹åŒ–äº†ä¸€ä¸ª`node`ç¯å¢ƒï¼Œä¾¿äºåç»­ä½¿ç”¨npmå‘½ä»¤å’Œæ‰§è¡Œjsä»£ç \n3. åŒ…å«ä¸€æ¡`npm install`çš„å‘½ä»¤è¡Œå‘½ä»¤ï¼Œå› ä¸ºç¬¬2æ­¥å·²ç»åˆå§‹åŒ–äº†`node`ç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨`npm install`å®‰è£…ç›¸å…³çš„ä¾èµ–\n4. æ‰§è¡Œbuild.shè„šæœ¬æ„å»ºå‘åŒ…éœ€è¦çš„æ–‡ä»¶\n5. æ‰§è¡Œbuild.shè„šæœ¬è¿›è¡Œå‘åŒ…\n\n```yaml\n# This is a basic workflow to help you get started with Actions\n\nname: blog-friend-link-CI\n\n# Controls when the workflow will run\non:\n  # Triggers the workflow on push or pull request events but only for the \"master\" branch\n  pull_request:\n    branches: [\"master\", \"v*\", \"release*\"]\n    tags: [\"v*\"]\n\n  # Allows you to run this workflow manually from the Actions tab\n  workflow_dispatch:\n\n# A workflow run is made up of one or more jobs that can run sequentially or in parallel\njobs:\n  # This workflow contains a single job called \"build\"\n  publish:\n    # The type of runner that the job will run on\n    runs-on: ubuntu-latest\n\n    defaults:\n      run:\n        working-directory: blog/friend-link\n\n    # Steps represent a sequence of tasks that will be executed as part of the job\n    steps:\n      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it\n      - uses: actions/checkout@v3\n\n      # Runs a single command using the runners shell\n      - name: Use Node.js\n        uses: actions/setup-node@v3\n        with:\n          node-version: \"14.x\"\n          registry-url: \"https://registry.npmjs.org\"\n\n      # Runs a set of commands using the runners shell\n      - name: Install dependencies\n        run: npm install\n\n      - name: Run build script\n        run: ./build.sh build\n\n      - name: Publish\n        # if: github.ref_name == 'master'\n        run: ./build.sh publish\n        env:\n          COMMIT_ID: ${{ github.sha }}\n          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}\n```\n\n\n\n{% note warning %}\n\næ³¨æ„ï¼š\n\n1. ç¬¬2æ­¥éœ€è¦æŒ‡å®š`registry-url`ï¼Œä¸ç„¶åç»­å‘åŒ…ä¼šæŠ¥404\n2. ç¬¬5æ­¥çš„å‘åŒ…éœ€è¦ä¼ é€’NPM_TOKENï¼Œè€Œä¸æ˜¯ä½¿ç”¨å‘½ä»¤è¡Œç™»å½•çš„æ–¹å¼\n\n{% endnote %}\n\n##### ç”ŸæˆNPM TOKEN\n\nåˆ°NPMä¸»é¡µç‚¹å‡»å³ä¸Šè§’å¤´åƒï¼ˆæœªç™»å½•è¯·å…ˆç™»å½•ï¼‰æ‰¾åˆ°Access Tokensç‚¹å‡»è¿›å…¥\n\n![1662042180529](images/posts-assets/Hexo-Butterflyæ·»åŠ å‹é“¾.assets/1662042180529.jpg)\n\nç‚¹å‡»Generate New Tokenåˆ°ç”Ÿæˆæ–°çš„Tokençš„é¡µé¢\n\n![1662042264055](images/posts-assets/Hexo-Butterflyæ·»åŠ å‹é“¾.assets/1662042264055.jpg)\n\n\n\nç”Ÿæˆåè¿”å›Tokenåˆ—è¡¨ä¼šåœ¨è¡¨æ ¼å¤´ä¸Šæ˜¾ç¤ºTokenï¼Œç‚¹å‡»å³å¯å¤åˆ¶\n\n\n\n##### æ·»åŠ NPM TOKENåˆ°Github\n\nåˆ°Githubä»“åº“é¡µé¢ç‚¹å‡»Settingsåé€‰æ‹©Secretsé‡Œçš„Actions\n\n![1662042405123](images/posts-assets/Hexo-Butterflyæ·»åŠ å‹é“¾.assets/1662042405123.jpg)\n\nç‚¹å‡»New repository secretå»æ·»åŠ æ–°çš„å¯†é’¥\n\n![1662042461474](images/posts-assets/Hexo-Butterflyæ·»åŠ å‹é“¾.assets/1662042461474.jpg)\n\n{% note warning %}\n\næ³¨æ„ï¼šè¿™é‡Œå¡«å†™çš„Nameå’Œä½ åœ¨workflowå®šä¹‰æ–‡ä»¶ä¸­çš„éœ€è¦ä¸€è‡´\n\n{% endnote %}\n\nå®šä¹‰æ–‡ä»¶ä¸­é€šè¿‡`${{secrets.*}}`è·å–å¯¹åº”çš„å¯†é’¥\n\n![1662042506481](images/posts-assets/Hexo-Butterflyæ·»åŠ å‹é“¾.assets/1662042506481.jpg)\n\n\n\n### é‡åˆ°çš„é—®é¢˜\n\n#### 1. stepæ‰§è¡Œå¤šè¡Œå‘½ä»¤\n\n```yaml\n- name: Clean install dependencies and build\n  run: |\n    npm ci\n    npm run build\n```\n\n#### 2. æµæ°´çº¿æ— æ³•åˆ‡æ¢ç›®å½•\n\nåœ¨æµæ°´çº¿é‡Œé¢æ— æ³•ä½¿ç”¨`cd`ç­‰shellå‘½ä»¤åˆ‡æ¢ç›®å½•è·¯å¾„ï¼Œéœ€è¦ä½¿ç”¨`working-directory`çš„æ–¹å¼è®¾ç½®å·¥ä½œè·¯å¾„\n\næµæ°´çº¿çš„åˆå§‹è·¯å¾„æ˜¯ä»“åº“çš„æ ¹ç›®å½•\n\nstepä¸­é€šè¿‡`working-directory`æŒ‡å®šå·¥ä½œç›®å½•ï¼Œå±äºstepé—´ä¸å¯è§çš„ï¼Œæ¯ä¸ªstepéœ€è¦å•ç‹¬è®¾ç½®\n\n```yaml\n- name: Clean temp directory\n  run: rm -rf *\n  working-directory: ./temp\n```\n\nè‹¥æƒ³è¦åŒjobé‡Œçš„stepéƒ½åœ¨åŒä¸€ä¸ªå·¥ä½œç›®å½•ä¸‹ï¼Œåˆ™å¯ä»¥åœ¨jobä¸­é€šè¿‡`defaults.run.working-directory`\n\n```yaml\njobs:\n  job1:\n    runs-on: ubuntu-latest\n    defaults:\n      run:\n        shell: bash\n        working-directory: scripts\n```\n\n#### 3. NPM versionä¸å¯å›é€€\n\nNPMè§„å®šæ¯æ¬¡å‘åŒ…å¿…é¡»ä¿è¯ç‰ˆæœ¬å·æ¯”ä¸Šæ¬¡çš„å¤§\n\nå…·ä½“ç‰ˆæœ¬è§„åˆ™å‚ç…§ï¼š [NPMå‘åŒ…ç‰ˆæœ¬å·è§„èŒƒ](https://blog.csdn.net/Corazhang/article/details/111875879) \n\nè¿™é‡Œæˆ‘é€šè¿‡åœ¨ç‰ˆæœ¬å·åè¿½åŠ Gitçš„commitIDï¼ˆå‰6ä½ï¼‰è§£å†³\n\næœ€ç»ˆç‰ˆæœ¬å·æ ·ä¾‹ï¼š`1.0.0-e915db`\n\n{% note info %}\n\né€šè¿‡æµæ°´çº¿ä½¿ç”¨githubä¸Šä¸‹æ–‡å¯¹è±¡å°†commitIDè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼ˆ`COMMIT_ID`ï¼‰ï¼Œshellè„šæœ¬é€šè¿‡`${COMMIT_ID:0:6}`å³å¯è·å–åˆ°6ä½commitIDäº†\n\n{% endnote %}\n\n```yaml\n- name: Publish\n        # if: github.ref_name == 'master'\n        run: ./build.sh publish\n        env:\n          COMMIT_ID: ${{ github.sha }}\n          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}\n```\n\né€šè¿‡`github.sha`å¯è·å–åˆ°æäº¤IDï¼Œå°†å…¶è®¾ç½®åˆ°COMMIT_IDçš„ç¯å¢ƒå˜é‡ä¸­\n\nshellè„šæœ¬ä¸­å³å¯å¼•ç”¨åˆ°è¯¥å˜é‡\n\n```bash\nsed -i 's/\"version\": \"1.0.0\"/\"version\": \"1.0.0-'\"${COMMIT_ID:0:6}\"'\"/' package.json\n```\n\nä½¿ç”¨`sed`å‘½ä»¤æœç´¢`package.json`ä¸­çš„versionå±æ€§ï¼Œå°†å…¶æ›¿æ¢å³å¯\n\n\n\n#### 4. Shellè„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™\n\nä¸Šåº“å‰æ‰§è¡Œ`git update-index --chmod=+x xxx.sh`æ·»åŠ æ‰§è¡Œæƒé™åå†ä¸Šåº“\n\næˆ–è€…åœ¨æµæ°´çº¿æ‰§è¡Œæ—¶å…ˆæ‰§è¡Œ`chmod +x xxx.sh`çš„å‘½ä»¤èµ‹äºˆæ‰§è¡Œæƒé™\n\n\n\n\n\n\n\n\n\n","tags":["Hexo","Butterfly"],"categories":["å¾…å½’æ¡£"]},{"title":"Virtualbox-Centosç½‘ç»œé…ç½®","url":"/posts/476f1d65/","content":"\n\n\n### Host-Onlyæ–¹å¼å®ç°ä¸»æœº/è™šæ‹Ÿæœºäº’é€š\n\n1. ç‚¹å‡»åˆ›å»ºHost-Onlyç½‘å¡\n\n    ![1659263422994](images/posts-assets/Virtualbox-Centosç½‘ç»œé…ç½®.assets/1659263422994.jpg)\n\n2. ä¸å¯ç”¨DHCPæœåŠ¡å™¨ï¼ˆæ–¹ä¾¿åç»­å¯ä»¥ä½¿ç”¨é™æ€çš„IPè®¿é—®è™šæ‹Ÿæœºï¼‰\n\n    è®¾ç½®IPv4åœ°å€\n\n    ![1659263479379](images/posts-assets/Virtualbox-Centosç½‘ç»œé…ç½®.assets/1659263479379.jpg)\n\n3. è™šæ‹Ÿæœºç½‘ç»œè®¾ç½®\n\n    å¯ç”¨ç½‘å¡2ï¼Œè¿æ¥æ–¹å¼é€‰æ‹©ä»…ä¸»æœºï¼ˆHost-Onlyï¼‰ç½‘ç»œï¼Œç•Œé¢åç§°é€‰æ‹©åˆšæ‰åˆ›å»ºçš„Host-Onlyç½‘å¡\n\n    ![1659263713203](images/posts-assets/Virtualbox-Centosç½‘ç»œé…ç½®.assets/1659263713203.jpg)\n\n4. å¯åŠ¨è™šæ‹Ÿæœºï¼Œè¿›è¡Œç½‘ç»œé…ç½®\n\n    æŸ¥çœ‹ç½‘ç»œé…ç½®\n\n    ``` bash\n    ifconfig\n    # centosä¸­è‹¥æ²¡æœ‰è¯¥å‘½ä»¤å¯ä»¥ä½¿ç”¨ip addr\n    ```\n\n    ![1659264458715](images/posts-assets/Virtualbox-Centosç½‘ç»œé…ç½®.assets/1659264458715.jpg)\n\n    > enp0s3ã€enp0s8ç­‰å°±æ˜¯ç½‘å¡çš„åç§°\n\n    ```bash\n    # ç¼–è¾‘ç½‘å¡é…ç½®ï¼Œè‹¥æ²¡æœ‰è¯¥æ–‡ä»¶å¯ä»¥ä»å·²æœ‰çš„ç½‘å¡é…ç½®ä¸­æ‹·è´ååšä¿®æ”¹ï¼Œå…¶ä»–çš„ç½‘å¡é…ç½®æ–‡ä»¶å½¢å¦‚ifcfg-[ç½‘å¡åç§°]\n    vi /etc/sysconfig/network-scripts/ifcfg-enp0s8\n    ```\n\n    ä¿®æ”¹æˆ–æ·»åŠ å¦‚ä¸‹å­—æ®µ\n\n    ```ini\n    # é…ç½®æˆé™æ€IP\n    BOOTPROTO=\"static\"\n    # è®¾ç½®çš„IPåº”å½“å’Œç½‘å¡å¤„äºåŒä¸€ç½‘æ®µ\n    IPADDR=\"192.168.56.10\"\n    NETMASK=\"255.255.255.0\"\n    ```\n\n    é‡å¯ç½‘ç»œæœåŠ¡\n\n    ```bash\n    service network restart\n    ```\n\n    - é™„ï¼šç½‘å¡é…ç½®æ–‡ä»¶ä¸è‡ªåŠ¨é…ç½®è„šæœ¬\n\n        **ç½‘å¡é…ç½®æ–‡ä»¶**\n\n        ```ini\n        TYPE=\"Ethernet\"\n        PROXY_METHOD=\"none\"\n        BROWSER_ONLY=\"no\"\n        BOOTPROTO=\"static\"\n        DEFROUTE=\"yes\"\n        IPV4_FAILURE_FATAL=\"no\"\n        IPV6INIT=\"yes\"\n        IPV6_AUTOCONF=\"yes\"\n        IPV6_DEFROUTE=\"yes\"\n        IPV6_FAILURE_FATAL=\"no\"\n        IPV6_ADDR_GEN_MODE=\"stable-privacy\"\n        NAME=\"enp0s8\"\n        UUID=\"90e928eb-b2e6-444e-9c43-462513e6d130\"\n        DEVICE=\"enp0s8\"\n        ONBOOT=\"yes\"\n        IPADDR=\"192.168.56.10\"\n        NETMASK=\"255.255.255.0\"\n        ```\n\n        **è‡ªåŠ¨é…ç½®è„šæœ¬**\n\n        ```shell\n        #!/bin/bash\n        name=$1\n        echo 'copy script file'\n        cp ${name} /etc/sysconfig/network-scripts/ifcfg-${name}\n        echo 'restart network service'\n        service network restart\n        ```\n\n        > è„šæœ¬ä½¿ç”¨æ–¹å¼\n        >\n        > 1. ä¿®æ”¹æƒé™ï¼Œä½¿å…¶æœ‰æ‰§è¡Œæƒé™\n        >\n        >     ```bash\n        >     chmod +x [è„šæœ¬åç§°]\n        >     ```\n        >\n        > 2. æŒ‡å®šç½‘å¡åç§°ï¼ŒåŒç›®å½•ä¸‹æ”¾ç½‘å¡é…ç½®æ–‡ä»¶å¹¶ä»¥ç½‘å¡åç§°å‘½åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œç½‘ç»œè‡ªåŠ¨é…ç½®\n        >\n        >     ```bash\n        >     ./[è„šæœ¬åç§°] [ç½‘å¡åç§°]\n        >     # ä¾‹å¦‚ï¼š./set-network.sh enp0s8\n        >     ```\n        >\n        >     è¯´æ˜ï¼šè„šæœ¬è¯»å–åŒç›®å½•ä¸‹çš„enp0s8æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶çš„å†…å®¹æ‹·è´ï¼ˆè¦†ç›–ï¼‰å¯¹åº”çš„ç½‘å¡é…ç½®æ–‡ä»¶ï¼Œç¤ºä¾‹å‘½ä»¤åˆ™å°†`enp0s8`æ–‡ä»¶æ‹·è´ï¼ˆè¦†ç›–ï¼‰`/etc/sysconfig/network-scripts/ifcfg-enp0s8`æ–‡ä»¶\n\n5. å®¿ä¸»æœºpingæµ‹è¯•è¿é€šæ€§\n\n    ```bash\n    > ping 192.168.56.10\n    \n    æ­£åœ¨ Ping 192.168.56.10 å…·æœ‰ 32 å­—èŠ‚çš„æ•°æ®:\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    \n    192.168.56.10 çš„ Ping ç»Ÿè®¡ä¿¡æ¯:\n        æ•°æ®åŒ…: å·²å‘é€ = 4ï¼Œå·²æ¥æ”¶ = 4ï¼Œä¸¢å¤± = 0 (0% ä¸¢å¤±)ï¼Œ\n    å¾€è¿”è¡Œç¨‹çš„ä¼°è®¡æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½):\n        æœ€çŸ­ = 0msï¼Œæœ€é•¿ = 0msï¼Œå¹³å‡ = 0ms\n    ```\n\n6. ï¼ˆå¯é€‰ï¼‰é…ç½®hostsæ–‡ä»¶\n\n    hostsæ–‡ä»¶è·¯å¾„\n\n    Windowsï¼š`C:\\Windows\\System32\\drivers\\etc\\hosts`\n\n    Linuxï¼š`/etc/hosts`\n\n    æ·»åŠ åŸŸåæ˜ å°„\n\n    ```ini\n    192.168.56.10 centos-0\n    ```\n\n    `ping`æµ‹è¯•è¿é€šæ€§\n\n    ```bash\n    > ping centos-0\n    \n    æ­£åœ¨ Ping centos-0 [192.168.56.10] å…·æœ‰ 32 å­—èŠ‚çš„æ•°æ®:\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    æ¥è‡ª 192.168.56.10 çš„å›å¤: å­—èŠ‚=32 æ—¶é—´<1ms TTL=64\n    \n    192.168.56.10 çš„ Ping ç»Ÿè®¡ä¿¡æ¯:\n        æ•°æ®åŒ…: å·²å‘é€ = 4ï¼Œå·²æ¥æ”¶ = 4ï¼Œä¸¢å¤± = 0 (0% ä¸¢å¤±)ï¼Œ\n    å¾€è¿”è¡Œç¨‹çš„ä¼°è®¡æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½):\n        æœ€çŸ­ = 0msï¼Œæœ€é•¿ = 0msï¼Œå¹³å‡ = 0ms\n    ```\n\n    \n\n    \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["Virtualbox","Centos"],"categories":["å¾…å½’æ¡£"]},{"title":"vimå¸¸ç”¨å‘½ä»¤","url":"/posts/8c31560b/","content":"\n\n\n### Vim\n\n[å¸¸ç”¨å‘½ä»¤æ±‡æ€»](#common-use)\n\n#### ç®€ä»‹\n\n\n\n![20220721174326629](images/posts-assets/vim.assets/20220721174326629.jpg)\n\n\n\n#### æ¨¡å¼\n\nvimæœ‰3ç§æ¨¡å¼\n\n-   å‘½ä»¤æ¨¡å¼ï¼ˆCommand modeï¼‰\n-   è¾“å…¥æ¨¡å¼ï¼ˆInsert modeï¼‰\n-   åº•çº¿å‘½ä»¤æ¨¡å¼ï¼ˆLast line modeï¼‰\n\n##### å‘½ä»¤æ¨¡å¼\n\nç”¨æˆ·ä¸€å¯åŠ¨vimå°±è¿›å…¥å‘½ä»¤æ¨¡å¼\n\næ­¤çŠ¶æ€ä¸‹æ•²å‡»é”®ç›˜çš„åŠ¨ä½œä¼šè¢«è¯†åˆ«ä¸ºå‘½ä»¤\n\nå¸¸ç”¨å‘½ä»¤ï¼š\n\n-   `i`åˆ‡æ¢åˆ°è¾“å…¥æ¨¡å¼\n-   `x`åˆ é™¤å½“å‰å…‰æ ‡æ‰€åœ¨å¤„çš„å­—ç¬¦\n-   `:`åˆ‡æ¢åˆ°åº•çº¿å‘½ä»¤æ¨¡å¼\n\n##### è¾“å…¥æ¨¡å¼\n\n##### åº•çº¿å‘½ä»¤æ¨¡å¼\n\nåœ¨å‘½ä»¤æ¨¡å¼ä¸‹æŒ‰`:`è¿›å…¥åº•çº¿å‘½ä»¤æ¨¡å¼\n\nå¸¸ç”¨å‘½ä»¤ï¼š\n\n-   `:q`é€€å‡ºç¨‹åº\n-   `:q!`å¼ºåˆ¶é€€å‡º\n-   `:w`ä¿å­˜æ–‡ä»¶\n\n\n\n![20220721174906379](images/posts-assets/vim.assets/20220721174906379.jpg)\n\n\n\n#### <span id=\"common-use\">å¸¸ç”¨å‘½ä»¤æ±‡æ€»</span>\n\n##### æœç´¢æ›¿æ¢\n\n| å‘½ä»¤  | è¯´æ˜                                                         |\n| ----- | ------------------------------------------------------------ |\n| /word | å‘å…‰æ ‡ä»¥ä¸‹å¯»æ‰¾ä¸€ä¸ªåç§°ä¸º`word`çš„å­—ç¬¦ä¸²                       |\n| ?word | å‘å…‰æ ‡ä»¥ä¸Šæœç´¢                                               |\n| n     | nextï¼Œé‡å¤å‰ä¸€ä¸ªæœç´¢åŠ¨ä½œï¼Œå¦‚æœåˆšæ‰§è¡Œäº†å‘ä¸‹æœç´¢ï¼Œé‚£ä¹ˆå°±ä¼šç»§ç»­å‘ä¸‹æœç´¢ï¼Œå¦‚æœåˆšåˆšæ‰§è¡Œçš„æ˜¯å‘ä¸Šæœç´¢ï¼Œé‚£ä¹ˆç»§ç»­å‘ä¸Šæœç´¢ |\n| N     | `n`æ“ä½œçš„åå‘æ“ä½œ                                            |\n\n##### åˆ é™¤ã€å¤åˆ¶ã€ç²˜è´´\n\n| å‘½ä»¤       | è¯´æ˜             |\n| ---------- | ---------------- |\n| yy         | å¤åˆ¶ä¸€è¡Œ         |\n| dd         | å‰ªåˆ‡ä¸€è¡Œ         |\n| p/P        | ç²˜è´´             |\n| u          | undoï¼Œå›é€€ã€æ’¤é”€ |\n| `[ctrl]`+r | redoï¼Œé‡åš       |\n\n\n\n##### å…¶ä»–\n\n| å‘½ä»¤        | è¯´æ˜       |\n| ----------- | ---------- |\n| `:set nu`   | æ˜¾ç¤ºè¡Œå·   |\n| `:set nonu` | ä¸æ˜¾ç¤ºè¡Œå· |\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["vim","Linux"],"categories":["å¸¸ç”¨"]},{"title":"Kafkaæƒå¨æŒ‡å—","url":"/posts/d2d512ed/","content":"\n## Kafkaæƒå¨æŒ‡å—\n\n### åº\n\n>   `Kafka`æœ€åˆæ˜¯`LinkedIn`çš„ä¸€ä¸ªå†…éƒ¨åŸºç¡€è®¾æ–½ç³»ç»Ÿã€‚æˆ‘ä»¬å‘ç°ï¼Œè™½ç„¶æœ‰å¾ˆå¤šæ•°æ®åº“å’Œç³»ç»Ÿå¯\n>   ä»¥ç”¨æ¥å­˜å‚¨æ•°æ®ï¼Œä½†åœ¨æˆ‘ä»¬çš„æ¶æ„é‡Œï¼Œåˆšå¥½ç¼ºä¸€ä¸ªå¯ä»¥å¸®åŠ©**å¤„ç†æŒç»­æ•°æ®æµ**çš„ç»„ä»¶ã€‚åœ¨å¼€\n>   å‘`Kafka`ä¹‹å‰ï¼Œæˆ‘ä»¬å®éªŒäº†å„ç§ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œä»æ¶ˆæ¯ç³»ç»Ÿåˆ°æ—¥å¿—èšåˆç³»ç»Ÿï¼Œå†åˆ° ETL\n>   å·¥å…·ï¼Œå®ƒä»¬éƒ½æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚\n\n>   æˆ‘ä»¬è®¤ä¸º`Kafka`æ˜¯ä¸€ä¸ªæµå¹³å°ï¼šåœ¨è¿™ä¸ªå¹³å°ä¸Šå¯ä»¥å‘å¸ƒå’Œè®¢é˜…æ•°æ®æµï¼Œå¹¶æŠŠå®ƒä»¬ä¿å­˜èµ·æ¥ã€è¿›è¡Œå¤„ç†ã€‚\n>\n>   `Kafka`æœ‰ç‚¹åƒæ¶ˆæ¯ç³»ç»Ÿï¼Œå…è®¸å‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯æµï¼ˆç±»ä¼¼äºActiveMQã€RabbitMQç­‰ï¼‰ã€‚\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["Kafka"],"categories":["å•ƒä¹¦"]},{"title":"Kuberneteså®æˆ˜","url":"/posts/b293d35b/","content":"\n## Kuberneteså®æˆ˜\n\n### ç¬¬1éƒ¨åˆ† KubernetesåŸºç¡€ç¯‡\n\n#### ç¬¬1ç«  Kubernetesä»‹ç»\n\n##### å‡ ä¸ªæ¦‚å¿µ\n\n>   äº‘è®¡ç®—\n>\n>   ç‹­ä¹‰ä¸Šå°†æ˜¯æŒ‡ITåŸºç¡€è®¾æ–½çš„äº¤ä»˜å’Œä½¿ç”¨æ¨¡å¼ï¼Œå³é€šè¿‡ç½‘ç»œä»¥æŒ‰éœ€ã€æ˜“æ‰©å±•çš„æ–¹å¼è·å–æ‰€éœ€èµ„æºã€‚\n>\n>   å¹¿ä¹‰ä¸Šåˆ™æ˜¯æŒ‡æœåŠ¡çš„äº¤ä»˜å’Œä½¿ç”¨æ¨¡å¼ï¼Œé€šè¿‡ç½‘ç»œä»¥æŒ‰éœ€ã€æ˜“æ‰©å±•çš„æ–¹å¼è·å–æ‰€éœ€æœåŠ¡ã€‚\n>\n>   æä¾›èµ„æºçš„ç½‘ç»œè¢«å½¢è±¡åœ°æ¯”å–»æˆâ€œäº‘â€ï¼Œå…¶è®¡ç®—èƒ½åŠ›é€šå¸¸ç”±åˆ†å¸ƒå¼çš„å¤§è§„æ¨¡é›†ç¾¤å’Œè™šæ‹ŸåŒ–æŠ€æœ¯æä¾›çš„ã€‚\n>\n>   â€œäº‘â€å¥½æ¯”å‘ç”µå‚ï¼Œäº’è”ç½‘å¥½æ¯”è¾“ç”µçº¿è·¯ï¼Œåªä¸è¿‡å‘ç”µå‚å¯¹å¤–æä¾›çš„æ˜¯**ITæœåŠ¡**\n\nä¸šç•Œæ ¹æ®äº‘è®¡ç®—æä¾›æœåŠ¡èµ„æºçš„ç±»å‹å°†å…¶åˆ’åˆ†ä¸ºä¸‰å¤§ç±»ï¼š\n\n-   IaaSï¼ˆåŸºç¡€è®¾æ–½å³æœåŠ¡ï¼‰\n-   PaaSï¼ˆå¹³å°å³æœåŠ¡ï¼‰\n-   SaaSï¼ˆè½¯ä»¶å³æœåŠ¡ï¼‰\n\näº‘è®¡ç®—ä¸‰å±‚æ¶æ„å›¾\n\n![20220517160200947](images/posts-assets/Kuberneteså®æˆ˜.assets/20220517160200947.jpg)\n\n>   IaaSï¼ˆåŸºç¡€è®¾æ–½å³æœåŠ¡ï¼‰\n>\n>   ç™½è¯ï¼šå–ç»™ä½ ç¡¬ä»¶è®¾å¤‡ï¼Œç›¸æ¯”ä¸ä¼ ç»Ÿçš„è®¾å¤‡æ›´æ˜“æ‰©å±•è€Œå·²ï¼Œå¦‚äº‘ç¡¬ç›˜ã€äº‘æœåŠ¡å™¨ã€äº‘ä¸»æœº\n>\n>   é€šè¿‡è™šæ‹ŸåŒ–å’Œåˆ†å¸ƒå¼å­˜å‚¨ç­‰æŠ€æœ¯ï¼Œå®ç°äº†å¯¹åŒ…æ‹¬æœåŠ¡å™¨ã€å­˜å‚¨è®¾å¤‡ã€ç½‘ç»œè®¾å¤‡ç­‰å„ç§ç‰©ç†èµ„æºçš„æŠ½è±¡ï¼Œä»è€Œå½¢æˆäº†ä¸€ä¸ªå¯æ‰©å±•ã€å¯æŒ‰éœ€åˆ†é…çš„è™šæ‹Ÿèµ„æºæ± ã€‚ç›®å‰æœ€å…·ä»£è¡¨æ€§çš„IaaSäº§å“æœ‰Amazon AWSï¼Œæä¾›è™šæ‹ŸæœºEC2å’Œäº‘å­˜å‚¨S3ç­‰æœåŠ¡ã€‚\n\n\n\n>   PaaSï¼ˆå¹³å°å³æœåŠ¡ï¼‰\n>\n>   ç™½è¯ï¼šå–ç»™ä½ ä¸€äº›å¼€å‘ç»„ä»¶ï¼Œå¦‚äº‘æ•°æ®åº“ã€æˆ–æ˜¯Tomcatè¿è¡Œç¯å¢ƒç­‰ï¼ˆKubernetesä¹Ÿç®—åœ¨å®šä¹‰èŒƒç•´å†…ï¼‰ã€‚PaaSæœåŠ¡ä¸€èˆ¬åˆ†ä¸ºæ¡†æ¶ç±»æœåŠ¡å’Œä¸­é—´ä»¶æœåŠ¡ï¼Œ\n>\n>   æ¡†æ¶ç±»æœåŠ¡ï¼šTomcatã€Websphereã€Node.jsã€Rubyon Railsã€Ruby on Rack\n>\n>   ä¸­é—´ä»¶æœåŠ¡ï¼šæ•°æ®åº“(Mysqlã€mongoDBã€Redis)ã€æ¶ˆæ¯é˜Ÿåˆ—(RabbitMQ)ã€ç¼“å­˜(Memcache)ã€‚\n>\n>   \n>\n>   ä¸ºå¼€å‘è€…æä¾›äº†åº”ç”¨çš„å¼€å‘ç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒï¼Œå°†å¼€å‘è€…ä»ç¹ççš„ITç¯å¢ƒç®¡ç†ä¸­è§£æ”¾å‡ºæ¥ï¼Œè‡ªåŠ¨åŒ–éƒ¨ç½²å’Œè¿ç»´ï¼Œä½¿å¼€å‘è€…èƒ½å¤Ÿé›†ä¸­ç²¾åŠ›äºåº”ç”¨ä¸šåŠ¡å¼€å‘ï¼Œæå‡åº”ç”¨çš„å¼€å‘æ•ˆç‡ã€‚PaaSä¸»è¦é¢å‘çš„æ˜¯è½¯ä»¶ä¸“ä¸šäººå‘˜ï¼ŒGoogleçš„GAEæ˜¯PaaSçš„é¼»ç¥–ã€‚\n\n\n\n>   SaaSï¼ˆè½¯ä»¶å³æœåŠ¡ï¼‰\n>\n>   ç™½è¯ï¼šç›´æ¥å–è½¯ä»¶ç»™ä½ ç”¨\n>\n>   é¢å‘ä½¿ç”¨è½¯ä»¶çš„ç»ˆç«¯ç”¨æˆ·ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒSaaSå°†è½¯ä»¶åŠŸèƒ½ä»¥ç‰¹å®šçš„æ¥å£å½¢å¼å‘å¸ƒï¼Œç»ˆç«¯ç”¨æˆ·é€šè¿‡ç½‘ç»œæµè§ˆå™¨å°±å¯ä»¥ä½¿ç”¨è½¯ä»¶åŠŸèƒ½ï¼ˆé‚£ä¸å°±æ˜¯Webåº”ç”¨å˜›ï¼‰ã€‚SaaSæ˜¯åº”ç”¨æœ€å¹¿çš„äº‘è®¡ç®—æ¨¡å¼ï¼Œå¦‚åœ¨çº¿ä½¿ç”¨çš„é‚®ç®±ç³»ç»Ÿå’Œå„ç§ç®¡ç†ç³»ç»Ÿéƒ½å¯ä»¥è®¤ä¸ºæ˜¯SaaSçš„èŒƒç•´ã€‚\n\n![20220517161639971](images/posts-assets/Kuberneteså®æˆ˜.assets/20220517161639971.jpg)\n\n\n\n##### Kubernetesæ˜¯ä»€ä¹ˆ\n\næ˜¯Googleå¼€æºçš„å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿã€‚æ„å»ºåœ¨DockeræŠ€æœ¯ä¹‹ä¸Šï¼Œä¸ºå®¹å™¨åŒ–çš„åº”ç”¨æä¾›èµ„æºè°ƒåº¦ã€éƒ¨ç½²è¿è¡Œã€æœåŠ¡å‘ç°ã€æ‰©å®¹ç¼©å®¹ç­‰ä¸€æ•´å¥—åŠŸèƒ½ã€‚\n\nç‰¹æ€§ï¼š\n\n-   å®¹å™¨ç¼–æ’èƒ½åŠ›\n\n    å®¹å™¨ç»„åˆã€æ ‡ç­¾é€‰æ‹©å’ŒæœåŠ¡å‘ç°ç­‰\n\n-   è½»é‡çº§\n\n    éµå¾ªå¾®æœåŠ¡æ¶æ„ç†è®ºï¼Œæ•´ä¸ªç³»ç»Ÿåˆ’åˆ†å‡ºå„ä¸ªåŠŸèƒ½ç‹¬ç«‹çš„ç»„ä»¶ï¼Œç»„ä»¶ä¹‹é—´è¾¹ç•Œæ¸…æ™°ï¼Œéƒ¨ç½²ç®€å•ï¼Œå¯ä»¥è½»æ˜“åœ°è¿è¡Œåœ¨å„ç§ç³»ç»Ÿå’Œç¯å¢ƒä¸­ã€‚åŒæ—¶ï¼ŒKubernetesä¸­çš„è®¸å¤šåŠŸèƒ½éƒ½å®ç°äº†æ’ä»¶åŒ–ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿›è¡Œæ‰©å±•å’Œæ›¿æ¢ã€‚\n\n-   å¼€æ”¾å¼€æº\n\n##### Kubernetesæ ¸å¿ƒæ¦‚å¿µ\n\n###### Pod\n\nPodæ˜¯è‹¥å¹²ç›¸å…³**å®¹å™¨çš„ç»„åˆ**ï¼ŒPodåŒ…å«çš„å®¹å™¨è¿è¡Œåœ¨**åŒä¸€å°å®¿ä¸»æœº**ä¸Šï¼Œè¿™äº›å®¹å™¨ä½¿ç”¨**ç›¸åŒçš„ç½‘ç»œå‘½åç©ºé—´ã€IPåœ°å€å’Œç«¯å£**ï¼Œç›¸äº’ä¹‹é—´èƒ½é€šè¿‡`localhost`æ¥å‘ç°å’Œé€šä¿¡ã€‚å¦å¤–ï¼Œè¿™äº›å®¹å™¨è¿˜å¯å…±äº«ä¸€å—å­˜å‚¨å·ç©ºé—´ã€‚åœ¨Kubernetesä¸­åˆ›å»ºã€è°ƒåº¦å’Œç®¡ç†çš„æœ€å°å•ä½æ˜¯Podï¼Œè€Œä¸æ˜¯å®¹å™¨ï¼ŒPodé€šè¿‡æä¾›æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ï¼Œæä¾›äº†æ›´åŠ çµæ´»çš„éƒ¨ç½²å’Œç®¡ç†æ¨¡å¼ã€‚\n\n-   è‹¥å¹²è¿è¡Œåœ¨åŒä¸€å°å®¿ä¸»æœºä¸Šçš„ç›¸å…³å®¹å™¨çš„ç»„åˆ\n\n-   ä½¿ç”¨ç›¸åŒç½‘ç»œå‘½åç©ºé—´ã€IPåœ°å€å’Œç«¯å£\n\n-   å…±äº«ä¸€å—å­˜å‚¨å·ç©ºé—´\n\n\n\n###### Replication Controller\n\nç”¨æ¥æ§åˆ¶ç®¡ç†Podå‰¯æœ¬ï¼ˆReplicaï¼Œæˆ–è€…ç§°ä¸ºå®ä¾‹ï¼‰ï¼ŒRelication Controllerç¡®ä¿ä»»ä½•æ—¶å€™Kubernetesé›†ç¾¤ä¸­æœ‰æŒ‡å®šæ•°é‡çš„Podå‰¯æœ¬åœ¨è¿è¡Œã€‚å¦‚æœå°‘äºæŒ‡å®šæ•°é‡çš„Podå‰¯æœ¬ï¼Œå®ƒä¼šå¯åŠ¨æ–°çš„Podå‰¯æœ¬ï¼Œåä¹‹ä¼šæ€æ­»å¤šä½™çš„å‰¯æœ¬ä»¥ä¿è¯æ•°é‡ä¸å˜ã€‚Replication Controlleræ˜¯å¼¹æ€§ä¼¸ç¼©ã€æ»šåŠ¨å‡çº§çš„å®ç°æ ¸å¿ƒã€‚\n\n-   æ§åˆ¶å‰¯æœ¬æ•°é‡\n-   å¼¹æ€§ä¼¸ç¼©ã€æ»šåŠ¨å‡çº§çš„å®ç°æ ¸å¿ƒ\n\n###### Service\n\næ˜¯çœŸå®åº”ç”¨æœåŠ¡çš„æŠ½è±¡ï¼Œå®šä¹‰äº†Podçš„é€»è¾‘é›†åˆå’Œè®¿é—®è¿™ä¸ªPodé›†åˆçš„ç­–ç•¥ã€‚å®ƒå°†ä»£ç†Podå¯¹å¤–è¡¨ç°ä¸ºä¸€ä¸ªå•ä¸€è®¿é—®çš„æ¥å£ï¼Œå¤–éƒ¨ä¸éœ€è¦äº†è§£åç«¯Podå¦‚ä½•è¿è¡Œï¼Œå¯¹æ‰©å±•å’Œç»´æŠ¤æœ‰å¥½å¤„ï¼Œæä¾›äº†ä¸€å¥—ç®€åŒ–çš„æœåŠ¡ä»£ç†å’Œå‘ç°æœºåˆ¶ã€‚\n\n-   å®šä¹‰äº†Podçš„é€»è¾‘é›†åˆå’Œè®¿é—®è¿™ä¸ªPodé›†åˆçš„ç­–ç•¥\n-   å°†ä»£ç†Podå¯¹å¤–è¡¨ç°ä¸ºä¸€ä¸ªå•ä¸€è®¿é—®çš„æ¥å£\n-   æä¾›æœåŠ¡ä»£ç†å’Œå‘ç°æœºåˆ¶\n\n###### Label\n\nç”¨æ¥åŒºåˆ†Podã€Serviceã€Replication Controllerçš„Key/Valueå¯¹ï¼ŒKubernetesä¸­ä»»æ„APIå¯¹è±¡éƒ½å¯ä»¥é€šè¿‡Labelæ ‡è¯†ã€‚æ¯ä¸ªAPIå¯¹è±¡å¯ä»¥æœ‰å¤šä¸ªLabelï¼Œä½†æ˜¯æ¯ä¸ªLabelçš„Keyåªèƒ½å¯¹åº”ä¸€ä¸ªValueã€‚Labelæ˜¯Serviceå’ŒReplication Controllerè¿è¡Œçš„åŸºç¡€ï¼Œå®ƒä»¬éƒ½é€šè¿‡Labelæ¥å…³è”Podï¼Œæ˜¯ä¸€ç§æ¾è€¦åˆå…³ç³»ã€‚\n\n-   Key/Valueå¯¹ï¼Œæ ‡è¯†APIå¯¹è±¡\n-   æ¯ä¸ªAPIå¯¹è±¡å¯ä»¥æœ‰å¤šä¸ªLabelï¼Œä½†æ˜¯æ¯ä¸ªLabelçš„Keyåªèƒ½å¯¹åº”ä¸€ä¸ªValue\n\n###### Node\n\nK8så±äºä¸»ä»åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ï¼ŒNodeè¿è¡Œå¹¶ç®¡ç†å®¹å™¨ã€‚Nodeä½œä¸ºK8sçš„æ“ä½œå•å…ƒï¼Œç”¨æ¥åˆ†é…ç»™Podï¼ˆæˆ–è€…è¯´å®¹å™¨ï¼‰è¿›è¡Œç»‘å®šï¼ŒPodæœ€ç»ˆè¿è¡Œåœ¨Nodeä¸Šï¼ŒNodeå¯ä»¥è®¤ä¸ºæ˜¯Podçš„å®¿ä¸»æœºã€‚\n\n-   K8sæ“ä½œå•å…ƒï¼Œåˆ†é…ç»™Podè¿›è¡Œç»‘å®š\n-   å¯ä»¥è®¤ä¸ºæ˜¯Podçš„å®¿ä¸»æœº\n\n\n\n#### ç¬¬2ç«  K8sçš„æ¶æ„å’Œéƒ¨ç½²\n\n##### K8sçš„æ¶æ„å’Œç»„ä»¶\n\nK8så±äºä¸»ä»åˆ†å¸ƒå¼æ¶æ„ï¼ŒèŠ‚ç‚¹åœ¨è§’è‰²ä¸Šåˆ†ä¸ºMasterå’ŒNode\n\nK8sä½¿ç”¨`Etcd`ä½œä¸ºå­˜å‚¨ç»„ä»¶\n\n>   Etcdæ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œçµæ„Ÿæ¥è‡ªZooKeeperå’ŒDoozerï¼Œé€šè¿‡Raftä¸€è‡´æ€§ç®—æ³•å¤„ç†æ—¥å¿—å¤åˆ¶ä»¥ä¿è¯å¼ºä¸€è‡´æ€§ã€‚\n\nK8sä½¿ç”¨`Etcd`ä½œä¸ºç³»ç»Ÿçš„é…ç½®å­˜å‚¨ä¸­å¿ƒï¼ŒK8sä¸­çš„é‡è¦æ•°æ®éƒ½æ˜¯æŒä¹…åŒ–åœ¨`Etcd`ä¸­çš„ï¼Œè¿™ä½¿å¾—K8sæ¶æ„çš„å„ä¸ªç»„ä»¶å±äºæ— çŠ¶æ€ï¼Œå¯ä»¥æ›´ç®€å•å®æ–½åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ã€‚\n\nK8s Masterä½œä¸ºæ§åˆ¶èŠ‚ç‚¹ï¼Œè°ƒåº¦ç®¡ç†æ•´ä¸ªç³»ç»Ÿï¼ŒåŒ…å«ä»¥ä¸‹ç»„ä»¶\n\n-   K8s API Serverï¼šä½œä¸ºK8sç³»ç»Ÿçš„å…¥å£ï¼Œå…¶å°è£…äº†æ ¸å¿ƒå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œä»¥REST APIæ¥å£æ–¹å¼æä¾›ç»™å¤–éƒ¨å®¢æˆ·å’Œå†…éƒ¨ç»„ä»¶è°ƒç”¨ã€‚å®ƒç»´æŠ¤çš„RESTå¯¹è±¡å°†æŒä¹…åŒ–åˆ°`Etcd`ä¸­ã€‚\n\n-   K8s Schedulerï¼šè´Ÿè´£é›†ç¾¤çš„èµ„æºè°ƒåº¦ï¼Œä¸ºæ–°å»ºçš„Podåˆ†é…æœºå™¨ã€‚è¿™éƒ¨åˆ†å·¥ä½œåˆ†å‡ºæ¥ä¸€ä¸ªç»„ä»¶ï¼Œæ„å‘³ç€å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›¿æ¢æˆå…¶ä»–çš„è°ƒåº¦å™¨ã€‚\n\n-   K8s Controller Managerï¼šè´Ÿè´£æ‰§è¡Œå„ç§æ§åˆ¶å™¨ï¼Œç›®å‰å·²ç»å®ç°å¾ˆå¤šæ§åˆ¶å™¨æ¥ä¿è¯K8sçš„æ­£å¸¸è¿è¡Œ\n\n    | æ§åˆ¶å™¨ | è¯´æ˜ |\n    | ------ | ---- |\n    |        |      |\n    |        |      |\n    |        |      |\n\nK8s Nodeæ˜¯è¿è¡ŒèŠ‚ç‚¹ï¼Œç”¨äºè¿è¡Œç®¡ç†ä¸šåŠ¡çš„å®¹å™¨ï¼ŒåŒ…å«ä»¥ä¸‹ç»„ä»¶\n\n-   Kubeletï¼šè´Ÿè´£ç®¡æ§å®¹å™¨ï¼ŒKubeletä¼šä»K8s API Serveræ¥å—Podçš„åˆ›å»ºè¯·æ±‚ï¼Œå¯åŠ¨å’Œåœæ­¢å®¹å™¨ï¼Œç›‘æ§å®¹å™¨è¿è¡ŒçŠ¶æ€å¹¶æ±‡æŠ¥ç»™K8s API Serverã€‚\n-   K8s Proxyï¼šè´Ÿè´£ä¸ºPodåˆ›å»ºä»£ç†æœåŠ¡ï¼ŒK8s Proxyä¼šä»K8s API Serverè·å–æ‰€æœ‰çš„Serviceï¼Œå¹¶æ ¹æ®Serviceä¿¡æ¯åˆ›å»ºä»£ç†æœåŠ¡ï¼Œå®ç°Serviceåˆ°Podçš„è¯·æ±‚è·¯ç”±å’Œè½¬å‘ï¼Œä»è€Œå®ç°K8så±‚çº§çš„è™šæ‹Ÿè½¬å‘ç½‘ç»œã€‚\n-   Dockerï¼šK8s Nodeæ˜¯å®¹å™¨è¿è¡ŒèŠ‚ç‚¹ï¼Œéœ€è¦è¿è¡ŒDockeræœåŠ¡ï¼ŒK8sä¹Ÿæ”¯æŒå…¶ä»–å®¹å™¨å¼•æ“\n\n##### éƒ¨ç½²K8s\n\n###### ç¯å¢ƒå‡†å¤‡\n\nK8sæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶æ„ï¼Œå¯ä»¥çµæ´»è¿›è¡Œå®‰è£…éƒ¨ç½²ï¼Œå¯ä»¥éƒ¨ç½²åœ¨å•æœºï¼Œä¹Ÿå¯ä»¥åˆ†å¸ƒå¼éƒ¨ç½²ã€‚ä½†æ˜¯éœ€è¦è¿è¡Œåœ¨Linuxï¼ˆx86_64ï¼‰ç³»ç»Ÿä¸Šï¼Œè‡³å°‘1æ ¸CPUå’Œ1GBå†…å­˜ã€‚\n\nï¼ˆä½¿ç”¨4å°è™šæ‹Ÿæœºç”¨äºéƒ¨ç½²k8sè¿è¡Œç¯å¢ƒï¼Œä¸€ä¸ªetcdã€ä¸€ä¸ªK8s Masterå’Œä¸‰ä¸ªK8s Node\n\n###### è¿è¡Œetcd\n\n###### è·å–K8så‘è¡ŒåŒ…\n\n###### è¿è¡ŒK8s Masterç»„ä»¶\n\n###### è¿è¡ŒK8s Nodeç»„ä»¶\n\n###### æŸ¥è¯¢K8sçš„å¥åº·çŠ¶æ€\n\n###### åˆ›å»ºK8sè¦†ç›–ç½‘ç»œ\n\n##### å®‰è£…K8sæ‰©å±•æ’ä»¶\n\n###### å®‰è£…Cluster DNS\n\n`Cluster DNS`ç”¨äºæ”¯æŒK8sçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œä¸»è¦åŒ…å«å¦‚ä¸‹å‡ é¡¹ï¼š\n\n-   SkyDNSï¼šæä¾›DNSè§£ææœåŠ¡\n-   Etcdï¼šç”¨äºSkyDNSçš„å­˜å‚¨\n-   Kube2skyï¼šç›‘å¬K8sï¼Œå½“æœ‰æ–°çš„Serviceåˆ›å»ºæ—¶ï¼Œç”Ÿæˆç›¸åº”è®°å½•åˆ°SkyDNS\n\n###### å®‰è£…Cluster Monitoring\n\n###### å®‰è£…Cluster Logging\n\n###### å®‰è£…Kube UI\n\n\n\n#### ç¬¬3ç«  K8så¿«é€Ÿå…¥é—¨\n\nK8sæ˜¯å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œä¸ºå®¹å™¨åŒ–çš„åº”ç”¨æä¾›èµ„æºè°ƒåº¦ã€éƒ¨ç½²è¿è¡Œã€å®¹ç¾å®¹é”™å’ŒæœåŠ¡å‘ç°ç­‰åŠŸèƒ½ã€‚\n\n##### ç¤ºä¾‹åº”ç”¨Guestbook\n\nGuestbookæ˜¯ä¸€ä¸ªå…¸å‹çš„Webåº”ç”¨\n\n![20220719200349874](images/posts-assets/Kuberneteså®æˆ˜.assets/20220719200349874.jpg)\n\nGuestbookåŒ…å«ä¸¤éƒ¨åˆ†\n\n-   Frontend\n\n    Webå‰ç«¯ï¼Œæ— çŠ¶æ€èŠ‚ç‚¹ï¼Œå¯ä»¥æ–¹ä¾¿ä¼¸ç¼©ï¼Œæœ¬ä¾‹ä¸­å°†è¿è¡Œ3ä¸ªå®ä¾‹\n\n-   Redis\n\n    å­˜å‚¨éƒ¨åˆ†ï¼ŒRedisé‡‡ç”¨ä¸»å¤‡æ¨¡å¼ï¼Œå³è¿è¡Œ1ä¸ªRedis Masterã€2ä¸ªRedis Slaveï¼ŒRedis Slaveä¼šä»Redis MasteråŒæ­¥æ•°æ®\n\nGuestbookæä¾›çš„åŠŸèƒ½ï¼šåœ¨Frontendé¡µé¢æäº¤æ•°æ®ï¼ŒFrontendåˆ™å°†æ•°æ®ä¿å­˜åˆ°Redis Masterï¼Œç„¶åä»Redis Slaveè¯»å–æ•°æ®æ˜¾ç¤ºåˆ°é¡µé¢ä¸Šã€‚\n\n##### è¿è¡ŒRedis\n\nåœ¨K8sä¸Šéƒ¨ç½²Redisï¼ŒåŒ…æ‹¬Masterå’ŒSlave\n\n###### åˆ›å»ºRedis Master Pod\n\n`Pod`æ˜¯K8sçš„åŸºæœ¬å¤„ç†å•å…ƒï¼Œ`Pod`åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç›¸å…³çš„å®¹å™¨ï¼Œåº”ç”¨ä»¥`Pod`çš„å½¢å¼è¿è¡Œåœ¨K8sä¸­ï¼ˆæœ¬è´¨ä¸Šæ˜¯å®¹å™¨ï¼‰ã€‚`Replication Controller`èƒ½å¤Ÿæ§åˆ¶`Pod`æŒ‰ç…§æŒ‡å®šçš„å‰¯æœ¬æ•°ç›®æŒç»­è¿è¡Œï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯é€šè¿‡`Replication Controller`æ¥åˆ›å»º`Pod`æ¥ä¿è¯`Pod`çš„å¯é æ€§ã€‚\n\nå®šä¹‰`redis-master-controller.yaml`\n\n```yaml\napiVersion: v1\nkind: ReplicationController\nmetadata:\n  name: redis-master\n  labels:\n    name: redis-master\nspec:\n  replicas: 1\n  selector:\n    name: redis-master\n  template:\n    metadata:\n      labels:\n        name: redis-master\n    spec:\n      containers:\n      - name: master\n        image: redis\n        ports:\n        - containerPort: 6379\n```\n\nK8sä¸­é€šè¿‡æ–‡ä»¶å®šä¹‰APIå¯¹è±¡ï¼Œæ–‡ä»¶æ ¼å¼æ”¯æŒ`JSON`å’Œ`YAML`\n\nAPIå¯¹è±¡åŸºæœ¬å±æ€§ï¼š\n\n-   APIç‰ˆæœ¬ï¼ˆ`.apiVersion`ï¼‰\n\n-   APIå¯¹è±¡ç±»å‹ï¼ˆ`.kind`ï¼‰\n\n-   å…ƒæ•°æ®ï¼ˆ`.metadata`ï¼‰\n\n    `redis-master-controller.yaml`å®šä¹‰äº†V1ç‰ˆæœ¬ä¸‹ä¸€ä¸ªåç§°ä¸º`redis-master`çš„`Replication Controller`ï¼Œå¦å¤–é…ç½®äº†è§„æ ¼ï¼ˆ`.spec`ï¼‰ï¼Œå…¶ä¸­è®¾ç½®äº†`Pod`çš„å‰¯æœ¬æ•°ï¼ˆ`.spec.replicas`ï¼‰å’Œ`Pod`æ¨¡æ¿ï¼ˆ`.spec.template`ï¼‰\n\n    `Pod`æ¨¡æ¿ä¸­è¯´æ˜äº†`Pod`åŒ…å«äº†ä¸€ä¸ªå®¹å™¨ï¼Œè¯¥å®¹å™¨ä½¿ç”¨é•œåƒ`redis`ï¼Œå³è¿è¡ŒRedis Masterï¼Œè¯¥`Replication Controller`å°†å…³è”ä¸€ä¸ªè¿™æ ·çš„`Pod`ï¼Œè€Œ`Replication Controller`å’Œ`Pod`çš„å…³è”æ˜¯é€šè¿‡`Label`æ¥å®ç°çš„ï¼ˆ`.spec.selector`å’Œ`.spec.template.metadata.labels`ï¼‰\n\né€šè¿‡å®šä¹‰æ–‡ä»¶åˆ›å»º`Replication Controller`\n\n```bash\n$ kubectl create -f redis-master-controller.yaml\n```\n\n###### åˆ›å»ºRedis Master Service\n\nK8sä¸­`Pod`æ˜¯å˜åŒ–çš„ï¼Œç‰¹åˆ«æ˜¯å—åˆ°`Replication Controller`æ§åˆ¶çš„æ—¶å€™ï¼Œå½“`Pod`å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œ`Pod`çš„`IP`ä¹Ÿæ˜¯å˜åŒ–çš„ã€‚\n\n>   ç”±æ­¤è¡ç”Ÿå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é›†ç¾¤ä¸­çš„`Pod`å¦‚ä½•äº’ç›¸å‘ç°å¹¶è®¿é—®çš„ï¼Ÿ\n\nK8sæä¾›`Service`å®ç°æœåŠ¡å‘ç°\n\n`Service`æ˜¯çœŸå®åº”ç”¨çš„æŠ½è±¡ï¼Œå°†ç”¨æ¥**ä»£ç†**`Pod`ï¼Œå¯¹å¤–æä¾›å›ºå®š`IP`ä½œä¸ºè®¿é—®å…¥å£ï¼Œé€šè¿‡è®¿é—®`Service`æ¥è®¿é—®ç›¸åº”çš„`Pod`ï¼Œè®¿é—®è€…åªéœ€è¦çŸ¥é“`Service`çš„è®¿é—®åœ°å€ï¼Œè€Œä¸éœ€è¦æ„ŸçŸ¥`Pod`çš„å˜åŒ–\n\n{% hideBlock çŒœæµ‹ %}\n\nçŒœä¸€ä¸‹æ€ä¹ˆå®ç°çš„ï¼Œå¤§æ¦‚æ˜¯é€šè¿‡etcdåšæœåŠ¡æ³¨å†Œï¼Œå°†Podçš„IPæ³¨å†Œè¿›å»ï¼Œæ¯æ¬¡Podçš„å˜åŠ¨éƒ½ä¼šæ›´æ–°å…¶ä¸­æ³¨å†Œçš„IPï¼ŒServiceé€šè¿‡è¿™ä¸ªæ³¨å†Œçš„IPè®¿é—®Pod\n\n{% endhideBlock %}\n\nåˆ›å»ºRedis Master Serviceæ¥ä»£ç†Redis Master Pod\n\nRedis Master Serviceçš„å®šä¹‰æ–‡ä»¶`redis-master-service.yaml`ï¼š\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-master\n  labels:\n    name: redis-master\nspec:\n  ports:\n  - port: 6379\n    targetPort: 6379\n  selector:\n    name: redis-master\n```\n\nåˆ›å»ºService\n\n```bash\nkubectl create -f redis-master-service.yaml\n```\n\n\n\n`Service`é€šè¿‡`Label`å…³è”`Pod`ï¼Œåœ¨`Service`çš„å®šä¹‰ä¸­ï¼Œè®¾ç½®`.spec.selector`ä¸º`name=redis-master`å°†å…³è”`redis master pod`ï¼ˆåˆ›å»ºæ—¶æˆ‘ä»¬æŒ‡å®šäº†`selector.name`ä¸º`redis-master`\n\né€šè¿‡å‘½ä»¤æŸ¥è¯¢`Service`\n\n```bash\n$ kubectl get service redis-master\nNAME CLUSTER_IP EXTERNAL_IP PORT(S) SELECTOR AGE\n...  ...        <none>      ...     ...      ...\n```\n\n`CLUSTER_IP`ï¼šK8såˆ†é…ç»™`Serivce`çš„è™šæ‹ŸIP\n\n`PORT(S)`ï¼š6379/TCPï¼Œæ˜¯`Service`ä¼šè½¬å‘çš„ç«¯å£ï¼ˆé€šè¿‡`Service`å®šä¹‰æ–‡ä»¶ä¸­çš„`.spec.ports[0].port`æŒ‡å®šï¼‰ï¼ŒK8sä¼šå°†è®¿é—®è¯¥ç«¯å£çš„TCPè¯·æ±‚è½¬å‘åˆ°`Redis Master Pod`ä¸­ï¼Œç›®æ ‡ç«¯å£ä¸º6379/TCPï¼ˆé€šè¿‡`Service`å®šä¹‰æ–‡ä»¶ä¸­çš„`.spec.ports[0].targetPort`æŒ‡å®šï¼‰\n\nå› ä¸ºåˆ›å»ºRedis Master Serviceæ¥ä»£ç†Redis Master Podï¼Œæ‰€ä»¥Redis Slave Podé€šè¿‡Serviceçš„è™šæ‹ŸIPå°±å¯ä»¥è®¿é—®åˆ°Redis Master Podï¼Œä½†æ˜¯å¦‚æœåªæ˜¯ç¡¬é…ç½®Serviceçš„è™šæ‹ŸIPåˆ°Redis Slave Podä¸­ï¼Œè¿˜ä¸æ˜¯çœŸæ­£çš„æœåŠ¡å‘ç°ï¼ŒK8sæä¾›äº†ä¸¤ç§å‘ç°Serviceçš„æ–¹æ³•\n\n-   ç¯å¢ƒå˜é‡\n\n    å½“Podè¿è¡Œçš„æ—¶å€™ï¼ŒK8sä¼šå°†ä¹‹å‰å­˜åœ¨çš„Serviceçš„ä¿¡æ¯é€šè¿‡ç¯å¢ƒå˜é‡å†™åˆ°Podä¸­ï¼Œä»¥Redis Master Serviceä¸ºä¾‹ï¼Œå®ƒçš„ä¿¡æ¯ä¼šè¢«å†™åˆ°Podä¸­ï¼š\n\n    ```ini\n    REDIS_MASTER_SERVICE_HOST=10.254.233.212\n    REDIS_MASTER_PORT_6379_TCP_PROTO=tcp\n    REDIS_MASTER_SERVICE_PORT=6379\n    REDIS_MASTER_PORT=tcp://10.254.233.212:6379\n    REDIS_MASTER_PORT_6379_TCP=tcp://10.254.233.212:6379\n    REDIS_MASTER_PORT_6379_TCP_PORT=6379\n    REDIS_MASTER_PORT_6379_TCP_ADDR=10.254.233.212\n    ```\n\n    ç¼ºç‚¹ï¼šPodå¿…é¡»åœ¨Serviceä¹‹åå¯åŠ¨ï¼Œé‡‡ç”¨DNSæ–¹å¼å°±æ²¡æœ‰è¿™ç§é™åˆ¶\n\n-   DNS\n\n    å½“æœ‰æ–°çš„Serviceåˆ›å»ºæ—¶ï¼Œå°±ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€æ¡DNSè®°å½•ï¼Œä»¥Redis Master Serviceä¸ºä¾‹ï¼Œæœ‰ä¸€æ¡DNSè®°å½•ï¼š\n\n    `redis-master => 10.254.233.212`\n\n    ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼ŒK8séœ€è¦å®‰è£…Cluster DNSæ’ä»¶\n\n###### åˆ›å»ºRedis Slave Pod\n\né€šè¿‡Replication Controllerå¯åˆ›å»ºRedis Slave Podï¼Œå°†åˆ›å»ºä¸¤ä¸ªRedis Slave Podã€‚å®šä¹‰æ–‡ä»¶`redis-slave-controller.yaml`ï¼š\n\n```yaml\napiVersion: v1\nkind: ReplicationController\nmetadata:\n  name: redis-slave\n  labels:\n    name:  redis-slave\nspec:\n  replicas: 2\n  selector:\n    name:  redis-slave\n  template:\n    metadata:\n      labels:\n        name: redis-slave\n    spec:\n      containers:\n        - name: worker\n          image: gcr.io/google_samples/gb-redisslave:v1\n          env:\n            - name: GET_HOSTS_FROM\n              value: dns # è‹¥æ²¡æœ‰å®‰è£…cluster-dnsæ’ä»¶ï¼Œå¯ä»¥ç”¨envæ›¿ä»£ï¼Œä½†æ˜¯ä¸€å®šè¦åœ¨serviceåˆ›å»ºä¹‹åå†åˆ›å»º\n          ports:\n            - containerPort: 6379\n```\n\nå®šä¹‰æ–‡ä»¶ä¸­è®¾ç½®äº†Podçš„å‰¯æœ¬æ•°ä¸º2ï¼ŒPodæ¨¡æ¿ä¸­åŒ…å«ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨ä½¿ç”¨é•œåƒ`gcr.io/google_samples/gb-redisslave:v1`ï¼Œè¯¥é•œåƒå®é™…æ˜¯åŸºäºredisé•œåƒï¼Œé‡å†™äº†å¯åŠ¨è„šæœ¬ï¼Œå°†å…¶ä½œä¸ºRedis Masterçš„å¤‡ç”¨èŠ‚ç‚¹å¯åŠ¨ï¼Œå¯åŠ¨è„šæœ¬å¦‚ä¸‹ï¼š\n\n```bash\nif [[ ${GET_HOSTS_FROM:-dns} == \"env\" ]]; then\n\tredis-server --slaveof ${REDIS_MASTER_SERVICE_HOST} 6379\nelse\n\tredis-server --slaveof redis-master 6379\nfi\n```\n\nå…¶å®å°±æ˜¯é€šè¿‡`GET_HOSTS_FROM`ç¯å¢ƒå˜é‡æ§åˆ¶æœåŠ¡å‘ç°çš„\n\n>   æ‰©å±•ï¼š${GET_HOSTS_FROM:-dns}\n>\n>   shellä¸­å¯¹å˜é‡èµ‹é»˜è®¤å€¼ï¼Œè¿™é‡Œçš„æ„æ€æ˜¯å¦‚æœ`GET_HOSTS_FROM`æœªå®šä¹‰æˆ–ä¸ºç©ºä¸²ï¼Œåˆ™èµ‹äºˆé»˜è®¤å€¼dns\n>\n>   è¯­æ³•æ ¼å¼ï¼š${å˜é‡å:-é»˜è®¤å€¼}\n>\n>   å¦ä¸€ç§å†™æ³•æ˜¯åªæœ‰æœªå®šä¹‰æ‰èµ‹äºˆé»˜è®¤å€¼\n>\n>   è¯­æ³•æ ¼å¼ï¼š${å˜é‡å-é»˜è®¤å€¼}\n\nåˆ›å»ºPod\n\n```bash\nkubectl create -f redis-slave-controller.yaml\n```\n\n\n\n###### åˆ›å»ºRedis Slave Service\n\nredis-slave-service.yamlï¼š\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis-slave\n  labels:\n    name:  redis-slave\nspec:\n  selector:\n    name: redis-slave\n  ports:\n  - port: 6379\n    targetPort: 6379\n```\n\nåˆ›å»ºService\n\n```bash\nkubectl create -f redis-slave-service.yaml\n```\n\n\n\n##### è¿è¡ŒFrontend\n\n###### åˆ›å»ºFrontend Pod\n\né€šè¿‡Frontend Replication Controlleræ¥åˆ›å»ºFrontend Podï¼Œå°†åˆ›å»º3ä¸ªFrontend Pod\n\nfrontend-controller.yaml\n\n```yaml\napiVersion: v1\nkind: ReplicationController\nmetadata:\n  name: frontend\n  labels:\n    name:  frontend\nspec:\n  replicas: 3\n  selector:\n    name: frontend\n  template:\n    metadata:\n      labels:\n        app: frontend\n    spec:\n      containers:\n        - name: php-redis\n          image: gcr.io/google_samples/gb-frontend:v3\n          env:\n            - name: GET_HOSTS_FROM\n              value: env # æ²¡æœ‰è£…cluster-dnsæ’ä»¶ï¼Œæ‰€ä»¥ç”¨envæ›¿ä»£äº†dns\n          ports:\n            - containerPort: 80\n```\n\nå®šä¹‰æ–‡ä»¶ä¸­è®¾ç½®Podå‰¯æœ¬æ•°ä¸º3ï¼ŒPodæ¨¡æ¿åŒ…å«ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨ä½¿ç”¨é•œåƒ`gcr.io/google_samples/gb-frontend:v3`ï¼Œè¿™æ˜¯ä¸€ä¸ªPHPå®ç°çš„Webåº”ç”¨ï¼Œå†™æ•°æ®åˆ°Redis Masterï¼Œå¹¶ä»Redis Slaveä¸­è¯»å–æ•°æ®ã€‚å†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡`GET_HOSTS_FROM`ç¯å¢ƒå˜é‡æ§åˆ¶æœåŠ¡å‘ç°æ–¹å¼çš„ã€‚\n\nåˆ›å»ºPod\n\n```bash\nkubectl create -f frontend-controller.yaml\n```\n\n###### åˆ›å»ºFrontend Service\n\nfrontend-service.yaml\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: frontend\n  labels:\n    name:  frontend\nspec:\n  selector:\n    name: frontend\n  ports:\n  - port: 80\n    targetPort: 80\n```\n\n##### è®¾ç½®Guestbookå¤–ç½‘è®¿é—®\n\nç°åœ¨Guestbookå·²ç»è¿è¡Œåœ¨K8sä¸Šäº†ï¼Œä½†æ˜¯åªæœ‰å†…éƒ¨ç½‘ç»œèƒ½è®¿é—®ï¼Œå¤–éƒ¨ç½‘ç»œçš„ç”¨æˆ·æ˜¯æ— æ³•è®¿é—®çš„ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ ä¸€å±‚ç½‘ç»œè½¬å‘ï¼Œå³å¤–ç½‘åˆ°å†…ç½‘çš„è½¬å‘ã€‚å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨`NodePort`çš„æ–¹å¼å®ç°ã€‚\n\nå³K8sä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè®¾ç½®ç«¯å£ï¼Œç§°ä¸º`NodePort`ï¼Œé€šè¿‡`NodePort`å¯ä»¥è®¿é—®åˆ°`Pod`\n\nä¿®æ”¹frontend-service.yamlï¼Œè®¾ç½®`.spec.type`ä¸º`NodePort`ï¼š\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: frontend\n  labels:\n    name:  frontend\nspec:\n  type: NodePort # æ·»åŠ typeä¸ºNodePort\n  selector:\n    name: frontend\n  ports:\n  - port: 80\n    targetPort: 80\n```\n\né‡æ–°åˆ›å»ºServiceï¼š\n\n```bash\n$ kubectl replace -f front-service.yaml --force\nservice \"frontend\" deleted\nservice/frontend replaced\n$ kubectl get svc\nNAME           TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE\nfrontend       NodePort    10.0.0.69    <none>        80:32443/TCP   2s\nredis-master   ClusterIP   10.0.0.229   <none>        6379/TCP       127m\nredis-slave    ClusterIP   10.0.0.80    <none>        6379/TCP       82m\n```\n\nå¯ä»¥çœ‹åˆ°frontendçš„TYPEå·²ç»æ˜¯`NodePort`äº†ï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°`PORT(S)`æœ‰ç«¯å£æ˜ å°„ï¼ˆ80:32443/TCPï¼‰ï¼Œå¤–éƒ¨å¯ä»¥é€šè¿‡32443è®¿é—®\n\n##### æ¸…ç†Guestbook\n\n```bash\nkubectl delete rc redis-master redis-slave frontend\nkubectl delete svc redis-master redis-slave frontend\n```\n\n#### ç¬¬4ç«  Pod\n\n##### Hello World\n\nåˆ›å»ºä¸€ä¸ªç®€å•çš„Hello World Podï¼Œè¿è¡Œä¸€ä¸ªè¾“å‡ºHello Worldçš„å®¹å™¨\n\nå®šä¹‰æ–‡ä»¶hello-world-pod.yamlï¼š\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: hello-world\nspec:\n  restartPolicy: OnFailure\n  containers:\n  - name: hello-world\n    image: \"ubuntu:18.04\"\n    command: [\"/bin/echo\", \"hello\", \"world\"]\n```\n\nå®šä¹‰æ–‡ä»¶ä¸­æè¿°äº†Podçš„å±æ€§å’Œè¡Œä¸º\n\n-   `apiVersion`ï¼šå£°æ˜K8sçš„APIç‰ˆæœ¬ï¼Œç›®å‰æ˜¯v1\n\n-   `kind`ï¼šå£°æ˜APIå¯¹è±¡çš„ç±»å‹ï¼Œè¿™é‡Œçš„ç±»å‹æ˜¯Pod\n\n-   `metadata`ï¼šè®¾ç½®Podçš„å…ƒæ•°æ®\n\n    -   `name`ï¼šæŒ‡å®šPodçš„åç§°ï¼ŒPodçš„åç§°å¿…é¡»Namespaceå†…å”¯ä¸€\n\n-   `spec`ï¼šé…ç½®Podçš„å…·ä½“è§„æ ¼\n\n    -   `restartPolicy`ï¼šè®¾ç½®Podçš„é‡å¯ç­–ç•¥\n\n    -   `containers`ï¼šè®¾ç½®Podä¸­å®¹å™¨çš„è§„æ ¼ï¼Œæ•°ç»„æ ¼å¼ï¼Œæ¯ä¸€é¡¹å®šä¹‰ä¸€ä¸ªå®¹å™¨\n\n        `name`ï¼šæŒ‡å®šå®¹å™¨åç§°ï¼Œåœ¨Podçš„å®šä¹‰ä¸­å”¯ä¸€\n\n        `image`ï¼šè®¾ç½®å®¹å™¨é•œåƒ\n\n        `command`ï¼šè®¾ç½®å®¹å™¨çš„å¯åŠ¨å‘½ä»¤\n\nè¿™é‡Œçš„Podå®šä¹‰æ•ˆæœå’Œä»¥ä¸‹dockerå‘½ä»¤è¿è¡Œçš„å®¹å™¨æ•ˆæœä¸€æ ·\n\n```bash\n$ docker run --name hello-world ubuntu:18.04 /bin/echo 'hello world'\nhello world\n```\n\néœ€è¦æ³¨æ„ï¼Œå› ä¸ºå®¹å™¨è¾“å‡ºå®Œä¹‹åå°±ä¼šé€€å‡ºï¼Œè¿™æ˜¯ä¸€æ¬¡æ€§æ‰§è¡Œçš„ï¼Œæ‰€ä»¥Podçš„å®šä¹‰ä¸­æŠŠ`.spec.restartPolicy`è®¾ç½®ä¸º`OnFailure`ï¼Œå³å®¹å™¨æ­£å¸¸é€€å‡ºä¸ä¼šé‡æ–°åˆ›å»ºå®¹å™¨\n\nåˆ›å»ºPod\n\n```bash\n$ kubectl create -f hello-world-pod.yaml\n# æŸ¥è¯¢Podè¾“å‡º\n$ kubectl logs hello-world\nhello world\n```\n\n\n\n##### Podçš„åŸºæœ¬æ“ä½œ\n\n###### åˆ›å»ºPod\n\nK8sä¸­å¤§éƒ¨åˆ†çš„APIå¯¹è±¡éƒ½æ˜¯é€šè¿‡`kubectl create`å‘½ä»¤åˆ›å»ºçš„\n\nå¦‚æœPodçš„å®šä¹‰æœ‰è¯¯ï¼Œ`kubectl create`ä¼šæ‰“å°å‡ºé”™è¯¯ä¿¡æ¯\n\n###### æŸ¥è¯¢Pod\n\n```bash\nkubectl get pod (pod name)\n```\n\nä¸æŒ‡å®špodåˆ™æŸ¥è¯¢å…¨éƒ¨pod\n\nå­—æ®µå«ä¹‰ï¼š\n\n-   `NAME`ï¼šPodåç§°\n-   `READY`ï¼šPodçš„å‡†å¤‡çŠ¶å†µï¼Œå³è¾¹çš„æ•°å­—è¡¨ç¤ºPodåŒ…å«çš„å®¹å™¨æ€»æ•°ï¼Œå·¦è¾¹çš„æ•°å­—è¡¨ç¤ºå‡†å¤‡å°±ç»ªçš„å®¹å™¨æ•°ç›®\n-   `STATUS`ï¼šPodçš„çŠ¶æ€\n-   `RESTARTS`ï¼šPodçš„é‡å¯æ¬¡æ•°\n-   `AGE`ï¼šPodçš„è¿è¡Œæ—¶é—´\n\nå…¶ä¸­Podçš„å‡†å¤‡çŠ¶å†µæŒ‡çš„æ˜¯Podæ˜¯å¦å‡†å¤‡å°±ç»ªä»¥æ¥å—è¯·æ±‚ï¼ŒPodçš„å‡†å¤‡çŠ¶å†µå–å†³äºå®¹å™¨ï¼Œå³æ‰€æœ‰å®¹å™¨éƒ½å‡†å¤‡å°±ç»ªäº†ï¼ŒPodæ‰å‡†å¤‡å°±ç»ªã€‚è¿™ä¸ªæ—¶å€™K8sçš„ä»£ç†æœåŠ¡æ‰ä¼šæ·»åŠ Podä½œä¸ºåˆ†å‘åç«¯ï¼Œè€Œä¸€æ—¦Podçš„å‡†å¤‡çŠ¶å†µå˜ä¸ºfalseï¼ˆè‡³å°‘ä¸€ä¸ªå®¹å™¨çš„å‡†å¤‡çŠ¶å†µå˜ä¸ºfalseï¼‰ï¼ŒK8sä¼šå°†Podä»ä»£ç†æœåŠ¡çš„åˆ†å‘åç«¯ç§»é™¤ã€‚\n\né»˜è®¤æƒ…å†µä¸‹ï¼Œ`kubectl get`åªæ˜¾ç¤ºPodçš„ç®€è¦ä¿¡æ¯\n\n```bash\nkubectl get pod (pod name) --output json # jsonæ ¼å¼æ˜¾ç¤ºï¼Œ--outputå¯ä»¥ç®€å†™ä¸º-o\nkubectl get pod (pod name) --output yaml # yamlæ ¼å¼æ˜¾ç¤ºï¼Œ--outputå¯ä»¥ç®€å†™ä¸º-o\n```\n\nä¹Ÿæ”¯æŒGo Templateæ–¹å¼è¿‡æ»¤æŒ‡å®šçš„ä¿¡æ¯ï¼Œæ¯”å¦‚æŸ¥è¯¢Podçš„è¿è¡ŒçŠ¶æ€ï¼š\n\n```bash\nkubectl get pod (pod name) -o go-template --template={{.status.phase}}\n```\n\n`kubectl describe`æŸ¥è¯¢Podçš„çŠ¶æ€å’Œç”Ÿå‘½äº‹ä»¶ï¼š\n\n```bash\nkubectl describe pod (pod name)\n```\n\nå­—æ®µå«ä¹‰ï¼š\n\n-   `Name`ï¼šPodåç§°\n-   `Namespace`ï¼šPodçš„Namespace\n-   `Image(s)`ï¼šPodä½¿ç”¨çš„é•œåƒ\n-   `Node`ï¼šPodæ‰€åœ¨çš„Node\n-   `Start Time`ï¼šPodçš„èµ·å§‹æ—¶é—´\n-   `Labels`ï¼šPodçš„Label\n-   `Status`ï¼šPodçš„çŠ¶æ€\n-   `Reason`ï¼šPodå¤„äºå½“å‰çŠ¶æ€çš„åŸå› \n-   `Message`ï¼šPodå¤„äºå½“å‰çŠ¶æ€çš„ä¿¡æ¯\n-   `IP`ï¼šPodçš„PodIP\n-   `Replication Controllers`ï¼šPodå¯¹åº”çš„Replication Controller\n-   `Containers`ï¼šPodä¸­å®¹å™¨çš„ä¿¡æ¯\n    -   `Container ID`ï¼šå®¹å™¨ID\n    -   `Image`ï¼šå®¹å™¨çš„é•œåƒ\n    -   `Image ID`ï¼šé•œåƒID\n    -   `State`ï¼šå®¹å™¨çš„çŠ¶æ€\n    -   `Ready`ï¼šå®¹å™¨çš„å‡†å¤‡çŠ¶æ€\n    -   `Restart Count`ï¼šå®¹å™¨çš„é‡å¯æ¬¡æ•°ç»Ÿè®¡\n    -   `Environment Variables`ï¼šå®¹å™¨çš„ç¯å¢ƒå˜é‡\n-   `Conditions`ï¼šPodçš„æ¡ä»¶ï¼ŒåŒ…å«Podçš„å‡†å¤‡çŠ¶å†µ\n-   `Volumes`ï¼šPodçš„æ•°æ®å·\n-   `Events`ï¼šä¸Podç›¸å…³çš„äº‹ä»¶åˆ—è¡¨\n\n###### åˆ é™¤Pod\n\n```bash\nkubectl delete pod [pod name]\nkubectl delete pod --all\n```\n\n###### æ›´æ–°Pod\n\nå¦‚æœæƒ³è¦æ›´æ–°Podï¼Œå¯ä»¥åœ¨ä¿®æ”¹å®šä¹‰æ–‡ä»¶åæ‰§è¡Œï¼š\n\n```bash\nkubectl replace [file]\n```\n\nä½†æ˜¯å¾ˆå¤šå±æ€§æ²¡åŠæ³•ä¿®æ”¹ï¼Œæ¯”å¦‚å®¹å™¨é•œåƒï¼Œè¿™æ—¶å€™å¯ä»¥é€šè¿‡`--force`å‚æ•°å¼ºåˆ¶æ›´æ–°ï¼Œç­‰äºé‡å»ºPod\n\n##### Podä¸å®¹å™¨\n\nåœ¨Dockerä¸­ï¼Œå®¹å™¨æ˜¯æœ€å°å¤„ç†å•ä½ï¼Œéš”ç¦»æ˜¯åŸºäºLinux Namespaceå®ç°çš„ï¼ŒLinuxå†…æ ¸ä¸­æä¾›äº†6ç§Linux Namespaceéš”ç¦»çš„ç³»ç»Ÿè°ƒç”¨\n\n| Linux Namespace | ç³»ç»Ÿè°ƒç”¨å‚æ•°  | éš”ç¦»å†…å®¹                   |\n| --------------- | ------------- | -------------------------- |\n| UTS             | CLONE_NEWUTS  | ä¸»æœºåä¸åŸŸå               |\n| IPC             | CLONE_NEWIPC  | ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œå…±äº«å†…å­˜ |\n| PID             | CLONE_NEWPID  | è¿›ç¨‹ç¼–å·                   |\n| Network         | CLONE_NEWNET  | ç½‘ç»œè®¾å¤‡ã€ç½‘æ ¼æ ˆã€ç«¯å£ç­‰   |\n| Mount           | CLONE_NEWNS   | æŒ‚è½½ç‚¹ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰         |\n| User            | CLONE_NEWUSER | ç”¨æˆ·å’Œç”¨æˆ·ç»„               |\n\nåœ¨K8sä¸­ï¼ŒPodåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç›¸å…³å®¹å™¨ï¼ŒPodå¯ä»¥è®¤ä¸ºæ˜¯å®¹å™¨çš„ä¸€ç§å»¶ä¼¸æ‰©å±•ï¼Œä¸€ä¸ªPodä¹Ÿæ˜¯ä¸€ä¸ªéš”ç¦»ä½“ï¼Œè€ŒPodåŒ…å«çš„ä¸€ç»„å®¹å™¨åˆæ˜¯å…±äº«çš„ï¼ˆå½“å‰å…±äº«çš„Linux NamespaceåŒ…æ‹¬ï¼šPIDã€Networkã€IPCå’ŒUTSï¼‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒPodä¸­çš„å®¹å™¨å¯ä»¥è®¿é—®å…±åŒçš„æ•°æ®å·æ¥å®ç°æ–‡ä»¶ç³»ç»Ÿçš„å…±äº«ï¼Œæ‰€ä»¥**K8sçš„æ•°æ®å·æ˜¯Podçº§åˆ«çš„**\n\nPodæ˜¯å®¹å™¨çš„é›†åˆï¼Œå®¹å™¨æ˜¯çœŸæ­£çš„æ‰§è¡Œä½“ã€‚Podçš„è®¾è®¡ä¸æ˜¯ä¸ºäº†è¿è¡ŒåŒä¸€ä¸ªåº”ç”¨çš„å¤šä¸ªå®ä¾‹ï¼Œè€Œæ˜¯è¿è¡Œä¸€ä¸ªåº”ç”¨ã€å¤šä¸ªç´§å¯†è”ç³»çš„ç¨‹åºã€‚è€Œæ¯ä¸ªç¨‹åºè¿è¡Œåœ¨å•ç‹¬çš„å®¹å™¨ä¸­ï¼Œä»¥Podçš„å½¢å¼ç»„åˆæˆä¸€ä¸ªåº”ç”¨ã€‚ç›¸æ¯”äºå•ä¸ªå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªç¨‹åºï¼Œè¿™æ ·è®¾è®¡çš„å¥½å¤„æœ‰ï¼š\n\n-   é€æ˜æ€§ï¼šå°†Podå†…çš„å®¹å™¨å‘åŸºç¡€è®¾æ–½å¯è§ï¼Œåº•å±‚ç³»ç»Ÿå°±èƒ½å‘å®¹å™¨æä¾›å¦‚è¿›ç¨‹ç®¡ç†å’Œèµ„æºç›‘æ§ç­‰æœåŠ¡\n-   è§£ç»‘è½¯ä»¶çš„ä¾èµ–ï¼šå•ä¸ªå®¹å™¨å¯ä»¥ç‹¬ç«‹é‡å»ºå’Œé‡æ–°éƒ¨ç½²ï¼Œå®ç°ç‹¬ç«‹å®¹å™¨çš„å®æ—¶æ›´æ–°\n-   æ˜“ç”¨æ€§ï¼šç”¨æˆ·ä¸éœ€è¦è¿è¡Œè‡ªå·±çš„è¿›ç¨‹ç®¡ç†å™¨ï¼Œä¹Ÿä¸éœ€è¦è´Ÿè´£ä¿¡å·é‡å’Œé€€å‡ºç çš„ä¼ é€’ç­‰\n-   é«˜æ•ˆæ€§ï¼šå› ä¸ºåº•å±‚è®¾å¤‡è´Ÿè´£æ›´å¤šçš„ç®¡ç†ï¼Œå®¹å™¨å› è€Œæ›´è½»é‡åŒ–\n\nåœ¨Podä¸­å¯ä»¥è¯¦ç»†é…ç½®å¦‚ä½•è¿è¡Œä¸€ä¸ªå®¹å™¨\n\n###### é•œåƒ\n\nè¿è¡Œå®¹å™¨å¿…é¡»å…ˆæŒ‡å®šé•œåƒï¼Œé•œåƒåç§°éµå¾ªDockerçš„å‘½åè§„èŒƒã€‚\n\nå¦‚æœé•œåƒä¸å­˜åœ¨ï¼Œä¼šä»Dockeré•œåƒä»“åº“ä¸‹è½½ã€‚K8sä¸­å¯ä»¥é€‰æ‹©é•œåƒçš„ä¸‹è½½ç­–ç•¥ï¼Œæ”¯æŒçš„ç­–ç•¥æœ‰ï¼š\n\n-   Alwaysï¼šæ¯æ¬¡éƒ½ä¸‹è½½æœ€æ–°çš„é•œåƒ\n-   Neverï¼šåªä½¿ç”¨æœ¬åœ°é•œåƒï¼Œä»ä¸ä¸‹è½½\n-   IfNotPresentï¼šåªæœ‰æœ¬åœ°æ²¡æœ‰çš„æ—¶å€™æ‰ä¸‹è½½\n\né€šè¿‡`imagePullPolicy`è®¾ç½®é•œåƒä¸‹è½½ç­–ç•¥\n\n```yaml\nname: hello\nimage: 'ubuntu:18.04'\nimagePullPolicy: Always\n```\n\n###### å¯åŠ¨å‘½ä»¤\n\nå¯åŠ¨å‘½ä»¤ç”¨æ¥è¯´æ˜å®¹å™¨æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œåœ¨Podçš„å®šä¹‰ä¸­å¯ä»¥è®¾ç½®å®¹å™¨å¯åŠ¨å‘½ä»¤å’Œå‚æ•°\n\nä¾‹ï¼š\n\n```yaml\n...\ncontainers:\n- name: hello\n  image: 'ubuntu:18.04'\n  command: [\"/bin/echo\", \"hello\", \"world\"]\n...\n```\n\nä¹Ÿå¯ä»¥é…ç½®ä¸ºï¼š\n\n```yaml\n...\ncommand: [\"/bin/echo\"]\nargs: [\"hello\", \"world\"]\n...\n```\n\nåœ¨Podå®šä¹‰ä¸­`command`å’Œ`args`éƒ½æ˜¯å¯é€‰é¡¹ï¼Œå°†å’ŒDockeré•œåƒçš„`ENTRYPOINT`å’Œ`CMD`ç›¸äº’ä½œç”¨ï¼Œç”Ÿæˆæœ€ç»ˆå®¹å™¨çš„å¯åŠ¨å‘½ä»¤\n\nè§„åˆ™ï¼š\n\n-   åªè¦æŒ‡å®šäº†commandï¼Œå°±ä¸ä¼šä½¿ç”¨é•œåƒä¸­çš„å‘½ä»¤\n-   æ²¡æŒ‡å®šcommandï¼ŒæŒ‡å®šäº†argsï¼Œåˆ™å°†argsä½œä¸ºå‚æ•°ä½¿ç”¨ï¼Œå‘½ä»¤ä½¿ç”¨é•œåƒä¸­çš„å‘½ä»¤\n\n###### ç¯å¢ƒå˜é‡\n\nPodä¸­å¯ä»¥è®¾ç½®å®¹å™¨è¿è¡Œæ—¶çš„ç¯å¢ƒå˜é‡ï¼š\n\n```yaml\nenv:\n- name: PARAMETER_1\n  value: value_1\n- name: PARAMETER_2\n  value: value_2\n```\n\nåœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼ŒPodä¸­çš„å®¹å™¨å¸Œæœ›è·å–æœ¬èº«çš„ä¿¡æ¯ï¼Œæ¯”å¦‚Podçš„åç§°ï¼ŒPodæ‰€åœ¨çš„Namespaceç­‰ï¼Œåœ¨K8sä¸­æä¾›äº†`Downward API`è·å–è¿™äº›ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡å‘Šè¯‰å®¹å™¨\n\n-   Podçš„åç§°ï¼šmetadata.name\n-   Podçš„Namespaceï¼šmetadata.namespace\n-   Podçš„PodIPï¼šstatus.podIP\n\nç°åœ¨åˆ›å»ºä¸€ä¸ªPodå¹¶é€šè¿‡ç¯å¢ƒå˜é‡è·å–`Downward API`\n\nå®šä¹‰æ–‡ä»¶downwardapi-env.yamlï¼š\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: downwardapi-env\nspec:\n  containers:\n  - name: test-container\n    image: \"ubuntu:18.04\"\n    command: [\"/bin/bash\", \"-c\", \"while true; do sleep 5; done\"]\n    env:\n      - name: MY_POD_NAME\n        valueFrom:\n          fieldRef:\n            fieldPath: metadata.name\n      - name: MY_POD_NAMESPACE\n        valueFrom:\n          fieldRef:\n            fieldPath: metadata.namespace\n      - name: MY_POD_IP\n        valueFrom:\n          fieldRef:\n            fieldPath: status.podIP\n```\n\n```bash\n# åˆ›å»ºPod\n$ kubectl create -f downwardapi-env.yaml\n# è¾“å‡ºPodå†…ç¯å¢ƒå˜é‡\n$ kubectl exec downwardapi-env env | grep MY_POD\nMY_POD_NAME=downwardapi-env\nMY_POD_NAMESPACE=default\nMY_POD_IP=10.0.10.103\n```\n\n\n\n###### ç«¯å£\n\nåœ¨Dockerä¸­è¿è¡Œå®¹å™¨é€šè¿‡`-p`/`--publish`å‚æ•°è®¾ç½®ç«¯å£æ˜ å°„è§„åˆ™\n\nåœ¨Podçš„å®šä¹‰ä¸­ä¹Ÿå¯ä»¥è®¾ç½®ç«¯å£æ˜ å°„è§„åˆ™\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: my-nginx\nspec:\n  containers:\n  - name: nginx\n    image: nginx\n    ports:\n      - name: web\n        containerPort: 80\n        protocol: TCP\n        hostIP: 0.0.0.0\n        hostPort: 80\n```\n\nåœ¨Podçš„å®šä¹‰ä¸­ï¼Œé€šè¿‡`.spec.containers[].ports[]`è®¾ç½®å®¹å™¨çš„ç«¯å£ï¼Œæ•°ç»„å½¢å¼ï¼Œå‚æ•°å«ä¹‰ï¼š\n\n-   nameï¼šç«¯å£åç§°ï¼ŒPodå†…å”¯ä¸€ï¼Œå½“åªé…ç½®ä¸€ä¸ªç«¯å£çš„æ—¶å€™ï¼Œè¿™æ˜¯å¯é€‰çš„ï¼Œå½“é…ç½®å¤šä¸ªç«¯å£çš„æ—¶å€™ï¼Œè¿™æ˜¯å¿…é€‰çš„\n-   containerPortï¼š**å¿…é€‰**ï¼Œè®¾ç½®åœ¨å®¹å™¨å†…çš„ç«¯å£\n-   protocolï¼šå¯é€‰ï¼Œè®¾ç½®ç«¯å£åè®®ï¼ŒTCPæˆ–UDPï¼Œé»˜è®¤æ˜¯TCP\n-   hostIPï¼šå¯é€‰ï¼Œè®¾ç½®åœ¨å®¿ä¸»æœºä¸Šçš„IPï¼Œé»˜è®¤ç»‘å®šåˆ°æ‰€æœ‰å¯ç”¨çš„IPæ¥å£ä¸Šï¼Œå³0.0.0.0\n-   hostPortï¼šå¯é€‰ï¼Œè®¾ç½®åœ¨å®¿ä¸»æœºä¸Šçš„ç«¯å£ï¼Œå¦‚æœè®¾ç½®åˆ™è¿›è¡Œç«¯å£æ˜ å°„\n\n>   ä½¿ç”¨å®¿ä¸»æœºç«¯å£éœ€è¦è€ƒè™‘ç«¯å£å†²çªé—®é¢˜ï¼Œå¹¸è¿çš„æ˜¯ï¼ŒK8såœ¨è°ƒåº¦Podçš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥å®¿ä¸»æœºç«¯å£æ˜¯å¦å†²çªã€‚æ¯”å¦‚ä¸¤ä¸ªPodéƒ½éœ€è¦ä½¿ç”¨å®¿ä¸»æœº80ç«¯å£ï¼Œé‚£ä¹ˆè°ƒåº¦çš„æ—¶å€™ä¼šå°†ä¸¤ä¸ªPodè°ƒåº¦åˆ°ä¸åŒçš„Nodeä¸Šã€‚å¦‚æœæ‰€æœ‰Nodeçš„ç«¯å£éƒ½è¢«å ç”¨äº†ï¼Œé‚£ä¹ˆPodè°ƒåº¦å¤±è´¥ã€‚\n\n###### æ•°æ®æŒä¹…åŒ–å’Œå…±äº«\n\nå®¹å™¨æ˜¯ä¸´æ—¶å­˜åœ¨çš„ï¼Œå¦‚æœå®¹å™¨è¢«é”€æ¯ï¼Œå®¹å™¨ä¸­çš„æ•°æ®å°†ä¼šä¸¢å¤±\n\nä¸ºäº†èƒ½å¤ŸæŒä¹…åŒ–æ•°æ®ä»¥åŠå…±äº«å®¹å™¨é—´çš„æ•°æ®ï¼ŒDockeræå‡ºäº†æ•°æ®å·ï¼ˆVolumeï¼‰çš„æ¦‚å¿µ\n\næ•°æ®å·å°±æ˜¯ç›®å½•æˆ–è€…æ–‡ä»¶ï¼Œå®ƒå¯ä»¥ç»•è¿‡è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥æ­£å¸¸çš„æ–‡ä»¶æˆ–è€…ç›®å½•çš„å½¢å¼å­˜åœ¨ä¸å®¿ä¸»æœºä¸Š\n\nä½¿ç”¨`docker run`è¿è¡Œå®¹å™¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨å‚æ•°`--volume`/`-v`åˆ›å»ºæ•°æ®å·ï¼Œå°†å®¿ä¸»æœºä¸Šçš„ç›®å½•æˆ–è€…æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚å³ä½¿å®¹å™¨è¢«é”€æ¯ï¼Œæ•°æ®å·ä¸­çš„æ•°æ®ä»ç„¶ä¿å­˜åœ¨å®¿ä¸»æœºä¸Šã€‚\n\n\n\nK8så¯¹Dockeræ•°æ®å·è¿›è¡Œäº†æ‰©å±•ï¼Œæ”¯æŒå¯¹æ¥ç¬¬ä¸‰æ–¹å­˜å‚¨ç³»ç»Ÿã€‚ä¸”K8sä¸­çš„æ•°æ®å·æ˜¯Podçº§åˆ«çš„ï¼ŒPodä¸­çš„å®¹å™¨å¯ä»¥è®¿é—®å…±åŒçš„æ•°æ®å·ï¼Œå®ç°å®¹å™¨é—´çš„æ•°æ®å…±äº«ã€‚\n\næˆ‘ä»¬å¯¹HelloWorldPodè¿›è¡Œæ”¹é€ ï¼š\n\nåœ¨Podä¸­å£°æ˜åˆ›å»ºæ•°æ®å·ï¼ŒPodä¸­çš„ä¸¤ä¸ªå®¹å™¨å°†å…±äº«æ•°æ®å·ï¼Œå®¹å™¨`write`å†™å…¥æ•°æ®ï¼Œå®¹å™¨`read`è¯»å‡ºæ•°æ®\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: hello-world\nspec:\n  restartPolicy: Never\n  containers:\n  - name: write\n    image: \"ubuntu:18.04\"\n    command:\n      - \"bash\"\n      - \"-c\"\n      - \"echo 'hello world' >> /data/hello\"\n    volumeMounts:\n      - name: data\n        mountPath: /data\n  - name: read\n    image: \"ubuntu:18.04\"\n    command:\n      - \"bash\"\n      - \"-c\"\n      - \"sleep 10; cat /data/hello\"\n    volumeMounts:\n      - name: data\n        mountPath: /data\n  volumes:\n    - name: data\n      hostPath:\n        path: /tmp\n\n```\n\n##### Podçš„ç½‘ç»œ\n\nPodä¸­æ‰€æœ‰å®¹å™¨ç½‘ç»œéƒ½æ˜¯å…±äº«çš„ï¼Œä¸€ä¸ªPodä¸­çš„æ‰€æœ‰å®¹å™¨çš„ç½‘ç»œæ˜¯ä¸€è‡´çš„ï¼Œå®ƒä»¬èƒ½å¤Ÿé€šè¿‡æœ¬åœ°åœ°å€è®¿é—®å…¶ä»–ç”¨æˆ·å®¹å™¨çš„ç«¯å£\n\nK8sç½‘ç»œæ¨¡å‹ä¸­ï¼Œæ¯ä¸€ä¸ªPodéƒ½æ‹¥æœ‰ä¸€ä¸ªæ‰å¹³åŒ–å…±äº«ç½‘ç»œå‘½ä»¤ç©ºé—´çš„IPï¼Œç§°ä¸ºPodIPã€‚\n\n```bash\n$ kubectl get pod my-app --template={{.status.podIP}}\n10.0.10.204\n```\n\nè¿™æ˜¯Dockerä¸ºå®¹å™¨è¿›è¡Œç½‘ç»œè™šæ‹ŸåŒ–éš”ç¦»è€Œåˆ†é…çš„å†…éƒ¨IPã€‚ä¹Ÿå¯ä»¥è®¾ç½®Podä¸ºHostç½‘ç»œæ¨¡å¼ï¼Œå³ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼Œä¸è¿›è¡Œç½‘ç»œè™šæ‹ŸåŒ–éš”ç¦»ã€‚Podçš„PodIPå°±æ˜¯å…¶æ‰€åœ¨Nodeçš„IPã€‚\n\né€šè¿‡`.spec.hostNetwork`è®¾ç½®Podä¸ºHostç½‘ç»œæ¨¡å¼\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: host-network-mode\nspec:\n  containers:\n  - name: host-network-mode\n    image: nginx\n    ports:\n      - containerPort: 80\n        protocol: TCP\n        name: web\n  hostNetwork: true\n```\n\næ³¨æ„ï¼š\n\n1.  ä¸å­˜åœ¨ç½‘ç»œéš”ç¦»ï¼Œæ‰€ä»¥å®¹æ˜“å‘ç”Ÿç«¯å£å†²çª\n2.  Podå¯ä»¥ç›´æ¥è®¿é—®å®¿ä¸»æœºä¸Šçš„æ‰€æœ‰ç½‘ç»œè®¾å¤‡å’ŒæœåŠ¡ï¼Œä»å®‰å…¨æ€§ä¸Šæ¥è¯´æ˜¯ä¸å¯æ§çš„\n\n##### Podçš„é‡å¯ç­–ç•¥\n\né‡å¯ç­–ç•¥é€šè¿‡`.spec.restartPolicy`è®¾ç½®ï¼Œç›®å‰æ”¯æŒ3ç§ç­–ç•¥\n\n-   Alwaysï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºåï¼Œæ€»æ˜¯é‡å¯å®¹å™¨ï¼Œé»˜è®¤\n-   OnFailureï¼šå½“å®¹å™¨ç»ˆæ­¢å¼‚å¸¸é€€å‡ºæ—¶ï¼Œæ‰é‡å¯å®¹å™¨\n-   Neverï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºæ—¶ï¼Œä»ä¸é‡å¯\n\n>   Podä¸­çš„å®¹å™¨é‡å¯æ¬¡æ•°ç»Ÿè®¡ï¼Œå®é™…å¹¶ä¸æ˜¯éå¸¸ç²¾ç¡®ï¼Œåªèƒ½ä½œä¸ºä¸€ä¸ªå‚è€ƒ\n\n##### Podçš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸ\n\n###### å®¹å™¨çŠ¶æ€\n\nPodçš„æœ¬è´¨æ˜¯ä¸€ç»„å®¹å™¨\n\nK8så¯¹Podä¸­çš„å®¹å™¨è¿›è¡Œäº†çŠ¶æ€çš„è®°å½•\n\n-   Waitingï¼šå®¹å™¨æ­£åœ¨ç­‰å¾…åˆ›å»ºï¼Œæ¯”å¦‚ä¸‹è½½é•œåƒ\n    -   Reasonï¼šç­‰å¾…åŸå› \n-   Runningï¼šå®¹å™¨å·²ç»åˆ›å»ºå¹¶ä¸”æ­£åœ¨è¿è¡Œ\n    -   startedAtï¼šå®¹å™¨åˆ›å»ºæ—¶é—´\n-   Terminatedï¼šå®¹å™¨ç»ˆæ­¢é€€å‡º\n    -   exitCodeï¼šé€€å‡ºç \n    -   signalï¼šå®¹å™¨é€€å‡ºä¿¡å·\n    -   reasonï¼šå®¹å™¨é€€å‡ºåŸå› \n    -   messageï¼šå®¹å™¨é€€å‡ºä¿¡æ¯\n    -   startedAtï¼šå®¹å™¨åˆ›å»ºæ—¶é—´\n    -   finishedAtï¼šå®¹å™¨é€€å‡ºæ—¶é—´\n    -   containerIDï¼šå®¹å™¨çš„ID\n\n```bash\n# æŸ¥è¯¢PodçŠ¶æ€\n$ kubectl describe pod my-pod\n```\n\n###### Podçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ\n\nPodä¸€æ—¦è¢«åˆ†é…åˆ°Nodeåï¼Œå°±ä¸ä¼šç¦»å¼€è¿™ä¸ªNode\n\nPodçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼š\n\n-   Pendingï¼šPodå·²ç»è¢«åˆ›å»ºï¼Œä½†æ˜¯æœ‰å®¹å™¨æœªè¢«åˆ›å»º\n-   Runningï¼šPodå·²ç»è¢«è°ƒåº¦åˆ°Nodeï¼Œæ‰€æœ‰å®¹å™¨å·²ç»åˆ›å»ºï¼Œå¹¶ä¸”è‡³å°‘ä¸€ä¸ªå®¹å™¨åœ¨è¿è¡Œæˆ–è€…æ­£åœ¨é‡å¯\n-   Succeededï¼šPodä¸­æ‰€æœ‰å®¹å™¨æ­£å¸¸é€€å‡º\n-   Failedï¼šPodä¸­æ‰€æœ‰å®¹å™¨é€€å‡ºï¼Œè‡³å°‘ä¸€ä¸ªå®¹å™¨æ˜¯å¼‚å¸¸é€€å‡ºçš„\n\n###### ç”Ÿå‘½å‘¨æœŸå›è°ƒå‡½æ•°\n\nK8sæä¾›äº†å›è°ƒå‡½æ•°ï¼Œåœ¨å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸçš„ç‰¹å®šé˜¶æ®µæ‰§è¡Œè°ƒç”¨ï¼Œæ¯”å¦‚å®¹å™¨åœ¨åœæ­¢å‰å¸Œæœ›æ‰§è¡ŒæŸé¡¹æ“ä½œï¼Œå°±å¯ä»¥æ³¨å†Œç›¸åº”çš„é’©å­å‡½æ•°ã€‚\n\n-   PostStartï¼šåœ¨å®¹å™¨åˆ›å»ºæˆåŠŸåè°ƒç”¨\n-   PreStopï¼šåœ¨å®¹å™¨è¢«ç»ˆæ­¢å‰è°ƒç”¨\n\né’©å­å‡½æ•°çš„å®ç°æ–¹å¼æœ‰ä»¥ä¸‹ä¸¤ç§\n\n-   Exec\n\n    æ‰§è¡ŒæŒ‡å®šå‘½ä»¤\n\n    é…ç½®å‚æ•°ï¼š\n\n    commandï¼šéœ€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œå­—ç¬¦ä¸²æ•°ç»„\n\n    ç¤ºä¾‹\n\n    ```yaml\n    exec:\n      command:\n      \t- cat\n      \t- /tmp/health\n    ```\n\n-   HTTP\n\n    å‘èµ·ä¸€ä¸ªHTTPè°ƒç”¨è¯·æ±‚\n\n    é…ç½®å‚æ•°ï¼š\n\n    pathï¼šè¯·æ±‚çš„URLè·¯å¾„ï¼Œå¯é€‰\n\n    portï¼šè¯·æ±‚çš„ç«¯å£ï¼Œå¿…é€‰\n\n    hostï¼šè¯·æ±‚çš„IPï¼Œå¯é€‰ï¼Œé»˜è®¤æ˜¯Podçš„PodIP\n\n    schemeï¼šè¯·æ±‚çš„åè®®ï¼Œå¯é€‰ï¼Œé»˜è®¤æ˜¯HTTP\n\n    ç¤ºä¾‹ï¼š\n\n    ```yaml\n    httpGet:\n      host: 192.168.1.1\n      path: /notify\n      port: 8080\n    ```\n\nç°å®šä¹‰ä¸€ä¸ªPodï¼ŒåŒ…å«ä¸€ä¸ªJavaçš„Webåº”ç”¨æœåŠ¡å™¨ï¼Œå…¶ä¸­è®¾ç½®äº†PostStartå’ŒPreStopå›è°ƒå‡½æ•°ã€‚åœ¨å®¹å™¨åˆ›å»ºæˆåŠŸåï¼Œå¤åˆ¶`/sample.war`åˆ°`/app`ç›®å½•ã€‚è€Œåœ¨å®¹å™¨è¢«ç»ˆæ­¢å‰ï¼Œå‘é€HTTPè¯·æ±‚åˆ°`http://monitor.com:8080/warning`ï¼Œå¾€ç›‘æ§ç³»ç»Ÿå‘é€ä¸€ä¸ªè­¦å‘Šï¼ŒPodçš„å®šä¹‰å¦‚ä¸‹ï¼š\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: javaweb\nspec:\n  containers:\n  - name: war\n    image: resouer/sample:v2\n    lifecycle:\n      postStart:\n        exec:\n          command:\n            - \"cp\"\n            - \"/sample.war\"\n            - \"/app\"\n      preStop:\n        httpGet:\n          host: monitor.com\n          path: /warning\n          port: 8080\n          scheme: HTTP\n```\n\n##### è‡ªå®šä¹‰æ£€æŸ¥Pod\n\nå¯¹äºPodæ˜¯å¦å¥åº·ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæ˜¯æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚ä½†æœ‰çš„æ—¶å€™å®¹å™¨æ­£å¸¸è¿è¡Œå¹¶ä¸ä»£è¡¨å¥åº·ï¼Œå¯èƒ½æœ‰çš„åº”ç”¨è¿›ç¨‹å·²ç»é˜»å¡ä½æ— æ³•æ­£å¸¸å¤„ç†è¯·æ±‚ï¼Œæ‰€ä»¥ä¸ºäº†æä¾›æ›´åŠ å¥å£®çš„åº”ç”¨ï¼Œå¾€å¾€éœ€è¦å®šåˆ¶åŒ–çš„å¥åº·æ£€æŸ¥ã€‚\n\nK8sæä¾›`Probe`æœºåˆ¶ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„`Probe`\n\n-   Liveness Probeï¼šç”¨äºå®¹å™¨çš„è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥å¤±è´¥ï¼ŒK8så°†ä¼šæ€æ­»Podï¼Œç„¶åæ ¹æ®é‡å¯ç­–ç•¥é‡å¯Pod\n-   Readiness Probeï¼šç”¨äºæ£€æŸ¥å®¹å™¨çš„è‡ªå®šä¹‰å‡†å¤‡çŠ¶å†µæ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥å¤±è´¥ï¼ŒK8sä¼šå°†Podä»æœåŠ¡ä»£ç†çš„åˆ†å‘åç«¯ç§»é™¤ï¼Œå³ä¸ä¼šåˆ†å‘è¯·æ±‚ç»™è¯¥Pod\n\n`Probe`æ”¯æŒä»¥ä¸‹ä¸‰ç§æ£€æŸ¥æ–¹æ³•\n\n-   ExecAction\n\n    åœ¨å®¹å™¨ä¸­æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤è¿›è¡Œæ£€æŸ¥ï¼Œå½“å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼ˆè¿”å›ç ä¸º0ï¼‰ï¼Œæ£€æŸ¥æˆåŠŸã€‚\n\n    é…ç½®å‚æ•°\n\n    commandï¼šæ£€æŸ¥å‘½ä»¤ï¼Œå­—ç¬¦ä¸²æ•°ç»„\n\n    ç¤ºä¾‹\n\n    ```yaml\n    exec:\n      command:\n        - cat\n        - /tmp/health\n    ```\n\n-   TCPSocketAction\n\n    å¯¹Podä¸­çš„æŒ‡å®šTCPç«¯å£è¿›è¡Œæ£€æŸ¥ï¼Œå½“TCPç«¯å£è¢«å ç”¨ï¼Œæ£€æŸ¥æˆåŠŸ\n\n    é…ç½®å‚æ•°\n\n    portï¼šæ£€æŸ¥çš„TCPç«¯å£\n\n    ç¤ºä¾‹\n\n    ```yaml\n    tcpSocket:\n      port: 8080\n    ```\n\n-   HTTPGetAction\n\n    å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œå½“è¿”å›ç ä»‹äº200~400ä¹‹é—´æ—¶ï¼Œæ£€æŸ¥æˆåŠŸ\n\n    é…ç½®å‚æ•°\n\n    pathï¼šè¯·æ±‚çš„URIè·¯å¾„ï¼Œå¯é€‰\n\n    portï¼šè¯·æ±‚çš„ç«¯å£ï¼Œå¿…é€‰\n\n    hostï¼šè¯·æ±‚çš„IPï¼Œå¯é€‰ï¼Œé»˜è®¤ä¸ºPodçš„PodIP\n\n    schemeï¼šè¯·æ±‚çš„åè®®ï¼Œå¯é€‰ï¼Œé»˜è®¤ä¸ºHTTP\n\n    ç¤ºä¾‹\n\n    ```yaml\n    httpGet:\n      path: /health\n      port: 8080\n    ```\n\n###### Podçš„å¥åº·æ£€æŸ¥\n\nå®šä¹‰ä¸€ä¸ªPodï¼Œä½¿ç”¨`Liveness Probe`é€šè¿‡`ExecAction`æ–¹å¼æ£€æŸ¥å®¹å™¨çš„å¥åº·çŠ¶æ€ï¼ŒPodçš„å®šä¹‰æ–‡ä»¶`liveness-exec-pod.yaml`ï¼š\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: liveness-exec-pod\n  labels:\n    test: liveness\nspec:\n  containers:\n  - name: liveness\n    image: \"ubuntu:18.04\"\n    command:\n      - \"/bin/sh\"\n      - \"-c\"\n      - \"echo ok > /tmp/health; sleep 60; rm -rf /tmp/health; sleep 600\"\n    livenessProbe:\n      exec:\n        command: [\"cat\", \"/tmp/health\"]\n      initialDelaySeconds: 15\n      timeoutSeconds: 1\n```\n\n```bash\n$ kubectl describe pod liveness-exec-pod | grep Unhealthy\n  Warning  Unhealthy  <invalid> (x3 over <invalid>)  kubelet            Liveness probe failed: cat: /tmp/health: No such file or directory\n```\n\nå¯ä»¥çœ‹åˆ°`Liveness Probe`æ£€æŸ¥å¤±è´¥å¹¶é‡å¯äº†Pod\n\n###### Podçš„å‡†å¤‡çŠ¶å†µæ£€æŸ¥\n\nå®šä¹‰ä¸€ä¸ªPodï¼Œä½¿ç”¨`Readiness Probe`é€šè¿‡ExecActionæ–¹å¼æ£€æŸ¥å®¹å™¨çš„å‡†å¤‡çŠ¶å†µï¼ŒPodçš„å®šä¹‰æ–‡ä»¶`readiness-exec-pod.yaml`ï¼š\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: readiness-exec-pod\n  labels:\n    test: readiness\nspec:\n  containers:\n  - name: readiness\n    image: \"ubuntu:18.04\"\n    command: [\"/bin/sh\", \"-c\", \"echo ok > /tmp/ready; sleep 60; rm -rf /tmp/ready; sleep 600\"]\n    readinessProbe:\n      exec:\n        command: [\"cat\", \"/tmp/ready\"]\n      initialDelaySeconds: 15\n      timeoutSeconds: 1\n```\n\næŸ¥çœ‹Podï¼Œå¤§æ¦‚ä¸€åˆ†é’Ÿåå¯ä»¥çœ‹åˆ°Podçš„readyæ•°ç›®å˜ä¸º0\n\n```bash\n$ kubectl get pod\nNAME                 READY   STATUS             RESTARTS   AGE\nreadiness-exec-pod   0/1     Running            0          109s\n\n# æŸ¥çœ‹äº‹ä»¶å¯ä»¥çœ‹åˆ°ï¼ŒReadiness Probeæ£€æŸ¥å¤±è´¥\n$ kubectl describe pod readiness-exec-pod | grep Unhealthy\n  Warning  Unhealthy  <invalid> (x21 over <invalid>)  kubelet            Readiness probe failed: cat: /tmp/ready: No such file or directory\n```\n\n\n\n##### è°ƒåº¦Pod\n\nPodè°ƒåº¦æŒ‡çš„æ˜¯Podåœ¨åˆ›å»ºä¹‹ååˆ†é…åˆ°å“ªä¸€ä¸ªNodeä¸Šï¼Œè°ƒåº¦ç®—æ³•åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤\n\n1.  ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„Node\n2.  é€‰æ‹©æœ€ä¼˜çš„Node\n\nå¯¹äºæ‰€æœ‰çš„Nodeï¼Œé¦–å…ˆK8sé€šè¿‡è¿‡æ»¤å‡½æ•°å»é™¤ä¸ç¬¦åˆæ¡ä»¶çš„Nodeï¼ŒK8s v1.1.1æ”¯æŒçš„è¿‡æ»¤å‡½æ•°å¦‚ä¸‹ï¼š\n\n-   NoDiskConflictï¼šæ£€æŸ¥Podè¯·æ±‚çš„æ•°æ®å·æ˜¯å¦ä¸Nodeä¸Šå·²å­˜åœ¨PodæŒ‚è½½çš„æ•°æ®å·å­˜åœ¨å†²çªï¼Œå¦‚æœå­˜åœ¨å†²çªï¼Œåˆ™è¿‡æ»¤æ‰è¯¥Node\n-   PodFitsResourcesï¼šæ£€æŸ¥Nodeçš„å¯ç”¨èµ„æºï¼ˆCPUå’Œå†…å­˜ï¼‰æ˜¯å¦æ»¡è¶³Podçš„èµ„æºè¯·æ±‚\n-   PodFitsPortsï¼šæ£€æŸ¥Podè®¾ç½®çš„HostPortsåœ¨Nodeä¸Šæ˜¯å¦å·²ç»è¢«å…¶ä»–Podå ç”¨\n-   PodFitsHostï¼šå¦‚æœPodè®¾ç½®äº†NodeNameå±æ€§ï¼Œåˆ™ç­›é€‰å‡ºæŒ‡å®šçš„Node\n-   PodSelectorMatchesï¼šå¦‚æœPodè®¾ç½®äº†NodeSelectorå±æ€§ï¼Œåˆ™ç­›é€‰å‡ºç¬¦åˆçš„Node\n-   CheckNodeLabelPresenceï¼šæ£€æŸ¥Nodeæ˜¯å¦å­˜åœ¨`Kubernetes Scheduler`é…ç½®çš„æ ‡ç­¾\n\nç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„Nodeæ¥è¿è¡ŒPodï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªç¬¦åˆæ¡ä»¶çš„Nodeï¼Œé‚£ä¹ˆéœ€è¦é€‰æ‹©å‡ºæœ€ä¼˜çš„Nodeã€‚\n\nK8sé€šè¿‡ä¼˜å…ˆçº§å‡½æ•°æ¥è¯„ä¼°å‡ºæœ€ä¼˜çš„Nodeï¼Œå¯¹äºæ¯ä¸ªNodeï¼Œä¼˜å…ˆçº§å‡½æ•°ç»™å‡ºä¸€ä¸ªåˆ†æ•°ï¼š0~10ï¼ˆ10è¡¨ç¤ºæœ€ä¼˜ï¼Œ0è¡¨ç¤ºæœ€å·®ï¼‰ï¼Œæ¯ä¸ªä¼˜å…ˆçº§å‡½æ•°è®¾ç½®æœ‰æƒé‡å€¼ï¼ŒNodeæœ€ç»ˆåˆ†æ•°å°±æ˜¯æ¯ä¸ªä¼˜å…ˆçº§å‡½æ•°ç»™å‡ºçš„åˆ†æ•°çš„åŠ æƒå’Œã€‚\n\nK8s v1.1.1æä¾›çš„ä¼˜å…ˆçº§å‡½æ•°æœ‰ï¼š\n\n-   LeastRequestedPriorityï¼šä¼˜å…ˆé€‰æ‹©æœ‰æœ€å¤šå¯ç”¨èµ„æºçš„Node\n-   CalculateNodeLabelPriorityï¼šä¼˜å…ˆé€‰æ‹©å«æœ‰æŒ‡å®šLabelçš„Node\n-   BalancedResourceAllocationï¼šä¼˜å…ˆé€‰æ‹©èµ„æºä½¿ç”¨å‡è¡¡çš„Node\n\nå¦‚ä½•è¿›è¡ŒNodeé€‰æ‹©ï¼Ÿ\n\n-   åœ¨å®šä¹‰Podæ—¶é€šè¿‡è®¾ç½®`.spec.nodeSelector`æ¥é€‰æ‹©Node\n\n    ```yaml\n    apiVersion: v1\n    kind: Pod\n    metadata:\n      name: nginx\n      labels:\n        env: test\n    spec:\n      containers:\n        ...\n      nodeSelector:\n        env: test\n    ```\n\n    Podåˆ›å»ºæˆåŠŸåå¤§æ¦‚ç‡ä¼šè¢«åˆ†é…åˆ°æœ‰`env=test`æ ‡ç­¾çš„Nodeä¸Š\n\n-   åœ¨å®šä¹‰Podæ—¶é€šè¿‡`.spec.nodeName`ç›´æ¥æŒ‡å®šNode\n\n    ```yaml\n    apiVersion: v1\n    kind: Pod\n    metadata:\n      name: nginx\n      labels:\n        env: test\n    spec:\n      containers:\n        ...\n      nodeName: kube-node-0\n    ```\n\n    {% note warning %}\n\n    è¿˜æ˜¯å»ºè®®ä½¿ç”¨`Node Selector`ï¼Œå› ä¸ºé€šè¿‡`Label`é€‰æ‹©æ˜¯ä¸€ç§å¼±ç»‘å®šï¼Œè€Œç›´æ¥æŒ‡å®š`Node Name`æ˜¯ä¸€ç§å¼ºç»‘å®šï¼ŒNodeå¤±æ•ˆæ—¶ä¼šå¯¼è‡´`Pod`æ— æ³•è°ƒåº¦\n\n    {% endnote %}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["Kubernetes","Docker"],"categories":["å•ƒä¹¦"]},{"title":"å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„","url":"/posts/499d1db9/","content":"\n\n\n## å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„\n\n### ç¬¬1ç¯‡ æ¦‚è¿°\n\n#### å¤§å‹ç½‘ç«™æ¶æ„æ¼”åŒ–\n\n##### å¤§å‹ç½‘ç«™æ¶æ„æ¼”åŒ–å‘å±•å†ç¨‹\n\n###### åˆå§‹é˜¶æ®µçš„ç½‘ç«™æ¶æ„\n\nå°å‹ç½‘ç«™æœ€å¼€å§‹æ²¡æœ‰å¤ªå¤šäººè®¿é—®ï¼Œåªéœ€è¦ä¸€å°æœåŠ¡å™¨å°±å¯ä»¥äº†ã€‚\n\n![20220517102751693](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220517102751693.jpg)\n\nåº”ç”¨ç¨‹åºã€æ•°æ®åº“ã€æ–‡ä»¶ç­‰æ‰€æœ‰çš„èµ„æºéƒ½åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šã€‚\n\n###### åº”ç”¨æœåŠ¡å’Œæ•°æ®æœåŠ¡åˆ†ç¦»\n\néšç€ç½‘ç«™ä¸šåŠ¡å‘å±•ï¼Œä¸€å°æœåŠ¡å™¨é€æ¸ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼šè¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·è®¿é—®å¯¼è‡´æ€§èƒ½è¶Šæ¥è¶Šå·®ï¼Œè¶Šæ¥è¶Šå¤šçš„æ•°æ®å¯¼è‡´å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚è¿™æ—¶éœ€è¦å°†åº”ç”¨å’Œæ•°æ®åˆ†ç¦»ã€‚åº”ç”¨å’Œæ•°æ®åˆ†ç¦»åæ•´ä¸ªç½‘ç«™ä½¿ç”¨ä¸‰å°æœåŠ¡å™¨ï¼šåº”ç”¨æœåŠ¡å™¨ã€æ–‡ä»¶æœåŠ¡å™¨å’Œæ•°æ®åº“æœåŠ¡å™¨ã€‚è¿™ä¸‰å°æœåŠ¡å™¨å¯¹ç¡¬ä»¶èµ„æºçš„è¦æ±‚ä¸åŒï¼Œ\n\nåº”ç”¨æœåŠ¡å™¨éœ€è¦å¤„ç†å¤§é‡çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€ä»¥éœ€è¦æ›´å¼ºå¤§çš„CPUï¼›\n\næ•°æ®åº“æœåŠ¡å™¨éœ€è¦å¿«é€Ÿç£ç›˜æ£€ç´¢å’Œæ•°æ®ç¼“å­˜ï¼Œæ‰€ä»¥éœ€è¦æ›´å¿«çš„ç¡¬ç›˜å’Œæ›´å¤§çš„å†…å­˜ï¼›\n\næ–‡ä»¶æœåŠ¡å™¨éœ€è¦å­˜å‚¨å¤§é‡ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦æ›´å¤§çš„ç¡¬ç›˜ã€‚\n\n![20220517103257768](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220517103257768.jpg)\n\n\n\néšç€ç”¨æˆ·é€æ¸å¢å¤šï¼Œæ•°æ®åº“å‹åŠ›å¤ªå¤§ä¼šå¯¼è‡´è®¿é—®å»¶è¿Ÿï¼Œå½±å“æ•´ä¸ªç½‘ç«™çš„æ€§èƒ½ã€‚\n\n###### ä½¿ç”¨ç¼“å­˜æ”¹å–„ç½‘ç«™æ€§èƒ½\n\n**ç½‘ç«™è®¿é—®ç‰¹ç‚¹ä¹Ÿéµå¾ªäºŒå…«å®šå¾‹**ï¼š80%çš„ä¸šåŠ¡è®¿é—®é›†ä¸­åœ¨20%çš„æ•°æ®ä¸Šã€‚\n\næ·˜å®ä¹°å®¶æµè§ˆçš„å•†å“é›†ä¸­åœ¨å°‘éƒ¨åˆ†æˆäº¤æ•°å¤šã€è¯„ä»·è‰¯å¥½çš„å•†å“ä¸Šï¼›\n\nç™¾åº¦æœç´¢å…³é”®è¯é›†ä¸­åœ¨å°‘éƒ¨åˆ†çƒ­é—¨è¯æ±‡ä¸Šï¼›\n\nåªæœ‰ç»å¸¸ç™»å½•çš„ç”¨æˆ·æ‰ä¼šå‘å¾®åšã€çœ‹å¾®åšï¼Œè¿™éƒ¨åˆ†ç”¨æˆ·åªå æ€»ç”¨æˆ·æ•°çš„ä¸€å°éƒ¨åˆ†ã€‚\n\n\n\næŠŠæ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­å¯ä»¥å‡å°‘æ•°æ®åº“è®¿é—®çš„å‹åŠ›\n\n>   è¯»å¤šå†™å°‘çš„æƒ…å†µåº”è¯¥éƒ½å¯ä»¥å…ˆä½¿ç”¨ç¼“å­˜æ¥è§£å†³ï¼Œä¸ç®¡æ˜¯çƒ­é—¨ã€å†·é—¨æ•°æ®éƒ½å¯ä»¥ï¼Œé‡ç‚¹åº”è¯¥æ˜¯è¯»å¤šå†™å°‘ï¼Ÿ\n>\n>   è‹¥æ˜¯å†™å…¥æ“ä½œæ›´å¤šï¼Œé‡‡ç”¨ç¼“å­˜çš„æ–¹å¼éœ€è¦é¢‘ç¹çš„æ›´æ–°ç¼“å­˜ï¼Œå¦‚æœä¸šåŠ¡å¯¹äºä¸€è‡´æ€§æœ‰è¦æ±‚ï¼Œé‚£ä¹ˆéœ€è¦åœ¨æ›´æ–°ç¼“å­˜çš„æ–¹å¼ä¸Šåšæ–‡ç« ï¼Œè§£å†³ä¸€è‡´æ€§çš„é—®é¢˜ï¼›å†™å…¥æ“ä½œæœ€ç»ˆéƒ½æ˜¯è¦è½ç›˜çš„ï¼Œå³æœ€ç»ˆä¸€å®šéœ€è¦æ•°æ®åº“ï¼Œæ‰€ä»¥å®é™…ä¸ŠåŠ å…¥ç¼“å­˜å¹¶ä¸èƒ½å¾ˆå¥½çš„ç¼“è§£æ•°æ®åº“çš„å‹åŠ›ã€‚è¿™æ—¶å€™åº”è¯¥è¦è€ƒè™‘åˆ†åº“åˆ†è¡¨äº†ã€‚\n\nç¼“å­˜ä¹Ÿåˆ†ä¸¤ç§ï¼š\n\n-   åº”ç”¨æœåŠ¡å™¨ä¸Šçš„æœ¬åœ°ç¼“å­˜\n\n    è®¿é—®é€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯å†…å­˜å—é™ï¼Œè€Œä¸”ä¼šå‡ºç°åº”ç”¨ç¨‹åºäº‰ç”¨å†…å­˜çš„æƒ…å†µ\n\n-   åˆ†å¸ƒå¼ç¼“å­˜æœåŠ¡å™¨ä¸Šçš„è¿œç¨‹ç¼“å­˜\n\n    å¯ä»¥ä½¿ç”¨é›†ç¾¤çš„æ–¹å¼ï¼Œéƒ¨ç½²å¤§å†…å­˜çš„æœåŠ¡å™¨ä½œä¸ºä¸“é—¨çš„ç¼“å­˜æœåŠ¡å™¨ï¼Œç†è®ºä¸Šå¯ä»¥åšåˆ°ä¸å—å†…å­˜å®¹é‡é™åˆ¶çš„ç¼“å­˜æœåŠ¡\n\n![20220517143627635](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220517143627635.jpg)\n\nä½¿ç”¨ç¼“å­˜åï¼Œæ•°æ®è®¿é—®çš„å‹åŠ›å¾—åˆ°ç¼“è§£ï¼Œä½†æ˜¯å•ä¸€åº”ç”¨æœåŠ¡å™¨èƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚è¿æ¥æœ‰é™ï¼Œåœ¨è®¿é—®é«˜å³°æœŸï¼Œåº”ç”¨æœåŠ¡å™¨æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚\n\n\n\n###### ä½¿ç”¨åº”ç”¨æœåŠ¡å™¨é›†ç¾¤æ”¹å–„ç½‘ç«™çš„å¹¶å‘å¤„ç†èƒ½åŠ›\n\nå½“ä¸€å°æœåŠ¡å™¨çš„å¤„ç†èƒ½åŠ›ä¸è¶³æ—¶ï¼Œä¸è¦ä¼å›¾å»æ¢æ›´å¼ºå¤§çš„æœåŠ¡å™¨ï¼ˆå¯¹äºå¤§å‹ç½‘ç«™è€Œè¨€ï¼Œä¸ç®¡å¤šå¼ºå¤§çš„æœåŠ¡å™¨éƒ½ä¸èƒ½æ»¡è¶³ç½‘ç«™æŒç»­å¢é•¿çš„ä¸šåŠ¡éœ€æ±‚ï¼‰\n\næ›´æ°å½“çš„åšæ³•æ˜¯å¢åŠ æœåŠ¡å™¨çš„æ•°é‡æ¥åˆ†æ‹…å‹åŠ›\n\n![20220517144311935](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220517144311935.jpg)\n\né€šè¿‡è´Ÿè½½å‡è¡¡è°ƒåº¦æœåŠ¡å™¨ï¼Œå°†ç”¨æˆ·è¯·æ±‚åˆ†æ‘Šåˆ°å¤šå°æœåŠ¡å™¨ä¸Š\n\n>   å½“è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨ä¹Ÿæˆä¸ºç“¶é¢ˆçš„æ—¶å€™ï¼Œå°±éœ€è¦é€šè¿‡DNSç­‰è¿›è¡Œè´Ÿè½½å‡è¡¡äº†\n\n###### æ•°æ®åº“è¯»å†™åˆ†ç¦»\n\nä½¿ç”¨ç¼“å­˜ä¹‹åï¼Œå¤§éƒ¨åˆ†çš„æ•°æ®è¯»æ“ä½œå¯ä»¥ä¸é€šè¿‡æ•°æ®åº“å®Œæˆï¼Œä½†æ˜¯ä»æœ‰ä¸€éƒ¨åˆ†è¯»ï¼ˆç¼“å­˜æœªå‘½ä¸­ã€ç¼“å­˜è¿‡æœŸï¼‰å’Œå…¨éƒ¨çš„å†™æ“ä½œéœ€è¦è®¿é—®æ•°æ®åº“ï¼Œåœ¨ç½‘ç«™çš„ç”¨æˆ·è¾¾åˆ°ä¸€å®šè§„æ¨¡ä¹‹åï¼Œæ•°æ®åº“å› ä¸ºè´Ÿè½½å‹åŠ›è¿‡é«˜è€Œæˆä¸ºç½‘ç«™çš„ç“¶é¢ˆã€‚\n\nç›®å‰å¤§éƒ¨åˆ†çš„ä¸»æµæ•°æ®åº“éƒ½æä¾›ä¸»ä»çƒ­å¤‡åŠŸèƒ½ï¼Œé€šè¿‡é…ç½®ä¸¤å°æ•°æ®åº“ä¸»ä»å…³ç³»ï¼Œå¯ä»¥å°†ä¸€å°æ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„æ•°æ®æ›´æ–°åŒæ­¥åˆ°å¦ä¸€å°æœåŠ¡å™¨ä¸Šã€‚åˆ©ç”¨è¿™ä¸ªåŠŸèƒ½å¯ä»¥å®ç°æ•°æ®åº“è¯»å†™åˆ†ç¦»ã€‚\n\n![20220517145003753](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220517145003753.jpg)\n\nåº”ç”¨æœåŠ¡å™¨åœ¨å†™æ•°æ®çš„æ—¶å€™ï¼Œè®¿é—®ä¸»æ•°æ®åº“ï¼Œä¸»æ•°æ®åº“å°†æ•°æ®åŒæ­¥éƒ½ä»åº“ï¼Œåº”ç”¨æœåŠ¡å™¨ä»ä»åº“è¯»å–æ•°æ®ã€‚\n\n###### ä½¿ç”¨åå‘ä»£ç†å’ŒCDNåŠ é€Ÿç½‘ç«™å“åº”\n\nä¸åŒåœ°åŒºçš„ç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶ï¼Œé€Ÿåº¦å·®åˆ«è¿˜æ˜¯æŒºå¤§çš„ï¼Œä¸ºäº†æœ‰æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œéœ€è¦åŠ é€Ÿç½‘ç«™è®¿é—®é€Ÿåº¦ã€‚\n\nä¸»è¦æ‰‹æ®µæœ‰CDNå’Œåå‘ä»£ç†\n\nCDNå’Œåå‘ä»£ç†çš„åŸºæœ¬åŸç†éƒ½æ˜¯ç¼“å­˜ï¼ŒåŒºåˆ«åœ¨äºï¼š\n\n-   CDNï¼šéƒ¨ç½²åœ¨ç½‘ç»œæä¾›å•†çš„æœºæˆ¿ï¼Œç”¨æˆ·åœ¨è¯·æ±‚ç½‘ç«™æœåŠ¡æ—¶å¯ä»¥ä»è·ç¦»è‡ªå·±æœ€è¿‘çš„ç½‘ç»œæä¾›å•†æœºæˆ¿è·å–æ•°æ®\n-   åå‘ä»£ç†ï¼šéƒ¨ç½²åœ¨ç½‘ç«™çš„ä¸­å¿ƒæœºæˆ¿ï¼Œå½“ç”¨æˆ·è¯·æ±‚åˆ°è¾¾ä¸­å¿ƒæœºæˆ¿åï¼Œé¦–å…ˆè®¿é—®çš„æœåŠ¡å™¨æ˜¯åå‘ä»£ç†æœåŠ¡å™¨ï¼Œå¦‚æœåå‘ä»£ç†æœåŠ¡å™¨ä¸­ç¼“å­˜ç€ç”¨æˆ·è¯·æ±‚çš„èµ„æºï¼Œå°±å°†å…¶ç›´æ¥è¿”å›ç»™ç”¨æˆ·ã€‚\n\n![20220517145615846](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220517145615846.jpg)\n\nä½¿ç”¨CDNå’Œåå‘ä»£ç†çš„ç›®çš„åœ¨äºå°½æ—©å°†æ•°æ®è¿”å›ç»™ç”¨æˆ·ï¼ŒåŠ å¿«ç”¨æˆ·è®¿é—®é€Ÿåº¦ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å‡è½»åç«¯æœåŠ¡å™¨çš„å‹åŠ›ã€‚\n\n###### ä½¿ç”¨åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿå’Œåˆ†å¸ƒå¼æ•°æ®åº“ç³»ç»Ÿ\n\n**åˆ†å¸ƒå¼æ•°æ®åº“æ˜¯ç½‘ç«™æ•°æ®åº“æ‹†åˆ†çš„æœ€åæ‰‹æ®µï¼Œåªæœ‰åœ¨å•è¡¨æ•°æ®è§„æ¨¡éå¸¸åºå¤§çš„æ—¶å€™æ‰ä½¿ç”¨**\n\næ›´å¸¸ç”¨çš„æ‹†åˆ†æ‰‹æ®µæ˜¯ä¸šåŠ¡åˆ†åº“\n\n![20220517145932862](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220517145932862.jpg)\n\n###### ä½¿ç”¨NoSQLå’Œæœç´¢å¼•æ“\n\nç½‘ç«™ä¸šåŠ¡è¶Šæ¥è¶Šå¤æ‚ï¼Œå¯¹æ•°æ®å­˜å‚¨å’Œæ£€ç´¢ä¹Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œè¿™æ—¶å€™éœ€è¦é‡‡ç”¨éå…³ç³»å‹æ•°æ®åº“å’Œéæ•°æ®åº“æŸ¥è¯¢æŠ€æœ¯å¦‚æœç´¢å¼•æ“ï¼ˆå€’æ’ç´¢å¼•ï¼Œç©ºé—´æ¢æ—¶é—´ï¼‰ã€‚\n\n![20220608172046676](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220608172046676.jpg)\n\n###### ä¸šåŠ¡æ‹†åˆ†\n\nå¤§å‹ç½‘ç«™æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œé€šè¿‡åˆ†è€Œæ²»ä¹‹çš„æ‰‹æ®µå°†æ•´ä¸ªç½‘ç«™ä¸šåŠ¡åˆ†æˆä¸åŒçš„äº§å“çº¿ï¼Œåˆ†å½’ä¸åŒçš„å›¢é˜Ÿè´Ÿè´£\n\nå…·ä½“åˆ°æŠ€æœ¯ä¸Šï¼Œä¹Ÿä¼šæ ¹æ®äº§å“çº¿åˆ’åˆ†ï¼Œå°†ä¸€ä¸ªç½‘ç«™æ‹†åˆ†æˆè®¸å¤šä¸åŒçš„åº”ç”¨ï¼Œæ¯ä¸ªåº”ç”¨å•ç‹¬éƒ¨ç½²ç»´æŠ¤ã€‚\n\n-   é€šè¿‡ä¸€ä¸ªè¶…é“¾æ¥å»ºç«‹å…³ç³»ï¼ˆé¦–é¡µä¸Šçš„å¯¼èˆªé“¾æ¥æŒ‡å‘ä¸åŒçš„åœ°å€ï¼‰\n-   é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œæ•°æ®åˆ†å‘\n-   è®¿é—®åŒä¸€ä¸ªæ•°æ®å­˜å‚¨ç³»ç»Ÿæ¥æ„æˆä¸€ä¸ªå…³è”çš„å®Œæ•´ç³»ç»Ÿ\n\n>   è¿™éƒ¨åˆ†åŒä¸‹é¢è¯´çš„åˆ†å¸ƒå¼æœåŠ¡çš„åŒºåˆ«åœ¨äºï¼šä»…æŒ‰ä¸šåŠ¡æ‹†åˆ†ï¼ˆæ‹†åˆ†æˆä¸åŒçš„äº§å“çº¿å„è‡ªç‹¬ç«‹æ¥å¼€å‘ï¼‰ä¼šå‡ºç°è®¸å¤šçš„å†—ä½™ï¼Œå¯èƒ½æ¯ä¸ªç³»ç»Ÿéƒ½å†—ä½™å¼€å‘äº†ä¸€å¥—ç”¨æˆ·ç®¡ç†æ¨¡å—ï¼Œè€Œåˆ†å¸ƒå¼æœåŠ¡ç›®çš„å°±æ˜¯ä¸ºäº†å°†è¿™äº›å†—ä½™çš„ä¸šåŠ¡æŠ½å–å‡ºæ¥å•ç‹¬éƒ¨ç½²\n\n![20220608173451442](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220608173451442.jpg)\n\n###### åˆ†å¸ƒå¼æœåŠ¡\n\nä¸šåŠ¡æ‹†åˆ†å¯¼è‡´éƒ¨ç½²ç»´æŠ¤è¶Šæ¥è¶Šå›°éš¾ï¼Œä¸”å­˜åœ¨è®¸å¤šç›¸åŒçš„ä¸šåŠ¡æ“ä½œï¼Œå¦‚ç”¨æˆ·ç®¡ç†ã€å•†å“ç®¡ç†ç­‰ï¼Œå¯ä»¥å°†è¿™äº›å…±ç”¨çš„ä¸šåŠ¡æŠ½å–å‡ºæ¥ç‹¬ç«‹éƒ¨ç½²ã€‚\n\n##### ç½‘ç«™æ¶æ„è®¾è®¡è¯¯åŒº\n\n###### ä¼å›¾ç”¨æŠ€æœ¯è§£å†³æ‰€æœ‰é—®é¢˜\n\nå…¸å‹çš„ä¾‹å­å°±æ˜¯12306\n\nå®é™…ä¸Š12306å´©æºƒçš„åŸå› æœ€å¤§çš„é—®é¢˜è¿˜æ˜¯åœ¨äºå®ƒçš„ä¸šåŠ¡æ¶æ„ï¼Œ12306æ ¹æœ¬å°±ä¸åº”è¯¥ä»¥çª—å£å”®ç¥¨çš„æ¨¡å¼åœ¨ç½‘ä¸Šå”®ç¥¨ï¼ˆé›¶ç‚¹å¼€å§‹å‡ºå”®è‹¥å¹²å¤©åçš„è½¦ç¥¨ï¼‰ã€‚\n\nåæ¥çš„æ”¹è¿›å¯èƒ½æ›´å¤šçš„æ˜¯åœ¨ä¸šåŠ¡ä¸Šè¿›è¡Œè°ƒæ•´ï¼šå”®ç¥¨æ–¹å¼ä¸Šå¼•å…¥æ’é˜Ÿæœºåˆ¶ã€æ•´ç‚¹å”®ç¥¨è°ƒæ•´ä¸ºåˆ†æ—¶æ®µå”®ç¥¨\n\n\n\n#### å¤§å‹ç½‘ç«™æ¶æ„æ¨¡å¼\n\nå»ºç­‘å­¦ä¸­å¯¹äºæ¨¡å¼çš„å®šä¹‰ï¼š\n\n>   æè¿°äº†ä¸€ä¸ªåœ¨æˆ‘ä»¬å‘¨å›´ä¸æ–­é‡å¤å‘ç”Ÿçš„é—®é¢˜åŠé—®é¢˜è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒã€‚è¿™æ ·ï¼Œå°±èƒ½ä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨è¯¥æ–¹æ¡ˆè€Œä¸å¿…é‡å¤å·¥ä½œ\n\n![20220608175406653](images/posts-assets/å¤§å‹ç½‘ç«™æŠ€æœ¯æ¶æ„.assets/20220608175406653.jpg)\n\n##### ç½‘ç«™æ¶æ„æ¨¡å¼\n\n###### åˆ†å±‚\n\nåˆ†å±‚æ—¶æœ€å¸¸è§åœ°ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå°†ç³»ç»Ÿåœ¨`æ¨ªå‘`ç»´åº¦ä¸Šåˆ‡åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†è´Ÿè´£ä¸€éƒ¨åˆ†ç›¸å¯¹æ¯”è¾ƒ`å•ä¸€`çš„èŒè´£ï¼Œç„¶åé€šè¿‡ä¸Šå±‚å¯¹ä¸‹å±‚çš„`ä¾èµ–`å’Œ`è°ƒç”¨`ç»„æˆä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿã€‚\n\n| åº”ç”¨å±‚ | è´Ÿè´£å…·ä½“ä¸šåŠ¡å’Œè§†å›¾å±•ç¤ºï¼Œå¦‚ç½‘ç«™é¦–é¡µåŠæœç´¢è¾“å…¥å’Œç»“æœå±•ç¤º |\n| ------ | ------------------------------------------------------ |\n| æœåŠ¡å±‚ | ä¸ºåº”ç”¨å±‚æä¾›æœåŠ¡æ”¯æŒï¼Œå¦‚ç”¨æˆ·ç®¡ç†æœåŠ¡ï¼Œè´­ç‰©è½¦æœåŠ¡ç­‰     |\n| æ•°æ®å±‚ | æä¾›æ•°æ®å­˜å‚¨è®¿é—®æœåŠ¡ï¼Œå¦‚æ•°æ®åº“ã€ç¼“å­˜ã€æ–‡ä»¶ã€æœç´¢å¼•æ“ç­‰ |\n\n>   æ˜¯å¦å¯ä»¥è¿™æ ·ç†è§£ï¼Ÿ\n>\n>   åº”ç”¨å±‚ï¼šå¦‚å‰ç«¯æœåŠ¡ï¼ŒVueã€Reactç»„æˆçš„å‰ç«¯é¡¹ç›®æä¾›è§†å›¾å±•ç¤ºï¼Œå…·ä½“çš„æ•°æ®æ¥æºé€šè¿‡Ajaxè¯·æ±‚åç«¯è·å–ï¼Œä½œä¸ºå‰ç«¯é¡¹ç›®å³å¯å•ç‹¬éƒ¨ç½²\n>\n>   æœåŠ¡å±‚ï¼šå¦‚ä¸€ä¸ªJava-Springbooté¡¹ç›®ï¼Œå…·ä½“çš„åç«¯é€»è¾‘å¤„ç†å±‚ï¼Œæš´éœ²æ¥å£ä¾›å‰ç«¯è°ƒç”¨è·å–æ•°æ®\n>\n>   æ•°æ®å±‚ï¼šå¦‚MySQLã€Elasticsearchã€Redisç­‰æ•°æ®å­˜å‚¨æœåŠ¡ï¼Œåªåšæ•°æ®å­˜å‚¨çš„åŠŸèƒ½ï¼Œå…·ä½“æ•°æ®å¦‚ä½•ä½¿ç”¨äº¤ç»™æœåŠ¡å±‚è·å–åå¤„ç†\n\nåˆ†å±‚æ¶æ„ä¹Ÿæœ‰ä¸€äº›æŒ‘æˆ˜ï¼Œå°±æ˜¯å¿…é¡»åˆç†è§„åˆ’å±‚æ¬¡è¾¹ç•Œå’Œæ¥å£\n\n>   å‰åç«¯åˆ†ç¦»å¼€å‘ä¸­éœ€è¦å¯¹å‰åç«¯è”è°ƒçš„æ¥å£è¿›è¡Œäº‹å…ˆè§„åˆ’ï¼Œæ‰èƒ½æ›´å¥½çš„å¹¶è¡Œå¼€å‘\n\nå¼€å‘è¿‡ç¨‹ä¸­ä¸¥æ ¼éµå¾ªåˆ†å±‚æ¶æ„çš„çº¦æŸï¼Œç¦æ­¢è·¨å±‚æ¬¡è°ƒç”¨ä»¥åŠé€†å‘è°ƒç”¨\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["æ¶æ„è®¾è®¡"],"categories":["å•ƒä¹¦"]},{"title":"Gitæƒå¨æŒ‡å—","url":"/posts/ca74b95d/","content":"\n## Gitæƒå¨æŒ‡å—\n\n### ç¬¬4ç«  gitåˆå§‹åŒ–\n\n#### åˆ›å»ºç‰ˆæœ¬åº“åŠç¬¬ä¸€æ¬¡æäº¤\n\n1.   å‘Šè¯‰Gitå½“å‰ç”¨æˆ·çš„å§“åå’Œé‚®ä»¶åœ°å€ï¼Œé…ç½®çš„ç”¨æˆ·åå’Œé‚®ä»¶åœ°å€å°†åœ¨ç‰ˆæœ¬åº“æäº¤æ—¶ç”¨åˆ°\n\n     ```bash\n     git config --global user.name \"[ç”¨æˆ·å]\"\n     git config --global user.email \"[é‚®ä»¶åœ°å€]\"\n     ```\n\n2.   åˆå§‹åŒ–ä»“åº“\n\n     ```bash\n     mkdir demo\n     cd demo\n     git init\n     Initialized empty Git repository in D:/workspace/git/demo/.git/\n     ```\n\n     å¦‚æœGitç‰ˆæœ¬æ˜¯1.6.5ä»¥ä¸Šï¼Œå¯ä»¥åœ¨`git init`å‘½ä»¤åé¢è·Ÿä¸Šç›®å½•åç§°ï¼Œä¼šè‡ªåŠ¨å®Œæˆç›®å½•åˆ›å»º\n\n     ```bash\n     git init demo\n     Initialized empty Git repository in D:/workspace/git/demo/.git/\n     ```\n\nè‡³æ­¤ä»“åº“å³åˆ›å»ºæˆåŠŸ\n\nç°åœ¨åœ¨å·¥ä½œåŒºä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶welcome.txt\n\n```bash\necho \"Hello.\" > welcome.txt\n```\n\nå°†æ–°å»ºç«‹çš„æ–‡ä»¶æ·»åŠ åˆ°ç‰ˆæœ¬åº“\n\n```bash\ngit add welcome.txt\n```\n\n>   Gitå’Œå¤§éƒ¨åˆ†å…¶ä»–ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸€æ ·ï¼Œéƒ½éœ€è¦æ‰§è¡Œä¸€æ¬¡æäº¤æ“ä½œï¼Œå¯¹äºGitæ¥è¯´å°±æ˜¯æ‰§è¡Œ`git commit`å‘½ä»¤ã€‚\n>\n>   åœ¨æäº¤è¿‡ç¨‹ä¸­éœ€è¦è¾“å…¥æäº¤è¯´æ˜ï¼Œè¿™ä¸ªè¦æ±‚å¯¹Gitæ¥è¯´æ˜¯å¼ºåˆ¶æ€§çš„ï¼ˆä¸æ¥å—ç©ºç™½æäº¤è¯´æ˜ï¼‰ï¼Œå°±ç®—åœ¨æäº¤æ—¶ä¸åœ¨å‘½ä»¤è¡Œæä¾›ï¼ŒGitä¼šè‡ªåŠ¨æ‰“å¼€ä¸€ä¸ªç¼–è¾‘å™¨è¦æ±‚è¾“å…¥æäº¤è¯´æ˜çš„ã€‚\n\nä½¿ç”¨`-m`å‚æ•°ç›´æ¥ç»™å‡ºæäº¤è¯´æ˜\n\n```bash\ngit commit -m \"initialized.\"\n[master (root-commit) dbda1b1] initialized.\n 1 file changed, 1 insertion(+)\n create mode 100644 welcome.txt\n\n```\n\n-   é€šè¿‡`-m`å‚æ•°è®¾ç½®æäº¤è¯´æ˜\n-   å‘½ä»¤è¾“å‡ºæ˜¾ç¤ºæ­¤æ¬¡æäº¤åœ¨åä¸ºmasterçš„åˆ†æ”¯ä¸Šï¼Œä¸”æ˜¯è¯¥åˆ†æ”¯çš„ç¬¬ä¸€æ¬¡æäº¤ï¼ˆroot-commitï¼‰ï¼Œæäº¤IDæ˜¯dbda1b1ã€‚\n-   æ­¤æ¬¡æäº¤ä¿®æ”¹äº†ä¸€ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«ä¸€è¡Œæ’å…¥ï¼ˆæ–°å¢ï¼‰\n-   æ­¤æ¬¡æäº¤åˆ›å»ºäº†æ–°æ–‡ä»¶welcome.txt\n\nå¦‚æœä¹‹å‰æ²¡æœ‰è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±ï¼Œåˆ™ä¼šå‡ºç°å¦‚ä¸‹å†…å®¹ï¼š\n\n```bash\nAuthor identity unknown\n\n*** Please tell me who you are.\n\nRun\n\n  git config --global user.email \"you@example.com\"\n  git config --global user.name \"Your Name\"\n\nto set your account's default identity.\nOmit --global to set the identity only in this repository.\n\nfatal: unable to auto-detect email address (got 'User@8-sri0091.(none)')\n\n```\n\n#### æ€è€ƒï¼šä¸ºä»€ä¹ˆå·¥ä½œåŒºæ ¹ç›®å½•æœ‰ä¸€ä¸ª.gitç›®å½•\n\nåˆå§‹åŒ–ä»“åº“ä¹‹åï¼Œä¼šåœ¨æ ¹ç›®å½•å‡ºç°åä¸º`.git`çš„éšè—ç›®å½•\n\nWindowsç”¨æˆ·éœ€è¦é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¾ç½®åæ‰å¯ä»¥çœ‹åˆ°\n\n![20220516153036140](images/posts-assets/Gitæƒå¨æŒ‡å—.assets/20220516153036140.jpg)\n\nLinuxç”¨æˆ·é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯æŸ¥çœ‹\n\n```bash\nls -a\n./  ../  .git/\n\n```\n\nGitä»¥åŠå…¶ä»–åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿçš„ä¸€ä¸ªå…±åŒçš„æ˜¾è‘—ç‰¹ç‚¹æ˜¯ï¼Œç‰ˆæœ¬åº“ä½äºå·¥ä½œåŒºçš„æ ¹ç›®å½•ä¸‹ã€‚å¯¹Gitæ¥è¯´å°±æ˜¯`.git`ç›®å½•ï¼Œä¸”ä»…æ­¤ä¸€å¤„ï¼Œæ²¡æœ‰ä»»ä½•å…¶ä»–è·Ÿè¸ªæ–‡ä»¶æˆ–ç›®å½•äº†ã€‚\n\nä¼ ç»Ÿé›†ä¸­å¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿçš„ç‰ˆæœ¬åº“å’Œå·¥ä½œåŒºæ˜¯åˆ†å¼€çš„ï¼Œç”šè‡³æ˜¯åœ¨ä¸åŒçš„ä¸»æœºä¸Šï¼Œå› æ­¤å¿…é¡»å»ºç«‹å·¥ä½œåŒºå’Œç‰ˆæœ¬åº“çš„å¯¹åº”ã€‚\n\nGitå°†ç‰ˆæœ¬åº“ï¼ˆ`.git`ç›®å½•ï¼‰æ”¾åœ¨å·¥ä½œåŒºæ ¹ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆGitçš„ç›¸å…³æ“ä½œä¸€å®šè¦åœ¨å·¥ä½œåŒºæ ¹ç›®å½•ä¸‹æ‰§è¡Œå—ï¼Ÿæ¢å¥è¯è¯´ï¼Œå½“å·¥ä½œåŒºä¸­åŒ…å«å­ç›®å½•ï¼Œå¹¶åœ¨å­ç›®å½•ä¸­æ‰§è¡ŒGitå‘½ä»¤ï¼Œå¦‚ä½•å®šä½åˆ°ç‰ˆæœ¬åº“çš„ï¼Ÿ\n\nå®é™…ä¸Šï¼Œå½“åœ¨Gitå·¥ä½œåŒºçš„æŸä¸ªå­ç›®å½•ä¸‹æ‰§è¡Œæ“ä½œçš„æ—¶å€™ï¼Œä¼šåœ¨å·¥ä½œåŒºç›®å½•ä¸­ä¾æ¬¡å‘ä¸Šé€’å½’æŸ¥æ‰¾`.git`ç›®å½•ï¼Œæ‰¾åˆ°çš„`.git`ç›®å½•å°±æ˜¯å·¥ä½œåŒºå¯¹åº”çš„ç‰ˆæœ¬åº“äº†ã€‚\n\nä¾‹å¦‚åœ¨éGitå·¥ä½œåŒºæ‰§è¡Œ`git`å‘½ä»¤æ—¶ä¼šå› ä¸ºæ‰¾ä¸åˆ°`.git`ç›®å½•æŠ¥é”™\n\n```bash\ncd /d/workspace/git\ngit status\nfatal: not a git repository (or any of the parent directories): .git\n\n```\n\nä½¿ç”¨`strace`å‘½ä»¤å»è·Ÿè¸ªæ‰§è¡Œ`git status`å‘½ä»¤æ—¶çš„ç£ç›˜è®¿é—®ï¼Œå¯ä»¥çœ‹åˆ°æ²¿ç›®å½•ä¾æ¬¡å‘ä¸Šé€’å½’çš„è¿‡ç¨‹ã€‚\n\n```bash\nstrace -e 'trace=file' git status\n```\n\n\n\næ˜¾ç¤ºç‰ˆæœ¬åº“`.git`ç›®å½•æ‰€åœ¨ä½ç½®\n\n```bash\ngit rev-parse --git-dir\nD:/workspace/git/demo/.git\n\n```\n\næ˜¾ç¤ºå·¥ä½œåŒºæ ¹ç›®å½•\n\n```bash\ngit rev-parse --show-toplevel\nD:/workspace/git/demo\n\n```\n\nç›¸å¯¹äºå·¥ä½œåŒºæ ¹ç›®å½•çš„ç›¸å¯¹ç›®å½•\n\n```bash\ngit rev-parse --show-prefix\na/b/c/\n\n```\n\næ˜¾ç¤ºä»å½“å‰ç›®å½•åé€€åˆ°å·¥ä½œåŒºæ ¹ç›®å½•çš„æ·±åº¦\n\n```bash\ngit rev-parse --show-cdup\n../../../\n\n```\n\n#### æ€è€ƒï¼šgit configå‘½ä»¤çš„å„å‚æ•°åŒºåˆ«\n\nGitçš„é…ç½®æ–‡ä»¶åˆ†åˆ«æ˜¯ç‰ˆæœ¬åº“çº§åˆ«ã€å…¨å±€ï¼ˆç”¨æˆ·ä¸»ç›®å½•ä¸‹ï¼Œç”¨æˆ·çº§ï¼‰å’Œç³»ç»Ÿçº§åˆ«ã€‚\n\n`--global`ï¼šå…¨å±€çº§åˆ«\n\n`--system`ï¼šç³»ç»Ÿçº§åˆ«\n\n\n\n### ç¬¬5ç«  gitæš‚å­˜åŒº\n\n#### ä¿®æ”¹ä¸èƒ½ç›´æ¥æäº¤å—\n\né¦–å…ˆè¿›è¡Œæ–‡ä»¶è¿½åŠ \n\n```bash\necho \"Nice to meet you.\" >> welcome.txt\n```\n\n```bash\ngit diff\ndiff --git a/welcome.txt b/welcome.txt\nindex 18832d3..fd3c069 100644\n--- a/welcome.txt\n+++ b/welcome.txt\n@@ -1 +1,2 @@\n Hello.\n+Nice to meet you.\n\n```\n\néœ€è¦æ‰§è¡Œ`git add`å‘½ä»¤å°†æ–‡ä»¶ä¿®æ”¹æ·»åŠ åˆ°æš‚å­˜åŒºä¹‹åæ‰å¯ä»¥è¿›è¡Œæäº¤\n\nå¦‚æœç›´æ¥æ‰§è¡Œæäº¤æ“ä½œ\n\n```bash\ngit commit -m \"Append a nice line.\"\nOn branch master\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n        modified:   welcome.txt\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\n\n```\n\n\n\n#### ç†è§£Gitæš‚å­˜åŒºï¼ˆstageï¼‰\n\nåœ¨ç‰ˆæœ¬åº“`.git`ç›®å½•ä¸‹æœ‰ä¸€ä¸ªindexæ–‡ä»¶ï¼Œä¸‹é¢é’ˆå¯¹è¿™ä¸ªæ–‡ä»¶åšä¸€ä¸ªå®éªŒ\n\n1.   æ’¤é”€å·¥ä½œåŒºä¸­å¯¹welcome.txtæ–‡ä»¶å°šæœªæäº¤çš„æ›´æ”¹\n\n     ```bash\n     git checkout -- welcome.txt # æ’¤é”€å·¥ä½œåŒºä¸­å¯¹welcome.txtæ–‡ä»¶å°šæœªæäº¤çš„æ›´æ”¹\n     git status -s # å¦‚æœgitç‰ˆæœ¬å°äº1.7.3ï¼Œæ‰§è¡Œgit diff\n     ```\n\n     \n\n2.   æŸ¥çœ‹.git/indexæ–‡ä»¶\n\n     ```bash\n     ls --full-time .git/index\n     -rw-r--r-- 1 User 197121 145 2022-05-16 19:17:16.292820100 +0800 .git/index\n     \n     ```\n\n3.   å†æ¬¡æ‰§è¡Œ\n\n     ```bash\n     git status -s # å†æ¬¡æ‰§è¡Œ\n     ls --full-time .git/index\n     -rw-r--r-- 1 User 197121 145 2022-05-16 19:17:16.292820100 +0800 .git/index\n     \n     ```\n\n     å¯ä»¥çœ‹åˆ°æ—¶é—´æˆ³ä¸å˜\n\n4.   ç°åœ¨ä¿®æ”¹ä¸‹welcome.txtçš„æ—¶é—´æˆ³ï¼Œä½†æ˜¯ä¸æ”¹å˜å®ƒçš„å†…å®¹\n\n     ```bash\n     ls --full-time welcome.txt\n     -rw-r--r-- 1 User 197121 25 2022-05-16 19:18:32.223701400 +0800 welcome.txt\n     touch welcome.txt\n     ls --full-time welcome.txt # å¯ä»¥çœ‹åˆ°æ—¶é—´æˆ³æ›´æ–°äº†\n     -rw-r--r-- 1 User 197121 25 2022-05-16 19:24:35.298879700 +0800 welcome.txt\n     git status -s\n     ls --full-time .git/index # æ—¶é—´æˆ³æ›´æ–°äº†\n     -rw-r--r-- 1 User 197121 145 2022-05-16 19:25:20.322562900 +0800 .git/index\n     \n     ```\n\nå®éªŒè¯´æ˜`git status`å‘½ä»¤æ˜¯å…ˆæ ¹æ®.git/indexæ–‡ä»¶ä¸­è®°å½•çš„ï¼ˆç”¨äºè·Ÿè¸ªå·¥ä½œåŒºæ–‡ä»¶çš„ï¼‰æ—¶é—´æˆ³ã€é•¿åº¦ç­‰ä¿¡æ¯åˆ¤æ–­å·¥ä½œåŒºæ–‡ä»¶æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœå·¥ä½œåŒºæ–‡ä»¶çš„æ—¶é—´æˆ³æ”¹å˜äº†ï¼Œè¯´æ˜æ–‡ä»¶çš„å†…å®¹å¯èƒ½è¢«æ”¹å˜äº†ï¼Œéœ€è¦æ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶å†…å®¹è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœæ–‡ä»¶å†…å®¹æ²¡å˜ï¼Œåˆ™å°†è¯¥æ–‡ä»¶çš„æ–°æ—¶é—´æˆ³è®°å½•åˆ°.git/indexæ–‡ä»¶ä¸­ã€‚å› ä¸ºå¦‚æœè¦åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æ›´æ”¹ï¼Œä½¿ç”¨æ—¶é—´æˆ³ã€æ–‡ä»¶é•¿åº¦ç­‰ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒè¦æ¯”é€šè¿‡æ–‡ä»¶å†…å®¹æ¯”è¾ƒè¦å¿«å¾—å¤šï¼Œè¿™ä¹Ÿæ˜¯Gité«˜æ•ˆçš„åŸå› ä¹‹ä¸€ã€‚\n\næ–‡ä»¶.git/indexå®é™…å°±æ˜¯ä¸€ä¸ªåŒ…å«æ–‡ä»¶ç´¢å¼•çš„ç›®å½•æ•°ï¼Œè®°å½•äº†æ–‡ä»¶åå’Œæ–‡ä»¶çš„çŠ¶æ€ä¿¡æ¯ï¼ˆæ—¶é—´æˆ³å’Œæ–‡ä»¶é•¿åº¦ç­‰ï¼‰ã€‚æ–‡ä»¶å†…å®¹ä¿å­˜åœ¨.git/objectsç›®å½•ä¸­\n\n![20220516193323223](images/posts-assets/Gitæƒå¨æŒ‡å—.assets/20220516193323223.jpg)\n\n-   å·¦ä¾§ä¸ºå·¥ä½œåŒºï¼Œå³ä¾§ä¸ºç‰ˆæœ¬åº“ã€‚åœ¨ç‰ˆæœ¬åº“ä¸­æ ‡è®°ä¸ºindexçš„åŒºåŸŸæ˜¯æš‚å­˜åŒºï¼Œæ ‡è®°ä¸ºmasterçš„æ˜¯masteråˆ†æ”¯æ‰€ä»£è¡¨çš„ç›®å½•æ ‘ã€‚\n-   æ­¤æ—¶HEADå®é™…æ˜¯æŒ‡å‘masteråˆ†æ”¯çš„ä¸€ä¸ªâ€œæ¸¸æ ‡â€ï¼Œæ‰€ä»¥å›¾ç¤ºçš„å‘½ä»¤ä¸­å‡ºç°HEADçš„åœ°æ–¹å¯ä»¥ç”¨masteræ›¿æ¢ã€‚\n-   å›¾ä¸­çš„objectsä¸ºGitå¯¹è±¡åº“ï¼Œå®é™…ä½äº.git/objectsç›®å½•ä¸‹ã€‚\n-   å½“å¯¹å·¥ä½œåŒºä¿®æ”¹ï¼ˆæˆ–æ–°å¢ï¼‰çš„æ–‡ä»¶æ‰§è¡Œ`git add`å‘½ä»¤æ—¶ï¼Œæš‚å­˜åŒºçš„ç›®å½•æ ‘å°†è¢«æ›´æ–°ï¼ŒåŒæ—¶å·¥ä½œåŒºä¿®æ”¹ï¼ˆæˆ–æ–°å¢ï¼‰çš„æ–‡ä»¶å†…å®¹ä¼šè¢«å†™å…¥å¯¹è±¡åº“ä¸­çš„ä¸€ä¸ªæ–°çš„å¯¹è±¡ä¸­ï¼Œè€Œè¯¥å¯¹è±¡çš„IDè¢«è®°å½•åœ¨æš‚å­˜åŒºçš„æ–‡ä»¶ç´¢å¼•ä¸­ã€‚\n-   å½“æ‰§è¡Œ`git commit`æ—¶ï¼Œæš‚å­˜åŒºçš„ç›®å½•æ ‘ä¼šå†™åˆ°ç‰ˆæœ¬åº“ï¼ˆå¯¹è±¡åº“ï¼‰ä¸­ï¼Œmasteråˆ†æ”¯ä¼šåšç›¸åº”çš„æ›´æ–°ï¼Œå³masteræœ€æ–°æŒ‡å‘çš„ç›®å½•æ ‘å°±æ˜¯æäº¤æ—¶åŸæš‚å­˜åŒºçš„ç›®å½•æ ‘ã€‚\n-   å½“æ‰§è¡Œ`git reset HEAD`å‘½ä»¤æ—¶ï¼Œæš‚å­˜åŒºçš„ç›®å½•æ ‘ä¼šè¢«é‡å†™ï¼Œä¼šè¢«masteråˆ†æ”¯æŒ‡å‘çš„ç›®å½•æ ‘æ‰€æ›¿æ¢ï¼Œä½†æ˜¯å·¥ä½œåŒºä¸å—å½±å“ã€‚\n-   å½“æ‰§è¡Œ`git rm --cached <file>`å‘½ä»¤æ—¶ï¼Œä¼šç›´æ¥ä»æš‚å­˜åŒºåˆ é™¤æ–‡ä»¶ï¼Œå·¥ä½œåŒºä¸åšå‡ºæ”¹å˜ã€‚\n-   å½“æ‰§è¡Œ`git checkout .`æˆ–`git checkout -- <file>`å‘½ä»¤æ—¶ï¼Œä¼šç”¨æš‚å­˜åŒºå…¨éƒ¨æ–‡ä»¶æˆ–æŒ‡å®šæ–‡ä»¶æ›¿æ¢å·¥ä½œåŒºæ–‡ä»¶ã€‚è¿™ä¸ªæ“ä½œå¾ˆå±é™©ï¼Œä¼šæ¸…é™¤å·¥ä½œåŒºä¸­æœªæ·»åŠ åˆ°æš‚å­˜åŒºçš„æ”¹åŠ¨ã€‚\n-   å½“æ‰§è¡Œ`git checkout HEAD .`æˆ–`git checkout HEAD <file>`å‘½ä»¤æ—¶ï¼Œä¼šç”¨HEADæŒ‡å‘çš„masteråˆ†æ”¯ä¸­çš„å…¨éƒ¨æˆ–éƒ¨åˆ†æ–‡ä»¶æ›¿æ¢æš‚å­˜åŒºå’Œå·¥ä½œåŒºä¸­çš„æ–‡ä»¶ã€‚è¿™ä¸ªå‘½ä»¤æå…¶å±é™©ï¼Œå› ä¸ºä¸ä½†ä¼šæ¸…æ¥šå·¥ä½œåŒºä¸­æœªæäº¤çš„æ”¹åŠ¨ï¼Œä¹Ÿä¼šæ¸…é™¤æš‚å­˜åŒºä¸­æœªæäº¤çš„æ”¹åŠ¨ã€‚\n\næ —å­ï¼š\n\n```bash\ntouch new.txt # åˆ›å»ºæ–°æ–‡ä»¶\ngit status\nOn branch master\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n        new.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\n\ngit add new.txt # æ·»åŠ åˆ°æš‚å­˜åŒº\ngit status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n        new file:   new.txt\n\necho \"new line.\" >> new.txt # æ›´æ–°æ–‡ä»¶\ngit status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n        new file:   new.txt\n\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n        modified:   new.txt\n# æ­¤æ—¶å·¥ä½œåŒºä¸­æœ‰æ›´æ”¹æœªæäº¤ï¼ˆæ–°å¢æ•°æ®çš„æ›´æ”¹ï¼‰åˆ°æš‚å­˜åŒºï¼Œæš‚å­˜åŒºä¹Ÿæœ‰æ›´æ”¹æœªæäº¤ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰åˆ°ç‰ˆæœ¬åº“\ngit checkout -- new.txt\ngit status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n        new file:   new.txt\n# æ­¤æ—¶å·¥ä½œåŒºä¸­æœªæäº¤çš„ä¿®æ”¹å·²ç»è¢«æ¸…é™¤äº†\ncat new.txt\n# æŸ¥çœ‹new.txtçš„å†…å®¹ï¼Œæ²¡æœ‰å‘ç°æ–°å¢çš„æ•°æ®\n# é‡æ–°å°†æ–‡ä»¶æ›´æ”¹ï¼Œè¿™é‡Œå°±çœç•¥äº†\ngit reset HEAD\ngit status\nOn branch master\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n        new.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\n# å¯ä»¥çœ‹åˆ°æš‚å­˜åŒºæœªæäº¤çš„æ›´æ”¹è¢«æ¸…é™¤ï¼Œnew.txtå˜æˆäº†æœªè¿½è¸ªçŠ¶æ€äº†\n# å·¥ä½œåŒºä¸­çš„å†…å®¹ä¸å—å½±å“\ncat new.txt\nnew line.\n# é‡æ–°æ¢å¤ä¸‹çŠ¶æ€ï¼Œè¿™é‡Œçœç•¥äº†\ngit status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n        new file:   new.txt\n\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n        modified:   new.txt\n\ngit rm --cached new.txt\nerror: the following file has staged content different from both the\nfile and the HEAD:\n    new.txt\n(use -f to force removal)\n# æ­¤æ—¶ä¸‰ä¸ªåŒºåŸŸçš„çŠ¶æ€å‡ä¸åŒï¼Œæ‰€ä»¥ä¸å…è®¸æ­¤æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨-få‚æ•°å¼ºåˆ¶æ‰§è¡Œ\ngit rm --cached -f new.txt\ngit status\nOn branch master\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n        new.txt\n\nnothing added to commit but untracked files present (use \"git add\" to track)\n# æ­¤æ—¶æš‚å­˜åŒºä¸­æ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥new.txtå˜æˆäº†æœªè¿½è¸ªçŠ¶æ€ï¼Œå·¥ä½œåŒºä¸­æ–‡ä»¶ä¸å˜\n# æ¢å¤ä¸‹çŠ¶æ€ï¼Œè¿™é‡Œçœç•¥äº†\ngit status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n        new file:   new.txt\n\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n        modified:   new.txt\n\ngit commit -m \"add new.txt\" # å°†æ–°å¢çš„new.txtæäº¤åˆ°ç‰ˆæœ¬åº“\ngit status\nOn branch master\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n        modified:   new.txt\n# new.txtæ–°å¢æ•°æ®çš„æ›´æ–°è¿˜åœ¨å·¥ä½œåŒºä¸­\ngit add new.txt\necho \"new new line.\" >> new.txt\ngit status\nOn branch master\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n        modified:   new.txt\n\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n        modified:   new.txt\n\n git checkout master new.txt # æ­¤æ“ä½œå°†æ¸…ç©ºå·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„æ›´æ”¹\n git status\n On branch master\nnothing to commit, working tree clean\ncat new.txt\n# æœ€ç»ˆnew.txtä¸­æ²¡æœ‰å†…å®¹ï¼Œè¢«æ›¿æ¢æˆäº†ç‰ˆæœ¬åº“ä¸­çš„ç‰ˆæœ¬äº†\n```\n\n#### git diff\n\n**å·¥ä½œåŒºã€æš‚å­˜åŒºå’Œç‰ˆæœ¬åº“çš„ç›®å½•æ ‘æµè§ˆ**\n\nç›´è§‚åœ°æŸ¥çœ‹æš‚å­˜åŒºåŠHEADä¸­çš„ç›®å½•æ ‘ï¼Ÿ\n\nå¯¹äºHEADï¼ˆç‰ˆæœ¬åº“ä¸­å½“å‰æäº¤ï¼‰æŒ‡å‘çš„ç›®å½•æ ‘ï¼Œå¯ä»¥ä½¿ç”¨Gitåº•å±‚å‘½ä»¤`ls-tree`æŸ¥çœ‹\n\n```bash\ngit ls-tree -l HEAD\n100644 blob e69de29bb2d1d6434b8b29ae775ad8c2e48c5391       0    new.txt\n100644 blob fd3c069c1de4f4bc9b15940f490aeb48852f3c42      25    welcome.txt\n\n```\n\n-   `-l`å‚æ•°å¯ä»¥æ˜¾ç¤ºæ–‡ä»¶çš„å¤§å°\n\n`git ls-files`å‘½ä»¤å¯ä»¥æ˜¾ç¤ºæš‚å­˜åŒºç›®å½•æ ‘\n\n```bash\ngit ls-files -s\n100644 e69de29bb2d1d6434b8b29ae775ad8c2e48c5391 0       new.txt\n100644 9ac7e0760066ad8d06a0d952c4e1260e628551b4 0       welcome.txt\n\n```\n\nç¬¬ä¸‰åˆ—ä¸æ˜¯æ–‡ä»¶å¤§å°ï¼Œè€Œæ˜¯æ–‡ä»¶ç¼–å·\n\n\n\n**git diff**\n\n1.   å·¥ä½œåŒºä¸æš‚å­˜åŒºæ¯”è¾ƒ\n\n     ```bash\n     git diff\n     diff --git a/new.txt b/new.txt\n     index e69de29..2595e07 100644\n     --- a/new.txt\n     +++ b/new.txt\n     @@ -0,0 +1 @@\n     +new line.\n     \n     ```\n\n2.   æš‚å­˜åŒºå’ŒHEADæ¯”è¾ƒ\n\n     ```bash\n     git diff --cached\n     index fd3c069..9ac7e07 100644\n     --- a/welcome.txt\n     +++ b/welcome.txt\n     @@ -1,2 +1,3 @@\n      Hello.\n      Nice to meet you.\n     +Bye bye.\n     \n     ```\n\n3.   å·¥ä½œåŒºå’ŒHEADæ¯”è¾ƒ\n\n     ```bash\n     git diff HEAD\n     diff --git a/new.txt b/new.txt\n     index e69de29..2595e07 100644\n     --- a/new.txt\n     +++ b/new.txt\n     @@ -0,0 +1 @@\n     +new line.\n     diff --git a/welcome.txt b/welcome.txt\n     index fd3c069..9ac7e07 100644\n     --- a/welcome.txt\n     +++ b/welcome.txt\n     @@ -1,2 +1,3 @@\n      Hello.\n      Nice to meet you.\n     +Bye bye.\n     \n     ```\n\n### ç¬¬6ç«  gitå¯¹è±¡\n\n#### Gitå¯¹è±¡åº“\n\n```bash\ngit log -1 --pretty=raw\ncommit 86343253f0d44b3a002b11423c02587fd3040e07 # è¿™äº›æ•°å­—å®é™…ä¸Šæ˜¯SHA1å“ˆå¸Œå€¼ï¼Œè¿™æ˜¯æœ¬æ¬¡æäº¤çš„å”¯ä¸€æ ‡è¯†\ntree f341012ebeaf74262be6892be96ecce373a68ef3 # è¿™æ˜¯æœ¬æ¬¡æäº¤æ‰€å¯¹åº”çš„ç›®å½•æ ‘\nparent ca04d27bdf1a442d67c379fd5803f5b85c868bd5 # è¿™æ˜¯æœ¬æ¬¡æäº¤çš„çˆ¶æäº¤ï¼ˆä¸Šä¸€æ¬¡æäº¤ï¼‰\nauthor Crayon <614820984@qq.com> 1652703487 +0800\ncommitter Crayon <614820984@qq.com> 1652703487 +0800\n\n    add new.txt\n\n```\n\nç ”ç©¶Gitå¯¹è±¡IDå¯ä»¥ä½¿ç”¨`git cat-file`å‘½ä»¤\n\n```bash\ngit cat-file -t <ID> # æŸ¥çœ‹IDç±»å‹\ngit cat-file -p <ID> # æŸ¥çœ‹æ–‡ä»¶å†…å®¹\n```\n\n#### SHA1å“ˆå¸Œå€¼æ˜¯ä»€ä¹ˆ\n\nå“ˆå¸Œæ˜¯ä¸€ç§æ‘˜è¦ç®—æ³•ï¼ˆæ•£åˆ—ç®—æ³•ï¼‰ï¼Œå¯ä»¥å°†ä»»æ„é•¿åº¦çš„è¾“å…¥ç»è¿‡æ•£åˆ—è¿ç®—è½¬æ¢ä¸ºå›ºå®šé•¿åº¦çš„è¾“å‡ºã€‚\n\næ¯”è¾ƒè‘—åçš„æ‘˜è¦ç®—æ³•æœ‰MD5å’ŒSHA1\n\nLinuxä¸‹ä½¿ç”¨`sha1sum`å‘½ä»¤å¯ä»¥ç”Ÿæˆæ‘˜è¦\n\n```bash\nprintf Git | sha1sum\n5819778898df55e3a762f0c5728b457970d72cae *-\n\n```\n\næäº¤çš„SHA1å“ˆå¸Œå€¼æ˜¯å¦‚ä½•ç”Ÿæˆçš„\n\n-   æŸ¥çœ‹HEADå¯¹åº”çš„æäº¤å†…å®¹\n\n    ```bash\n    git cat-file commit HEAD\n    tree f341012ebeaf74262be6892be96ecce373a68ef3\n    parent ca04d27bdf1a442d67c379fd5803f5b85c868bd5\n    author Crayon <614820984@qq.com> 1652703487 +0800\n    committer Crayon <614820984@qq.com> 1652703487 +0800\n    \n    add new.txt\n    \n    ```\n\n-   æäº¤ä¿¡æ¯ä¸­æ€»å…±åŒ…å«ä¸ª210å­—ç¬¦\n\n    ```bash\n    git cat-file commit HEAD | wc -c\n    210\n    \n    ```\n\n-   åœ¨æäº¤ä¿¡æ¯çš„å‰é¢åŠ ä¸Šå†…å®¹commit 210\\<null>ï¼ˆ\\<null>ä¸ºç©ºå­—ç¬¦ï¼‰ï¼Œç„¶åæ‰§è¡ŒSHA1ç®—æ³•\n\n    ```bash\n    (printf \"commit 210\\000\"; git cat-file commit HEAD) | sha1sum\n    86343253f0d44b3a002b11423c02587fd3040e07 *-\n    \n    git rev-parse HEAD\n    86343253f0d44b3a002b11423c02587fd3040e07\n    \n    ```\n\næ–‡ä»¶å†…å®¹çš„SHA1å“ˆå¸Œå€¼æ˜¯å¦‚ä½•ç”Ÿæˆçš„\n\n-   æŸ¥çœ‹ç‰ˆæœ¬åº“ä¸­welcome.txtçš„å†…å®¹\n\n    ```bash\n    git cat-file blob HEAD:welcome.txt\n    Hello.\n    Nice to meet you.\n    \n    ```\n\n-   æ–‡ä»¶æ€»å…±åŒ…å«25å­—èŠ‚çš„å†…å®¹\n\n    ```bash\n    git cat-file blob HEAD:welcome.txt | wc -c\n    25\n    \n    ```\n\n-   åœ¨æ–‡ä»¶å†…å®¹çš„å‰é¢åŠ ä¸Šblob 25\\<null>ï¼Œç„¶åæ‰§è¡ŒSHA1ç®—æ³•\n\n    ```bash\n    (printf \"blob 25\\000\"; git cat-file blob HEAD:welcome.txt) | sha1sum\n    fd3c069c1de4f4bc9b15940f490aeb48852f3c42 *-\n    git rev-parse HEAD:welcome.txt\n    fd3c069c1de4f4bc9b15940f490aeb48852f3c42\n    \n    ```\n\n\n\n>   HEADä»£è¡¨ç‰ˆæœ¬åº“ä¸­æœ€è¿‘ä¸€æ¬¡æäº¤\n>\n>   ç¬¦å·`^`å¯ä»¥ç”¨äºæŒ‡ä»£çˆ¶æäº¤ã€‚ä¾‹å¦‚ï¼š\n>\n>   -   `HEAD^`ä»£è¡¨ç‰ˆæœ¬åº“ä¸­çš„ä¸Šä¸€æ¬¡æäº¤ï¼Œå³æœ€è¿‘ä¸€æ¬¡æäº¤çš„çˆ¶æäº¤\n>   -   `HEAD^^`åˆ™ä»£è¡¨`HEAD^`çš„çˆ¶æäº¤\n>\n>   å¯¹äºä¸€ä¸ªæäº¤æœ‰å¾ˆå¤šä¸ªçˆ¶æäº¤ï¼Œå¯ä»¥åœ¨ç¬¦å·`^`åé¢ç”¨æ•°å­—è¡¨ç¤ºç¬¬å‡ æ¬¡æäº¤ã€‚ä¾‹å¦‚ï¼š\n>\n>   -   `a573106^2`çš„å«ä¹‰æ˜¯æäº¤`a573106`çš„å¤šä¸ªçˆ¶æäº¤ä¸­çš„ç¬¬äºŒä¸ªçˆ¶æäº¤ï¼ˆæ—¥å¿—åˆ†æ”¯å›¾ä½“ç°åœ¨æ¨ªå‘ï¼‰ï¼ˆä¸æ˜¯ç¥–å…ˆæäº¤ï¼ï¼‰[ä¾‹å­](#8.2.multi-parent)\n>   -   `HEAD^1`ç›¸å½“äº`HEAD^`\n>\n>   ç¬¦å·`~<n>`ä¹Ÿå¯ä»¥ç”¨äºæŒ‡ä»£ç¥–å…ˆæäº¤ï¼ˆæ—¥å¿—åˆ†æ”¯å›¾ä½“ç°åœ¨çºµå‘ï¼‰ã€‚ä¾‹å¦‚ï¼š\n>\n>   `a573106~5`ç›¸å½“äº`a573106^^^^^`\n\n\n\n### ç¬¬7ç«  gité‡ç½®\n\nmasteråˆ†æ”¯åœ¨ç‰ˆæœ¬åº“çš„å¼•ç”¨ç›®å½•ï¼ˆ.git/refsï¼‰ä¸­ä½“ç°ä¸ºä¸€ä¸ªå¼•ç”¨æ–‡ä»¶`.git/refs/heads/master`ï¼Œå…¶å†…å®¹å°±æ˜¯åˆ†æ”¯ä¸­æœ€æ–°æäº¤çš„æäº¤ID\n\n```bash\ncat .git/refs/heads/master\n86343253f0d44b3a002b11423c02587fd3040e07\n\n```\n\n\n\næ·»åŠ æ–°æ–‡ä»¶ï¼ŒæŸ¥çœ‹ID\n\n```bash\ntouch new-commit.txt\ngit add new-commit.txt\ncat .git/refs/heads/master\n724d3845eb776ded300fedf37e8642b81c6f8b54\n\n```\n\nå¼•ç”¨`refs/heads/master`å°±åƒä¸€ä¸ªæ¸¸æ ‡ï¼Œåœ¨æœ‰æ–°çš„æäº¤çš„æ—¶å€™æŒ‡å‘äº†æ–°çš„æäº¤\n\n`git reset`å‘½ä»¤å¯ä»¥å°†â€œæ¸¸æ ‡â€æŒ‡å‘ä»»æ„ä¸€ä¸ªå­˜åœ¨çš„æäº¤ID\n\né‡ç½®ä¹‹åå¦‚æœæ²¡æœ‰è®°ä½æäº¤IDï¼Œé€šè¿‡æµè§ˆå†å²è®°å½•æ˜¯æ‰¾ä¸åˆ°çš„\n\n#### ç”¨reflogæŒ½æ•‘é”™è¯¯çš„é‡ç½®\n\nå¦‚æœæ²¡æœ‰é‡ç½®å‰masteråˆ†æ”¯æŒ‡å‘çš„æäº¤IDï¼Œæƒ³è¦é‡ç½®å›åŸæ¥çš„æäº¤ä¼¼ä¹æ˜¯ä¸€ä»¶éº»çƒ¦çš„äº‹ï¼ˆå»å¯¹è±¡åº“ä¸­ä¸€ä¸ªä¸€ä¸ªåœ°æ‰¾ï¼‰ã€‚\n\n`.git/logs`ç›®å½•ä¸‹æ—¥å¿—æ–‡ä»¶è®°å½•äº†åˆ†æ”¯å˜æ›´æƒ…å†µã€‚é»˜è®¤éè£¸ç‰ˆæœ¬åº“ï¼ˆå¸¦æœ‰å·¥ä½œåŒºï¼‰éƒ½æä¾›åˆ†æ”¯æ—¥å¿—åŠŸèƒ½ï¼Œè¿™æ˜¯å› ä¸ºå¸¦æœ‰å·¥ä½œåŒºçš„ç‰ˆæœ¬åº“éƒ½æœ‰å¦‚ä¸‹è®¾ç½®ï¼š\n\n```bash\ngit config core.logallrefupdates\ntrue\n\n```\n\næŸ¥çœ‹masteråˆ†æ”¯çš„æ—¥å¿—æ–‡ä»¶`.git/logs/refs/heads/master`ä¸­çš„å†…å®¹\n\n```bash\ntail -5 .git/logs/refs/heads/master\n86343253f0d44b3a002b11423c02587fd3040e07 33d9b1023f6be2ae49454973d071be2b28e1facb Crayon <614820984@qq.com> 1652790561 +0800    commit: new commit\n33d9b1023f6be2ae49454973d071be2b28e1facb 86343253f0d44b3a002b11423c02587fd3040e07 Crayon <614820984@qq.com> 1652790577 +0800    reset: moving to HEAD~1\n86343253f0d44b3a002b11423c02587fd3040e07 724d3845eb776ded300fedf37e8642b81c6f8b54 Crayon <614820984@qq.com> 1652790678 +0800    reset: moving to 724d3845eb776ded300fedf37e8642b81c6f8b54\n724d3845eb776ded300fedf37e8642b81c6f8b54 86343253f0d44b3a002b11423c02587fd3040e07 Crayon <614820984@qq.com> 1652790709 +0800    reset: moving to HEAD~1\n86343253f0d44b3a002b11423c02587fd3040e07 724d3845eb776ded300fedf37e8642b81c6f8b54 Crayon <614820984@qq.com> 1652790722 +0800    reset: moving to 724d3845eb776ded300fedf37e8642b81c6f8b54\n\n\n```\n\nç¬¬ä¸€åˆ—è¡¨ç¤ºåŸæŒ‡å‘ï¼Œç¬¬äºŒåˆ—è¡¨ç¤ºå˜æ›´åæŒ‡å‘ï¼Œæ–‡ä»¶æœ€åæ˜¯æœ€æ–°çš„è®°å½•\n\nGitæä¾›`git reflog`å‘½ä»¤\n\n```bash\ngit reflog show master | head -5 # head -5è¡¨ç¤ºå–å‰äº”è¡Œ\n724d384 HEAD@{0}: reset: moving to 724d3845eb776ded300fedf37e8642b81c6f8b54\n8634325 HEAD@{1}: reset: moving to HEAD~1\n724d384 HEAD@{2}: reset: moving to 724d3845eb776ded300fedf37e8642b81c6f8b54\n8634325 HEAD@{3}: reset: moving to HEAD~1\n33d9b10 HEAD@{4}: commit: new commit\n\n```\n\nä¸æ—¥å¿—æ–‡ä»¶ä¸åŒï¼Œè¿™é‡Œè¾“å‡ºçš„ç¬¬ä¸€è¡Œå³ä¸ºæœ€æ–°ç‰ˆæœ¬\n\n`git reflog`å‘½ä»¤åœ¨è¾“å‡ºä¸­æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿æ˜“è®°çš„è¡¨è¾¾å¼ï¼š\\<refname>@{\\<n>}\n\nè¿™ä¸ªè¡¨è¾¾å¼çš„å«ä¹‰æ˜¯å¼•ç”¨\\<refname>ä¹‹å‰ç¬¬\\<n>æ¬¡æ”¹å˜æ—¶çš„SHA1å“ˆå¸Œå€¼\n\n-   é‡ç½®masterä¸ºä¸¤æ¬¡æ”¹å˜ä¹‹å‰çš„å€¼\n\n    ```bash\n    git reset --hard master@{2}\n    ```\n\n    é‡ç½®åå°±èƒ½æˆåŠŸå›åˆ°è¢«æ’¤é”€çš„ç‰ˆæœ¬äº†\n\n#### æ·±å…¥äº†è§£`git reset`å‘½ä»¤\n\n`git reset`å‘½ä»¤æœ‰ä¸¤ç§ç”¨æ³•\n\n```bash\n$ git reset [-q] [<commit>] [--] <paths>...\n$ git reset [--soft | --mixed | --hard | --merge | --keep] [-q] [<commit>]\n```\n\n<span id=\"7.2.reset-default\">ä¸Šè¿°ä¸¤ç§ç”¨æ³•ä¸­ï¼Œå…¶ä¸­\\<commit>éƒ½æ˜¯å¯é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨å¼•ç”¨æˆ–æäº¤IDï¼Œå¦‚æœçœç•¥\\<commit>åˆ™ç›¸å½“äºä½¿ç”¨HEADçš„æŒ‡å‘ä½œä¸ºæäº¤IDã€‚</span>\n\nç¬¬ä¸€ç§ç”¨æ³•åœ¨å‘½ä»¤ä¸­åŒ…å«è·¯å¾„\\<paths>ï¼Œä¸ºäº†é¿å…å’Œæäº¤IDåŒåè€Œå‘ç”Ÿå†²çªï¼Œå¯ä»¥åœ¨\\<paths>å‰ç”¨ä¸¤ä¸ªè¿ç»­çš„`-`ä½œä¸ºåˆ†éš”ã€‚\n\n>   ç¬¬ä¸€ç§ç”¨æ³•ä¸ä¼šé‡ç½®å¼•ç”¨ï¼Œæ›´ä¸ä¼šæ”¹å˜å·¥ä½œåŒºï¼Œè€Œæ˜¯ç”¨æŒ‡å®šçš„æäº¤çŠ¶æ€ä¸‹çš„æ–‡ä»¶æ›¿æ¢æ‰æš‚å­˜åŒºä¸­çš„æ–‡ä»¶ã€‚\n>\n>   ä¾‹å­ï¼š\n>\n>   ```bash\n>   # å…ˆå¾€new.txtæ·»åŠ æ–°å†…å®¹\n>   echo \"new line.\" >> new.txt\n>   git add new.txt\n>   git status\n>   On branch master\n>   Changes to be committed:\n>     (use \"git restore --staged <file>...\" to unstage)\n>           modified:   new.txt\n>   \n>   git reset -- new.txt\n>   Unstaged changes after reset:\n>   M       new.txt\n>   \n>   git status\n>   On branch master\n>   Changes not staged for commit:\n>     (use \"git add <file>...\" to update what will be committed)\n>     (use \"git restore <file>...\" to discard changes in working directory)\n>           modified:   new.txt\n>   # å¯ä»¥çœ‹åˆ°åˆšåˆšçš„æäº¤è¢«æ’¤é”€äº†\n>   ```\n\nç¬¬äºŒç§ç”¨æ³•åˆ™ä¼šé‡ç½®å¼•ç”¨ï¼Œè€Œä¸”æ ¹æ®å‚æ•°çš„ä¸åŒå¯ä»¥å¯¹å·¥ä½œåŒºæˆ–æš‚å­˜åŒºè¿›è¡Œé‡ç½®\n\n![20220518160543182](images/posts-assets/Gitæƒå¨æŒ‡å—.assets/20220518160543182.jpg)\n\nå‘½ä»¤æ ¼å¼ï¼š`git reset [--soft | --mixed | --hard] [<commit>]`\n\n-   `--hard`å‚æ•°ï¼šä¼šæ‰§è¡Œä¸Šå›¾ä¸­çš„å…¨éƒ¨åŠ¨ä½œâ‘ ã€â‘¡ã€â‘¢ï¼Œå³ï¼š\n    1.   æ›¿æ¢å¼•ç”¨çš„æŒ‡å‘ã€‚å¼•ç”¨æŒ‡å‘æ–°çš„æäº¤IDã€‚\n    2.   æ›¿æ¢æš‚å­˜åŒºã€‚æ›¿æ¢åï¼Œæš‚å­˜åŒºçš„å†…å®¹å’Œå¼•ç”¨æŒ‡å‘çš„ç›®å½•æ ‘ä¸€è‡´ã€‚\n    3.   æ›¿æ¢å·¥ä½œåŒºã€‚æ›¿æ¢åï¼Œå·¥ä½œåŒºçš„å†…å®¹å˜å¾—å’Œæš‚å­˜åŒºä¸€è‡´ï¼Œä¹Ÿå’ŒHEADæ‰€æŒ‡å‘çš„ç›®å½•æ ‘ä¸€è‡´ã€‚\n-   `--soft`å‚æ•°ï¼šä¼šæ‰§è¡ŒåŠ¨ä½œâ‘ ã€‚å³åªæ›´æ”¹å¼•ç”¨çš„æŒ‡å‘ï¼Œä¸æ”¹å˜æš‚å­˜åŒºå’Œå·¥ä½œåŒºã€‚\n-   `--mixed`å‚æ•°æˆ–ä¸åŠ å‚æ•°ï¼ˆé»˜è®¤`--mixed`ï¼‰ï¼šä¼šæ‰§è¡ŒåŠ¨ä½œâ‘ ã€â‘¡ã€‚å³æ›´æ”¹å¼•ç”¨çš„æŒ‡å‘å¹¶é‡ç½®æš‚å­˜åŒºï¼Œä½†æ˜¯ä¸æ”¹å˜å·¥ä½œåŒºã€‚\n\nä¾‹å­ï¼š\n\n-   `git reset`ï¼ˆåŒ`git reset HEAD`ï¼‰\n\n    ç”¨HEADæŒ‡å‘çš„ç›®å½•æ ‘é‡ç½®æš‚å­˜åŒºï¼Œå·¥ä½œåŒºä¸ä¼šå—åˆ°å½±å“ã€‚\n\n    >   ç›¸å½“äºå°†ä¹‹å‰ç”¨`git add`å‘½ä»¤æ·»åŠ åˆ°æš‚å­˜åŒºçš„å†…å®¹æ’¤å‡º\n\n-   `git reset --soft HEAD^`\n\n    å·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸åšæ”¹å˜ï¼Œä½†æ˜¯å¼•ç”¨å›é€€ä¸€æ¬¡ã€‚å½“å¯¹æœ€æ–°æäº¤çš„æäº¤è¯´æ˜æˆ–æäº¤æ›´æ”¹ä¸æ»¡æ„çš„æ—¶å€™ï¼Œæ’¤é”€æœ€æ–°çš„æäº¤ä»¥ä¾¿é‡æ–°æäº¤ã€‚\n\n    >   `git commit --amend`ç”¨äºå¯¹æœ€æ–°çš„æäº¤è¿›è¡Œé‡æ–°æäº¤ä»¥ä¿®è¡¥é”™è¯¯çš„æäº¤è¯´æ˜æˆ–æäº¤æ–‡ä»¶ã€‚\n    >\n    >   ç›¸å½“äºæ‰§è¡Œäº†ä¸‹é¢ä¸¤æ¡å‘½ä»¤\n    >\n    >   ```bash\n    >   git reset --soft HEAD^\n    >   git commit -e -F .git/COMMIT_EDITMSG # .git/COMMIT_EDITMSGä¿å­˜äº†ä¸Šæ¬¡çš„æäº¤æ—¥å¿—\n    >   ```\n\n-   `git reset HEAD^`åŒï¼ˆ`git reset --mixed HEAD^`ï¼‰\n\n    å·¥ä½œåŒºä¸å˜ï¼Œå°†æš‚å­˜åŒºå’Œå¼•ç”¨å›é€€ä¸€æ¬¡\n\n-   `git reset --hard HEAD^`\n\n    å½»åº•æ’¤é”€æœ€è¿‘çš„æäº¤ã€‚å·¥ä½œåŒºã€æš‚å­˜åŒºã€å¼•ç”¨å…¨éƒ¨å›é€€ã€‚\n\n### ç¬¬8ç«  gitæ£€å‡º\n\né‡ç½®å‘½ä»¤çš„ä¸€ä¸ªç”¨é€”å°±æ˜¯ä¿®æ”¹å¼•ç”¨çš„æ¸¸æ ‡æŒ‡å‘ã€‚\n\n~~é‡ç½®å‘½ä»¤æ²¡æœ‰ä½¿ç”¨ä»»ä½•å‚æ•°å¯¹æ‰€è¦é‡ç½®çš„åˆ†æ”¯åè¿›è¡Œè®¾ç½®ï¼Œè¿™æ˜¯å› ä¸ºé‡ç½®å‘½ä»¤é’ˆå¯¹çš„æ˜¯å¤´æŒ‡é’ˆ`HEAD`ã€‚~~\n\né‡ç½®å‘½ä»¤æ²¡æœ‰æ”¹å˜å¤´æŒ‡é’ˆ`HEAD`çš„å†…å®¹æ˜¯å› ä¸ºHEADæŒ‡å‘äº†ä¸€ä¸ªå¼•ç”¨`rerf/heads/master`ï¼Œæ‰€ä»¥é‡ç½®å‘½ä»¤ä½“ç°ä¸ºåˆ†æ”¯â€œæ¸¸æ ‡â€çš„å˜æ›´ï¼Œ`HEAD`æœ¬èº«ä¸€ç›´æŒ‡å‘çš„æ˜¯`refs/heads/master`ï¼Œå¹¶æ²¡æœ‰åœ¨é‡ç½®æ—¶æ”¹å˜ã€‚\n\n#### HEADçš„é‡ç½®å³æ£€å‡º\n\n`HEAD`å¯ä»¥ç†è§£ä¸ºâ€œå¤´æŒ‡é’ˆâ€ï¼Œæ˜¯å½“å‰å·¥ä½œåŒºçš„â€œåŸºç¡€ç‰ˆæœ¬â€ï¼Œå½“æ‰§è¡Œæäº¤æ—¶ï¼Œå°†æŒ‡å‘æœ€æ–°çš„æäº¤\n\næŸ¥çœ‹å½“å‰`HEAD`çš„æŒ‡å‘\n\n```bash\n$ cat .git/HEAD\nref: refs/heads/master\n$ git branch -v\n* master 8634325 add new.txt\n```\n\nç”¨`git checkout`å‘½ä»¤æ£€å‡ºè¯¥IDçš„çˆ¶æäº¤\n\n```bash\n$ git checkout 8634325^\nNote: switching to '8634325^'.\n\nYou are in 'detached HEAD' state. You can look around, make experimental\nchanges and commit them, and you can discard any commits you make in this\nstate without impacting any branches by switching back to a branch.\n\nIf you want to create a new branch to retain commits you create, you may\ndo so (now or later) by using -c with the switch command. Example:\n\n  git switch -c <new-branch-name>\n\nOr undo this operation with:\n\n  git switch -\n\nTurn off this advice by setting config variable advice.detachedHead to false\n\nHEAD is now at ca04d27 Append a nice line.\n\n```\n\nå‡ºç°å¤§æ®µçš„è¾“å‡ºï¼Œæ„æ€å°±æ˜¯ç°åœ¨å¤„äºâ€œåˆ†ç¦»å¤´æŒ‡é’ˆâ€çš„çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹æ‰§è¡Œå¦ä¸€ä¸ª`checkout`å‘½ä»¤æ£€å‡ºåˆ™ä¼šä¸¢å¼ƒåœ¨æ­¤çŠ¶æ€ä¸‹çš„ä¿®æ”¹å’Œæäº¤ï¼Œå¦‚æœæƒ³è¦ä¿ç•™æ­¤çŠ¶æ€ä¸‹çš„ä¿®æ”¹å’Œæäº¤ï¼Œä½¿ç”¨`-b`å‚æ•°è°ƒç”¨`checkout`å‘½ä»¤æ¥åˆ›å»ºæ–°çš„è·Ÿè¸ªåˆ†æ”¯ï¼Œå¦‚ï¼š\n\n`git checkout -b new_branch_name`\n\n\n\næŸ¥çœ‹`HEAD`çš„å†…å®¹å¯ä»¥å‘ç°å¤´æŒ‡é’ˆæŒ‡å‘äº†ä¸€ä¸ªå…·ä½“çš„æäº¤\n\n```bash\n$ cat .git/HEAD\nca04d27bdf1a442d67c379fd5803f5b85c868bd5\n```\n\nä½¿ç”¨`reflog`å‘½ä»¤ä¹Ÿå¯ä»¥çœ‹åˆ°å¤´æŒ‡é’ˆè¢«æ›´æ”¹äº†\n\n```bash\n$ git reflog -1\nca04d27 (HEAD) HEAD@{0}: checkout: moving from master to 8634325^\n```\n\n>   `reflog`çš„å†…å®¹æ˜¯`HEAD`å¤´æŒ‡é’ˆçš„å˜è¿è®°å½•ï¼Œè€Œä¸æ˜¯`master`åˆ†æ”¯\n\n```bash\n$ git rev-parse HEAD master\nca04d27bdf1a442d67c379fd5803f5b85c868bd5\n86343253f0d44b3a002b11423c02587fd3040e07\n```\n\nå¯ä»¥çœ‹åˆ°`HEAD`å’Œ`master`æŒ‡å‘ä¸åŒçš„æäº¤\n\n`checkout`å’Œ`reset`å‘½ä»¤ä¸åŒï¼Œåˆ†æ”¯ï¼ˆ`master`ï¼‰çš„æŒ‡å‘æ²¡æœ‰æ”¹å˜ï¼Œè¿˜æ˜¯æŒ‡å‘çš„åŸæœ‰æäº¤çš„ID\n\nè¯•ç€åšä¸€æ¬¡æ›´æ”¹ï¼Œå¹¶åŠ å…¥åˆ°æš‚å­˜åŒº\n\n```bash\n$ touch detached-commit.txt\n$ git add detached-commit.txt\n$ git status\nHEAD detached at ca04d27\nChanges to be committed:\n  (use \"git restore --staged <file>...\" to unstage)\n        new file:   detached-commit.txt\n```\n\næ‰§è¡Œæäº¤å¹¶æŸ¥çœ‹å¤´æŒ‡é’ˆæŒ‡å‘\n\n```bash\n$  git commit -m \"commit in detached HEAD mode\"\n[detached HEAD ccedb9c] commit in detached HEAD mode\n 1 file changed, 0 insertions(+), 0 deletions(-)\n create mode 100644 detached-commit.txt\n \n $ cat .git/HEAD\nccedb9c816bd52920c9ba001c04067c935363f83\n```\n\nå¤´æŒ‡é’ˆæŒ‡å‘æœ€æ–°çš„æäº¤\n\næŸ¥çœ‹æ—¥å¿—ä¹Ÿå¯ä»¥å‘ç°æ–°çš„æäº¤å»ºç«‹åœ¨ä¹‹å‰çš„æäº¤åŸºç¡€ä¹‹ä¸Š\n\n```bash\n$ git log --graph --oneline\n* ccedb9c (HEAD) commit in detached HEAD mode\n* ca04d27 Append a nice line.\n* 6e314b7 empty commit\n* dbda1b1 initialized.\n```\n\n>   è®°ä¸‹æ–°çš„æäº¤IDï¼ˆccedb9cï¼‰\n\nä»¥`master`åˆ†æ”¯åä½œä¸ºå‚æ•°æ‰§è¡Œ`checkout`å‘½ä»¤å°†åˆ†æ”¯åˆ‡æ¢åˆ°`master`ä¸Š\n\n```bash\n$ git checkout master\nWarning: you are leaving 1 commit behind, not connected to\nany of your branches:\n\n  ccedb9c commit in detached HEAD mode\n\nIf you want to keep it by creating a new branch, this may be a good time\nto do so with:\n\n git branch <new-branch-name> ccedb9c\n\nSwitched to branch 'master'\n\n```\n\né€šè¿‡æ—¥å¿—å·²ç»çœ‹ä¸åˆ°ä¹‹å‰çš„æäº¤äº†ï¼Œä½†æ˜¯ä»ç„¶å­˜åœ¨äºå¯¹è±¡åº“ä¸­ï¼ˆä½†æ˜¯å› ä¸ºè¿™ä¸ªæäº¤æ²¡æœ‰è¢«ä»»ä½•åˆ†æ”¯è·Ÿè¸ªåˆ°ï¼Œæ‰€ä»¥ä¸ä¿è¯è¿™ä¸ªæäº¤ä¼šæ°¸ä¹…å­˜åœ¨ï¼‰\n\n```bash\n$ git log --graph --pretty=oneline\n* 86343253f0d44b3a002b11423c02587fd3040e07 (HEAD -> master) add new.txt\n* ca04d27bdf1a442d67c379fd5803f5b85c868bd5 Append a nice line.\n* 6e314b7f5526662dd54dc3c7e2058010557ccb5b empty commit\n* dbda1b1f8b84a477531578bd15917da5686ee8f2 initialized.\n```\n\n#### æŒ½æ•‘åˆ†ç¦»å¤´æŒ‡é’ˆ\n\nåˆšæ‰åˆ†ç¦»å¤´æŒ‡é’ˆçŠ¶æ€ä¸‹çš„æäº¤åªèƒ½é€šè¿‡æäº¤IDè®¿é—®åˆ°ï¼Œå¦‚æœä½¿ç”¨`reset`è™½ç„¶å¯ä»¥å°†`master`åˆ†æ”¯é‡ç½®åˆ°è¯¥æäº¤ï¼Œä½†æ˜¯å°±ä¼šä¸¢åˆ°å½“å‰`master`çš„æœ€æ–°æäº¤ï¼ˆ`reset`å‘½ä»¤ä½“ç°å‡ºæ¥çš„å°±æ˜¯åˆ†æ”¯æ¸¸æ ‡çš„æ”¹å˜ï¼‰\n\nè¿™ä¸ªæ—¶å€™éœ€è¦ä½¿ç”¨`merge`ï¼ˆåˆå¹¶ï¼‰æ“ä½œ\n\nå°†`ccedb9c`è¿™ä¸ªæäº¤åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ä¸Š\n\n```bash\n$ git merge ccedb9c\nMerge made by the 'ort' strategy.\n detached-commit.txt | 0\n 1 file changed, 0 insertions(+), 0 deletions(-)\n create mode 100644 detached-commit.txt\n\n```\n\næŸ¥çœ‹æ—¥å¿—å¯ä»¥çœ‹åˆ°ä¸ä¸€æ ·çš„åˆ†æ”¯å›¾\n\n```bash\n$ git log --graph --oneline\n*   b06ad0b (HEAD -> master) Merge commit 'ccedb9c'\n|\\\n| * ccedb9c commit in detached HEAD mode\n* | 8634325 add new.txt\n|/\n* ca04d27 Append a nice line.\n* 6e314b7 empty commit\n* dbda1b1 initialized.\n\n```\n\næŸ¥çœ‹æœ€æ–°æäº¤çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°è¯¥æäº¤æœ‰<span id=\"8.2.multi-parent\">ä¸¤ä¸ªçˆ¶æäº¤</span>\n\n```bash\n$ git cat-file -p HEAD\ntree d8102c804d8cbf350b31dc6a38fe384ed5586559\nparent 86343253f0d44b3a002b11423c02587fd3040e07\nparent ccedb9c816bd52920c9ba001c04067c935363f83\nauthor Crayon <614820984@qq.com> 1655277888 +0800\ncommitter Crayon <614820984@qq.com> 1655277888 +0800\n\nMerge commit 'ccedb9c'\n\n```\n\n#### æ·±å…¥äº†è§£`git checkout`å‘½ä»¤\n\nä¸‰ç§ç”¨æ³•\n\n```bash\n$ git checkout [-q] [<commit>] [--] <paths>...\n$ git checkout [<branch>]\n$ git checkout [-m] [[-b|--orphan] <new_branch>] [<start_point>]\n```\n\nç¬¬ä¸€ç§ç”¨æ³•çš„`--`ä¸»è¦æ˜¯ç”¨æ¥é¿å…å¼•ç”¨å’Œè·¯å¾„åŒåå‘ç”Ÿå†²çª\n\n-   ç¬¬ä¸€ç§ç”¨æ³•çš„\\<commit>æ˜¯å¯é€‰é¡¹ï¼Œå¦‚æœçœç•¥åˆ™ç›¸å½“äºä»æš‚å­˜åŒºè¿›è¡Œæ£€å‡ºï¼Œè¿™å’Œ[é‡ç½®å‘½ä»¤](#7.2.reset-default)ä¸åŒï¼ˆé‡ç½®é»˜è®¤å€¼æ˜¯`HEAD`ï¼‰\n\n    é‡ç½®ä¸€èˆ¬ç”¨äºé‡ç½®æš‚å­˜åŒºï¼ˆé™¤éä½¿ç”¨`--hard`å‚æ•°ï¼Œå¦åˆ™ä¸é‡ç½®å·¥ä½œåŒºï¼‰ï¼Œè€Œæ£€å‡ºå‘½ä»¤ä¸»è¦æ˜¯è¦†ç›–å·¥ä½œåŒºï¼ˆå¦‚æœ\\<commit>ä¸çœç•¥ï¼Œä¹Ÿä¼šæ›¿æ¢æš‚å­˜åŒºä¸­çš„ç›¸åº”æ–‡ä»¶ï¼‰\n\n-   ç¬¬ä¸€ç§ç”¨æ³•ï¼ˆåŒ…å«\\<paths>çš„ç”¨æ³•ï¼‰ä¸ä¼šæ”¹å˜`HEAD`å¤´æŒ‡é’ˆï¼Œä¸»è¦ç”¨äºæŒ‡å®šç‰ˆæœ¬çš„æ–‡ä»¶è¦†ç›–å·¥ä½œåŒºä¸­å¯¹åº”çš„æ–‡ä»¶ã€‚å¦‚æœçœç•¥\\<commit>ï¼Œåˆ™ä¼šç”¨æš‚å­˜åŒºä¸­çš„æ–‡ä»¶è¦†ç›–å·¥ä½œåŒºçš„æ–‡ä»¶ï¼Œå¦åˆ™ç”¨æŒ‡å®šæäº¤ä¸­çš„æ–‡ä»¶è¦†ç›–æš‚å­˜åŒºå’Œå·¥ä½œåŒºä¸­å¯¹åº”çš„æ–‡ä»¶\n\n    ```bash\n    # æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ä¸‹çš„æ–‡ä»¶å†…å®¹\n    $ cat welcome.txt\n    Hello.\n    Nice to meet you.\n    \n    # è¿½åŠ ä¸€è¡Œï¼Œå¹¶æ·»åŠ åˆ°æš‚å­˜åŒº\n    $ echo 'new line.' >> welcome.txt\n    $ git add welcome.txt\n    \n    # å†æ¬¡è¿½åŠ ä¸€è¡Œå†…å®¹\n    $ echo 'new new line.' >> welcome.txt\n    \n    # æ­¤æ—¶çš„æ–‡ä»¶å†…å®¹\n    $ cat welcome.txt\n    Hello.\n    Nice to meet you.\n    new line.\n    new new line.\n    \n    # é€šè¿‡ä½¿ç”¨æš‚å­˜åŒºæ–‡ä»¶å†…å®¹è¦†ç›–å·¥ä½œåŒºæ–‡ä»¶å†…å®¹å®ç°æ’¤é”€ä¿®æ”¹çš„ç›®çš„\n    $ git checkout -- welcome.txt\n    \n    # æ­¤æ—¶çš„æ–‡ä»¶å†…å®¹\n    $ cat welcome.txt\n    Hello.\n    Nice to meet you.\n    new line.\n    \n    # å°†ä¿®æ”¹æäº¤\n    $ git commit -m \"append new line to welcome.txt\"\n    \n    # è¿½åŠ ä¸€è¡Œå¹¶æ·»åŠ åˆ°æš‚å­˜åŒº\n    $ echo 'new new line.' >> welcome.txt\n    $ git add welcome.txt\n    \n    # ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„æ–‡ä»¶å†…å®¹è¦†ç›–å½“å‰å·¥ä½œåŒºä¸æš‚å­˜åŒºä¸­çš„æ–‡ä»¶å†…å®¹å®ç°å•ä¸ªæ–‡ä»¶ç‰ˆæœ¬å›é€€çš„æ•ˆæœ\n    $ git checkout 095d003 -- welcome.txt\n    \n    $ git status\n    On branch master\n    nothing to commit, working tree clean\n    \n    $ cat welcome.txt\n    Hello.\n    Nice to meet you.\n    new line.\n    \n    # å¯ä»¥çœ‹åˆ°æš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„å†…å®¹éƒ½è¢«æ¸…ç©º\n    # è‹¥æ˜¯å·²ç»æäº¤çš„æ›´æ”¹çš„æƒ…å†µ\n    $ echo 'new new line.' >> welcome.txt\n    $ git add welcome.txt\n    $ git commit -m \"append new new line to welcome.txt\"\n    [master 7402a4e] append new new line to welcome.txt\n     1 file changed, 1 insertion(+)\n    \n    $ git checkout 095d003 -- welcome.txt\n    # å·¥ä½œåŒºå›é€€\n    $ cat welcome.txt\n    Hello.\n    Nice to meet you.\n    new line.\n    # æš‚å­˜åŒºç”Ÿæˆæ–°çš„æš‚å­˜æ–‡ä»¶ä¿¡æ¯ï¼Œéšæ—¶å¯ä»¥æäº¤ä¿®æ”¹\n    $ git status\n    On branch master\n    Changes to be committed:\n      (use \"git restore --staged <file>...\" to unstage)\n            modified:   welcome.txt\n    \n    ```\n\n-   ç¬¬äºŒç§ç”¨æ³•åˆ™ä¼šæ”¹å˜`HEAD`å¤´æŒ‡é’ˆã€‚\\<branch>æŒ‡ä»£åˆ‡æ¢åˆ°å“ªä¸ªåˆ†æ”¯ï¼Œå¦‚æœä¸æŒ‡å®šåˆ†æ”¯ååˆ™ä¼šè¿›å…¥â€œåˆ†ç¦»å¤´æŒ‡é’ˆâ€çš„çŠ¶æ€\n\n-   ç¬¬ä¸‰ç§ç”¨æ³•ä¸»è¦ç”¨æ¥åˆ›å»ºå’Œåˆ‡æ¢åˆ°æ–°åˆ†æ”¯ï¼ˆ\\<new_branch>ï¼‰ï¼Œæ–°çš„åˆ†æ”¯ä»\\<start_point>æŒ‡å®šçš„æäº¤å¼€å§‹åˆ›å»º\n\n    ```bash\n    # é€šè¿‡æ—¥å¿—æŸ¥åˆ°ç¥–å…ˆæäº¤çš„ID\n    $ git log --graph --oneline\n    *   b06ad0b (HEAD -> master) Merge commit 'ccedb9c'\n    |\\\n    | * ccedb9c commit in detached HEAD mode\n    * | 8634325 add new.txt\n    |/\n    * ca04d27 Append a nice line.\n    * 6e314b7 empty commit\n    * dbda1b1 initialized.\n    \n    # åˆ›å»ºä¸€ä¸ªä»ç¥–å…ˆæäº¤å¼€å§‹çš„åˆ†æ”¯\n    $ git checkout -b parent-parent ca04d27\n    Switched to a new branch 'parent-parent'\n    \n    # å†æ¬¡æŸ¥çœ‹æ—¥å¿—å¯ä»¥å‘ç°åˆ†æ”¯æŒ‡å‘ç¥–å…ˆæäº¤\n    $ git log --graph --oneline\n    * ca04d27 (HEAD -> parent-parent) Append a nice line.\n    * 6e314b7 empty commit\n    * dbda1b1 initialized.\n    \n    ```\n\n    >   ä¸€æ¡ç‰¹åˆ«å±é™©çš„å‘½ä»¤ï¼š\n    >\n    >   `git checkout -- .`æˆ–`git checkout .`\n    >\n    >   `.`ä»£è¡¨é€šé…ï¼Œä¹Ÿå°±æ˜¯æŒ‡æ‰€æœ‰æ–‡ä»¶\n    >\n    >   å®ƒä¼šå–æ¶ˆæ‰€æœ‰æœ¬åœ°ä¿®æ”¹ï¼Œä½¿ç”¨æš‚å­˜åŒºè¦†ç›–å·¥ä½œåŒº\n\n### ç¬¬9ç«  æ¢å¤è¿›åº¦\n\n>   `git stash`å‘½ä»¤çš„ä½¿ç”¨\n>\n>   [stashå•è¯é‡Šä¹‰](https://dict.youdao.com/w/stash/#keyfrom=dict2.top)\n\n`git stash`ç”¨äºä¿å­˜è¿›åº¦ä¸æ¢å¤è¿›åº¦\n\næŸ¥çœ‹ä¿å­˜çš„è¿›åº¦\n\n```bash\n$ git stash list\nstash@{0}: WIP on master: 8634325 add new.txt\n```\n\n```bash\n# ä¿å­˜å½“å‰å·¥ä½œè¿›åº¦ï¼Œä¼šåˆ†åˆ«å¯¹æš‚å­˜åŒºå’Œå·¥ä½œåŒºçš„çŠ¶æ€è¿›è¡Œä¿å­˜\n$ git stash\n# git stashçš„å®Œæ•´ç‰ˆ\n# --patchä¼šæ˜¾ç¤ºå·¥ä½œåŒºå’ŒHEADçš„å·®å¼‚ï¼Œé€šè¿‡å¯¹å·®å¼‚æ–‡ä»¶çš„ç¼–è¾‘å†³å®šæœ€ç»ˆè¦ä¿å­˜çš„å·¥ä½œåŒºå†…å®¹\n# -kæˆ–--keep-indexä¼šåœ¨è¿›åº¦ä¿å­˜åå°†æš‚å­˜åŒºé‡ç½®ã€‚é»˜è®¤ä¼šå°†æš‚å­˜åŒºå’Œå·¥ä½œåŒºå¼ºåˆ¶é‡ç½®\n$ git stash [save [--patch] [-k|--[no-]keep-index] [-q|--quiet] [<message>]\n# æ˜¾ç¤ºè¿›åº¦åˆ—è¡¨\n$ git stash list\n# æ¢å¤è¿›åº¦\n# å¦‚æœä¸ä½¿ç”¨ä»»ä½•å‚æ•°ï¼Œä¼šæ¢å¤æœ€æ–°ä¿å­˜çš„è¿›åº¦ï¼Œå¹¶å°†æ¢å¤çš„å·¥ä½œè¿›åº¦ä»å­˜å‚¨çš„å·¥ä½œè¿›åº¦åˆ—è¡¨ä¸­æ¸…é™¤\n# --indexä¼šå°è¯•æ¢å¤æš‚å­˜åŒº\n# stashæ˜¯æ˜¾ç¤ºè¿›åº¦åˆ—è¡¨æ—¶æä¾›çš„stashæ ‡è¯†ï¼Œæ¢å¤æŒ‡å®šè¿›åº¦\n$ git stash pop [--index] [<stash>]\n# å’ŒpopåŒºåˆ«åœ¨äºæ¢å¤åä¸åˆ é™¤è¿›åº¦\n$ git stash apply [--index] [<stash>]\n# åˆ é™¤ä¸€ä¸ªè¿›åº¦ï¼Œé»˜è®¤åˆ é™¤æœ€æ–°è¿›åº¦\n$ git stash drop [<stash>]\n# åˆ é™¤æ‰€æœ‰è¿›åº¦\n$ git stash clear\n# åŸºäºè¿›åº¦åˆ›å»ºåˆ†æ”¯\n$ git stash branch <branchname> <stash>\n```\n\n\n\n#### æ¢ç§˜`git stash`\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["Git"],"categories":["å•ƒä¹¦"]},{"title":"ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ","url":"/posts/20597ff2/","content":"\n\n\n## ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ\n\n### ç¬¬1ç«  åˆ†å¸ƒå¼ç»“æ„\n\n#### ä»é›†ä¸­å¼åˆ°åˆ†å¸ƒå¼\n\n##### é›†ä¸­å¼çš„ç‰¹ç‚¹\n\nç”±ä¸€å°æˆ–å¤šå°ä¸»è®¡ç®—æœºç»„æˆçš„ä¸­å¿ƒèŠ‚ç‚¹ï¼Œæ•°æ®é›†ä¸­å­˜å‚¨äºè¿™ä¸ªä¸­å¿ƒèŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”æ•´ä¸ªç³»ç»Ÿçš„æ‰€æœ‰ä¸šåŠ¡å•å…ƒéƒ½é›†ä¸­éƒ¨ç½²åœ¨è¿™ä¸ªä¸­å¿ƒèŠ‚ç‚¹ä¸Šï¼Œç³»ç»Ÿçš„æ‰€æœ‰åŠŸèƒ½å‡ç”±å…¶é›†ä¸­å¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨é›†ä¸­å¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç»ˆç«¯æˆ–å®¢æˆ·ç«¯æœºå™¨ä»…ä»…è´Ÿè´£æ•°æ®çš„å½•å…¥å’Œè¾“å‡ºï¼Œè€Œæ•°æ®çš„å­˜å‚¨ä¸æ§åˆ¶å¤„ç†å®Œå…¨äº¤ç”±ä¸»æœºå®Œæˆã€‚\n\nç‰¹ç‚¹ï¼šéƒ¨ç½²ç»“æ„ç®€å•ï¼Œä¸ç”¨è€ƒè™‘å¤šèŠ‚ç‚¹éƒ¨ç½²å¸¦æ¥çš„åˆ†å¸ƒå¼åä½œé—®é¢˜\n\n\n\n##### åˆ†å¸ƒå¼çš„ç‰¹ç‚¹\n\n>   ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿæ¦‚å¿µä¸è®¾è®¡ã€‹ä¸­å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®šä¹‰ï¼š\n>\n>   åˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä¸€ä¸ªç¡¬ä»¶æˆ–è½¯ä»¶ç»„ä»¶åˆ†å¸ƒåœ¨ä¸åŒçš„**ç½‘ç»œ**è®¡ç®—æœºä¸Šï¼Œå½¼æ­¤ä¹‹é—´ä»…ä»…é€šè¿‡æ¶ˆæ¯ä¼ é€’è¿›è¡Œé€šä¿¡å’Œåè°ƒçš„ç³»ç»Ÿã€‚\n\nåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨æ²¡æœ‰ä»»ä½•ç‰¹å®šä¸šåŠ¡é€»è¾‘çº¦æŸçš„æƒ…å†µä¸‹ï¼Œéƒ½ä¼šæœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹å¾ï¼š\n\n1.   åˆ†å¸ƒæ€§\n\n     åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šå°è®¡ç®—æœºéƒ½ä¼šåœ¨ç©ºé—´ä¸Šéšæ„åˆ†å¸ƒï¼ŒåŒæ—¶ï¼Œæœºå™¨çš„åˆ†å¸ƒæƒ…å†µä¹Ÿä¼šéšæ—¶å˜åŠ¨\n\n     >   èŠ‚ç‚¹ä¸Šä¸‹çº¿\n\n2.   å¯¹ç­‰æ€§\n\n     åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è®¡ç®—æœºæ²¡æœ‰ä¸»/ä»ä¹‹åˆ†çš„ï¼Œæ‰€æœ‰è®¡ç®—æœºèŠ‚ç‚¹æ˜¯å¯¹ç­‰çš„ã€‚\n\n     å‰¯æœ¬ï¼ˆReplicaï¼‰æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¸¸è§çš„æ¦‚å¿µä¹‹ä¸€ï¼ŒæŒ‡çš„æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¯¹æ•°æ®å’ŒæœåŠ¡æä¾›çš„ä¸€ç§å†—ä½™æ–¹å¼ã€‚\n\n     åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸ºäº†å¯¹å¤–æä¾›é«˜å¯ç”¨çš„æœåŠ¡ï¼Œå¾€å¾€ä¼šå¯¹æ•°æ®å’ŒæœåŠ¡è¿›è¡Œå‰¯æœ¬å¤„ç†ã€‚\n\n     >   å‰¯æœ¬åˆ†ä¸¤ç±»\n     >\n     >   1.   æ•°æ®å‰¯æœ¬\n     >   2.   æœåŠ¡å‰¯æœ¬\n\n     **æ•°æ®å‰¯æœ¬**æ˜¯æŒ‡åœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸ŠæŒä¹…åŒ–åŒä¸€ä»½æ•°æ®ï¼Œå½“æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Šå­˜å‚¨çš„æ•°æ®ä¸¢å¤±æ—¶ï¼Œå¯ä»¥ä»å‰¯æœ¬ä¸Šè¯»å–åˆ°è¯¥æ•°æ®ï¼Œè¿™æ˜¯è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®ä¸¢å¤±é—®é¢˜æœ€ä¸ºæœ‰æ•ˆçš„æ‰‹æ®µ\n\n     >   æ¶‰åŠåˆ°å‰¯æœ¬å°±è‚¯å®šä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜\n\n     å¦ä¸€ç±»å‰¯æœ¬æ˜¯**æœåŠ¡å‰¯æœ¬**ï¼ŒæŒ‡å¤šä¸ªèŠ‚ç‚¹æä¾›åŒæ ·çš„æœåŠ¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰èƒ½åŠ›æ¥å—æ¥è‡ªå¤–éƒ¨çš„è¯·æ±‚å¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚\n\n3.   å¹¶å‘æ€§\n\n     åŒä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹å¯èƒ½ä¼šå¹¶å‘åœ°æ“ä½œä¸€äº›å…±äº«çš„èµ„æºï¼Œå¦‚æ•°æ®åº“æˆ–åˆ†å¸ƒå¼å­˜å‚¨ç­‰\n\n4.   ç¼ºä¹å…¨å±€æ—¶é’Ÿ\n\n     åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¾ˆéš¾å®šä¹‰ä¸¤ä¸ªäº‹ä»¶çš„å…ˆåï¼Œå› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿç¼ºä¹ä¸€ä¸ªå…¨å±€çš„æ—¶é’Ÿåºåˆ—æ§åˆ¶\n     \n5.   æ•…éšœæ€»æ˜¯ä¼šå‘ç”Ÿ\n\n     ç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ‰€æœ‰è®¡ç®—æœºï¼Œéƒ½æœ‰å¯èƒ½å‘ç”Ÿä»»ä½•å½¢å¼çš„æ•…éšœã€‚\n\n     ä»»ä½•åœ¨è®¾è®¡é˜¶æ®µè€ƒè™‘åˆ°çš„å¼‚å¸¸æƒ…å†µï¼Œä¸€å®šä¼šåœ¨ç³»ç»Ÿå®é™…è¿è¡Œä¸­å‘ç”Ÿï¼Œå¹¶ä¸”åœ¨ç³»ç»Ÿå®é™…è¿è¡Œè¿‡ç¨‹ä¸­è¿˜ä¼šé‡åˆ°å¾ˆå¤šåœ¨è®¾è®¡æ—¶æœªèƒ½è€ƒè™‘åˆ°çš„å¼‚å¸¸æ•…éšœã€‚æ‰€ä»¥ï¼Œé™¤ééœ€æ±‚æŒ‡æ ‡å…è®¸ï¼Œåœ¨ç³»ç»Ÿè®¾è®¡æ—¶ä¸èƒ½æ”¾è¿‡ä»»ä½•å¼‚å¸¸æƒ…å†µã€‚\n\n\n\n##### åˆ†å¸ƒå¼ç¯å¢ƒçš„å„ç§é—®é¢˜\n\n###### é€šä¿¡å¼‚å¸¸\n\nåˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦åœ¨å„ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œç½‘ç»œé€šä¿¡ï¼Œç”±äºç½‘ç»œæœ¬èº«çš„ä¸å¯é æ€§ï¼Œä¼šå¯¼è‡´æœ€ç»ˆåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•é¡ºåˆ©å®Œæˆä¸€æ¬¡ç½‘ç»œé€šä¿¡ã€‚\n\nå³ä½¿èƒ½å¤Ÿæ­£å¸¸è¿›è¡Œé€šä¿¡ï¼Œå»¶æ—¶ä¹Ÿä¼šè¿œå¤§äºå•æœºæ“ä½œã€‚é€šå¸¸å•æœºå†…å­˜è®¿é—®çš„å»¶æ—¶åœ¨çº³ç§’çº§åˆ«ï¼ˆé€šå¸¸æ˜¯10nså·¦å³ï¼‰ï¼Œè€Œæ­£å¸¸çš„ä¸€æ¬¡ç½‘ç»œé€šä¿¡çš„å»¶æ—¶åœ¨0.1\\~1mså·¦å³ï¼ˆç›¸å½“äºå†…å­˜è®¿é—®å»¶æ—¶çš„105\\~106å€ï¼‰ï¼Œå»¶æ—¶å¤§ä¹Ÿä¼šå½±å“æ¶ˆæ¯çš„æ”¶å‘è¿‡ç¨‹ï¼Œå› æ­¤æ¶ˆæ¯ä¸¢å¤±å’Œæ¶ˆæ¯å»¶è¿Ÿå˜å¾—éå¸¸æ™®éã€‚\n\n###### ç½‘ç»œåˆ†åŒº\n\nå½“ç½‘ç»œç”±äºå‘ç”Ÿå¼‚å¸¸æƒ…å†µï¼Œå¯¼è‡´åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éƒ¨åˆ†èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œå»¶æ—¶ä¸æ–­å¢å¤§ï¼Œæœ€ç»ˆå¯¼è‡´ç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ‰€æœ‰èŠ‚ç‚¹ä¸­ï¼Œåªæœ‰éƒ¨åˆ†èŠ‚ç‚¹ä¹‹é—´èƒ½å¤Ÿæ­£å¸¸é€šä¿¡ï¼Œè€Œå¦ä¸€äº›èŠ‚ç‚¹ä¸èƒ½â€”â€”è¿™ä¸ªç°è±¡ç§°ä¸ºç½‘ç»œåˆ†åŒºï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„è„‘è£‚ã€‚\n\nç½‘ç»œåˆ†åŒºå‡ºç°çš„æ—¶å€™ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¼šå‡ºç°å±€éƒ¨å°é›†ç¾¤ï¼Œåœ¨æç«¯æƒ…å†µä¸‹ï¼Œè¿™äº›å±€éƒ¨å°é›†ç¾¤ä¼šç‹¬ç«‹å®ŒæˆåŸæœ¬éœ€è¦æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ‰èƒ½å®Œæˆçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¯¹æ•°æ®çš„äº‹åŠ¡å¤„ç†ã€‚\n\n###### ä¸‰æ€\n\nä¼ ç»Ÿçš„å•æœºç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºåœ¨è°ƒç”¨ä¸€ä¸ªå‡½æ•°ä¹‹åï¼Œèƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªéå¸¸æ˜ç¡®çš„å“åº”ï¼šæˆåŠŸæˆ–å¤±è´¥ã€‚è€Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºç½‘ç»œæ˜¯ä¸å¯é çš„ï¼Œè™½ç„¶åœ¨ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç½‘ç»œé€šä¿¡ä¹Ÿèƒ½å¤Ÿæ¥å—åˆ°æˆåŠŸæˆ–å¤±è´¥çš„å“åº”ï¼Œä½†æ˜¯å½“ç½‘ç»œå‡ºç°å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œå°±å¯èƒ½ä¼šå‡ºç°è¶…æ—¶ç°è±¡ï¼š\n\n1.   ç”±äºç½‘ç»œåŸå› ï¼Œè¯¥è¯·æ±‚å¹¶æ²¡æœ‰è¢«æˆåŠŸåœ°å‘é€åˆ°æ¥æ”¶æ–¹ï¼Œè€Œæ˜¯åœ¨å‘é€è¿‡ç¨‹ä¸­å°±å‘ç”Ÿäº†æ¶ˆæ¯ä¸¢å¤±ç°è±¡ã€‚\n2.   è¯¥è¯·æ±‚æˆåŠŸåœ°è¢«æ¥æ”¶æ–¹æ¥æ”¶åï¼Œå¹¶è¿›è¡Œäº†å¤„ç†ï¼Œä½†æ˜¯å°†å“åº”åé¦ˆç»™å‘é€æ–¹çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†æ¶ˆæ¯ä¸¢å¤±ç°è±¡ã€‚\n\n>   1.   æ¥å—æ–¹ç”šè‡³éƒ½æ²¡æœ‰æ”¶åˆ°è¯·æ±‚\n>   2.   æ¥æ”¶æ–¹å¤„ç†å®Œå¹¶åé¦ˆï¼Œä½†æ˜¯å‘é€æ–¹æ²¡æ¥æ”¶åˆ°\n\nå½“å‡ºç°è¿™æ ·çš„è¶…æ—¶ç°è±¡æ—¶ï¼Œç½‘ç»œé€šä¿¡çš„å‘èµ·æ–¹æ˜¯æ— æ³•ç¡®å®šå½“å‰è¯·æ±‚æ˜¯å¦è¢«æˆåŠŸå¤„ç†çš„ã€‚\n\n###### èŠ‚ç‚¹æ•…éšœ\n\næŒ‡çš„æ˜¯ç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„æœåŠ¡å™¨èŠ‚ç‚¹å‡ºç°å®•æœºæˆ–â€œåƒµæ­»â€ç°è±¡\n\n\n\n#### ä»ACIDåˆ°CAP/BASE\n\n##### ACID\n\n##### åˆ†å¸ƒå¼äº‹åŠ¡\n\n##### CAPå’ŒBASEç†è®º\n\n###### CAPå®šç†\n\nCAPç†è®ºå‘Šè¯‰æˆ‘ä»¬ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆCï¼šConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAï¼šAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPï¼šPartition toleranceï¼‰è¿™ä¸‰ä¸ªåŸºæœ¬éœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­çš„ä¸¤é¡¹ã€‚\n\n-   ä¸€è‡´æ€§\n\n    æŒ‡æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬æ˜¯å¦èƒ½å¤Ÿä¿æŒä¸€è‡´çš„ç‰¹æ€§ã€‚åœ¨ä¸€è‡´æ€§éœ€æ±‚ä¸‹ï¼Œå½“ä¸€ä¸ªç³»ç»Ÿåœ¨æ•°æ®ä¸€è‡´çš„çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œåº”è¯¥ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä»ç„¶å¤„äºä¸€è‡´çŠ¶æ€ã€‚\n\n    å¯¹äºä¸€ä¸ªå°†æ•°æ®å‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒåˆ†å¸ƒå¼èŠ‚ç‚¹ä¸Šçš„ç³»ç»Ÿæ¥è¯´ï¼Œå¦‚æœå¯¹ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œäº†æ›´æ–°æ“ä½œå¹¶ä¸”æ›´æ–°æˆåŠŸåï¼Œå´æ²¡æœ‰ä½¿å¾—ç¬¬äºŒèŠ‚ç‚¹ä¸Šçš„æ•°æ®å¾—åˆ°ç›¸åº”çš„æ›´æ–°ï¼Œäºæ˜¯åœ¨å¯¹ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œè·å–çš„ä¾ç„¶æ˜¯è€æ•°æ®ï¼ˆæˆ–ç§°ä¸ºè„æ•°æ®ï¼‰ï¼Œè¿™å°±æ˜¯å…¸å‹çš„åˆ†å¸ƒå¼æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚\n\n    åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœèƒ½å¤Ÿåšåˆ°é’ˆå¯¹ä¸€ä¸ªæ•°æ®é¡¹çš„æ›´æ–°æ“ä½œæ‰§è¡ŒæˆåŠŸåï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è¯»å–åˆ°å…¶æœ€æ–°çš„å€¼ï¼Œé‚£ä¹ˆè¿™æ ·çš„ç³»ç»Ÿè¢«è®¤ä¸ºå…·æœ‰**å¼ºä¸€è‡´æ€§**ï¼ˆæˆ–ä¸¥æ ¼ä¸€è‡´æ€§ï¼‰ã€‚\n\n-   å¯ç”¨æ€§\n\n    æŒ‡ç³»ç»Ÿæä¾›çš„æœåŠ¡å¿…é¡»ä¸€ç›´å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œå¯¹äºç”¨æˆ·çš„æ¯ä¸€ä¸ªæ“ä½œè¯·æ±‚æ€»æ˜¯èƒ½å¤Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ç»“æœã€‚\n\n    â€œè¿”å›ç»“æœâ€æ˜¯å¯ç”¨æ€§çš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„æŒ‡æ ‡ï¼Œä»–è¦æ±‚ç³»ç»Ÿåœ¨å®Œæˆå¯¹ç”¨æˆ·è¯·æ±‚çš„å¤„ç†åï¼Œè¿”å›ä¸€ä¸ªæ­£å¸¸çš„å“åº”ç»“æœï¼ˆå°±æ˜¯èƒ½å¤Ÿåæ˜ å‡ºå¯¹è¯·æ±‚çš„å¤„ç†ç»“æœï¼Œå³æˆåŠŸæˆ–å¤±è´¥ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®©ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘çš„è¿”å›ç»“æœï¼‰\n\n-   åˆ†åŒºå®¹é”™æ€§\n\n    åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨é‡åˆ°ä»»ä½•ç½‘ç»œåˆ†åŒºæ•…éšœçš„æ—¶å€™ï¼Œä»ç„¶éœ€è¦èƒ½å¤Ÿä¿è¯å¯¹å¤–æä¾›æ»¡è¶³ä¸€è‡´æ€§å’Œå¯ç”¨æ€§çš„æœåŠ¡ï¼Œé™¤éæ•´ä¸ªç½‘ç»œéƒ½å‘ç”Ÿæ•…éšœã€‚\n    \n    >   ç½‘ç»œåˆ†åŒºï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒçš„å­ç½‘ç»œï¼ˆæœºæˆ¿æˆ–å¼‚åœ°ç½‘ç»œç­‰ï¼‰ä¸­ï¼Œç”±äºä¸€äº›ç‰¹æ®Šçš„åŸå› å¯¼è‡´è¿™äº›å­ç½‘ç»œä¹‹é—´å‡ºç°ç½‘ç»œä¸è¿é€šçš„æƒ…å†µï¼Œä½†æ˜¯å­ç½‘ç»œå†…éƒ¨é€šä¿¡æ­£å¸¸ï¼Œä»è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„ç½‘ç»œç¯å¢ƒè¢«åˆ‡åˆ†æˆè‹¥å¹²ä¸ªå­¤ç«‹çš„åŒºåŸŸã€‚\n    >\n    >   éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¯ä¸ªèŠ‚ç‚¹çš„åŠ å…¥ä¸é€€å‡ºéƒ½å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç½‘ç»œåˆ†åŒºã€‚\n\n![20220516094438424](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220516094438424.jpg)\n\n1.   ~~CAï¼ˆæ”¾å¼ƒPï¼‰~~\n\n     å¦‚æœå¸Œæœ›èƒ½å¤Ÿé¿å…ç³»ç»Ÿå‡ºç°åˆ†åŒºï¼Œä¸€ç§ç®€å•çš„åšæ³•æ˜¯å°†æ‰€æœ‰çš„æ•°æ®ï¼ˆæˆ–è€…ä»…ä»…å°†é‚£äº›ä¸äº‹åŠ¡ç›¸å…³çš„æ•°æ®ï¼‰éƒ½æ”¾åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·è™½ç„¶æ— æ³•100%ä¿è¯ç³»ç»Ÿä¸ä¼šå‡ºé”™ï¼Œä½†è‡³å°‘ä¸ä¼šç¢°åˆ°ç”±äºç½‘ç»œåˆ†åŒºå¸¦æ¥çš„è´Ÿé¢å½±å“ã€‚\n\n     æ³¨æ„ï¼šæ”¾å¼ƒPä¹Ÿå°±æ„å‘³ç€æ”¾å¼ƒäº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ï¼Œå¯ä»¥è¯´å°±ä¸æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿäº†ã€‚\n\n2.   CPï¼ˆæ”¾å¼ƒAï¼‰\n\n     ä¸€æ—¦å‘ç”Ÿç½‘ç»œåˆ†åŒºæˆ–å…¶ä»–æ•…éšœï¼Œå—åˆ°å½±å“çš„æœåŠ¡éœ€è¦ç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œå› ä¸ºåœ¨è¿™æ®µæœŸé—´ç³»ç»Ÿæ— æ³•å¯¹å¤–æä¾›æ­£å¸¸çš„æœåŠ¡ï¼Œå³ä¸å¯ç”¨\n\n3.   APï¼ˆæ”¾å¼ƒCï¼‰\n\n     æ³¨æ„ï¼šè¿™é‡Œè¯´çš„æ”¾å¼ƒä¸€è‡´æ€§å¹¶ä¸æ˜¯å®Œå…¨æ”¾å¼ƒä¸€è‡´æ€§ï¼ˆæ²¡æœ‰ä¸€è‡´æ€§çš„ç³»ç»Ÿæ²¡æ„ä¹‰ï¼‰\n\n     æ”¾å¼ƒä¸€è‡´æ€§æŒ‡çš„æ˜¯æ”¾å¼ƒå¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯ä¿ç•™æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\n\n     å³ç³»ç»Ÿæ— æ³•ä¿è¯æ•°æ®ä¸€å®šæ˜¯å®æ—¶åŒæ­¥çš„ï¼Œä½†æ˜¯èƒ½å¤Ÿä¿è¯æ•°æ®æœ€ç»ˆä¼šè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚\n\n     è¿™å°±å¼•å…¥äº†ä¸€ä¸ªæ—¶é—´çª—å£çš„æ¦‚å¿µï¼Œå…·ä½“å¤šä¹…å–å†³äºç³»ç»Ÿè®¾è®¡ï¼Œä¸»è¦åŒ…æ‹¬**æ•°æ®å‰¯æœ¬åœ¨ä¸åŒèŠ‚ç‚¹ä¹‹é—´çš„å¤åˆ¶æ—¶é—´é•¿çŸ­**\n\nå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œåˆ†åŒºå®¹é”™æ€§æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚\n\nå› ä¸ºæ—¢ç„¶æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ç»„ä»¶å¿…ç„¶éœ€è¦è¢«éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œå°±å¿…ç„¶å‡ºç°å­ç½‘ç»œã€‚\n\n###### BASEç†è®º\n\n1.   Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰\n2.   Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰\n3.   Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰\n\næ ¸å¿ƒæ€æƒ³ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrong consistencyï¼‰ï¼Œä½†æ˜¯æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually consistencyï¼‰ã€‚\n\n-   åŸºæœ¬å¯ç”¨\n\n    æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼ˆä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ï¼ï¼‰\n\n    ä»¥ä¸‹ä¸¤ä¸ªå°±æ˜¯â€œåŸºæœ¬å¯ç”¨â€çš„å…¸å‹ä¾‹å­ï¼š\n\n    -   å“åº”æ—¶é—´ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæœç´¢å¼•æ“éœ€è¦åœ¨0.5ç§’ä¹‹å†…è¿”å›ç»™ç”¨æˆ·ç»“æœï¼Œä½†æ˜¯ç”±äºæ•…éšœï¼ŒæŸ¥è¯¢æ—¶é—´å¯èƒ½å¢åŠ åˆ°1~2ç§’ã€‚\n    -   åŠŸèƒ½ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…å‡ ä¹èƒ½åœ¨è´­ç‰©ç½‘ç«™é¡ºåˆ©å®Œæˆæ¯ä¸€ç¬”è®¢å•ï¼Œä½†æ˜¯èŠ‚æ—¥å¤§ä¿ƒæ´»åŠ¨æ—¶ï¼Œæ¶ˆè´¹è€…è´­ç‰©è¡Œä¸ºæ¿€å¢ï¼Œä¸ºäº†ä¿æŠ¤ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ã€‚\n\n-   è½¯çŠ¶æ€ï¼ˆå¼±çŠ¶æ€ï¼‰\n\n    å’Œç¡¬çŠ¶æ€ç›¸æ¯”ï¼ŒæŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸å½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³**å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶**ã€‚\n\n-   æœ€ç»ˆä¸€è‡´æ€§\n\n    æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿä¸­æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚\n\n    >   ä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§\n\n    å®é™…å·¥ç¨‹å®è·µä¸­ï¼Œæœ€ç»ˆä¸€è‡´æ€§å­˜åœ¨äº”ç±»ä¸»è¦å˜ç§\n\n    1.   å› æœä¸€è‡´æ€§ï¼ˆCausal consistencyï¼‰\n\n         å¦‚æœè¿›ç¨‹Aåœ¨æ›´æ–°å®ŒæŸä¸ªæ•°æ®é¡¹åé€šçŸ¥äº†è¿›ç¨‹Bï¼Œé‚£ä¹ˆè¿›ç¨‹Bä¹‹åå¯¹è¯¥æ•°æ®é¡¹çš„è®¿é—®éƒ½åº”è¯¥èƒ½å¤Ÿè·å–åˆ°è¿›ç¨‹Aæ›´æ–°åçš„æœ€æ–°å€¼ï¼Œå¹¶ä¸”å¦‚æœè¿›ç¨‹Bè¦å¯¹è¯¥æ•°æ®é¡¹è¿›è¡Œæ›´æ–°æ“ä½œçš„è¯ï¼ŒåŠ¡å¿…åŸºäºè¿›ç¨‹Aæ›´æ–°åçš„æœ€æ–°å€¼ï¼Œå³ä¸èƒ½å‘ç”Ÿä¸¢å¤±æ›´æ–°çš„æƒ…å†µã€‚ä¸æ­¤åŒæ—¶ï¼Œä¸è¿›ç¨‹Aæ— å› æœå…³ç³»çš„è¿›ç¨‹Cçš„æ•°æ®è®¿é—®åˆ™æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚\n\n    2.   è¯»å·±ä¹‹æ‰€å†™ï¼ˆRead your writesï¼‰\n\n         è¿›ç¨‹Aæ›´æ–°ä¸€ä¸ªæ•°æ®é¡¹ä¹‹åï¼Œå®ƒè‡ªå·±æ€»æ˜¯èƒ½å¤Ÿè®¿é—®åˆ°æ›´æ–°è¿‡çš„æœ€æ–°å€¼ï¼Œè€Œä¸ä¼šçœ‹åˆ°æ—§å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå•ä¸ªæ•°æ®è·å–è€…æ¥è¯´ï¼Œå…¶è¯»å–åˆ°çš„æ•°æ®ï¼Œä¸€å®šä¸ä¼šæ¯”è‡ªå·±ä¸Šæ¬¡å†™å…¥çš„å€¼æ—§ã€‚å› æ­¤å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§ç‰¹æ®Šçš„å› æœä¸€è‡´æ€§ã€‚\n\n    3.   ä¼šè¯ä¸€è‡´æ€§ï¼ˆSession consistencyï¼‰\n\n         å¯¹ç³»ç»Ÿæ•°æ®çš„è®¿é—®è¿‡ç¨‹æ¡†å®šåœ¨ä¸€ä¸ªä¼šè¯å½“ä¸­ï¼šç³»ç»Ÿèƒ½å¤Ÿä¿è¯åœ¨åŒä¸€ä¸ªæœ‰æ•ˆçš„ä¼šè¯ä¸­å®ç°â€œè¯»å·±ä¹‹æ‰€å†™â€çš„ä¸€è‡´æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œä¹‹åï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿåœ¨åŒä¸€ä¸ªä¼šè¯ä¸­å§‹ç»ˆè¯»å–åˆ°è¯¥æ•°æ®é¡¹çš„æœ€æ–°å€¼ã€‚\n\n    4.   å•è°ƒè¯»ä¸€è‡´æ€§ï¼ˆMonotonic read consistencyï¼‰\n    \n         å¦‚æœä¸€ä¸ªè¿›ç¨‹ä»ç³»ç»Ÿä¸­è¯»å–å‡ºä¸€ä¸ªæ•°æ®é¡¹çš„ä¸€ä¸ªå€¼åï¼Œé‚£ä¹ˆç³»ç»Ÿå¯¹äºè¯¥è¿›ç¨‹åç»­çš„ä»»ä½•æ•°æ®è®¿é—®éƒ½ä¸åº”è¯¥è¿”å›æ›´æ—§çš„å€¼ã€‚\n    \n    5.   å•è°ƒå†™ä¸€è‡´æ€§ï¼ˆMonotonic write consistencyï¼‰\n    \n         ä¸€ä¸ªç³»ç»Ÿéœ€è¦èƒ½å¤Ÿä¿è¯æ¥è‡ªåŒä¸€ä¸ªè¿›ç¨‹çš„å†™æ“ä½œè¢«é¡ºåºæ‰§è¡Œã€‚\n    \n    å®é™…ç³»ç»Ÿå®è·µä¸­ï¼Œå¯ä»¥å°†è‹¥å¹²ç§ä¸€è‡´æ€§å˜ç§äº’ç›¸ç»“åˆ\n    \n    æœ€ç»ˆä¸€è‡´æ€§å¹¶ä¸æ˜¯åªæœ‰å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿæ‰æ¶‰åŠçš„ç‰¹æ€§ï¼Œè®¸å¤šç°ä»£çš„å…³ç³»å‹æ•°æ®åº“éƒ½é‡‡ç”¨äº†æœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹ã€‚é‡‡ç”¨åŒæ­¥å’Œå¼‚æ­¥æ–¹å¼æ¥å®ç°ä¸»å¤‡æ•°æ®å¤åˆ¶ã€‚åœ¨åŒæ­¥æ–¹å¼ä¸­ï¼Œæ•°æ®çš„å¤åˆ¶è¿‡ç¨‹é€šå¸¸æ˜¯æ›´æ–°äº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤äº‹åŠ¡å®Œæˆåï¼Œä¸»å¤‡æ•°æ®åº“çš„æ•°æ®å°±ä¼šè¾¾åˆ°ä¸€è‡´ã€‚è€Œåœ¨å¼‚æ­¥æ–¹å¼ä¸­ï¼Œå¤‡åº“çš„æ›´æ–°å¾€å¾€ä¼šå­˜åœ¨å»¶æ—¶ï¼Œè¿™å–å†³äºäº‹åŠ¡æ—¥å¿—åœ¨ä¸»å¤‡æ•°æ®åº“ä¹‹é—´ä¼ è¾“çš„æ—¶é—´é•¿çŸ­ï¼Œå¦‚æœä¼ è¾“æ—¶é—´è¿‡é•¿æˆ–è€…ç”šè‡³æ˜¯æ—¥å¿—ä¼ è¾“è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸å¯¼è‡´æ— æ³•åŠæ—¶å°†äº‹åŠ¡åº”ç”¨åˆ°å¤‡åº“ä¸Šï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ— è®ºæ˜¯é‡‡ç”¨é‡è¯•è¿˜æ˜¯äººä¸ºè®¢æ­£ï¼Œå…³ç³»å‹æ•°æ®åº“è¿˜æ˜¯èƒ½å¤Ÿä¿è¯æœ€ç»ˆæ•°æ®ä¸€è‡´æ€§ã€‚\n\n\n\n### ç¬¬2ç«  ä¸€è‡´æ€§åè®®\n\n#### 2PCä¸3PC\n\nåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸€ä¸ªæœºå™¨èŠ‚ç‚¹è™½ç„¶éƒ½èƒ½æ˜ç¡®çŸ¥é“è‡ªå·±åœ¨è¿›è¡Œäº‹åŠ¡æ“ä½œè¿‡ç¨‹ä¸­çš„ç»“æœæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œä½†æ˜¯å´æ— æ³•ç›´æ¥è·å–åˆ°å…¶ä»–åˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ“ä½œç»“æœã€‚å› æ­¤å½“ä¸€ä¸ªäº‹åŠ¡æ“ä½œéœ€è¦è·¨è¶Šå¤šä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡å¤„ç†çš„ACIDç‰¹æ€§ï¼Œå°±éœ€è¦å¼•å…¥ä¸€ä¸ªç§°ä¸ºâ€œ**åè°ƒè€…**ï¼ˆCoordinatorï¼‰â€çš„ç»„ä»¶æ¥ç»Ÿä¸€è°ƒåº¦æ‰€æœ‰åˆ†å¸ƒå¼èŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘ï¼Œè¿™äº›è¢«è°ƒåº¦çš„åˆ†å¸ƒå¼èŠ‚ç‚¹åˆ™è¢«ç§°ä¸ºâ€œ**å‚ä¸è€…**ï¼ˆParticipantï¼‰â€ã€‚\n\nåè°ƒè€…è´Ÿè´£è°ƒåº¦å‚ä¸è€…çš„è¡Œä¸ºï¼Œå¹¶æœ€ç»ˆå†³å®šè¿™äº›å‚ä¸è€…æ˜¯å¦è¦æŠŠäº‹åŠ¡çœŸæ­£è¿›è¡Œæäº¤ã€‚\n\nåŸºäºè¿™ä¸ªæ€æƒ³è¡ç”Ÿå‡ºäºŒé˜¶æ®µæäº¤å’Œä¸‰é˜¶æ®µæäº¤ä¸¤ç§åè®®ã€‚\n\n##### 2PC\n\nTwo-Phase Commitï¼ˆäºŒé˜¶æ®µæäº¤ï¼‰ï¼Œæ˜¯ä¸ºäº†ä½¿åŸºäºåˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸‹çš„æ‰€æœ‰èŠ‚ç‚¹åœ¨è¿›è¡Œäº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­èƒ½å¤Ÿä¿æŒåŸå­æ€§å’Œä¸€è‡´æ€§è€Œè®¾è®¡çš„ä¸€ç§ç®—æ³•ã€‚ä¹Ÿè¢«è®¤ä¸ºæ˜¯ä¸€ç§ä¸€è‡´æ€§åè®®ï¼Œç”¨æ¥ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„ä¸€è‡´æ€§ã€‚\n\n###### åè®®è¯´æ˜\n\näºŒé˜¶æ®µæäº¤åè®®å°±æ˜¯å°†äº‹åŠ¡çš„æäº¤è¿‡ç¨‹åˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µæ¥è¿›è¡Œå¤„ç†ï¼Œå…¶æ‰§è¡Œæµç¨‹å¦‚ä¸‹\n\n###### é˜¶æ®µä¸€ï¼šæäº¤äº‹åŠ¡è¯·æ±‚\n\n1.   äº‹åŠ¡è¯¢é—®\n\n     åè°ƒè€…å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€äº‹åŠ¡å†…å®¹ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶å¼€å§‹ç­‰å¾…å„å‚ä¸è€…çš„å“åº”ã€‚\n\n2.   æ‰§è¡Œäº‹åŠ¡\n\n     å„å‚ä¸è€…èŠ‚ç‚¹æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°†Undoå’ŒRedoä¿¡æ¯è®°å…¥äº‹åŠ¡æ—¥å¿—ä¸­ã€‚\n\n3.   å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆäº‹åŠ¡è¯¢é—®çš„å“åº”\n\n     å¦‚æœå‚ä¸è€…æˆåŠŸæ‰§è¡Œäº†äº‹åŠ¡æ“ä½œï¼Œé‚£ä¹ˆå°±åé¦ˆç»™åè°ƒè€…Yeså“åº”ï¼Œè¡¨ç¤ºäº‹åŠ¡å¯ä»¥æ‰§è¡Œï¼›\n\n     å¦‚æœå‚ä¸è€…æ²¡æœ‰æˆåŠŸæ‰§è¡Œäº‹åŠ¡ï¼Œé‚£ä¹ˆå°±åé¦ˆç»™åè°ƒè€…Noå“åº”ï¼Œè¡¨ç¤ºäº‹åŠ¡ä¸å¯ä»¥æ‰§è¡Œã€‚\n\nç”±äºä¸Šè¿°å†…å®¹åœ¨å½¢å¼ä¸Šè¿‘ä¼¼åè°ƒè€…ç»„ç»‡å„å‚ä¸è€…å¯¹ä¸€æ¬¡äº‹åŠ¡æ“ä½œçš„æŠ•ç¥¨è¡¨æ€è¿‡ç¨‹ï¼Œå› æ­¤äºŒé˜¶æ®µæäº¤åè®®çš„é˜¶æ®µä¸€ä¹Ÿè¢«ç§°ä¸ºâ€œæŠ•ç¥¨é˜¶æ®µâ€ï¼Œå³å„å‚ä¸è€…æŠ•ç¥¨è¡¨æ˜æ˜¯å¦è¦ç»§ç»­æ‰§è¡Œæ¥ä¸‹æ¥çš„äº‹åŠ¡æäº¤æ“ä½œã€‚\n\n###### é˜¶æ®µäºŒï¼šæ‰§è¡Œäº‹åŠ¡æäº¤\n\nåè°ƒè€…æ ¹æ®å„å‚ä¸è€…çš„åé¦ˆæƒ…å†µæ¥å†³å®šæœ€ç»ˆæ˜¯å¦å¯ä»¥è¿›è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œæ­£å¸¸æƒ…å†µä¸‹åŒ…å«ä»¥ä¸‹ä¸¤ç§å¯èƒ½ï¼š\n\n-   æ‰§è¡Œäº‹åŠ¡æäº¤\n\n    åŠ å…¥åè°ƒè€…ä»æ‰€æœ‰çš„å‚ä¸è€…è·å¾—çš„åé¦ˆéƒ½æ˜¯Yeså“åº”ï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œäº‹åŠ¡æäº¤ã€‚\n\n    1.   å‘é€æäº¤è¯·æ±‚\n\n         åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘å‡ºCommitè¯·æ±‚ã€‚\n\n    2.   äº‹åŠ¡æäº¤\n\n         å‚ä¸è€…æ¥æ”¶åˆ°Commitè¯·æ±‚åï¼Œä¼šæ­£å¼æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶åœ¨å®Œæˆæäº¤ä¹‹åé‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æ‰§è¡ŒæœŸé—´å ç”¨çš„äº‹åŠ¡èµ„æºã€‚\n\n    3.   åé¦ˆäº‹åŠ¡æäº¤ç»“æœ\n\n         å‚ä¸è€…åœ¨å®Œæˆäº‹åŠ¡æäº¤ä¹‹åï¼Œå‘åè°ƒè€…å‘é€Ackæ¶ˆæ¯ã€‚\n\n    4.   å®Œæˆäº‹åŠ¡\n\n         åè°ƒè€…æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„Ackæ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ã€‚\n\n-   ä¸­æ–­äº‹åŠ¡\n\n    å‡å¦‚å‡ºç°äº†ä¸€ä¸ªå‚ä¸è€…å‘åè°ƒè€…åé¦ˆäº†Noå“åº”ï¼Œæˆ–è€…åœ¨ç­‰å¾…è¶…æ—¶ä¹‹åï¼Œåè°ƒè€…æ— æ³•æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆå“åº”ï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡ã€‚\n\n    1.   å‘é€å›æ»šè¯·æ±‚\n\n         åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘é€Rollbackè¯·æ±‚ã€‚\n\n    2.   äº‹åŠ¡å›æ»š\n\n         å‚ä¸è€…æ¥æ”¶åˆ°Rollbackè¯·æ±‚åï¼Œä¼šåˆ©ç”¨åœ¨é˜¶æ®µä¸€ä¸­è®°å½•çš„Undoä¿¡æ¯æ¥æ‰§è¡Œäº‹åŠ¡å›æ»šæ“ä½œï¼Œå¹¶åœ¨å®Œæˆå›æ»šä¹‹åé‡Šæ”¾åœ¨æ•´ä¸ªäº‹åŠ¡æ‰§è¡ŒæœŸé—´å ç”¨çš„èµ„æºã€‚\n\n    3.   åé¦ˆäº‹åŠ¡å›æ»šç»“æœ\n\n         å‚ä¸è€…åœ¨å®Œæˆäº‹åŠ¡å›æ»šä¹‹åï¼Œå‘åè°ƒè€…å‘é€Ackæ¶ˆæ¯ã€‚\n\n    4.   ä¸­æ–­äº‹åŠ¡\n\n         åè°ƒè€…æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„Ackæ¶ˆæ¯åï¼Œå®Œæˆäº‹åŠ¡ä¸­æ–­ã€‚\n\näºŒé˜¶æ®µæäº¤å°†äº‹åŠ¡å¤„ç†è¿‡ç¨‹åˆ†ä¸º**æŠ•ç¥¨**å’Œ**æ‰§è¡Œ**é˜¶æ®µï¼Œå…¶æ ¸å¿ƒæ˜¯å¯¹æ¯ä¸ªäº‹åŠ¡éƒ½é‡‡ç”¨å…ˆå°è¯•åæäº¤çš„å¤„ç†æ–¹å¼ï¼Œå› æ­¤ä¹Ÿå¯ä»¥å°†äºŒé˜¶æ®µæäº¤çœ‹ä½œæ˜¯ä¸€ä¸ªå¼ºä¸€è‡´æ€§çš„ç®—æ³•ã€‚\n\näº‹åŠ¡æäº¤ï¼š\n\n![20220516120609153](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220516120609153.jpg)\n\näº‹åŠ¡ä¸­æ–­ï¼š\n\n![20220516120734800](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220516120734800.jpg)\n\n###### ä¼˜ç¼ºç‚¹\n\nä¼˜ç‚¹ï¼šåŸç†ç®€å•ï¼Œå®ç°æ–¹ä¾¿\n\nç¼ºç‚¹ï¼šåŒæ­¥é˜»å¡ï¼Œå•ç‚¹é—®é¢˜ï¼Œè„‘è£‚ï¼Œå¤ªè¿‡ä¿å®ˆ\n\n**åŒæ­¥é˜»å¡**\n\nå„ä¸ªå‚ä¸è€…åœ¨ç­‰å¾…å…¶ä»–å‚ä¸è€…å“åº”çš„è¿‡ç¨‹ä¸­å°†æ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œ\n\n**å•ç‚¹é—®é¢˜**\n\nåè°ƒè€…çš„è§’è‰²ä¹‹é‡è¦ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜ï¼Œå…¶ä»–å‚ä¸è€…å°†ä¼šä¸€ç›´å¤„äºé”å®šäº‹åŠ¡èµ„æºçš„çŠ¶æ€ï¼Œæ— æ³•ç»§ç»­å®Œæˆäº‹åŠ¡æ“ä½œ\n\n**æ•°æ®ä¸ä¸€è‡´**\n\nåœ¨é˜¶æ®µäºŒï¼Œå½“åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€Commitè¯·æ±‚ä¹‹åï¼Œå‘ç”Ÿäº†å±€éƒ¨ç½‘ç»œå¼‚å¸¸æˆ–è€…æ˜¯åè°ƒè€…åœ¨å°šæœªå‘é€å®ŒCommitè¯·æ±‚ä¹‹å‰è‡ªèº«å‘ç”Ÿäº†å´©æºƒï¼Œå¯¼è‡´æœ€ç»ˆåªæœ‰éƒ¨åˆ†å‚ä¸è€…æ”¶åˆ°äº†Commitè¯·æ±‚ã€‚äºæ˜¯ï¼Œè¿™éƒ¨åˆ†æ”¶åˆ°äº†Commitè¯·æ±‚çš„å‚ä¸è€…å°±ä¼šè¿›è¡Œäº‹åŠ¡çš„æäº¤ï¼Œè€Œå…¶ä»–æ²¡æœ‰æ”¶åˆ°Commitè¯·æ±‚çš„å‚ä¸è€…åˆ™æ— æ³•è¿›è¡Œäº‹åŠ¡æäº¤ï¼Œäºæ˜¯æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§ç°è±¡\n\n**å¤ªè¿‡ä¿å®ˆ**\n\nåè°ƒè€…æŒ‡ç¤ºå‚ä¸è€…è¿›è¡Œäº‹åŠ¡æäº¤è¯¢é—®çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‚ä¸è€…å‡ºç°æ•…éšœçš„è¯ï¼Œåè°ƒè€…ä¾é çš„è‡ªèº«çš„è¶…æ—¶æœºåˆ¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸­æ–­äº‹åŠ¡ï¼Œè¿™æ ·çš„ç­–ç•¥æ¯”è¾ƒä¿å®ˆï¼Œæ²¡æœ‰è¾ƒä¸ºå®Œå–„çš„é‡è¯•æœºåˆ¶ï¼Œä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„å¤±è´¥éƒ½ä¼šå¯¼è‡´äº‹åŠ¡å¤±è´¥\n\n##### 3PC\n\n###### åè®®è¯´æ˜\n\n2PCçš„æ”¹è¿›ç‰ˆï¼Œå…¶å°†äºŒé˜¶æ®µæäº¤åè®®çš„â€œæäº¤äº‹åŠ¡è¯·æ±‚â€è¿‡ç¨‹ä¸€åˆ†ä¸ºäºŒï¼Œå½¢æˆç”±`CanCommit`ã€`PreCommit`å’Œ`doCommit`ä¸‰ä¸ªé˜¶æ®µç»„æˆçš„äº‹åŠ¡å¤„ç†åè®®\n\n![20220601184902017](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220601184902017.jpg)\n\n###### é˜¶æ®µä¸€ï¼šCanCommit\n\n1.   äº‹åŠ¡è¯¢é—®\n\n     åè°ƒè€…å‘æ‰€æœ‰çš„å‚ä¸è€…å‘é€ä¸€ä¸ªåŒ…å«äº‹åŠ¡å†…å®¹çš„`canCommit`è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶å¼€å§‹ç­‰å¾…å„å‚ä¸è€…çš„å“åº”ã€‚\n\n2.   å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆäº‹åŠ¡è¯¢é—®çš„å“åº”\n\n     å‚ä¸è€…åœ¨æ¥æ”¶åˆ°æ¥è‡ªåè°ƒè€…çš„`canCommit`è¯·æ±‚åï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœå…¶è‡ªèº«è®¤ä¸ºå¯ä»¥é¡ºåˆ©æ‰§è¡Œäº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šåé¦ˆYeså“åº”ï¼Œå¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ï¼Œå¦åˆ™åé¦ˆNoå“åº”ã€‚\n\n###### é˜¶æ®µäºŒï¼šPreCommit\n\nåè°ƒè€…ä¼šæ ¹æ®åé¦ˆæƒ…å†µæ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›è¡Œäº‹åŠ¡çš„`PreCommit`æ“ä½œï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼ŒåŒ…å«ä¸¤ç§å¯èƒ½ã€‚\n\n-   æ‰§è¡Œäº‹åŠ¡é¢„æäº¤\n\n    æ‰€æœ‰çš„å‚ä¸è€…åé¦ˆéƒ½æ˜¯Yesï¼Œé‚£ä¹ˆæ‰§è¡Œäº‹åŠ¡é¢„æäº¤\n\n    1.   å‘é€é¢„æäº¤è¯·æ±‚\n\n         åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€`preCommit`è¯·æ±‚ï¼Œå¹¶è¿›å…¥`Prepared`é˜¶æ®µ\n\n    2.   äº‹åŠ¡é¢„æäº¤\n\n         å‚ä¸è€…æ¥æ”¶åˆ°åä¼šæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°†Undoå’ŒRedoä¿¡æ¯è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ä¸­\n\n    3.   å„å‚ä¸è€…å‘åè°ƒè€…åé¦ˆäº‹åŠ¡æ‰§è¡Œå“åº”\n\n         å¦‚æœå‚ä¸è€…æˆåŠŸæ‰§è¡Œäº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šåé¦ˆç»™åè°ƒè€…Ackå“åº”ï¼ŒåŒæ—¶ç­‰å¾…æœ€ç»ˆçš„æŒ‡ä»¤ï¼šæäº¤ï¼ˆcommitï¼‰æˆ–ä¸­æ­¢ï¼ˆabortï¼‰\n\n-   ä¸­æ–­äº‹åŠ¡\n\n    æœ‰ä»»ä½•ä¸€ä¸ªå‚ä¸è€…åé¦ˆNoï¼Œæˆ–è€…åœ¨ç­‰å¾…è¶…æ—¶ä¹‹åï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡\n\n    1.   å‘é€ä¸­æ–­è¯·æ±‚\n\n         åè°ƒè€…å‘é€`abort`è¯·æ±‚\n\n    2.   ä¸­æ–­äº‹åŠ¡\n\n         æ— è®ºæ˜¯æ”¶åˆ°åè°ƒè€…çš„`abort`è¯·æ±‚ï¼Œè¿˜æ˜¯ç­‰å¾…åè°ƒè€…è¯·æ±‚è¶…æ—¶ï¼Œå‚ä¸è€…éƒ½ä¼šä¸­æ–­äº‹åŠ¡\n\n###### é˜¶æ®µä¸‰ï¼šdoCommit\n\nçœŸæ­£è¿›è¡Œäº‹åŠ¡æäº¤ï¼Œå­˜åœ¨ä¸¤ç§æƒ…å†µ\n\n-   æ‰§è¡Œæäº¤\n\n    1.   å‘é€æäº¤è¯·æ±‚\n\n         å‡è®¾åè°ƒè€…å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œå¹¶ä¸”æ”¶åˆ°äº†æ‰€æœ‰å‚ä¸è€…çš„Ackå“åº”ï¼Œé‚£ä¹ˆå®ƒå°†ä»â€œé¢„æäº¤â€è½¬æ¢åˆ°â€œæäº¤â€çŠ¶æ€ï¼Œå¹¶å‘æ‰€æœ‰å‚ä¸è€…å‘é€`doCommit`è¯·æ±‚\n\n    2.   äº‹åŠ¡æäº¤\n\n         å‚ä¸è€…æ¥æ”¶åˆ°`doCommit`è¯·æ±‚åï¼Œä¼šæ­£å¼æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œï¼Œå¹¶åœ¨å®Œæˆæäº¤ä¹‹åé‡Šæ”¾èµ„æº\n\n    3.   åé¦ˆäº‹åŠ¡æäº¤ç»“æœ\n\n         å‘åè°ƒè€…å‘é€Ack\n\n    4.   å®Œæˆäº‹åŠ¡\n\n         åè°ƒè€…æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„Ackåå®Œæˆäº‹åŠ¡\n\n-   ä¸­æ–­äº‹åŠ¡\n\n    å‡è®¾åè°ƒè€…å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œå¹¶ä¸”æœ‰ä»»æ„ä¸€ä¸ªå‚ä¸è€…å‘åè°ƒè€…å‘é€äº†Noå“åº”ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šä¸­æ–­äº‹åŠ¡\n\n    1.   å‘é€ä¸­æ–­è¯·æ±‚\n\n         åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…èŠ‚ç‚¹å‘é€`abort`è¯·æ±‚\n\n    2.   äº‹åŠ¡å›æ»š\n\n         å‚ä¸è€…æ¥æ”¶åˆ°`abort`è¯·æ±‚åï¼Œä¼šåˆ©ç”¨é˜¶æ®µäºŒä¸­è®°å½•çš„Undoä¿¡æ¯è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œä¹‹åé‡Šæ”¾èµ„æº\n\n    3.   åé¦ˆäº‹åŠ¡å›æ»šç»“æœ\n\n         å‘åè°ƒè€…å‘é€Ack\n\n    4.   ä¸­æ–­äº‹åŠ¡\n\n         åè°ƒè€…æ¥æ”¶æ‰€æœ‰å‚ä¸è€…åé¦ˆçš„Ackåä¸­æ–­äº‹åŠ¡\n\n>   æ³¨æ„ï¼šä¸€æ—¦è¿›å…¥é˜¶æ®µä¸‰ï¼Œå¯èƒ½ä¼šå­˜åœ¨ä»¥ä¸‹æ•…éšœ\n>\n>   -   åè°ƒè€…å‡ºç°é—®é¢˜\n>   -   åè°ƒè€…å’Œå‚ä¸è€…ä¹‹é—´çš„ç½‘ç»œå‡ºç°æ•…éšœ\n\næ— è®ºå“ªç§ï¼Œæœ€ç»ˆéƒ½ä¼šå¯¼è‡´å‚ä¸è€…æ— æ³•æ¥æ”¶åˆ°åè°ƒè€…çš„`doCommit`æˆ–`abort`è¯·æ±‚ï¼Œå‚ä¸è€…ä¼šåœ¨ç­‰å¾…è¶…æ—¶ä¹‹åç»§ç»­è¿›è¡Œäº‹åŠ¡æäº¤\n\n###### ä¼˜ç¼ºç‚¹\n\nç›¸è¾ƒäºäºŒé˜¶æ®µï¼Œæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯é™ä½å‚ä¸è€…çš„é˜»å¡èŒƒå›´ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨å‡ºç°å•ç‚¹æ•…éšœåç»§ç»­è¾¾æˆä¸€è‡´\n\n>   ???\n\nç¼ºç‚¹ï¼šå‚ä¸è€…åœ¨æ¥æ”¶åˆ°`PreCommit`æ¶ˆæ¯åï¼Œå¦‚æœå‡ºç°ç½‘ç»œåˆ†åŒºï¼Œæ­¤æ—¶åè°ƒè€…æ‰€åœ¨çš„èŠ‚ç‚¹å’Œå‚ä¸è€…æ— æ³•è¿›è¡Œæ­£å¸¸çš„ç½‘ç»œé€šä¿¡ï¼Œè¿™ç§æƒ…å†µä¸‹å‚ä¸è€…ä»ç„¶ä¼šè¿›è¡Œäº‹åŠ¡æäº¤ï¼Œè¿™ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´æ€§\n\n\n#### Paxosç®—æ³•\n\nPaxos[ËˆpÃ¦ksoÊŠs]\n\nåŸºäºæ¶ˆæ¯ä¼ é€’ä¸”å…·æœ‰é«˜åº¦å®¹é”™ç‰¹æ€§çš„ä¸€è‡´æ€§ç®—æ³•\n\n##### æ‹œå åº­å°†å†›é—®é¢˜\n\n![20220607100552312](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220607100552312.jpg)\n\nç†è®ºä¸Šæ¥è¯´è¯•å›¾åœ¨å¼‚æ­¥ç³»ç»Ÿå’Œä¸å¯é çš„é€šé“ä¸Šæ¥è¾¾åˆ°ä¸€è‡´æ€§çŠ¶æ€æ˜¯ä¸å¯èƒ½çš„ï¼Œå› æ­¤å¯¹äºä¸€è‡´æ€§çš„ç ”ç©¶éƒ½æ˜¯å‡è®¾ä¿¡é“æ˜¯å¯é çš„ã€‚\n\n-   å¤§å¤šæ•°ç³»ç»Ÿéƒ½æ˜¯éƒ¨ç½²åœ¨å±€åŸŸç½‘å†…çš„ï¼Œå› æ­¤æ¶ˆæ¯è¢«ç¯¡æ”¹çš„æƒ…å†µéå¸¸ç½•è§\n-   ç”±äºç¡¬ä»¶å’Œç½‘ç»œåŸå› è€Œé€ æˆçš„æ¶ˆæ¯ä¸å®Œæ•´é—®é¢˜åªéœ€è¦ä¸€å¥—ç®€å•çš„æ ¡éªŒç®—æ³•å³å¯é¿å…\n\næ‰€ä»¥åœ¨å®é™…å·¥ç¨‹å®è·µä¸­ï¼Œå¯ä»¥å‡è®¾ä¸å­˜åœ¨æ‹œå åº­å°†å†›é—®é¢˜\n\n![20220607101012024](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220607101012024.jpg)\n\n##### Paxosç®—æ³•è¯¦è§£\n\n###### é—®é¢˜æè¿°\n\nå‡è®¾æœ‰ä¸€ç»„å¯ä»¥æå‡ºææ¡ˆçš„è¿›ç¨‹é›†åˆï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•æ¥è¯´éœ€è¦ä¿è¯ä»¥ä¸‹å‡ ç‚¹ï¼š\n\n-   åœ¨è¿™äº›è¢«æå‡ºçš„ææ¡ˆä¸­ï¼Œåªæœ‰ä¸€ä¸ªä¼šè¢«é€‰å®š\n-   å¦‚æœæ²¡æœ‰ææ¡ˆè¢«æå‡ºï¼Œé‚£ä¹ˆå°±ä¸ä¼šæœ‰è¢«é€‰å®šçš„ææ¡ˆ\n-   å½“ä¸€ä¸ªææ¡ˆè¢«é€‰å®šåï¼Œè¿›ç¨‹åº”è¯¥å¯ä»¥è·å–è¢«é€‰å®šçš„ææ¡ˆä¿¡æ¯\n\nå¯¹äºä¸€è‡´æ€§æ¥è¯´ï¼Œå®‰å…¨æ€§ï¼ˆSafetyï¼‰éœ€æ±‚å¦‚ä¸‹ï¼š\n\n-   åªæœ‰è¢«æå‡ºçš„ææ¡ˆæ‰èƒ½è¢«é€‰å®š\n-   åªèƒ½æœ‰ä¸€ä¸ªå€¼è¢«é€‰å®š\n-   å¦‚æœæŸä¸ªè¿›ç¨‹è®¤ä¸ºæŸä¸ªææ¡ˆè¢«é€‰å®šäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªææ¡ˆå¿…é¡»æ˜¯çœŸçš„è¢«é€‰å®šçš„é‚£ä¸ª\n\nåœ¨`Paxos`ç®—æ³•ä¸­ï¼Œæœ‰ä¸‰ç§å‚ä¸è§’è‰²ï¼Œç”¨`Proposer`ã€`Acceptor`å’Œ`Learner`è¡¨ç¤º\n\nåœ¨å…·ä½“å®ç°ä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å¯èƒ½å……å½“ä¸æ­¢ä¸€ç§è§’è‰²ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒè¿›ç¨‹å¦‚ä½•æ˜ å°„åˆ°å„ç§è§’è‰²ã€‚\n\nå‡è®¾ä¸åŒå‚ä¸è€…ä¹‹é—´å¯ä»¥é€šè¿‡æ”¶å‘æ¶ˆæ¯æ¥è¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆï¼š\n\n-   æ¯ä¸ªå‚ä¸è€…ä»¥ä»»æ„çš„é€Ÿåº¦æ‰§è¡Œï¼Œå¯èƒ½ä¼šå› ä¸ºå‡ºé”™è€Œåœæ­¢ï¼Œä¹Ÿå¯èƒ½ä¼šé‡å¯ã€‚åŒæ—¶ï¼Œå³ä½¿ä¸€ä¸ªææ¡ˆè¢«é€‰å®šåï¼Œæ‰€æœ‰çš„å‚ä¸è€…ä¹Ÿéƒ½æœ‰å¯èƒ½å¤±è´¥æˆ–é‡å¯ï¼Œå› æ­¤é™¤éé‚£äº›å¤±è´¥æˆ–é‡å¯çš„å‚ä¸è€…å¯ä»¥è®°å½•æŸäº›ä¿¡æ¯ï¼Œå¦åˆ™å°†æ— æ³•ç¡®å®šæœ€ç»ˆçš„å€¼ã€‚\n-   æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°ä¸å¯é¢„çŸ¥çš„å»¶è¿Ÿï¼Œä¹Ÿå¯èƒ½ä¼šé‡å¤æˆ–ä¸¢å¤±ï¼Œä½†æ˜¯æ¶ˆæ¯ä¸ä¼šè¢«æŸåï¼Œå³æ¶ˆæ¯å†…å®¹ä¸ä¼šè¢«ç¯¡æ”¹ï¼ˆæ‹œå åº­å¼é—®é¢˜ï¼‰\n\n###### ææ¡ˆçš„é€‰å®š\n\n**å•ä¸€Acceptor**\n\nè¦é€‰å®šå”¯ä¸€ææ¡ˆçš„æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åªå…è®¸ä¸€ä¸ª`Acceptor`å­˜åœ¨ï¼Œè¿™æ ·`Proposer`åªèƒ½å‘é€ææ¡ˆç»™è¿™ä¸ª`Acceptor`ï¼Œ`Acceptor`ä¼šé€‰æ‹©å®ƒæ¥æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªææ¡ˆä½œä¸ºè¢«é€‰å®šææ¡ˆã€‚\n\nè¿™ç§æ–¹å¼å¾ˆç®€å•ï¼Œä½†æ˜¯ä¸€æ—¦è¿™ä¸ª`Acceptor`å‡ºç°é—®é¢˜ï¼Œæ•´ä¸ªç³»ç»Ÿå°±æ— æ³•å·¥ä½œ\n\n**å¤šä¸ªAcceptor**\n\nä½¿ç”¨å¤šä¸ª`Acceptor`é¿å…å•ç‚¹é—®é¢˜\n\n`Proposer`å‘ä¸€ä¸ª`Acceptor`é›†åˆå‘é€ææ¡ˆï¼Œé›†åˆä¸­çš„æ¯ä¸ª`Acceptor`éƒ½å¯èƒ½ä¼šæ‰¹å‡†è¯¥ææ¡ˆï¼Œå½“æœ‰è¶³å¤Ÿå¤šçš„`Acceptor`æ‰¹å‡†è¿™ä¸ªææ¡ˆçš„æ—¶å€™ï¼ˆæ¯”å¦‚è¯´åŠæ•°ä»¥ä¸Šï¼Ÿï¼‰æˆ‘ä»¬å°±è®¤ä¸ºè¯¥ææ¡ˆè¢«é€‰å®šäº†ã€‚\n\n>   ä»€ä¹ˆæ˜¯è¶³å¤Ÿå¤šï¼Ÿ\n>\n>   å‡å®šè¶³å¤Ÿå¤šçš„`Acceptor`æ˜¯æ•´ä¸ª`Acceptor`é›†åˆçš„å­é›†ï¼Œå¹¶ä¸”è®©è¿™ä¸ªå­é›†å¤§å¾—å¯ä»¥åŒ…å«`Acceptor`é›†åˆä¸­çš„å¤§å¤šæ•°æˆå‘˜ï¼Œå› ä¸ºä»»æ„ä¸¤ä¸ªåŒ…å«å¤§å¤šæ•°`Acceptor`çš„å­é›†è‡³å°‘æœ‰ä¸€ä¸ªå…¬å…±æˆå‘˜ã€‚å¦å¤–å†è§„å®šæ¯ä¸ª`Acceptor`æœ€å¤šåªèƒ½æ‰¹å‡†ä¸€ä¸ªææ¡ˆï¼Œé‚£ä¹ˆå°±èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªææ¡ˆè¢«é€‰å®šäº†ã€‚\n\n**æ¨å¯¼è¿‡ç¨‹**\n\nåœ¨æ²¡æœ‰å¤±è´¥å’Œæ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›å³ä½¿åœ¨åªæœ‰ä¸€ä¸ªææ¡ˆè¢«æå‡ºçš„æƒ…å†µä¸‹ï¼Œä»ç„¶å¯ä»¥é€‰å‡ºä¸€ä¸ªææ¡ˆï¼Œè¿™å°±æš—ç¤ºäº†ä¸€ä¸ªéœ€æ±‚ï¼š\n\n>   P1ï¼šä¸€ä¸ª`Acceptor`å¿…é¡»æ‰¹å‡†å®ƒæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªææ¡ˆ\n\nä½†æ˜¯è¿™ä¸ªéœ€æ±‚ä¼šå¼•å‡ºå¦ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœå¤šä¸ªææ¡ˆè¢«ä¸åŒçš„`Proposer`åŒæ—¶æå‡ºï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´è™½ç„¶æ¯ä¸ª`Acceptor`éƒ½æ‰¹å‡†äº†å®ƒæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªææ¡ˆï¼Œä½†æ˜¯æ²¡æœ‰ä¸€ä¸ªææ¡ˆæ˜¯ç”±å¤šæ•°äººéƒ½æ‰¹å‡†çš„\n\n![20220607205041955](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220607205041955.jpg)\n\nå¦å¤–ï¼Œå³ä½¿åªæœ‰ä¸¤ä¸ªææ¡ˆè¢«æå‡ºï¼Œå¦‚æœæ¯ä¸ªææ¡ˆéƒ½è¢«å·®ä¸å¤šä¸€åŠçš„`Acceptor`æ‰¹å‡†ï¼Œæ­¤æ—¶å³ä½¿åªæœ‰ä¸€ä¸ª`Acceptor`å‡ºé”™ï¼Œéƒ½æœ‰å¯èƒ½å¯¼è‡´æ— æ³•ç¡®å®šè¯¥é€‰å®šå“ªä¸ªææ¡ˆ\n\n![20220607205238893](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220607205238893.jpg)\n\nåœ¨`P1`çš„åŸºç¡€ä¸Šï¼Œå†åŠ ä¸Šä¸€ä¸ªææ¡ˆè¢«é€‰å®šéœ€è¦ç”±åŠæ•°ä»¥ä¸Šçš„`Acceptor`æ‰¹å‡†çš„éœ€æ±‚ï¼Œæš—ç¤ºç€ä¸€ä¸ª`Acceptor`å¿…é¡»èƒ½å¤Ÿæ‰¹å‡†ä¸æ­¢ä¸€ä¸ªææ¡ˆã€‚åœ¨è¿™é‡Œç”¨å…¨å±€çš„ç¼–å·æ¥å”¯ä¸€æ ‡è¯†æ¯ä¸€ä¸ªè¢«`Acceptor`æ‰¹å‡†çš„ææ¡ˆï¼Œå½“ä¸€ä¸ªå…·æœ‰æŸValueå€¼çš„ææ¡ˆè¢«åŠæ•°ä»¥ä¸Šçš„`Acceptor`æ‰¹å‡†åï¼Œæˆ‘ä»¬å°±è®¤ä¸ºè¯¥Valueè¢«é€‰å®šäº†ï¼Œæ­¤æ—¶æˆ‘ä»¬ä¹Ÿè®¤ä¸ºè¯¥ææ¡ˆè¢«é€‰å®šäº†ã€‚\n\n>   æ­¤å¤„è®²çš„ææ¡ˆå·²ç»å’ŒValueä¸æ˜¯åŒä¸€ä¸ªæ¦‚å¿µäº†ï¼Œææ¡ˆå˜æˆäº†ç”±ç¼–å·å’ŒValueç»„æˆçš„ç»„åˆä½“ï¼Œå³`[ç¼–å·, Value]`æ¥è¡¨ç¤ºä¸€ä¸ªææ¡ˆ\n\nè™½ç„¶å…è®¸å¤šä¸ªææ¡ˆè¢«é€‰å®šï¼Œä½†åŒæ—¶å¿…é¡»è¦ä¿è¯æ‰€æœ‰è¢«é€‰å®šçš„ææ¡ˆéƒ½å…·æœ‰ç›¸åŒçš„Valueå€¼ï¼Œç»“åˆææ¡ˆçš„ç¼–å·ï¼Œè¯¥çº¦å®šå¯ä»¥å®šä¹‰å¦‚ä¸‹ï¼š\n\n>   P2ï¼šå¦‚æœç¼–å·ä¸ºM~0~ã€Valueå€¼ä¸ºV~0~çš„ææ¡ˆï¼ˆå³[M~0~, V~0~]ï¼‰è¢«é€‰å®šäº†ï¼Œé‚£ä¹ˆæ‰€æœ‰æ¯”ç¼–å·M~0~æ›´é«˜çš„ï¼Œä¸”è¢«é€‰å®šçš„ææ¡ˆï¼Œå…¶Valueå€¼å¿…é¡»ä¹Ÿæ˜¯V~0~\n\n### ç¬¬4ç«  ZooKeeperä¸Paxos\n\n#### åˆè¯†ZooKeeper\n\n##### ZooKeeperä¸­çš„åŸºæœ¬æ¦‚å¿µ\n\n###### é›†ç¾¤è§’è‰²\n\n>   é€šå¸¸åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ„æˆä¸€ä¸ªé›†ç¾¤çš„æ¯ä¸€å°æœºå™¨éƒ½æœ‰è‡ªå·±çš„è§’è‰²ï¼Œæœ€å…¸å‹çš„å°±æ˜¯ä¸»ä»æ¨¡å¼ï¼ˆMaste/Slaveï¼‰ã€‚\n>\n>   -   Masteræœºå™¨ï¼šèƒ½å¤Ÿå¤„ç†æ‰€æœ‰å†™æ“ä½œ\n>   -   Slaveæœºå™¨ï¼šé€šè¿‡å¼‚æ­¥å¤åˆ¶æ–¹å¼è·å–æœ€æ–°æ•°æ®ï¼Œå¹¶æä¾›è¯»æœåŠ¡çš„æœºå™¨\n\nä½†æ˜¯åœ¨ZooKeeperä¸­ï¼Œå®ƒæ²¡æœ‰æ²¿ç”¨ä¼ ç»Ÿçš„Master/Slaveæ¦‚å¿µï¼Œè€Œæ˜¯å¼•å…¥Leaderã€Followerå’ŒObserverä¸‰ç§è§’è‰²ã€‚\n\n-   æ‰€æœ‰æœºå™¨é€šè¿‡Leaderé€‰ä¸¾è¿‡ç¨‹æ¥é€‰å®šä¸€å°Leaderæœºå™¨ï¼ŒLeaderæœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯æä¾›è¯»å’Œå†™æœåŠ¡\n-   Followerå’ŒObserveréƒ½èƒ½æä¾›è¯»æœåŠ¡ï¼ŒåŒºåˆ«åœ¨äºObserverä¸å‚ä¸Leaderé€‰ä¸¾è¿‡ç¨‹ï¼Œä¹Ÿä¸å‚ä¸å†™æ“ä½œçš„â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ï¼Œå› æ­¤`Observerå¯ä»¥åœ¨ä¸å½±å“å†™æ€§èƒ½çš„æƒ…å†µä¸‹æå‡é›†ç¾¤çš„è¯»æ€§èƒ½`\n\n###### ä¼šè¯ï¼ˆSessionï¼‰\n\næŒ‡å®¢æˆ·ç«¯ä¼šè¯ï¼ŒZooKeeperä¸­ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æ˜¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„`TCPé•¿è¿æ¥`ã€‚å®¢æˆ·ç«¯å¯åŠ¨çš„æ—¶å€™ä¸æœåŠ¡å™¨å»ºç«‹TCPè¿æ¥ï¼Œä»ç¬¬ä¸€æ¬¡è¿æ¥å»ºç«‹å¼€å§‹ï¼Œå®¢æˆ·ç«¯ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸå°±å¼€å§‹äº†ï¼Œå®¢æˆ·ç«¯é€šè¿‡`å¿ƒè·³æ£€æµ‹`ä¸æœåŠ¡å™¨ä¿æŒæœ‰æ•ˆçš„ä¼šè¯ã€‚\n\nSessionçš„`sessionTimeout`ç”¨æ¥è®¾ç½®å®¢æˆ·ç«¯ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œå½“ç”±äºæœåŠ¡å™¨å‹åŠ›å¤ªå¤§ã€ç½‘ç»œæ•…éšœæˆ–æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ç­‰åŸå› å¯¼è‡´å®¢æˆ·ç«¯è¿æ¥æ–­å¼€ï¼Œåªè¦åœ¨sessionTimeoutè§„å®šæ—¶é—´å†…é‡è¿ï¼Œé‚£ä¹ˆä¹‹å‰åˆ›å»ºçš„ä¼šè¯ä»ç„¶æœ‰æ•ˆã€‚\n\n###### æ•°æ®èŠ‚ç‚¹ï¼ˆZNodeï¼‰\n\nZooKeeperä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç±»\n\n-   æ„æˆé›†ç¾¤çš„æœºå™¨ï¼Œç§°ä¸ºæœºå™¨èŠ‚ç‚¹\n-   æ•°æ®æ¨¡å‹ä¸­çš„æ•°æ®å•å…ƒï¼Œç§°ä¸ºæ•°æ®èŠ‚ç‚¹â€”â€”ZNode\n\nZooKeeperå°†æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®æ¨¡å‹æ˜¯ä¸€é¢—æ ‘ï¼ˆZNode Treeï¼‰ï¼Œç”±æ–œæ ï¼ˆ/ï¼‰è¿›è¡Œåˆ†å‰²çš„è·¯å¾„ï¼Œå°±æ˜¯ä¸€ä¸ªZNodeã€‚æ¯ä¸ªZNodeä¸Šä¼šä¿å­˜è‡ªå·±çš„æ•°æ®å†…å®¹ï¼ŒåŒæ—¶è¿˜ä¼šä¿å­˜ä¸€ç³»åˆ—å±æ€§ä¿¡æ¯ã€‚\n\n**æ•°æ®èŠ‚ç‚¹åˆ†ç±»**\n\n-   æŒä¹…èŠ‚ç‚¹\n\n    ä¸€æ—¦åˆ›å»ºï¼Œé™¤éä¸»åŠ¨ç§»é™¤ï¼Œå¦åˆ™ä¼šä¸€ç›´ä¿å­˜åœ¨ZooKeeperä¸­\n\n-   ä¸´æ—¶èŠ‚ç‚¹\n\n    ç”Ÿå‘½å‘¨æœŸä¸å®¢æˆ·ç«¯ä¼šè¯ç»‘å®šï¼Œä¸€æ—¦å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œè¿™ä¸ªå®¢æˆ·ç«¯åˆ›å»ºçš„ä¸´æ—¶èŠ‚ç‚¹å°±ä¼šè¢«ç§»é™¤\n\n    ZooKeeperè¿˜å…è®¸ç”¨æˆ·ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼šSEQUENTIALã€‚ä¸€æ—¦èŠ‚ç‚¹è¢«æ ‡è®°è¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªèŠ‚ç‚¹åˆ›å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨åœ¨èŠ‚ç‚¹ååé¢è¿½åŠ ä¸Šä¸€ä¸ªæ•´å‹æ•°å­—ï¼Œè¿™ä¸ªæ•´å‹æ•°å­—æ˜¯ç”±çˆ¶èŠ‚ç‚¹ç»´æŠ¤çš„è‡ªå¢æ•°å­—\n\n###### ç‰ˆæœ¬\n\nZooKeeperçš„æ¯ä¸ªZNodeä¸Šéƒ½ä¼šå­˜å‚¨æ•°æ®ï¼ŒZooKeeperä¼šç»´æŠ¤ä¸€ä¸ªå«ä½œ`Stat`çš„æ•°æ®ç»“æ„ï¼ŒStatä¸­è®°å½•äº†è¿™ä¸ªZNodeçš„ä¸‰ä¸ªæ•°æ®ç‰ˆæœ¬ï¼Œåˆ†åˆ«æ˜¯versionï¼ˆå½“å‰ZNodeçš„ç‰ˆæœ¬ï¼‰ã€cversionï¼ˆå½“å‰ZNodeå­èŠ‚ç‚¹ç‰ˆæœ¬ï¼‰å’Œaversionï¼ˆå½“å‰ZNodeçš„ACLç‰ˆæœ¬ï¼‰\n\n###### Watcher\n\näº‹ä»¶ç›‘å¬å™¨ï¼ŒZooKeeperå…è®¸ç”¨æˆ·åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€äº›Watcherï¼Œå¹¶ä¸”åœ¨ä¸€äº›ç‰¹å®šäº‹ä»¶è§¦å‘æ—¶ï¼ŒZooKeeperä¼šå°†äº‹ä»¶é€šçŸ¥åˆ°æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯ä¸Š\n\n###### ACL\n\nAccess Control Listsï¼Œä¸€ç§æƒé™æ§åˆ¶ç­–ç•¥ï¼Œç±»ä¼¼äºUNIXæ–‡ä»¶ç³»ç»Ÿçš„æƒé™æ§åˆ¶ã€‚ZooKeeperå®šä¹‰äº†5ç§æƒé™\n\n-   CREATEï¼šåˆ›å»ºå­èŠ‚ç‚¹æƒé™\n-   READï¼šè·å–èŠ‚ç‚¹æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨çš„æƒé™\n-   WRITEï¼šæ›´æ–°èŠ‚ç‚¹æ•°æ®çš„æƒé™\n-   DELETEï¼šåˆ é™¤å­èŠ‚ç‚¹çš„æƒé™\n-   ADMINï¼šè®¾ç½®èŠ‚ç‚¹ACLçš„æƒé™\n\n>   æ³¨æ„ï¼šCREATEå’ŒDELETEéƒ½æ˜¯é’ˆå¯¹å­èŠ‚ç‚¹çš„æƒé™æ§åˆ¶\n\n\n\n\n\n#### ZooKeeperçš„ZABåè®®\n\n### ç¬¬5ç«  ä½¿ç”¨ZooKeeper\n\n#### å®‰è£…éƒ¨ç½²\n\n1.   å®‰è£…JRE\n\n     -   yumå®‰è£…\n\n         ```bash\n         yum search java\n         ...\n         java-1.8.0-openjdk.x86_64 : OpenJDK 8 Runtime Environment\n         java-1.8.0-openjdk-accessibility.i686 : OpenJDK accessibility connector\n         java-1.8.0-openjdk-accessibility.x86_64 : OpenJDK accessibility connector\n         java-1.8.0-openjdk-demo.i686 : OpenJDK Demos 8\n         java-1.8.0-openjdk-demo.x86_64 : OpenJDK 8 Demos\n         java-1.8.0-openjdk-devel.i686 : OpenJDK Development Environment 8\n         java-1.8.0-openjdk-devel.x86_64 : OpenJDK 8 Development Environment\n         java-1.8.0-openjdk-headless.i686 : OpenJDK Headless Runtime Environment 8\n         java-1.8.0-openjdk-headless.x86_64 : OpenJDK 8 Headless Runtime Environment\n         java-1.8.0-openjdk-javadoc.noarch : OpenJDK 8 API documentation\n         java-1.8.0-openjdk-javadoc-zip.noarch : OpenJDK 8 API documentation compressed in a single archive\n         java-1.8.0-openjdk-src.i686 : OpenJDK Source Bundle 8\n         java-1.8.0-openjdk-src.x86_64 : OpenJDK 8 Source Bundle\n         ...\n         ```\n\n         ä»æè¿°å¯ä»¥çœ‹å‡ºå„ä¸ªåŒ…çš„åŒºåˆ«ï¼Œé€‰æ‹©jreå®‰è£…å°±è¡Œäº†\n\n         `yum install java-1.8.0-openjdk.x86_64`\n\n     -   aptå®‰è£…\n\n     -   æºç å®‰è£…\n\n2.   å®‰è£…ZooKeeper\n\n     1.   å®˜ç½‘ä¸‹è½½åœ°å€ï¼š[https://zookeeper.apache.org/releases.html](https://zookeeper.apache.org/releases.html)\n\n          æ¸…åé•œåƒåœ°å€ï¼š[https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper](https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper)\n\n          ```bash\n          wget https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.7.1/apache-zookeeper-3.7.1-bin.tar.gz\n          ###å¯èƒ½å‡ºç°###\n          Resolving mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)... 101.6.15.130, 2402:f000:1:400::2\n          Connecting to mirrors.tuna.tsinghua.edu.cn (mirrors.tuna.tsinghua.edu.cn)|101.6.15.130|:443... connected.\n          ERROR: cannot verify mirrors.tuna.tsinghua.edu.cn's certificate, issued by '/C=US/O=Let\\'s Encrypt/CN=R3':\n            Issued certificate has expired.\n          To connect to mirrors.tuna.tsinghua.edu.cn insecurely, use `--no-check-certificate'.\n          \n          \n          åŠ ä¸Š --no-check-certificate é€‰é¡¹å³å¯\n          # wget --no-check-certificate https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/zookeeper-3.7.1/apache-zookeeper-3.7.1-bin.tar.gz\n          ```\n\n     2.   è§£åŒ…\n\n          ```bash\n          tar -zxvf apache-zookeeper-3.7.1-bin.tar.gz\n          # å‚æ•°è§£é‡Š\n          # -z: é€šè¿‡gzipæŒ‡ä»¤å‹ç¼©/è§£å‹ç¼©æ–‡ä»¶ï¼Œæ–‡ä»¶åæœ€å¥½ä¸º*.tar.gz\n          # -x: ä»å½’æ¡£æ–‡ä»¶ä¸­æå–æ–‡ä»¶\n          # -v: æ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹\n          # -f: æŒ‡å®šå¤‡ä»½ï¼ˆå‹ç¼©ï¼‰æ–‡ä»¶\n          ```\n\n     3.   æ‹·è´é…ç½®æ–‡ä»¶\n\n          `conf`ç›®å½•ä¸‹æœ‰ä¸ªæ ·ä¾‹é…ç½®ï¼Œæ‹·è´ä¸€ä»½é‡å‘½åä¸º`zoo.cfg`\n\n          ```bash\n          cd apache-zookeeper-3.7.1-bin\n          cd conf\n          cp zoo_sample.cfg zoo.cfg\n          ```\n\n     4.   å¯åŠ¨æœåŠ¡ç«¯\n\n          ```bash\n          # å›é€€åˆ°binç›®å½•\n          cd ../bin\n          ./zkServer.sh start\n          ```\n\n     å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š\n\n     ```bash\n     /usr/bin/java\n     ZooKeeper JMX enabled by default\n     Using config: /opt/apache-zookeeper-3.7.1/bin/../conf/zoo.cfg\n     Starting zookeeper ... FAILED TO START\n     \n     # ä½¿ç”¨å‰å°è¿è¡ŒæŸ¥çœ‹æ—¥å¿—ä¿¡æ¯\n     ./zkServer.sh start-foreground\n     /usr/bin/java\n     ZooKeeper JMX enabled by default\n     Using config: /opt/apache-zookeeper-3.7.1/bin/../conf/zoo.cfg\n     Error: Could not find or load main class org.apache.zookeeper.server.quorum.QuorumPeerMain\n     # å¯ä»¥çœ‹åˆ°åŸå› åœ¨äºæ‰¾ä¸åˆ°ä¸»ç±»\n     ```\n\n     è§£å†³æ–¹æ¡ˆï¼šè¦ä¸‹è½½åå­—å¸¦`bin`çš„å‹ç¼©åŒ…ï¼Œä¸å¸¦`bin`çš„å±äºæºç åŒ…ï¼Œéœ€è¦è‡ªè¡Œè¿›è¡Œç¼–è¯‘ï¼Œç¼ºå°‘äº†`jar`åŒ…å½“ç„¶å°±æ‰¾ä¸åˆ°ä¸»ç±»äº†\n\n     å·¦å›¾ä¸ºæºç åŒ…ï¼Œå³å›¾ä¸º`bin`åŒ…\n\n     ![20220606202341162](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220606202341162.jpg)\n\n     æºç ç¼–è¯‘å‚ç…§`README_packaging.md`æ–‡æ¡£æ“ä½œå°±å¯ä»¥äº†\n\n     -   æºç å®‰è£…ï¼ˆTODOï¼‰\n\n     \n\n     æŸ¥çœ‹æœåŠ¡ç«¯çŠ¶æ€\n\n     ```bash\n     ./zkServer.sh status\n     /usr/bin/java\n     ZooKeeper JMX enabled by default\n     Using config: /opt/apache-zookeeper-3.7.1-bin/bin/../conf/zoo.cfg\n     Client port found: 2181. Client address: localhost. Client SSL: false.\n     Mode: standalone\n     ```\n\n\n**å‚æ•°é…ç½®**\n\n-   é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé›†ç¾¤ä¸­çš„æ¯å°æœºå™¨éƒ½éœ€è¦æ„ŸçŸ¥åˆ°æ•´ä¸ªé›†ç¾¤æ˜¯ç”±å“ªå‡ å°æœºå™¨ç»„æˆçš„\n\n    `server.id=host:port:port`\n\n    `id`ä¸ºServer IDï¼Œç”¨æ¥æ ‡è¯†æœºå™¨åœ¨é›†ç¾¤ä¸­çš„æœºå™¨åºå·ã€‚åŒæ—¶åœ¨æ¯å°æœºå™¨ä¸Šï¼Œéœ€è¦åœ¨æ•°æ®ç›®å½•åˆ›å»ºä¸€ä¸ª`myid`æ–‡ä»¶ï¼Œé‡Œé¢å†™å…¥æœºå™¨çš„`id`ï¼Œéœ€è¦ç¡®ä¿æ¯ä¸ªæœºå™¨çš„`myid`æ–‡ä»¶ä¸­çš„æ•°å­—ä¸åŒï¼Œæ•°å­—èŒƒå›´åœ¨1~255ã€‚\n\n    å¦‚ï¼š\n    \n    ```properties\n    server.1=IP1:2888:3888\n    server.2=IP2:2888:3888\n    server.3=IP3:2888:3888\n    ```\n    \n    ```bash\n    # æŸ¥çœ‹çŠ¶æ€\n    ./zkServer.sh status\n    /usr/bin/java\n    ZooKeeper JMX enabled by default\n    Using config: /opt/apache-zookeeper-3.7.1-bin/bin/../conf/zoo.cfg\n    Client port found: 2181. Client address: localhost. Client SSL: false.\n    Mode: follower # å¯ä»¥çœ‹åˆ°è¯¥æœºå™¨å±äºfollower\n    ```\n\n#### å®¢æˆ·ç«¯è„šæœ¬\n\n`bin`ç›®å½•ä¸‹çš„`zkCli.sh`å’Œ`zkCli.cmd`å°±æ˜¯å®¢æˆ·ç«¯è„šæœ¬\n\næ‰§è¡Œè„šæœ¬å³å¯è¿æ¥è‡³ZooKeeperæœåŠ¡ç«¯\n\n```bash\nbin/zkCli.sh\n```\n\næˆåŠŸè¿æ¥æ—¶ä¼šæœ‰ä»¥ä¸‹è¾“å‡º\n\n```bash\nWatchedEvent state:SyncConnected type:None path:null\n[zk: localhost:2181(CONNECTED) 0]\n```\n\nå¦‚æœæ²¡æœ‰æ˜¾ç¤ºæŒ‡å®šæœåŠ¡å™¨åœ°å€ï¼Œé»˜è®¤è¿æ¥çš„æ˜¯æœ¬åœ°ZooKeeperæœåŠ¡å™¨\n\n```bash\n# è¯¥å‘½ä»¤å¯ä»¥è¿æ¥æŒ‡å®šZooKeeperæœåŠ¡å™¨\nbin/zkCli.sh -server ip:port\n```\n\n##### åˆ›å»º\n\n`create`å‘½ä»¤ç”¨äºåˆ›å»ºä¸€ä¸ªZooKeeperèŠ‚ç‚¹\n\n```bash\ncreate [-s] [-e] path data acl\n```\n\n>   è¯´æ˜ï¼š\n>\n>   -sï¼šé¡ºåºèŠ‚ç‚¹\n>\n>   -eï¼šä¸´æ—¶èŠ‚ç‚¹\n>\n>   pathï¼šèŠ‚ç‚¹è·¯å¾„ï¼Œå¿…é¡»ä»¥`/`å¼€å¤´\n>\n>   dataï¼šèŠ‚ç‚¹çš„å€¼\n>\n>   aclï¼šèŠ‚ç‚¹æƒé™ä¿¡æ¯ï¼Œä¸æ˜¯å¿…é¡»çš„ï¼Œç¼ºçœæƒ…å†µä¸‹ä¸åšä»»ä½•æƒé™æ§åˆ¶\n\n```bash\n[zk: localhost:2181(CONNECTED) 0] create /crayon 0\nCreated /crayon\n```\n\n##### è¯»å–\n\nä¸è¯»å–ç›¸å…³çš„å‘½ä»¤æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯`ls`ã€`get`å’Œ`stat`\n\n`ls`\n\nå¯ä»¥åˆ—å‡ºZooKeeperæŒ‡å®šèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼ˆç¬¬ä¸€çº§å­èŠ‚ç‚¹ï¼‰\n\n```bash\nls path [watch]\n```\n\n>   è¯´æ˜ï¼š\n>\n>   pathï¼šèŠ‚ç‚¹è·¯å¾„\n>\n>   watchï¼šç›‘å¬èŠ‚ç‚¹\n\n```bash\n[zk: localhost:2181(CONNECTED) 1] ls /\n[crayon, zookeeper]\n```\n\n`get`\n\nå¯ä»¥è·å–ZooKeeperæŒ‡å®šèŠ‚ç‚¹çš„æ•°æ®å†…å®¹\n\n```bash\nget path [watch]\n```\n\n```bash\n[zk: localhost:2181(CONNECTED) 2] get /crayon\n0\n```\n\n`stat`\n\nè·å–èŠ‚ç‚¹çš„å±æ€§ä¿¡æ¯\n\n```bash\nstat path [watch]\n```\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] stat /crayon\ncZxid = 0x4\nctime = Thu Jun 09 15:09:52 CST 2022\nmZxid = 0x4\nmtime = Thu Jun 09 15:09:52 CST 2022\npZxid = 0x4\ncversion = 0\ndataVersion = 0\naclVersion = 0\nephemeralOwner = 0x0\ndataLength = 1\nnumChildren = 0\n```\n\n##### æ›´æ–°\n\nä½¿ç”¨`set`å‘½ä»¤ï¼Œå¯ä»¥æ›´æ–°æŒ‡å®šèŠ‚ç‚¹çš„æ•°æ®å†…å®¹\n\n```bash\nset path data [version]\n```\n\n>   è¯´æ˜ï¼š\n>\n>   pathï¼šèŠ‚ç‚¹è·¯å¾„\n>\n>   dataï¼šè¦æ›´æ–°çš„æ•°æ®å†…å®¹\n>\n>   versionï¼šæŒ‡å®šæœ¬æ¬¡æ›´æ–°æ“ä½œæ˜¯åŸºäºZNodeçš„å“ªä¸€ä¸ªæ•°æ®ç‰ˆæœ¬è¿›è¡Œçš„\n\n```bash\n[zk: localhost:2181(CONNECTED) 11] stat /crayon\ncZxid = 0x4\nctime = Thu Jun 09 15:09:52 CST 2022\nmZxid = 0x5\nmtime = Thu Jun 09 15:32:42 CST 2022\npZxid = 0x4\ncversion = 0\ndataVersion = 1 # æ•°æ®ç‰ˆæœ¬ä»0å˜ä¸º1\naclVersion = 0\nephemeralOwner = 0x0\ndataLength = 1\nnumChildren = 0\n```\n\n##### åˆ é™¤\n\nä½¿ç”¨`delete`å‘½ä»¤å¯ä»¥åˆ é™¤ZooKeeperä¸Šçš„æŒ‡å®šèŠ‚ç‚¹\n\n```bash\ndelete path [version]\n```\n\n>   versionå‚æ•°ä¸`set`å‘½ä»¤ä¸­çš„versionå‚æ•°ä½œç”¨ä¸€è‡´\n\n```bash\n[zk: localhost:2181(CONNECTED) 14] delete /crayon\n```\n\nå¦‚æœèŠ‚ç‚¹å­˜åœ¨å­èŠ‚ç‚¹åˆ™ä¼šåˆ é™¤å¤±è´¥\n\n```bash\n[zk: localhost:2181(CONNECTED) 25] delete /crayon\nNode not empty: /crayon\n```\n\n#### Javaå®¢æˆ·ç«¯APIä½¿ç”¨\n\n##### åˆ›å»ºä¼šè¯\n\né€šè¿‡`new ZooKeeper()`åˆ›å»ºä¸€ä¸ªè¿æ¥\n\nè¯¥è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œæ„é€ æ–¹æ³•åœ¨å¤„ç†å®Œæˆå®¢æˆ·ç«¯åˆå§‹åŒ–å·¥ä½œåç«‹å³è¿”å›ï¼Œç”Ÿå‘½å‘¨æœŸè¿›å…¥`CONNECTING`çŠ¶æ€\n\nåœ¨çœŸæ­£å»ºç«‹è¿æ¥ä¹‹åï¼ŒæœåŠ¡ç«¯ä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¸€ä¸ªäº‹ä»¶é€šçŸ¥ï¼Œæ­¤æ—¶æ‰ç®—çœŸæ­£å»ºç«‹äº†ä¼šè¯\n\n```java\n/**\n * @author Crayon\n * @date 2022/6/9 16:18\n * å®¢æˆ·ç«¯è¿æ¥\n */\npublic class ZooKeeperConnectTest {\n    @Test\n    public void test() throws IOException, InterruptedException {\n        final CountDownLatch latch = new CountDownLatch(1);\n        ZooKeeper zooKeeper = new ZooKeeper(\"localhost:2181\", 4000, new Watcher() {\n            public void process(WatchedEvent watchedEvent) {\n                if (watchedEvent.getState() == Event.KeeperState.SyncConnected) {\n                    // å¦‚æœæ”¶åˆ°äº†æœåŠ¡ç«¯çš„å“åº”äº‹ä»¶ï¼šè¿æ¥æˆåŠŸ\n                    latch.countDown();\n                    System.out.println(\"connected!\");\n                }\n            }\n        });\n        System.out.println(\"waiting...\");\n        latch.await();\n        System.out.println(\"State: \" + zooKeeper.getState());\n    }\n}\n```\n\n\n\n**æºå¸¦Sessionè¿›è¡Œè¿æ¥**\n\n```java\n/**\n * @author Crayon\n * @date 2022/6/10 10:46\n * æºå¸¦Sessionä¿¡æ¯è¿›è¡Œè¿æ¥\n */\npublic class ZooKeeperConnectWithSessionIdTest {\n    private static class DefaultWatch implements Watcher {\n        private final String name;\n        private final CountDownLatch latch;\n\n        public DefaultWatch(String name, CountDownLatch latch) {\n            this.name = name;\n            this.latch = latch;\n        }\n\n        public void process(WatchedEvent event) {\n            System.out.printf(\"name: %s, event: %s\\n\", name, event);\n            latch.countDown();\n        }\n    }\n\n    @Test\n    public void test() throws IOException, InterruptedException {\n        String connectString = \"localhost:2181\";\n        int sessionTimeout = 4000;\n        int count = 2;\n        CountDownLatch latch0 = new CountDownLatch(1);\n        CountDownLatch latch = new CountDownLatch(count);\n        ZooKeeper zooKeeper0 = new ZooKeeper(connectString, sessionTimeout, new DefaultWatch(\"zookeeper0\", latch0));\n        latch0.await();\n        long sessionId = zooKeeper0.getSessionId();\n        byte[] sessionPasswd = zooKeeper0.getSessionPasswd();\n        ZooKeeper zooKeeper1 = new ZooKeeper(connectString, sessionTimeout, new DefaultWatch(\"zookeeper1\", latch), 1, \"error-password\".getBytes());\n        ZooKeeper zooKeeper2 = new ZooKeeper(connectString, sessionTimeout, new DefaultWatch(\"zookeeper2\", latch), sessionId, sessionPasswd);\n        System.out.println(\"waiting...\");\n        latch.await();\n        System.out.printf(\"zookeeper0 => sessionId: %d\\n\", sessionId);\n        System.out.printf(\"zookeeper2 => sessionId: %d\\n\", zooKeeper2.getSessionId());\n    }\n}\n```\n\n##### åˆ›å»ºèŠ‚ç‚¹\n\né€šè¿‡`create`æ–¹æ³•å¯ä»¥è¿›è¡ŒèŠ‚ç‚¹çš„åˆ›å»ºï¼Œåˆ†åˆ«`åŒæ­¥`å’Œ`å¼‚æ­¥`ä¸¤ç§æ–¹å¼\n\n-   åŒæ­¥æ–¹å¼\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/10 11:11\n     * åŒæ­¥èŠ‚ç‚¹åˆ›å»º\n     */\n    public class SyncCreateNodeTest {\n        public ZooKeeper getConnect() throws InterruptedException, IOException {\n            final CountDownLatch latch = new CountDownLatch(1);\n            ZooKeeper zooKeeper = ZooKeeperConnectTest.getConnect(new Watcher() {\n                @Override\n                public void process(WatchedEvent event) {\n                    if (event.getState() == Event.KeeperState.SyncConnected) {\n                        System.out.println(\"connected!\");\n                        latch.countDown();\n                    }\n                }\n            });\n            latch.await();\n            return zooKeeper;\n        }\n    \n        public ZooKeeper getConnect(long sessionId, byte[] sessionPasswd) throws InterruptedException, IOException {\n            final CountDownLatch latch = new CountDownLatch(1);\n            ZooKeeper zooKeeper = ZooKeeperConnectTest.getConnect(sessionId, sessionPasswd, new Watcher() {\n                @Override\n                public void process(WatchedEvent event) {\n                    if (event.getState() == Event.KeeperState.SyncConnected) {\n                        System.out.println(\"connected!\");\n                        latch.countDown();\n                    }\n                }\n            });\n            latch.await();\n            return zooKeeper;\n        }\n    \n        @Test\n        public void test() throws InterruptedException, IOException, KeeperException {\n            ZooKeeper zooKeeper = getConnect();\n            byte[] data = \"crayon-data\".getBytes(\"utf-8\");\n            String path = zooKeeper.create(\"/crayon\", data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n            System.out.println(\"path: \" + path);\n            ZooKeeper zooKeeper1 = getConnect(zooKeeper.getSessionId(), zooKeeper.getSessionPasswd());\n            Stat stat = zooKeeper1.exists(\"/crayon\", false);\n            byte[] nodeData = zooKeeper1.getData(\"/crayon\", false, stat);\n            System.out.println(\"data: \" + new String(nodeData, \"utf-8\"));\n        }\n    }\n    ```\n\n    ä¸´æ—¶èŠ‚ç‚¹å±äºä¼šè¯çº§åˆ«ï¼Œå½“è¿æ¥æ–­å¼€åï¼Œåœ¨ä¼šè¯è¿‡æœŸæ—¶é—´å†…æºç›¸åŒçš„ä¼šè¯ä¿¡æ¯é‡è¿çš„è¯ï¼Œä¸´æ—¶èŠ‚ç‚¹ä¾ç„¶å­˜åœ¨\n\n-   å¼‚æ­¥æ–¹å¼ï¼Œé€šè¿‡å¼‚æ­¥å›è°ƒçš„æ–¹å¼è¿›è¡Œé€šçŸ¥\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/10 11:11\n     * å¼‚æ­¥èŠ‚ç‚¹åˆ›å»º\n     */\n    public class AsyncCreateNodeTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException {\n            final CountDownLatch latch = new CountDownLatch(1);\n            ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            byte[] data = \"crayon-data\".getBytes(\"utf-8\");\n            zooKeeper.create(\"/crayon\", data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL, new AsyncCallback.StringCallback() {\n                @Override\n                public void processResult(int rc, String path, Object ctx, String name) {\n                    System.out.println(\"rc: \" + rc);\n                    System.out.println(\"path: \" + path);\n                    System.out.println(\"ctx: \" + ctx);\n                    System.out.println(\"name: \" + name);\n                    latch.countDown();\n                }\n            }, \"ctx\");\n            latch.await();\n        }\n    }\n    \n    ```\n\n    å’ŒåŒæ­¥æ¥å£ä¸åŒçš„æ˜¯ï¼Œå¼‚æ­¥æ¥å£æœ¬èº«ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ä»¥å›è°ƒå‡½æ•°ä¸­çš„å“åº”ç ï¼ˆrcå­—æ®µï¼‰ä½“ç°ï¼Œè€ŒåŒæ­¥æ¥å£å¯¹äºå¤±è´¥çš„æƒ…å†µä¼šæŠ›å‡ºå¼‚å¸¸\n\n    å›è°ƒçš„å‚æ•°è¯´æ˜ï¼š\n\n    ![20220610115820746](images/posts-assets/ä»Paxosåˆ°Zookeeperåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ.assets/20220610115820746.jpg)\n\n    \n\n##### åˆ é™¤èŠ‚ç‚¹\n\nåŒæ ·æœ‰åŒæ­¥ä¸å¼‚æ­¥ä¸¤ç§æ–¹å¼\n\nZooKeeperåªå…è®¸åˆ é™¤å¶å­èŠ‚ç‚¹\n\n-   åŒæ­¥æ–¹å¼\n\n    -   \n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/14 16:36\n     * åŒæ­¥åˆ é™¤èŠ‚ç‚¹\n     */\n    public class SyncDeleteNodeTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException {\n            ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            // åˆ é™¤ä¸å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œversionä¸º-1è¡¨ç¤ºåŒ¹é…ä»»æ„version\n            zooKeeper.delete(\"/inexist-node\", -1);\n            // åˆ é™¤å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯versionä¸å¯¹åº”\n            zooKeeper.delete(\"/crayon\", 1);\n            // åˆ é™¤å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œversionå¯¹åº”\n            zooKeeper.delete(\"/crayon\", 0);\n        }\n    }\n    ```\n\n    æ“ä½œä¸æˆåŠŸåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸\n\n    èŠ‚ç‚¹ä¸å­˜åœ¨ï¼š`org.apache.zookeeper.KeeperException$NoNodeException: KeeperErrorCode = NoNode for /inexist-node`\n\n    èŠ‚ç‚¹ç‰ˆæœ¬ä¸å¯¹åº”ï¼š`org.apache.zookeeper.KeeperException$BadVersionException: KeeperErrorCode = BadVersion for /crayon`\n\n    \n\n-   å¼‚æ­¥æ–¹å¼\n\n    å¼‚æ­¥æ–¹å¼é€šè¿‡çŠ¶æ€ç æ¥åˆ¤æ–­ç»“æœ\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/14 16:36\n     * åŒæ­¥åˆ é™¤èŠ‚ç‚¹\n     */\n    public class AsyncDeleteNodeTest {\n        @Test\n        public void test() throws IOException, InterruptedException {\n            ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            final CountDownLatch latch = new CountDownLatch(3);\n            AsyncCallback.VoidCallback cb = new AsyncCallback.VoidCallback() {\n                @Override\n                public void processResult(int rc, String path, Object ctx) {\n                    latch.countDown();\n                    switch (KeeperException.Code.get(rc)) {\n                        case OK:\n                            System.out.println(\"è¯·æ±‚æˆåŠŸ\");\n                            break;\n                        case NONODE:\n                            System.out.println(\"èŠ‚ç‚¹ä¸å­˜åœ¨\");\n                            break;\n                        case BADVERSION:\n                            System.out.println(\"èŠ‚ç‚¹ç‰ˆæœ¬ä¸å¯¹åº”\");\n                            break;\n                        default:\n                    }\n                    System.out.println(\"result code: \" + rc);\n                    System.out.println(\"path: \" + path);\n                    System.out.println(\"context: \" + ctx);\n                }\n            };\n            // åˆ é™¤ä¸å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œversionä¸º-1è¡¨ç¤ºåŒ¹é…ä»»æ„version\n            zooKeeper.delete(\"/inexist-node\", -1, cb, \"operation-0\");\n            // åˆ é™¤å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯versionä¸å¯¹åº”\n            zooKeeper.delete(\"/crayon\", 1, cb, \"operation-1\");\n            // åˆ é™¤å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œversionå¯¹åº”\n            zooKeeper.delete(\"/crayon\", 0, cb, \"operation-2\");\n    \n            latch.await();\n        }\n    }\n    \n    ```\n\n##### è¯»å–æ•°æ®\n\n###### getChildren\n\n-   åŒæ­¥\n\n    ```java\n/**\n     * @author Crayon\n     * @date 2022/6/14 16:33\n     * åŒæ­¥è·å–èŠ‚ç‚¹æ•°æ®\n     */\n    public class SyncGeChildrenTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException, BrokenBarrierException {\n            final CountDownLatch latch = new CountDownLatch(2);\n            final ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            System.out.println(zooKeeper.getChildren(\"/\", false));\n            Watcher watcher = new Watcher() {\n                @Override\n                public void process(WatchedEvent event) {\n                    if (event.getState() == Event.KeeperState.SyncConnected) {\n                        if (event.getType() == Event.EventType.NodeChildrenChanged) {\n                            try {\n                                System.out.println(\"re-get children: \" + zooKeeper.getChildren(event.getPath(), true));\n                            } catch (Exception e) {\n                                e.printStackTrace();\n                            } finally {\n                                latch.countDown();\n                            }\n                        }\n                    }\n                }\n            };\n            zooKeeper.getChildren(\"/\", watcher);\n            zooKeeper.delete(\"/crayon0\", -1);\n            zooKeeper.delete(\"/crayon1\", -1);\n            latch.await();\n        }\n    }\n    ```\n    \n    >   `Watcher`æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåœ¨ç›‘å¬åˆ°ä¸€æ¬¡é€šçŸ¥å¹¶æ‰§è¡Œä¹‹åå°±æ²¡ç”¨äº†ï¼Œç›‘å¬ä¸‹æ¬¡é€šçŸ¥éœ€è¦é‡æ–°æ³¨å†Œ`Watcher`\n\n-   å¼‚æ­¥\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/14 16:33\n     * å¼‚æ­¥è·å–èŠ‚ç‚¹æ•°æ®\n     */\n    public class AsyncGeChildrenTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException, BrokenBarrierException {\n            final CountDownLatch latch = new CountDownLatch(2);\n            final ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            System.out.println(zooKeeper.getChildren(\"/\", false));\n            Watcher watcher = new Watcher() {\n                @Override\n                public void process(WatchedEvent event) {\n                    if (event.getState() == Event.KeeperState.SyncConnected) {\n                        if (event.getType() == Event.EventType.NodeChildrenChanged) {\n                            try {\n                                System.out.println(\"re-get children: \" + zooKeeper.getChildren(event.getPath(), true));\n                            } catch (Exception e) {\n                                e.printStackTrace();\n                            } finally {\n                                latch.countDown();\n                            }\n                        }\n                    }\n                }\n            };\n            zooKeeper.getChildren(\"/\", watcher, new AsyncCallback.ChildrenCallback() {\n                @Override\n                public void processResult(int rc, String path, Object ctx, List<String> children) {\n                    System.out.println(\"result code: \" + rc);\n                    System.out.println(\"path: \" + path);\n                    System.out.println(\"ctx: \" + ctx);\n                    System.out.println(\"children: \" + children);\n                    latch.countDown();\n                }\n            }, null);\n            zooKeeper.delete(\"/crayon0\", -1);\n            latch.await();\n        }\n    }\n    ```\n\n###### getData\n\n-   åŒæ­¥\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/15 11:04\n     * åŒæ­¥è·å–èŠ‚ç‚¹æ•°æ®\n     */\n    public class SyncGetDataTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException {\n            ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            final CountDownLatch latch = new CountDownLatch(1);\n            zooKeeper.create(\"/crayon\", \"crayon\".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n            System.out.println(new String(zooKeeper.getData(\"/crayon\", new Watcher() {\n                @Override\n                public void process(WatchedEvent event) {\n                    if (event.getState() == Event.KeeperState.SyncConnected) {\n                        if (event.getType() == Event.EventType.NodeDataChanged) {\n                            System.out.println(\"node data changed!\");\n                            latch.countDown();\n                        }\n                    }\n                }\n            }, new Stat())));\n            zooKeeper.setData(\"/crayon\", \"crayon\".getBytes(), -1);\n            latch.await();\n        }\n    }\n    ```\n\n    å°½ç®¡å†…å®¹æ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯æ•°æ®ç‰ˆæœ¬å·å˜äº†ï¼Œæ‰€ä»¥ZooKeeperä¹Ÿè®¤ä¸ºèŠ‚ç‚¹æ•°æ®å˜åŒ–äº†\n\n-   å¼‚æ­¥\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/15 11:04\n     * å¼‚æ­¥è·å–èŠ‚ç‚¹æ•°æ®\n     */\n    public class AsyncGetDataTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException {\n            ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            final CountDownLatch latch = new CountDownLatch(2);\n            zooKeeper.create(\"/crayon\", \"crayon\".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n            zooKeeper.getData(\"/crayon\", new Watcher() {\n                @Override\n                public void process(WatchedEvent event) {\n                    if (event.getState() == Event.KeeperState.SyncConnected) {\n                        if (event.getType() == Event.EventType.NodeDataChanged) {\n                            System.out.println(\"node data changed!\");\n                            latch.countDown();\n                        }\n                    }\n                }\n            }, new AsyncCallback.DataCallback() {\n                @Override\n                public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {\n                    System.out.println(\"result code: \" + rc);\n                    System.out.println(\"path: \" + path);\n                    System.out.println(\"context: \" + ctx);\n                    System.out.println(\"data: \" + new String(data));\n                    System.out.println(\"stat: \" + stat);\n                    latch.countDown();\n                }\n            }, null);\n            zooKeeper.setData(\"/crayon\", \"crayon\".getBytes(), -1);\n            latch.await();\n        }\n    }\n    ```\n\n##### æ›´æ–°æ•°æ®\n\næ›´æ–°èŠ‚ç‚¹æ•°æ®æ˜¯å¯ä»¥æºå¸¦æ•°æ®ç‰ˆæœ¬çš„ï¼ŒæŒ‡å®šæ•°æ®ç‰ˆæœ¬è¿›è¡Œæ›´æ–°ï¼Œä½†æ˜¯è¯»å–æ•°æ®çš„æ¥å£å¹¶æ²¡æœ‰æä¾›æŒ‡å®šæ•°æ®ç‰ˆæœ¬çš„åŠŸèƒ½ï¼Ÿ\n\n>   CASï¼šé€šè¿‡æºå¸¦ä¸€ä¸ªé¢„æœŸå€¼è¿›è¡Œæ¯”è¾ƒï¼Œæ»¡è¶³çš„æƒ…å†µä¸‹å°±å¯ä»¥è¿›è¡Œä¿®æ”¹\n>\n>   å¦‚ï¼šä½¿ç”¨CASå°†1ä¿®æ”¹ä¸º2ï¼Œé‚£ä¹ˆå°±éœ€è¦æºå¸¦é¢„æœŸå€¼1ï¼Œé€šè¿‡ä¸ç°å€¼æ¯”è¾ƒçœ‹æ˜¯å¦æ•°æ®è¢«å¹¶å‘ä¿®æ”¹è¿‡ï¼Œç›¸åŒåˆ™å¯ä»¥åˆ¤å®šæ²¡æœ‰è¢«å¹¶å‘ä¿®æ”¹ï¼Œé‚£ä¹ˆä¿®æ”¹æ“ä½œæ‰å¯æˆåŠŸ\n>\n>   å®é™…ä¸Šè¿™ç§CASç­–ç•¥æœ‰ä¸ªABAé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¦‚æœå¤šä¸ªå¹¶å‘ä¿®æ”¹åç»“æœä¸å˜ï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼æ˜¯æ— æ³•æ„ŸçŸ¥åˆ°çš„\n>\n>   å¦‚ï¼šçº¿ç¨‹1ï¼š1 --> 2\n>\n>   çº¿ç¨‹2ï¼š2 --> 1\n>\n>   æ­¤æ—¶çº¿ç¨‹3æ— æ³•æ„ŸçŸ¥åˆ°å¹¶å‘ä¿®æ”¹çš„å­˜åœ¨ï¼Œå› ä¸ºæ•°æ®å€¼ä¸é¢„æœŸå€¼ï¼ˆ1ï¼‰ç›¸åŒ\n>\n>   è§£å†³è¿™ä¸ªé—®é¢˜çš„ç‰ˆæœ¬å°±æ˜¯é€šè¿‡ç‰ˆæœ¬å·æ¥åŒºåˆ†ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½ä¼šé€’å¢ç‰ˆæœ¬å·\n>\n>   è¿™ä¸ªæ•°æ®ç‰ˆæœ¬å°±æ˜¯æ ¹æ®CASè¡åŒ–è€Œæ¥çš„ï¼Œæºå¸¦çš„`version`å‚æ•°ä½œä¸ºCASçš„é¢„æœŸå€¼ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ª`version`åˆ¤æ–­æ•°æ®æ˜¯å¦è¢«å¹¶å‘ä¿®æ”¹äº†\n>\n>   ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½å¯ä»¥å®ç°åˆ†å¸ƒå¼é”æœåŠ¡\n\n-   åŒæ­¥\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/15 11:36\n     * åŒæ­¥æ›´æ–°æ•°æ®\n     */\n    public class SyncSetDataTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException {\n            ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            zooKeeper.create(\"/crayon\", \"crayon\".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n            zooKeeper.getData(\"/crayon\", false, null);\n            // -1ä¸æ˜¯ä¸€ä¸ªç‰¹å®šçš„ç‰ˆæœ¬å·ï¼Œè€Œæ˜¯è¡¨ç¤ºåŸºäºæœ€æ–°ç‰ˆæœ¬è¿›è¡Œæ›´æ–°ï¼Œå¯¹æ•°æ®ç‰ˆæœ¬æ²¡æœ‰è¦æ±‚çš„æƒ…å†µå¯ä»¥ä½¿ç”¨\n            Stat stat = zooKeeper.setData(\"/crayon\", \"crayon-modifyed\".getBytes(), -1);\n            System.out.println(stat.getCzxid());\n            System.out.println(stat.getMzxid());\n            System.out.println(stat.getVersion());\n        }\n    }\n    \n    ```\n\n-   å¼‚æ­¥\n\n    ```java\n    /**\n     * @author Crayon\n     * @date 2022/6/15 11:36\n     * å¼‚æ­¥æ›´æ–°æ•°æ®\n     */\n    public class AsyncSetDataTest {\n        @Test\n        public void test() throws IOException, InterruptedException, KeeperException {\n            ZooKeeper zooKeeper = SyncCreateNodeTest.getConnect();\n            final CountDownLatch latch = new CountDownLatch(1);\n            zooKeeper.create(\"/crayon\", \"crayon\".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);\n            zooKeeper.getData(\"/crayon\", false, null);\n            zooKeeper.setData(\"/crayon\", \"crayon-modifyed\".getBytes(), -1, new AsyncCallback.StatCallback() {\n                @Override\n                public void processResult(int rc, String path, Object ctx, Stat stat) {\n                    System.out.println(\"result code: \" + rc);\n                    System.out.println(\"path: \" + path);\n                    System.out.println(\"context: \" + ctx);\n                    System.out.println(stat.getCzxid());\n                    System.out.println(stat.getMzxid());\n                    System.out.println(stat.getVersion());\n                    latch.countDown();\n                }\n            }, null);\n            latch.await();\n        }\n    }\n    ```\n\n##### æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨\n\n\n\n##### æƒé™æ§åˆ¶\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","tags":["Paxos","Zookeeper","åˆ†å¸ƒå¼"],"categories":["å•ƒä¹¦"]}]